<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Frida使用说明 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Frida是一个动态代码插桩框架，这里的介绍主要以应用在Android平台应用程序上。动态二进制插桩（DBI）是将外部代码注入到现有的正在运行的二进制文件中，从而让它执行额外操作。DBI可以：  访问进程内存 在应用程序运行时覆盖函数 从导入的类调用函数 在堆上查找对象实例并使用 Hook、跟踪和拦截函数等  调试器也能完成相应工作，不过非常麻烦，比如各种反调试。 实验环境1.操作系统 MacOS">
<meta property="og:type" content="article">
<meta property="og:title" content="Frida使用说明">
<meta property="og:url" content="http://example.com/2017/05/05/Frida%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Frida是一个动态代码插桩框架，这里的介绍主要以应用在Android平台应用程序上。动态二进制插桩（DBI）是将外部代码注入到现有的正在运行的二进制文件中，从而让它执行额外操作。DBI可以：  访问进程内存 在应用程序运行时覆盖函数 从导入的类调用函数 在堆上查找对象实例并使用 Hook、跟踪和拦截函数等  调试器也能完成相应工作，不过非常麻烦，比如各种反调试。 实验环境1.操作系统 MacOS">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-05-05T14:22:23.000Z">
<meta property="article:modified_time" content="2020-11-12T02:26:14.707Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Frida使用说明" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/05/Frida%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/" class="article-date">
  <time datetime="2017-05-05T14:22:23.000Z" itemprop="datePublished">2017-05-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Frida使用说明
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Frida是一个动态代码插桩框架，这里的介绍主要以应用在Android平台应用程序上。动态二进制插桩（DBI）是将外部代码注入到现有的正在运行的二进制文件中，从而让它执行额外操作。DBI可以：</p>
<ul>
<li>访问进程内存</li>
<li>在应用程序运行时覆盖函数</li>
<li>从导入的类调用函数</li>
<li>在堆上查找对象实例并使用</li>
<li>Hook、跟踪和拦截函数等</li>
</ul>
<p>调试器也能完成相应工作，不过非常麻烦，比如各种反调试。</p>
<h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><p>1.操作系统 MacOS（Linux和Windows也可以）<br>2.主机安装Frida：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install frida</span><br><span class="line">...</span><br><span class="line">Successfully installed frida-10.0.9</span><br></pre></td></tr></table></figure>
<p>3.下载服务器二进制文件<a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">frida-server</a><br>我下载的是frida-server-10.0.9-android-arm.xz，要注意的是frida-server文件要与安装的frida是同一个版本。<br>这里说明一下我用的是nexus5 Android4.4，但是发现后面的实验所需Android的版本较高，改为使用SDK自带的Emulator，新建了一个Android7.0的虚拟机。</p>
<h2 id="Frida基础"><a href="#Frida基础" class="headerlink" title="Frida基础"></a>Frida基础</h2><p>Frida可以在Android应用程序中注入JavaScript或自己的库代码。从版本9开始Frida不再使用Google的V8 Javascript运行时，而是使用其内部的Duktape运行时。启动模拟器或连接设备：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ adb devices</span><br><span class="line">List of devices attached</span><br><span class="line">emulator-5554    device</span><br></pre></td></tr></table></figure>
<p>安装并启动frida-server：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ adb push frida-server-10.0.1-android-arm &#x2F;data&#x2F;local&#x2F;tmp&#x2F;frida-server</span><br><span class="line">$ adb shell</span><br><span class="line">generic:&#x2F; # cd &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line">generic:&#x2F;data&#x2F;local&#x2F;tmp # chmod 755 frida-server</span><br><span class="line">generic:&#x2F;data&#x2F;local&#x2F;tmp # .&#x2F;frida-server</span><br></pre></td></tr></table></figure>
<p>查看frida-server是否启动成功：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ frida-ps -U</span><br><span class="line"> PID  Name</span><br><span class="line">----  --------------------------------------------------</span><br><span class="line"> 698  adbd</span><br><span class="line">2113  android.process.acore</span><br><span class="line">2247  android.process.media</span><br><span class="line"> 700  audioserver</span><br><span class="line"> 701  cameraserver</span><br><span class="line">3426  com.android.gallery3d</span><br><span class="line">1261  com.android.inputmethod.latin</span><br><span class="line">1989  com.android.launcher3</span><br><span class="line">3543  com.android.managedprovisioning</span><br><span class="line">2720  com.android.phone</span><br><span class="line">1771  com.android.printspooler</span><br><span class="line">3122  com.android.providers.calendar</span><br><span class="line">1971  com.android.systemui</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>-U表示USB，允许Frida检查USB设备。这时将看到一个进程列表。现在可以通过Frida hook到任何一个进程，并对其进行插桩了。</p>
<h3 id="Hook应用程序函数调用"><a href="#Hook应用程序函数调用" class="headerlink" title="Hook应用程序函数调用"></a>Hook应用程序函数调用</h3><p>这里我先在模拟器上安装了一个Drozer的测试应用程序<a target="_blank" rel="noopener" href="https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk">sieve</a>。使用frida-trace可以跟踪由sieve使用的特定调用：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ frida-trace -i open -U -f com.mwr.example.sieve</span><br><span class="line">Instrumenting functions...</span><br><span class="line">open: Loaded handler at &quot;&#x2F;Users&#x2F;fan&#x2F;__handlers__&#x2F;libc.so&#x2F;open.js&quot;</span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">           &#x2F;* TID 0x1284 *&#x2F;</span><br><span class="line">   206 ms  open()</span><br><span class="line">           &#x2F;* TID 0x129a *&#x2F;</span><br><span class="line">   221 ms  open()</span><br><span class="line">           &#x2F;* TID 0x1284 *&#x2F;</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>
<p>frida-trace会生成一个Javascript文件（第二行输出），然后Frida将其注入到进程中，并hook特定调用（libc.so中的open函数）。修改生成的Javascript文件<code>open.js</code>可以输出open函数的调用参数。  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">log, args, state</span>) </span>&#123;</span><br><span class="line">    log(<span class="string">&quot;open(&quot;</span> + <span class="string">&quot;pathname=&quot;</span> + args[<span class="number">0</span>] + <span class="string">&quot;, flags=&quot;</span> + args[<span class="number">1</span>] + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>再次运行应用程序会输出如下信息：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -i open -U -f com.mwr.example.sieve</span><br><span class="line">Instrumenting functions...</span><br><span class="line">open: Loaded handler at &quot;&#x2F;Users&#x2F;fan&#x2F;__handlers__&#x2F;libc.so&#x2F;open.js&quot;</span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">           &#x2F;* TID 0x1383 *&#x2F;</span><br><span class="line">   222 ms  open(pathname&#x3D;0xa7137e65, flags&#x3D;0x80002)</span><br><span class="line">           &#x2F;* TID 0x1399 *&#x2F;</span><br><span class="line">   255 ms  open(pathname&#x3D;0xa662cc2c, flags&#x3D;0x2)</span><br><span class="line">           &#x2F;* TID 0x139a *&#x2F;</span><br><span class="line">   267 ms  open(pathname&#x3D;0xa662cc2c, flags&#x3D;0x2)</span><br><span class="line">           &#x2F;* TID 0x1383 *&#x2F;</span><br><span class="line">   286 ms  open(pathname&#x3D;0xa662c6df, flags&#x3D;0x2)</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>
<p>再对<code>open.js</code>做修改，让其输出打开文件路径的文本形式，而不是存储单元的地址。我们可以直接访问内存，这里可以参考Frida的<a target="_blank" rel="noopener" href="https://www.frida.re/docs/javascript-api/">Javascript API</a>。  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">log, args, state</span>) </span>&#123;</span><br><span class="line">    log(<span class="string">&quot;open(&quot;</span> + <span class="string">&quot;pathname=&quot;</span> + Memory.readUtf8String(args[<span class="number">0</span>]) + <span class="string">&quot;, flags=&quot;</span> + args[<span class="number">1</span>] + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>再次运行程序输出如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ frida-trace -i open -U -f com.mwr.example.sieve</span><br><span class="line">Instrumenting functions...</span><br><span class="line">open: Loaded handler at &quot;&#x2F;Users&#x2F;fan&#x2F;__handlers__&#x2F;libc.so&#x2F;open.js&quot;</span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">           &#x2F;* TID 0x1434 *&#x2F;</span><br><span class="line">   272 ms  open(pathname&#x3D;&#x2F;dev&#x2F;binder, flags&#x3D;0x80002)</span><br><span class="line">           &#x2F;* TID 0x1449 *&#x2F;</span><br><span class="line">   286 ms  open(pathname&#x3D;&#x2F;dev&#x2F;ashmem, flags&#x3D;0x2)</span><br><span class="line">           &#x2F;* TID 0x144a *&#x2F;</span><br><span class="line">   296 ms  open(pathname&#x3D;&#x2F;dev&#x2F;ashmem, flags&#x3D;0x2)</span><br><span class="line">           &#x2F;* TID 0x1434 *&#x2F;</span><br><span class="line">   300 ms  open(pathname&#x3D;&#x2F;sys&#x2F;qemu_trace&#x2F;process_name, flags&#x3D;0x2)</span><br><span class="line">   428 ms  open(pathname&#x3D;&#x2F;dev&#x2F;alarm, flags&#x3D;0x0)</span><br><span class="line">   431 ms  open(pathname&#x3D;&#x2F;sys&#x2F;qemu_trace&#x2F;process_name, flags&#x3D;0x2)</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<h3 id="Frida命令行接口frida-cli"><a href="#Frida命令行接口frida-cli" class="headerlink" title="Frida命令行接口frida-cli"></a>Frida命令行接口frida-cli</h3><p>启动sieve应用，并将生成的进程的任务留给Frida：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U --no-pause -f com.mwr.example.sieve</span><br><span class="line">     ____</span><br><span class="line">    &#x2F; _  |   Frida 10.0.1 - A world-class dynamic instrumentation framework</span><br><span class="line">   | (_| |</span><br><span class="line">    &gt; _  |   Commands:</span><br><span class="line">   &#x2F;_&#x2F; |_|       help      -&gt; Displays the help system</span><br><span class="line">   . . . .       object?   -&gt; Display information about &#39;object&#39;</span><br><span class="line">   . . . .       exit&#x2F;quit -&gt; Exit</span><br><span class="line">   . . . .</span><br><span class="line">   . . . .   More info at http:&#x2F;&#x2F;www.frida.re&#x2F;docs&#x2F;home&#x2F;</span><br><span class="line">Spawned &#96;com.mwr.example.sieve&#96;. Resuming main thread!</span><br><span class="line">[USB::Android Emulator 5554::[&#39;com.mwr.example.sieve&#39;]]-&gt;</span><br></pre></td></tr></table></figure>
<p>这样就能得到一个shell，可以使用Frida的<code>Javascrip API</code>写命令了。通过Tab可以查看和补全命令，Frida也提供了详细的API文档。对于Android，查看<code>Javascript API</code>的<a target="_blank" rel="noopener" href="https://www.frida.re/docs/javascript-api/#java">Java部分</a>。下面详细讨论一个访问Java对象的Javascript包装器，在和Android应用程序交互的时候，这是一种更便捷的方法。不同于hook libc函数，我们可以直接使用Java函数和对象。<br>列出加载的类：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[USB::Android Emulator 5554::[&#39;com.mwr.example.sieve&#39;]]-&gt; Java.perform(function()&#123;Java.enumerateLoadedClasses(&#123;&quot;onMatch&quot;:function(className)&#123; console.log(className) &#125;, &quot;onComplete&quot;:function()&#123;&#125;&#125;)&#125;)</span><br><span class="line">...</span><br><span class="line">com.mwr.example.sieve.AuthServiceConnector$MessageHandler</span><br><span class="line">com.mwr.example.sieve.WelcomeActivity</span><br><span class="line">com.mwr.example.sieve.PWDBHelper</span><br><span class="line">com.mwr.example.sieve.AuthService</span><br><span class="line">com.mwr.example.sieve.DBContentProvider</span><br><span class="line">com.mwr.example.sieve.AuthServiceConnector$ResponseListener</span><br><span class="line">com.mwr.example.sieve.MainLoginActivity</span><br><span class="line">com.mwr.example.sieve.FileBackupProvider</span><br><span class="line">com.mwr.example.sieve.AuthServiceConnector</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里输入了一个比较长的命令，是一些嵌套的函数代码。首先，输入的代码必须包装在<code>Java.perform(function()&#123;...&#125;)</code>中，这是Frida API硬性要求。<br>下面是在<code>Java.perform</code>包装器中插入的函数体：  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Java.enumerateLoadedClasses(</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="string">&quot;onMatch&quot;</span>: <span class="function"><span class="keyword">function</span>(<span class="params">className</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(className)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;onComplete&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>使用Frida API的<code>Java.enumerateLoadedClasses</code>枚举所有加载的类，并使用<code>console.log</code>将匹配的类输出到控制台。这种回调对象在Frida中是一种非常常见 的模式。你可以提供一个回调对象，形式如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;onMatch&quot;:function(arg1, ...)&#123;...&#125;,</span><br><span class="line">&quot;onComplete&quot;:function()&#123;&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当Frida找到符合要求的匹配项时，就会使用一个或多个参数调用<code>onMatch</code>；当Frida完成匹配工作时，就会调用<code>onComplete</code>。</p>
<h2 id="Frida加载外部脚本"><a href="#Frida加载外部脚本" class="headerlink" title="Frida加载外部脚本"></a>Frida加载外部脚本</h2><p>下面通过加载一个外部脚本来覆盖一个函数，首先，将下面的代码保存到一个脚本文件中，例如<code>sieve.js</code>:  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> Activity = Java.use(<span class="string">&quot;android.app.Activity&quot;</span>);</span><br><span class="line">   Activity.onResume.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">&quot;[*] onResume() got called!&quot;</span>);</span><br><span class="line">       <span class="built_in">this</span>.onResume();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这段代码将会覆盖<code>android.app.Activity</code>类的<code>onResume</code>函数。这里调用了<code>Java.use</code>来接收<code>android.app.Activity</code>类的包装对象，并访问其<code>onResume</code>函数的<code>implementation</code>属性，来重新实现。在新的函数体中，通过<code>this.onResume</code>调用原来的<code>onResume</code>函数，所以应用程序可以正常执行。<br>打开sieve应用，通过<code>-l</code>选项来注入这个脚本：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U -l sieve.js com.mwr.example.sieve</span><br></pre></td></tr></table></figure>
<p>一旦触发onResume，例如切换出sieve再切换回来，就会在shell中输出：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[*] onResume() got called!</span><br></pre></td></tr></table></figure>
<p>通过覆盖应用程序中的函数，就可以控制应用程序的行为。</p>
<blockquote>
<p>当模拟器速度较慢时，Frida会出现超时。为了防止这种情况，可以将脚本封装到<code>setImmediate</code>中。修改脚本文件后，<code>setImmediate</code>将自动重新运行脚本。<code>setImmediate</code>运行脚本是在后台，所以会立刻得到一个cli，稍等脚本处理完，就会输出结果。</p>
</blockquote>
<p>下面利用<code>Java.choose</code>查找堆中已经实例化的对象：  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] Starting script&quot;</span>);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;android.widget.EditText&quot;</span>, &#123;</span><br><span class="line">        <span class="string">&quot;onMatch&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] Instance found&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;onComplete&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] Finished heap search&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>运行脚本：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U -l sieve2.js com.mwr.example.sieve</span><br><span class="line">...</span><br><span class="line">[*] Starting script</span><br><span class="line">[USB::Android Emulator 5554::com.mwr.example.sieve]-&gt; [*] Instance found</span><br><span class="line">[*] Instance found</span><br><span class="line">[*] Instance found</span><br><span class="line">[*] Instance found</span><br><span class="line">[*] Finished heap search</span><br></pre></td></tr></table></figure>
<p>在堆上找到了四个<code>android.widget.EditText</code>，可以调用这些实例对象方法。这里只是为<code>console.log</code>输出添加<code>instance.toString()</code>。由于使用了<code>setImmediate</code>，所以只要修改脚本，Frida就会重新运行它：  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] Starting script&quot;</span>);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;android.widget.EditText&quot;</span>, &#123;</span><br><span class="line">        <span class="string">&quot;onMatch&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] Instance found: &quot;</span> + instance.toString());</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;onComplete&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] Finished heap search&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>输出结果：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] Starting script</span><br><span class="line">[*] Instance found: android.widget.EditText&#123;78e1fa3 VFED..CL. .F....ID 710,245-1440,383 #7f08002b app:id&#x2F;welcome_editt&#125;</span><br><span class="line">[*] Instance found: android.widget.EditText&#123;3952a0 VFED..CL. ......ID 710,488-1440,626 #7f08002d app:id&#x2F;welcome_editte&#125;</span><br><span class="line">[*] Instance found: android.widget.EditText&#123;7551e59 VFED..CL. .F...... 710,245-1440,383 #7f08002b app:id&#x2F;welcome_editt&#125;</span><br><span class="line">[*] Instance found: android.widget.EditText&#123;533a1e VFED..CL. ........ 710,488-1440,626 #7f08002d app:id&#x2F;welcome_editte&#125;</span><br><span class="line">[*] Finished heap search</span><br></pre></td></tr></table></figure>
<p>Frida实际上调用了<code>android.widget.EditText</code>对象实例的toString方法。借助Frida，我们可以读取进程内存、修改函数、查找对象实例。Frida的基本使用就是这样，可以通过其官网的Docs深入学习。</p>
<h2 id="使用Frida和Redare2：r2frida"><a href="#使用Frida和Redare2：r2frida" class="headerlink" title="使用Frida和Redare2：r2frida"></a>使用Frida和Redare2：r2frida</h2><p>还可以使用<code>Radare2</code>反汇编框架来检查应用程序的内存，方法是通过<code>r2frida</code>将<code>Radare2</code>连接到Frida，然后对进程的内存进行静态分析和反汇编处理。之前<a target="_blank" rel="noopener" href="http://pwn4.fun/2016/06/20/radare2%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/">简单介绍过Radare2</a>，还是要抽时间再多学习补充一下。<br>安装<code>Radare2</code>后，可以用Radare2的数据包管理程序来安装<code>r2frida</code>：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ r2pm install r2frida</span><br></pre></td></tr></table></figure>
<p>回到前面frida-trace的例子，还是输出内存地址：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -i open -U -f com.mwr.example.sieve</span><br><span class="line">Instrumenting functions...</span><br><span class="line">open: Loaded handler at &quot;&#x2F;Users&#x2F;fan&#x2F;__handlers__&#x2F;libc.so&#x2F;open.js&quot;</span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">           &#x2F;* TID 0x18cd *&#x2F;</span><br><span class="line">   208 ms  open(pathname&#x3D;0xa7137e65, flags&#x3D;0x80002)</span><br><span class="line">           &#x2F;* TID 0x18e1 *&#x2F;</span><br><span class="line">   232 ms  open(pathname&#x3D;0xa662cc2c, flags&#x3D;0x2)</span><br><span class="line">           &#x2F;* TID 0x18e2 *&#x2F;</span><br><span class="line">   250 ms  open(pathname&#x3D;0xa662cc2c, flags&#x3D;0x2)</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>
<p>使用r2frida显示内存地址的内容并读取路径名：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ r2 frida:&#x2F;&#x2F;emulator-5554&#x2F;com.mwr.example.sieve</span><br><span class="line"> -- Run .dmm* to load the flags of the symbols of all modules loaded in the debugger</span><br><span class="line">[0x00000000]&gt; s 0xa7137e65</span><br><span class="line">[0xa7137e65]&gt; px</span><br><span class="line">- offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF</span><br><span class="line">0xa7137e65  2f64 6576 2f62 696e 6465 7200 4269 6e64  &#x2F;dev&#x2F;binder.Bind</span><br><span class="line">0xa7137e75  6572 2069 6f63 746c 2074 6f20 6f62 7461  er ioctl to obta</span><br><span class="line">0xa7137e85  696e 2076 6572 7369 6f6e 2066 6169 6c65  in version faile</span><br><span class="line">0xa7137e95  643a 2025 7300 4269 6e64 6572 2064 7269  d: %s.Binder dri</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://bobao.360.cn/learning/detail/3641.html">http://bobao.360.cn/learning/detail/3641.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/05/05/Frida%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/" data-id="ckhe7o4l8001xchl76fn584ef" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/05/07/Frida%E8%A7%A3%E5%86%B3Android-Crackme1/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Frida解决Android Crackme1
        
      </div>
    </a>
  
  
    <a href="/2017/05/01/CVE-2014-7911-Android%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%88%E4%BA%8C%EF%BC%89/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CVE-2014-7911 Android提权漏洞（二）</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ARM/" rel="tag">ARM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithms/" rel="tag">Algorithms</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blockchain/" rel="tag">Blockchain</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-C/" rel="tag">C/C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fuzzing/" rel="tag">Fuzzing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IoT/" rel="tag">IoT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kernel/" rel="tag">Kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Machine-Learning/" rel="tag">Machine Learning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pwn/" rel="tag">Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Reverse/" rel="tag">Reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Symbolic-Execution/" rel="tag">Symbolic Execution</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tensorflow/" rel="tag">Tensorflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Virtual/" rel="tag">Virtual</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ARM/" style="font-size: 11px;">ARM</a> <a href="/tags/Algorithms/" style="font-size: 10px;">Algorithms</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Blockchain/" style="font-size: 11px;">Blockchain</a> <a href="/tags/C-C/" style="font-size: 18px;">C/C++</a> <a href="/tags/Crypto/" style="font-size: 10px;">Crypto</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Fuzzing/" style="font-size: 15px;">Fuzzing</a> <a href="/tags/IoT/" style="font-size: 12px;">IoT</a> <a href="/tags/Java/" style="font-size: 14px;">Java</a> <a href="/tags/Kernel/" style="font-size: 19px;">Kernel</a> <a href="/tags/Machine-Learning/" style="font-size: 17px;">Machine Learning</a> <a href="/tags/Pwn/" style="font-size: 19px;">Pwn</a> <a href="/tags/Reverse/" style="font-size: 13px;">Reverse</a> <a href="/tags/Symbolic-Execution/" style="font-size: 12px;">Symbolic Execution</a> <a href="/tags/Tensorflow/" style="font-size: 10px;">Tensorflow</a> <a href="/tags/Virtual/" style="font-size: 16px;">Virtual</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/07/29/so%E6%96%87%E4%BB%B6%E7%9A%84-init-array%E6%AE%B5%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81/">so文件的.init_array段中添加代码</a>
          </li>
        
          <li>
            <a href="/2020/07/09/PID-namespace/">PID namespace</a>
          </li>
        
          <li>
            <a href="/2020/07/08/Mount-namespace/">Mount namespace</a>
          </li>
        
          <li>
            <a href="/2020/07/06/User-namespace/">User namespace</a>
          </li>
        
          <li>
            <a href="/2020/07/01/UnionFS%E6%8A%80%E6%9C%AF/">UnionFS技术</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>