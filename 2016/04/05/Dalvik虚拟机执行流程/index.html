<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="trace使用(1) 在代码中加入调试命令 12345678910111213141516171819202122package com.example.dalviktestapp;import android.app.Activity;import android.os.Bundle;import android.os.Debug;public class MainActivity extend">
<meta property="og:type" content="article">
<meta property="og:title" content="Dalvik虚拟机执行流程">
<meta property="og:url" content="http://example.com/2016/04/05/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="BruceFan&#39;s Blog">
<meta property="og:description" content="trace使用(1) 在代码中加入调试命令 12345678910111213141516171819202122package com.example.dalviktestapp;import android.app.Activity;import android.os.Bundle;import android.os.Debug;public class MainActivity extend">
<meta property="og:locale">
<meta property="og:image" content="http://example.com/images/androiddalvik/traceview.png">
<meta property="article:published_time" content="2016-04-05T03:13:11.000Z">
<meta property="article:modified_time" content="2022-08-09T16:03:51.201Z">
<meta property="article:author" content="Bruce Fan">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/androiddalvik/traceview.png">

<link rel="canonical" href="http://example.com/2016/04/05/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>Dalvik虚拟机执行流程 | BruceFan's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BruceFan's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Stay hungry, stay foolish</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/04/05/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Dalvik虚拟机执行流程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-04-05 11:13:11" itemprop="dateCreated datePublished" datetime="2016-04-05T11:13:11+08:00">2016-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2022-08-10 00:03:51" itemprop="dateModified" datetime="2022-08-10T00:03:51+08:00">2022-08-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="trace使用"><a href="#trace使用" class="headerlink" title="trace使用"></a>trace使用</h2><p>(1) 在代码中加入调试命令</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dalviktestapp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Debug;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        test();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用Android调试模式下的调试方法</span></span><br><span class="line">        Debug.startMethodTracing(<span class="string">&quot;/sdcard/test&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello Dalvik&quot;</span>);</span><br><span class="line">        Debug.stopMethodTracing();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>(2) 在<code>AndroidMenifest.xml</code>文件中加入权限</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">uses-permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.MOUNT_UNMOUNT_FILESYSTEMS&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">uses-permission</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>(3) 右键项目-&gt;Debug As-&gt;Android Application，会在sdcard目录下生成trace文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ adb pull &#x2F;sdcard&#x2F;test.trace . &#x2F;&#x2F; 拷贝到本地</span><br><span class="line">$ traceview test.trace &#x2F;&#x2F; 用traceview查看</span><br></pre></td></tr></table></figure>
<p>可以看到程序中每个线程调用方法的启动和停止时间，分析程序的每一步流程，定位存在问题的代码。<br><img src="/images/androiddalvik/traceview.png"></p>
<h2 id="Dalvik虚拟机执行流程"><a href="#Dalvik虚拟机执行流程" class="headerlink" title="Dalvik虚拟机执行流程"></a>Dalvik虚拟机执行流程</h2><p>Dalvik虚拟机各部分功能：<br><strong>线程管理：</strong>进程隔离和线程管理，每一个Android应用在底层都会对应一个独立的Dalvik虚拟机实例，所有的Android应用的线程都对应一个Linux线程，进程管理依赖于Zygote机制。<br><strong>类加载：</strong>解析Dex文件并加载Dalvik字节码。<br><strong>解释器：</strong>根据自身的指令集Dalvik ByteCode解释字节码。<br><strong>内存管理：</strong>分配系统启动初始化和应用程序运行时需要的内存资源。<br><strong>即时编译(Just-In-Time, JIT)：</strong>在解释时动态地编译程序，以缓解解释器的低效工作。<br><strong>本地方法调用(Java Native Interface, JNI)：</strong>一套编程框架标准接口，允许Java代码和本地代码互相调用。<br><strong>反射机制实现模块：</strong>允许程序在运行时透过Reflection API取得任何一个已知名称的类的内部信息，包括其描述符、超类、实现的接口，也包括属性和方法等所有信息，并可于运行时改变属性内容或调用内部方法。<br><strong>调试支撑模块：</strong>Dalvik VM支持许多常见开发环境下的代码级调试，任何允许<code>JDWP（Java Debug Wire Protocol——Java 调试线协议）</code>下远程调试的工具都可以使用，其支持的调试器包括jdb、Eclipse、IntelliJ和JSwat。</p>
<h3 id="Dalvik虚拟机运行在ARM平台的入口点"><a href="#Dalvik虚拟机运行在ARM平台的入口点" class="headerlink" title="Dalvik虚拟机运行在ARM平台的入口点"></a>Dalvik虚拟机运行在ARM平台的入口点</h3><p>Dalvik虚拟机运行在ARM平台时，是从初始化进程加载的服务<code>Zygote</code>开始的。Zygote进程通过调用<code>startVm</code>来创建虚拟机。在这个函数中主要通过调用<code>JNI_CreateJavaVM()</code>来创建虚拟机。<br><strong>代码清单</strong> framework/base/core/jni/AndroidRuntime.cpp: startVm()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> AndroidRuntime::startVm(JavaVM** pJavaVM, JNIEnv** pEnv)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;initArgs) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGE(<span class="string">&quot;JNI_CreateJavaVM failed\n&quot;</span>);</span><br><span class="line">        goto bail;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dalvik虚拟机的入口点通过调用<code>JNI_CreateJavaVM()</code>函数来完成虚拟机的创建。<code>Java_CreateJavaVM</code>所完成的主要工作如下。<br>(1) 检查<code>JNI</code>版本是否正确；<br>(2) 解析命令行参数，初始化<code>JNIEnv</code>和<code>JavaVM</code>全局变量；<br>(3) 初始化全局变量<code>gDvm</code>；<br>(4) 调用<code>dvmStartup</code>初始化虚拟机的各个模块，包括初始化<code>垃圾收集器(GC)</code>、<code>类加载器</code>、<code>字节码校验模块</code>和<code>解释器</code>等，完成各模块的初始化后创建一个线程；<br>(5) 装载Dalvik虚拟机运行时核心类库并校验字节码。<br>JNI_CreateJavaVM函数的实现在文件dalvik/vm/Jni.cpp里<br><strong>代码清单</strong> dalvik/vm/Jni.cpp: JNI_CreateJavaVM()</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">JNI_CreateJavaVM</span><span class="params">(JavaVM** p_vm, JNIEnv** p_env, <span class="keyword">void</span>* vm_args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> JavaVMInitArgs* args = (JavaVMInitArgs*) vm_args;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* 初始化VM */</span></span><br><span class="line">    gDvm.initializing = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> status = </span><br><span class="line">        dvmStartup(argc, argv.get(), args-&gt;ignoreUnrecognized, (JNIEnv*)pEnv);</span><br><span class="line">    gDvm.initializing = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!status.empty()) &#123;</span><br><span class="line">        <span class="built_in">free</span>(pEnv);</span><br><span class="line">        <span class="built_in">free</span>(pVM);</span><br><span class="line">        LOGW(<span class="string">&quot;CreateJavaVM failed: %s&quot;</span>, status.c_str());</span><br><span class="line">        <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Success! Return stuff to caller */</span></span><br><span class="line">    dvmChangeStatus(<span class="literal">NULL</span>, THREAD_NATIVE);</span><br><span class="line">    *p_env = (JNIEnv*) pEnv;</span><br><span class="line">    *p_vm = (JavaVM*) pVM;</span><br><span class="line">    ALOGV(<span class="string">&quot;CreateJavaVM successded&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> JNI_OK;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Zygote进程"><a href="#Zygote进程" class="headerlink" title="Zygote进程"></a>Zygote进程</h3><p>Zygote进程是由<code>init进程</code>根据<code>system/core/rootdir/init.rc</code>文件中的配置项创建的，init进程是系统启动后运行在用户空间的首个进程。init进程启动完系统所需的各种Daemon线程后，启动Zygote进程。Zygote进程启动后，Android的应用程序都由Zygote进程启动运行。Zygote主要负责：<br>(1) 启动系统服务<code>system_server</code>进程（Android绝大多数系统服务的守护进程）。<br>(2) 创建子进程运行Android应用程序。<br>Zygote工作流程：<br>(1) 系统init进程创建Zygote进程，通过执行app_process程序，开启Zygote进程。<br>(2) app_process生成<code>AppRuntime</code>对象，分析其主函数传递过来的参数，传递给AppRuntime对象，调用对象的start方法，在start中完成了以下三件事。</p>
<ul>
<li>调用<code>startVm</code>注册虚拟机。在其中通过调用JNI_CreateJavaVM()创建虚拟机。</li>
<li>调用<code>startReg</code>注册JNI函数。注册虚拟机要使用的JNI函数，这样运行在虚拟机中的Java类就可以调用本地函数了。</li>
<li>调用<code>ZygoteInit类</code>的main函数，运行ZygoteInit类（位于framework/base/core/java/com/android/internal/os/ZygoteInit.java）。</li>
</ul>
<p>(3) <code>ZygoteInit</code>是Zygote的main函数入口，是Zygote的核心类，完成了Zygote的职责，其执行流程如下。</p>
<ul>
<li>调用<code>registerZygoteSocket</code>函数创建了一个socket接口，绑定socket套接字，接收新的Android应用程序运行请求。</li>
<li>调用<code>preloadClasses</code>和<code>preloadResource</code>函数加载Android application framework使用的类和资源。</li>
<li>调用<code>startSystemServer</code>函数来启动<code>SystemServer</code>组件。在startSystemServer中调用<code>forkSystemServer()</code>来创建出一个名为<code>system_server</code>的进程，这个进程调用<code>com.android.server.SystemServer</code>的main函数，启动各项系统服务，并最终将调用线程加入到Binder通信系统。<code>system_server</code>是系统Service所驻留的进程，该进程是framework的核心。</li>
<li>Zygote从startSystemServer函数返回后，调用<code>runSelectLoopMode</code>函数进入一个无限循环，监听socket接口等待新的应用程序请求。</li>
</ul>
<p>Zygote可以创建三种进程：fork<code>Zygote子进程</code>，forkSystemServer<code>system_server进程</code>，forkAndSpecialize<code>非Zygote子进程</code>。<br>三种创建进程的方法根据JNI机制均对应有native方法，位于dalvik/vm/native/dalvik_system_Zygote.cpp文件中：<br>(1) fork<br><strong>代码清单</strong> dalvik/vm/native/dalvik_system_Zygote.cpp: Dalvik_dalvik_system_Zygote_fork()</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* native public static int fork(); */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Dalvik_dalvik_system_Zygote_fork</span><span class="params">(<span class="keyword">const</span> u4* args, JValue* pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="comment">// 判断当前虚拟机是否支持Zygote</span></span><br><span class="line">    <span class="keyword">if</span> (!gDvm.zygote) &#123;</span><br><span class="line">        dvmThrowIllegalStateException(</span><br><span class="line">            <span class="string">&quot;VM instance not started with -Xzygote&quot;</span>);</span><br><span class="line">        RETURN_VOID();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断堆创建是否成功，不成功则停止虚拟机</span></span><br><span class="line">    <span class="keyword">if</span> (!dvmGcPreZygoteFork()) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;pre-fork heap failed&quot;</span>);</span><br><span class="line">        dvmAbort();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置信号机制</span></span><br><span class="line">    setSignalHandler();</span><br><span class="line">    <span class="comment">// 记录日志信息</span></span><br><span class="line">    dvmDumpLoaderStats(<span class="string">&quot;zygote&quot;</span>);</span><br><span class="line">    pid = fork();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_ANDROID_OS</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* child process */</span></span><br><span class="line">        <span class="keyword">extern</span> <span class="keyword">int</span> gMallocLeakZygoteChild;</span><br><span class="line">        gMallocLeakZygoteChild = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    RETURN_INT(pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新进程复制父进程的资源，新的Zygote进程的虚拟机参数中支持Zygote标记参数gDvm.zygote也为true，因而也可以fork子进程。<br>(2) forkSystemServer()<br><strong>代码清单</strong> dalvik/vm/native/dalvik_system_Zygote.cpp: Dalvik_dalvik_system_Zygote_forkSystemServer()</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * native public static int nativeForkSystemServer(int uid, int gid,</span></span><br><span class="line"><span class="comment"> *     int[] gids, int debugFlags, int[][] rlimits,</span></span><br><span class="line"><span class="comment"> *     long permittedCapabilities, long effectiveCapabilities);</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Dalvik_dalvik_system_Zygote_forkSystemServer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> u4* args, JValue* pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="comment">// 根据参数，fork一个子进程</span></span><br><span class="line">    pid = forkAndSpecializeCommon(args, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">/* The zygote process checks whether the child process has died or not. */</span></span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> status;</span><br><span class="line">        ALOGI(<span class="string">&quot;System server process %d has been created&quot;</span>, pid);</span><br><span class="line">        <span class="comment">// 保存system_server的进程id</span></span><br><span class="line">        gDvm.systemServerPid = pid;</span><br><span class="line">        <span class="comment">/* There is a slight window that the system server process has crashed</span></span><br><span class="line"><span class="comment">         * but it went unnoticed because we haven&#x27;t published its pid yet. So</span></span><br><span class="line"><span class="comment">         * we recheck here just to make sure that all is well.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (waitpid(pid, &amp;status, WNOHANG) == pid) &#123;</span><br><span class="line">            <span class="comment">// 如果system_server退出了，Zygote直接kill自己</span></span><br><span class="line">            ALOGE(<span class="string">&quot;System server process %d has died. Restarting Zygote!&quot;</span>, pid);</span><br><span class="line">            kill(getpid(), SIGKILL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    RETURN_INT(pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>system_server子进程一直驻留在系统中，一旦此进程退出，父进程Zygote也会被终止。系统init进程通过重启Zygote进程，使得Zygote进程重新启动system_server进程。<br>(3) forkAndSpecialize()<br><strong>代码清单</strong> dalvik/vm/native/dalvik_system_Zygote.cpp: Dalvik_dalvik_system_Zygote_forkAndSpecialize()</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * native public static int nativeForkAndSpecialize(int uid, int gid,</span></span><br><span class="line"><span class="comment"> *     int[] gids, int debugFlags, int[][] rlimits, int mountExternal,</span></span><br><span class="line"><span class="comment"> *     String seInfo, String niceName);</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Dalvik_dalvik_system_Zygote_forkAndSpecialize</span><span class="params">(<span class="keyword">const</span> u4 *args, JValue *pResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid = forkAndSpecializeCommon(args, <span class="literal">false</span>);</span><br><span class="line">    RETURN_INT(pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>forkAndSpecializeCommon()</code>函数的第二个参数标识创建的子进程是否为system_server子进程。forkSystemServer()调用时第二个参数为true，而forkAndSpecialize()调用时为false。<br><strong>代码清单</strong> dalvik/vm/native/dalvik_system_Zygote.cpp: forkAndSpecializeCommon()</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Utility routine to fork zygote and specialize the child process.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">pid_t</span> <span class="title">forkAndSpecializeCommon</span><span class="params">(<span class="keyword">const</span> u4* args, <span class="keyword">bool</span> isSystemServer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uid_t</span> uid = (<span class="keyword">uid_t</span>) args[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">gid_t</span> gid = (<span class="keyword">gid_t</span>) args[<span class="number">1</span>];</span><br><span class="line">    ArrayObject* gids = (ArrayObject *)args[<span class="number">2</span>];</span><br><span class="line">    u4 debugFlags = args[<span class="number">3</span>];</span><br><span class="line">    ArrayObject *rlimits = (ArrayObject *)args[<span class="number">4</span>];</span><br><span class="line">    u4 mountMode = MOUNT_EXTERNAL_NONE;</span><br><span class="line">    <span class="keyword">int64_t</span> permittedCapabilities, effectiveCapabilities;</span><br><span class="line">    <span class="keyword">char</span> *seInfo = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> *niceName = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 判断是否为system_server进程</span></span><br><span class="line">    <span class="keyword">if</span> (isSystemServer) &#123;</span><br><span class="line">        permittedCapabilities = args[<span class="number">5</span>] | (<span class="keyword">int64_t</span>) args[<span class="number">6</span>] &lt;&lt; <span class="number">32</span>;</span><br><span class="line">        effectiveCapabilities = args[<span class="number">7</span>] | (<span class="keyword">int64_t</span>) args[<span class="number">8</span>] &lt;&lt; <span class="number">32</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mountMode = args[<span class="number">5</span>];</span><br><span class="line">        permittedCapabilities = effectiveCapabilities = <span class="number">0</span>;</span><br><span class="line">        StringObject* seInfoObj = (StringObject*)args[<span class="number">6</span>];</span><br><span class="line">        <span class="keyword">if</span> (seInfoObj) &#123;</span><br><span class="line">            seInfo = dvmCreateCstrFromString(seInfoObj);</span><br><span class="line">            <span class="keyword">if</span> (!seInfo) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;seInfo dvmCreateCstrFromString failed&quot;</span>);</span><br><span class="line">                dvmAbort();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        StringObject* niceNameObj = (StringObject*)args[<span class="number">7</span>];</span><br><span class="line">        <span class="keyword">if</span> (niceNameObj) &#123;</span><br><span class="line">            niceName = dvmCreateCstrFromString(niceNameObj);</span><br><span class="line">            <span class="keyword">if</span> (!niceName) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;niceName dvmCreateCstrFromString failed&quot;</span>);</span><br><span class="line">                dvmAbort();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断当前虚拟机是否支持Zygote</span></span><br><span class="line">    <span class="keyword">if</span> (!gDvm.zygote) &#123;</span><br><span class="line">        dvmThrowIllegalStateException(</span><br><span class="line">            <span class="string">&quot;VM instance not started with -Xzygote&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断堆创建是否成功，不成功则停止虚拟机</span></span><br><span class="line">    <span class="keyword">if</span> (!dvmGcPreZygoteFork()) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;pre-fork heap failed&quot;</span>);</span><br><span class="line">        dvmAbort();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置信号处理</span></span><br><span class="line">    setSignalHandler();</span><br><span class="line">    dvmDumpLoaderStats(<span class="string">&quot;zygote&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> err;</span><br><span class="line">        <span class="comment">/* The child process */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_ANDROID_OS</span></span><br><span class="line">        <span class="keyword">extern</span> <span class="keyword">int</span> gMallocLeakZygoteChild;</span><br><span class="line">        gMallocLeakZygoteChild = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* keep caps across UID change, unless we&#x27;re staying root */</span></span><br><span class="line">        <span class="keyword">if</span> (uid != <span class="number">0</span>) &#123;</span><br><span class="line">            err = prctl(PR_SET_KEEPCAPS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;cannot PR_SET_KEEPCAPS: %s&quot;</span>, strerror(errno));</span><br><span class="line">                dvmAbort();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; prctl(PR_CAPBSET_READ, i, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &gt;= <span class="number">0</span>; i++) &#123;</span><br><span class="line">            err = prctl(PR_CAPBSET_DROP, i, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (errno == EINVAL) &#123;</span><br><span class="line">                    ALOGW(<span class="string">&quot;PR_CAPBSET_DROP %d failed: %s. &quot;</span></span><br><span class="line">                          <span class="string">&quot;Please make sure your kernel is compiled with &quot;</span></span><br><span class="line">                          <span class="string">&quot;file capabilities support enabled.&quot;</span>,</span><br><span class="line">                          i, strerror(errno));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ALOGE(<span class="string">&quot;PR_CAPBSET_DROP %d failed: %s.&quot;</span>, i, strerror(errno));</span><br><span class="line">                    dvmAbort();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_ANDROID_OS */</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mountMode != MOUNT_EXTERNAL_NONE) &#123;</span><br><span class="line">            err = mountEmulatedStorage(uid, mountMode);</span><br><span class="line">            <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;cannot mountExternalStorage(): %s&quot;</span>, strerror(errno));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (errno == ENOTCONN || errno == EROFS) &#123;</span><br><span class="line">                    <span class="comment">// When device is actively encrypting, we get ENOTCONN here</span></span><br><span class="line">                    <span class="comment">// since FUSE was mounted before the framework restarted.</span></span><br><span class="line">                    <span class="comment">// When encrypted device is booting, we get EROFS since</span></span><br><span class="line">                    <span class="comment">// FUSE hasn&#x27;t been created yet by init.</span></span><br><span class="line">                    <span class="comment">// In either case, continue without external storage.</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    dvmAbort();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将list数组中所标明的组加入到目前进程的组设置中</span></span><br><span class="line">        err = setgroupsIntarray(gids);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;cannot setgroups(): %s&quot;</span>, strerror(errno));</span><br><span class="line">            dvmAbort();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置资源限制</span></span><br><span class="line">        err = setrlimitsFromArray(rlimits);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;cannot setrlimit(): %s&quot;</span>, strerror(errno));</span><br><span class="line">            dvmAbort();</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// 设置指定进程组id</span></span><br><span class="line">        err = setresgid(gid, gid, gid);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;cannot setresgid(%d): %s&quot;</span>, gid, strerror(errno));</span><br><span class="line">            dvmAbort();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置用户id</span></span><br><span class="line">        err = setresuid(uid, uid, uid);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;cannot setresuid(%d): %s&quot;</span>, uid, strerror(errno));</span><br><span class="line">            dvmAbort();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (needsNoRandomizeWorkaround()) &#123;</span><br><span class="line">            <span class="keyword">int</span> current = personality(<span class="number">0xffffFFFF</span>);</span><br><span class="line">            <span class="keyword">int</span> success = personality((ADDR_NO_RANDOMIZE | current));</span><br><span class="line">            <span class="keyword">if</span> (success == <span class="number">-1</span>) &#123;</span><br><span class="line">                ALOGW(<span class="string">&quot;Personality switch failed. current=%d error=%d\n&quot;</span>, current, errno);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置Linux功能标识</span></span><br><span class="line">        err = setCapabilities(permittedCapabilities, effectiveCapabilities);</span><br><span class="line">        <span class="keyword">if</span> (err != <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;cannot set capabilities (%llx,%llx): %s&quot;</span>,</span><br><span class="line">                permittedCapabilities, effectiveCapabilities, strerror(err));</span><br><span class="line">            dvmAbort();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        err = set_sched_policy(<span class="number">0</span>, SP_DEFAULT);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;cannot set_sched_policy(0, SP_DEFAULT): %s&quot;</span>, strerror(-err));</span><br><span class="line">            dvmAbort();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        err = setSELinuxContext(uid, isSystemServer, seInfo, niceName);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;cannot set SELinux context: %s\n&quot;</span>, strerror(errno));</span><br><span class="line">            dvmAbort();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// These free(3) calls are safe because we know we&#x27;re only ever forking</span></span><br><span class="line">        <span class="comment">// a single-threaded process, so we know no other thread held the heap</span></span><br><span class="line">        <span class="comment">// lock when we forked.</span></span><br><span class="line">        <span class="built_in">free</span>(seInfo);</span><br><span class="line">        <span class="built_in">free</span>(niceName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Our system thread ID has changed.  Get the new one.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Thread* thread = dvmThreadSelf();</span><br><span class="line">        thread-&gt;systemTid = dvmGetSysThreadId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* configure additional debug options */</span></span><br><span class="line">        enableDebugFeatures(debugFlags);</span><br><span class="line">        <span class="comment">// 将信号量机制设为默认</span></span><br><span class="line">        unsetSignalHandler();</span><br><span class="line">        <span class="comment">// 子进程不支持Zygote</span></span><br><span class="line">        gDvm.zygote = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// 检查虚拟机初始化是否成功</span></span><br><span class="line">        <span class="keyword">if</span> (!dvmInitAfterZygote()) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;error in post-zygote initialization&quot;</span>);</span><br><span class="line">            dvmAbort();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* the parent process */</span></span><br><span class="line">        <span class="built_in">free</span>(seInfo);</span><br><span class="line">        <span class="built_in">free</span>(niceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>forkAndSpcializeCommon()函数与Dalvik_dalvik_system_Zygote_fork()函数流程的不同之处：</p>
<ul>
<li>在forkAndSpecializeCommon()函数开始时，需要根据参数<code>isSystemServer</code>判断所需创建的子进程是否为system_server，并对其参数进行处理。</li>
<li>由于调用forkAndSpecializeCommon()函数产生的子进程都不是Zygote进程，因此，要调用unsetSignalHandler()函数重置信号机制。同时，子进程不能创建新进程，故设置为不支持Zygote：<code>gDvm.zygote = false</code>。</li>
<li>子进程中还要检查虚拟机是否初始化成功，因为需要执行相应任务，所以必须保证虚拟机成功初始化。</li>
</ul>
<h3 id="Dalvik虚拟机运行应用程序"><a href="#Dalvik虚拟机运行应用程序" class="headerlink" title="Dalvik虚拟机运行应用程序"></a>Dalvik虚拟机运行应用程序</h3><p>应用程序是以apk文件形式被虚拟机通过<code>类加载模块</code>引用加载并提取可执行代码的。apk文件解压后得到Dex文件，类加载模块对Dex文件进行解析，将所需的类的各个信息抓取出来，并将其封装到一个数据结构实例对象中，以供解释器直接引用这个结构体对象的相关的成员变量，实现程序的实际运行。<br>类加载模块的工作主要分为以下两个阶段：<br>(1) 取得Dex原始文件将其还原到内存中，并将Dex文件与一个<code>DexFile结构体</code>对象关联。<br>(2) 对Dex文件中的各个类依次进行加载生成类对象实例，并将对象指针交付给<code>解释器</code>引用执行。<br>在Dalvik上执行的程序由字节码组成，在字节码加载已经完毕后，Dalvik虚拟机解释器被调用开始取指解释执行。解释器有两种实现：C语言实现和汇编语言实现，分别称为<code>Portable解释器</code>和<code>Fast解释器</code>。<br>为了缓解解释器的低效，有两种解决方法：</p>
<ul>
<li>采用NDK，调用静态编译的方法提高效率。</li>
<li>使用JIT，在运行时编译字节码并优化。<br>JIT更具一般性和可移植性。JIT混合了两种技术，解释器解释时编译部分程序。</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2016/04/04/ELF-Executable-and-Linking-Format-part1/" rel="prev" title="ELF: Executable and Linking Format part1">
      <i class="fa fa-chevron-left"></i> ELF: Executable and Linking Format part1
    </a></div>
      <div class="post-nav-item">
    <a href="/2016/04/11/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3glibc-malloc/" rel="next" title="深入理解glibc malloc">
      深入理解glibc malloc <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#trace%E4%BD%BF%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">trace使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">Dalvik虚拟机执行流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%90%E8%A1%8C%E5%9C%A8ARM%E5%B9%B3%E5%8F%B0%E7%9A%84%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="nav-number">2.1.</span> <span class="nav-text">Dalvik虚拟机运行在ARM平台的入口点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zygote%E8%BF%9B%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">Zygote进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%90%E8%A1%8C%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">2.3.</span> <span class="nav-text">Dalvik虚拟机运行应用程序</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Bruce Fan"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Bruce Fan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">138</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bruce Fan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
