<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="反编译apk文件1$ apktool d crackme.apk outdir # 反编译apk文件夹 res&#x2F;values&#x2F;strings.xml存储源代码中定义的strings资源，apk文件打包时，strings.xml中的字符串被加密存储为resources.arsc文件中，apk成功反编译后该文件也会被解密出来。源程序R.java中的所有索引值保存在strings.xml同目录下的pub">
<meta property="og:type" content="article">
<meta property="og:title" content="Android逆向基础">
<meta property="og:url" content="http://example.com/2016/01/08/Android%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="BruceFan&#39;s Blog">
<meta property="og:description" content="反编译apk文件1$ apktool d crackme.apk outdir # 反编译apk文件夹 res&#x2F;values&#x2F;strings.xml存储源代码中定义的strings资源，apk文件打包时，strings.xml中的字符串被加密存储为resources.arsc文件中，apk成功反编译后该文件也会被解密出来。源程序R.java中的所有索引值保存在strings.xml同目录下的pub">
<meta property="og:locale">
<meta property="og:image" content="http://example.com/images/androidre/crackme.png">
<meta property="article:published_time" content="2016-01-08T06:02:52.000Z">
<meta property="article:modified_time" content="2022-08-09T15:59:49.784Z">
<meta property="article:author" content="Bruce Fan">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/androidre/crackme.png">

<link rel="canonical" href="http://example.com/2016/01/08/Android%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%80/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>Android逆向基础 | BruceFan's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BruceFan's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Stay hungry, stay foolish</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/01/08/Android%E9%80%86%E5%90%91%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android逆向基础
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-01-08 14:02:52" itemprop="dateCreated datePublished" datetime="2016-01-08T14:02:52+08:00">2016-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2022-08-09 23:59:49" itemprop="dateModified" datetime="2022-08-09T23:59:49+08:00">2022-08-09</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="反编译apk文件"><a href="#反编译apk文件" class="headerlink" title="反编译apk文件"></a>反编译apk文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apktool d crackme.apk outdir # 反编译apk文件夹</span><br></pre></td></tr></table></figure>
<p><code>res/values/strings.xml</code>存储源代码中定义的strings资源，apk文件打包时，strings.xml中的字符串被加密存储为<code>resources.arsc</code>文件中，apk成功反编译后该文件也会被解密出来。源程序R.java中的所有索引值保存在strings.xml同目录下的public.xml文件中。</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ grep -nr &quot;0x7f05000b&quot; .&#x2F;smali # 在smali文件夹中查找含有“0x7f05000b”内容的文件</span><br><span class="line">$ apktool b outdir # 编译修改后的文件，编译成功后会在outdir下生成dist目录需要使用signapk.jar工具对apk文件进行签名</span><br></pre></td></tr></table></figure>

<h2 id="Android-Dalvik虚拟机"><a href="#Android-Dalvik虚拟机" class="headerlink" title="Android Dalvik虚拟机"></a>Android Dalvik虚拟机</h2><h3 id="Java虚拟机运行的是Java字节码，Dalvik虚拟机运行的是Dalvik字节码"><a href="#Java虚拟机运行的是Java字节码，Dalvik虚拟机运行的是Dalvik字节码" class="headerlink" title="Java虚拟机运行的是Java字节码，Dalvik虚拟机运行的是Dalvik字节码"></a>Java虚拟机运行的是Java字节码，Dalvik虚拟机运行的是Dalvik字节码</h3><p>Dalvik虚拟机通过解释DEX来执行这些字节码</p>
<h3 id="Dalvik可执行文件体积更小"><a href="#Dalvik可执行文件体积更小" class="headerlink" title="Dalvik可执行文件体积更小"></a>Dalvik可执行文件体积更小</h3><p><code>dx</code>工具负责将Java字节码转换位Dalvik字节码</p>
<h3 id="Java虚拟机与Dalvik虚拟机架构不同"><a href="#Java虚拟机与Dalvik虚拟机架构不同" class="headerlink" title="Java虚拟机与Dalvik虚拟机架构不同"></a>Java虚拟机与Dalvik虚拟机架构不同</h3><p>Java虚拟机基于栈架构，Dalvik虚拟机基于寄存器架构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ javac -source 1.6 -target 1.6 Hello.java</span><br><span class="line">$ dx --dex --output&#x3D;Hello.dex Hello.class</span><br><span class="line">$ javap -c -classpath . Hello # 查看Java字节码</span><br><span class="line">$ dexdump -d Hello.dex # 查看Dalvik字节码</span><br></pre></td></tr></table></figure>

<blockquote>
<p>dx和dexdump在/sdk/build_tools/android目录下</p>
</blockquote>
<h3 id="DEX文件反汇编工具"><a href="#DEX文件反汇编工具" class="headerlink" title="DEX文件反汇编工具"></a>DEX文件反汇编工具</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java -jar baksmali.jar -o baksmaliout Hello.dex</span><br></pre></td></tr></table></figure>

<h3 id="定位关键代码"><a href="#定位关键代码" class="headerlink" title="定位关键代码"></a>定位关键代码</h3><blockquote>
<p>信息反馈法<br>特征函数法<br>顺序查看法<br>代码注入法<br>栈跟踪法<br>Method Profiling</p>
</blockquote>
<h3 id="smali语法"><a href="#smali语法" class="headerlink" title="smali语法"></a>smali语法</h3><p><code>.registers</code>指令指定函数用到的寄存器数目<br>一条<code>.parameter</code>指令指定函数一个参数<br><code>.prologue</code>指令指定函数代码起始处<br>函数中引入的参数命名从<code>p0</code>开始，依次递增<br>寄存器<code>p0</code>作为<code>this</code>引用，<code>v0</code>开始表示函数的局部变量寄存器<br><strong>1.类型</strong><br>Dalvik字节码只有两种类型，<strong>基本类型</strong>与<strong>引用类型</strong>。除了对象与数组属于引用对象外，其他的Java类型都是基本类型。<br>Dalvik字节码类型描述符</p>
<table>
<thead>
<tr>
<th align="center">语法</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">V</td>
<td align="center">void, 只用于返回值类型</td>
</tr>
<tr>
<td align="center">Z</td>
<td align="center">boolean</td>
</tr>
<tr>
<td align="center">B</td>
<td align="center">byte</td>
</tr>
<tr>
<td align="center">S</td>
<td align="center">short</td>
</tr>
<tr>
<td align="center">C</td>
<td align="center">char</td>
</tr>
<tr>
<td align="center">I</td>
<td align="center">int</td>
</tr>
<tr>
<td align="center">J</td>
<td align="center">long</td>
</tr>
<tr>
<td align="center">F</td>
<td align="center">float</td>
</tr>
<tr>
<td align="center">D</td>
<td align="center">double</td>
</tr>
<tr>
<td align="center">L</td>
<td align="center">Java类类型</td>
</tr>
<tr>
<td align="center">[</td>
<td align="center">数组类型</td>
</tr>
</tbody></table>
<p><strong>2.方法</strong><br>方法调用格式  </p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">Lpackage/name/ObjectName;</span>-&gt;MethodName(III)Z</span><br></pre></td></tr></table></figure>
<p><code>Lpackage/name/ObjectName;-</code>应该理解为一个类型，<code>MethodName</code>为具体的方法名，<code>(III)Z</code>是方法的签名部分，<code>III</code>为方法的参数（3个int型参数），<code>Z</code>是方法的返回类型（boolean类型）<br>例：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">method(I[[II<span class="class">Ljava/lang/String;</span>[<span class="class">Ljava/lang/Object;</span>)<span class="class">Ljava/lang/String;</span></span><br><span class="line">String method(int, int[][], int, String, Object[])</span><br></pre></td></tr></table></figure>
<p><strong>3.字段</strong><br>字段调用格式</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">Lpackage/name/ObjectName;</span>-&gt;FieldName:<span class="class">Ljava/lang/String;</span></span><br></pre></td></tr></table></figure>
<p>字段由类型$Lpackage/name/ObjectName;$、字段名$FieldName$与字段类型$Ljava/lang/String;$组成。字段名与字段类型用<code>:</code>隔开。</p>
<h3 id="smali文件格式"><a href="#smali文件格式" class="headerlink" title="smali文件格式"></a>smali文件格式</h3><p>smali文件头3行描述了当前类的信息</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.class</span>&lt;访问权限&gt;[修饰关键字]&lt;类名&gt;</span><br><span class="line"><span class="keyword">.super</span>&lt;父类名&gt;</span><br><span class="line"><span class="keyword">.source</span>&lt;源文件名&gt;</span><br></pre></td></tr></table></figure>
<p>例：MainActivity.smali</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lcom/example/crackme/MainActivity;</span></span><br><span class="line"><span class="keyword">.super</span> <span class="class">Landroid/app/Activity;</span></span><br><span class="line"><span class="keyword">.source</span> <span class="string">&quot;MainActivity.java&quot;</span></span><br></pre></td></tr></table></figure>
<p>一个类由多个字段和方法组成，字段的声明用<code>.field</code>指令，字段有静态字段和实例字段<br>静态字段声明格式</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># static fields</span></span><br><span class="line"><span class="keyword">.field</span> &lt;访问权限&gt;<span class="keyword"> static</span> [修饰关键字] &lt;字段名&gt;:&lt;字段类型&gt;</span><br></pre></td></tr></table></figure>
<p>实例字段声明格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># instance fields</span><br><span class="line">.field &lt;访问权限&gt; [修饰关键字] &lt;字段名&gt;:&lt;字段类型&gt;</span><br></pre></td></tr></table></figure>
<p>例：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># instance fields</span></span><br><span class="line"><span class="keyword">.field</span><span class="keyword"> private</span> button:<span class="class">Landorid/widget/Button;</span></span><br></pre></td></tr></table></figure>
<p>方法的声明使用<code>.method</code>指令，方法有直接方法和虚方法<br>直接方法声明格式</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># direct methods</span></span><br><span class="line"><span class="keyword">.method</span> &lt;访问权限&gt; [修饰关键字] &lt;方法原型&gt;</span><br><span class="line">&lt;.locals&gt;</span><br><span class="line">[.parameter]</span><br><span class="line">[.prologue]</span><br><span class="line">[.line]</span><br><span class="line">&lt;代码体&gt;</span><br><span class="line"><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure>
<p>虚方法的声明格式与直接方法相同，只是起始出的注释为<code>virtual methods</code><br>smali文件中使用<code>.implements</code>指令指出<code>接口</code>，格式声明：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># interfaces</span></span><br><span class="line"><span class="keyword">.implements</span> &lt;接口名&gt;</span><br></pre></td></tr></table></figure>
<p>smail文件中使用<code>.annotation</code>指令指出<code>注解</code>，格式声明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># annotations</span><br><span class="line">.annotation [注解属性] &lt;注解类名&gt;</span><br><span class="line">    [注解字段 ＝ 值]</span><br><span class="line">.end annotation</span><br></pre></td></tr></table></figure>

<h3 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h3><p>baksmali在反编译dex文件时会为每个类单独生成一个smali文件，内部类也有自己独立的smali文件，<code>[外部类]$[内部类].smali</code><br><code>this$0</code>是内部类自动保留的一个指向所在外部类的引用，左边的this表示为父类的引用，右边的数值0表示引用层数<br>例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Outer</span> </span>&#123; <span class="comment">//this$0</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstInner</span> </span>&#123; <span class="comment">//this$1</span></span><br><span class="line">        <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondInner</span> </span>&#123; <span class="comment">//this$2</span></span><br><span class="line">            <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThirdInner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ThirdInner类访问FirstInner类的引用为<code>this$1</code>。<br><code>this$X</code>型字段都被指定为synthetic属性，表示它们是被编译器合成的、虚构的，并不是人为声明的该字段。</p>
<h2 id="Smali-baksmali"><a href="#Smali-baksmali" class="headerlink" title="Smali/baksmali"></a>Smali/baksmali</h2><p>Apktool其实只是一个将各种工具结合起来的懒人工具而已。最好使用smali/baksmali而不是Apktool，原因如下：首先，Apktool更新并没有smali/baksmali频繁，smali/baksmali更新后要过非长久的时间才会合并到Apktool中，在这之前你可能需要忍受很多诡异的bug。其次，Apktool在反编译或者重打包dex的时候，如果发生错误，仅仅只会提供错误的exception信息而已，但如果你使用smali/baksmali，工具会告诉你具体的出错原因，会对重打包后的调试有巨大的帮助。最后，很多apk为了对付反调试会在资源文件中加入很多junk code从而使得Apktool的解析崩溃掉，造成反编译失败或者无法重打包。但如果你仅对classes.dex操作就不会有这些问题了。<br>smali/baksmali的基本操作如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 将smali-2.1.2.jar和baksmali-2.1.2.jar和解压的classes.dex放到同一目录</span><br><span class="line">$ java -jar baksmali-2.1.2.jar -o classout&#x2F; classes.dex # 反编译dex文件到smali文件</span><br><span class="line">$ java -jar smali-2.1.2.jar classout&#x2F; -o classes.dex # 将smali文件编译成dex文件</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>学习smali最好的方法就是自己先用java写好程序，再用baksmali转换成smali语句，然后对照学习。比如下面就是java代码和用baksmali反编译过后的smali文件的对照分析。<br>BFLog类主要是用Log.d()输出调试信息，Java代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BFLog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span><span class="params">(String tag, String msg)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log.d(tag, msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span><span class="params">(Object someObj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log(<span class="string">&quot;bruce&quot;</span>, someObj.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Log</span><span class="params">(Object[] someObj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Log(<span class="string">&quot;bruce&quot;</span>, Arrays.toString(someObj));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的smali代码如下：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lcom/bruce/BFLog;</span> <span class="comment"># class的名字</span></span><br><span class="line"><span class="keyword">.super</span> <span class="class">Ljava/lang/Object;</span> <span class="comment"># 这个类继承的对象</span></span><br><span class="line"><span class="keyword">.source</span> <span class="string">&quot;BFLog.java&quot;</span> <span class="comment"># java文件名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># direct methods</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> constructor</span> &lt;init&gt;()V <span class="comment"># class的构造函数</span></span><br><span class="line"><span class="keyword">    .registers</span> 1</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span> <span class="comment"># 函数代码起始处</span></span><br><span class="line"><span class="keyword">    .line</span> 9</span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;p0&#125;, <span class="class">Ljava/lang/Object;</span>-&gt;&lt;init&gt;()V <span class="comment"># 调用Object的构造方法，p0相当于this指针</span></span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> static</span> Log(<span class="class">Ljava/lang/Object;</span>)V <span class="comment"># Log(Object)的方法实现</span></span><br><span class="line"><span class="keyword">    .registers</span> 3</span><br><span class="line"><span class="keyword">    .param</span> p0, <span class="string">&quot;someObj&quot;</span>    <span class="comment"># Ljava/lang/Object; 参数信息</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 17</span><br><span class="line">   <span class="built_in"> const-string </span>v0, <span class="string">&quot;bruce&quot;</span> <span class="comment"># 给v0赋值&quot;bruce&quot;</span></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;p0&#125;, <span class="class">Ljava/lang/Object;</span>-&gt;toString()<span class="class">Ljava/lang/String;</span> <span class="comment"># 调用toString()函数</span></span><br><span class="line">   <span class="built_in"> move-result-object </span>v1 <span class="comment"># toString()的结果保存在v1</span></span><br><span class="line">   <span class="built_in"> invoke-static </span>&#123;v0, v1&#125;, <span class="class">Lcom/bruce/BFLog;</span>-&gt;Log(<span class="class">Ljava/lang/String;</span><span class="class">Ljava/lang/String;</span>)V <span class="comment"># 调用BFLog的一个Log函数，参数是v0和v1</span></span><br><span class="line"><span class="keyword">    .line</span> 18</span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> static</span> Log(<span class="class">Ljava/lang/String;</span><span class="class">Ljava/lang/String;</span>)V <span class="comment"># Log(String, String)的方法实现</span></span><br><span class="line"><span class="keyword">    .registers</span> 2</span><br><span class="line"><span class="keyword">    .param</span> p0, <span class="string">&quot;tag&quot;</span>    <span class="comment"># Ljava/lang/String;</span></span><br><span class="line"><span class="keyword">    .param</span> p1, <span class="string">&quot;msg&quot;</span>    <span class="comment"># Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 12</span><br><span class="line">   <span class="built_in"> invoke-static </span>&#123;p0, p1&#125;, <span class="class">Landroid/util/Log;</span>-&gt;d(<span class="class">Ljava/lang/String;</span><span class="class">Ljava/lang/String;</span>)I <span class="comment"># 调用android API里的Log函数实现Log功能</span></span><br><span class="line"><span class="keyword">    .line</span> 13</span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> static</span> Log([<span class="class">Ljava/lang/Object;</span>)V <span class="comment"># Log(Object[])函数实现 ‘[’符号是数组的意思</span></span><br><span class="line"><span class="keyword">    .registers</span> 3</span><br><span class="line"><span class="keyword">    .param</span> p0, <span class="string">&quot;someObj&quot;</span>    <span class="comment"># [Ljava/lang/Object;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 22</span><br><span class="line">   <span class="built_in"> const-string </span>v0, <span class="string">&quot;bruce&quot;</span></span><br><span class="line">   <span class="built_in"> invoke-static </span>&#123;p0&#125;, <span class="class">Ljava/util/Arrays;</span>-&gt;toString([<span class="class">Ljava/lang/Object;</span>)<span class="class">Ljava/lang/String;</span> <span class="comment"># 将Object数组转换为String</span></span><br><span class="line">   <span class="built_in"> move-result-object </span>v1</span><br><span class="line">   <span class="built_in"> invoke-static </span>&#123;v0, v1&#125;, <span class="class">Lcom/bruce/BFLog;</span>-&gt;Log(<span class="class">Ljava/lang/String;</span><span class="class">Ljava/lang/String;</span>)V <span class="comment"># 调用Log(String, String)函数</span></span><br><span class="line"><span class="keyword">    .line</span> 23</span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure>

<h3 id="Smali插桩"><a href="#Smali插桩" class="headerlink" title="Smali插桩"></a>Smali插桩</h3><p>如果仅仅用Smali来分析代码，效果其实不如用dex2jar和jd-gui更直观，毕竟看反编译的java代码要更容易一些。但Smali强大之处就是可以随心所欲的进行插桩操作。何为插桩，在保证被测程序原有逻辑完整性的基础上在程序中插入一些探针（又称为“探测仪”），通过探针的执行并抛出程序运行的特征数据，通过对这些数据的分析，可以获得程序的控制流和数据流信息，进而得到逻辑覆盖等动态信息，从而实现测试目的的方法。下面我就来结合一个例子来讲解一下何如进行smali插桩。<br>测试程序是一个简单的crackme。输入密码，然后点击check，如果密码正确会输出yes，否则输出no。<br><img src="/images/androidre/crackme.png"><br>首先我们对crackme1这个apk进行解压，然后反编译。我们会在MainActivity中看到一个getkey(String,int)函数。这个函数貌似非常复杂，我们暂时不管。我们首先分析一下点下button后的逻辑。我们发现程序会通过getkey(“mrkxqcroxqtskx”,42)来计算出真正的密码，然后与我们输人的密码进行比较，java代码如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    String str = editText0.getText().toString();</span><br><span class="line">    <span class="keyword">if</span> (str.equals(getkey(<span class="string">&quot;mrkxqcroxqtskx&quot;</span>, <span class="number">42</span>))) &#123;</span><br><span class="line">        Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;Yes!&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;No!&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时候就是smali插桩大显身手的时候了，我们可以通过插桩直接获取getkey(“mrkxqcroxqtskx”, 42)这个函数的返回值，然后Log出来。这样我们就不需要研究getkey这个函数的实现了。具体过程如下：<br>1.首先解压apk然后用baksmali进行反编译。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ unzip -d outdir crackme1.apk</span><br><span class="line">$ cd outdir</span><br><span class="line">$ java -jar baksmali-2.1.2.jar -o classout classes.dex</span><br></pre></td></tr></table></figure>
<p>2.将上一节BFLog类的BFLog.smali文件拷贝到com/bruce目录下，这个文件有3个LOG函数，分别可以输出String的值，Object的值和Object数组的值。注意，如果原程序中没有com/bruce这个目录，你需要自己用mkdir创建一下。拷贝完后，目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">com</span><br><span class="line">└─bruce</span><br><span class="line">    │  BFLog.smali</span><br><span class="line">    │</span><br><span class="line">    └─crackme1</span><br><span class="line">            BuildConfig.smali</span><br><span class="line">            MainActivity$1.smali</span><br><span class="line">            MainActivity.smali</span><br><span class="line">            R$attr.smali</span><br><span class="line">            R$dimen.smali</span><br><span class="line">            R$drawable.smali</span><br><span class="line">            R$id.smali</span><br><span class="line">            R$layout.smali</span><br><span class="line">            R$menu.smali</span><br><span class="line">            R$string.smali</span><br><span class="line">            R$style.smali</span><br><span class="line">            R.smali</span><br></pre></td></tr></table></figure>
<p>3.用文本编辑器打开MainActivity$1.smali文件进行插桩。为什么是MainActivity$1.smali而不是MainActivity.smali呢？因为主要的判断逻辑是在OnClickListener这个类里，而这个类是MainActivity的一个内部类，同时我们在实现的时候也没有给这个类声明具体的名字，所以这个类用$1表示。加入BFLog.smali这个文件后，我们只需要在MainActivity$1.smali的第71行后面加上一行代码，invoke-static {v1}, Lcom/bruce/BFLog;-&gt;Log(Ljava/lang/Object;)V，就可以输出getkey的值了。Invoke是方法调用的指令，因为我们要调用的类是静态方法，所以使用invoke-static。如果是非静态方法的话，第一个参数应该是该方法的实例，然后依次是各个参数。具体插入情况如下：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const-string v1, <span class="string">&quot;mrkxqcroxqtskx&quot;</span></span><br><span class="line"></span><br><span class="line">const/16 v2, 0x2a</span><br><span class="line"></span><br><span class="line"><span class="comment"># invokes: Lcom/mzheng/crackme1/MainActivity;-&gt;getkey(Ljava/lang/String;I)Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line">invoke-static &#123;v1, v2&#125;, <span class="class">Lcom/mzheng/crackme1/MainActivity;</span>-&gt;access$0(<span class="class">Ljava/lang/String;</span>I)<span class="class">Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line">move-result-object v1</span><br><span class="line"></span><br><span class="line"><span class="comment">############################## begin ##############################</span></span><br><span class="line">invoke-static &#123;v1&#125;, <span class="class">Lcom/bruce/BFLog;</span>-&gt;Log(<span class="class">Ljava/lang/Object;</span>)V</span><br><span class="line"><span class="comment">############################## end ###############################</span></span><br><span class="line">invoke-virtual &#123;v0, v1&#125;, <span class="class">Ljava/lang/String;</span>-&gt;equals(<span class="class">Ljava/lang/Object;</span>)Z</span><br><span class="line"></span><br><span class="line">move-result v1</span><br></pre></td></tr></table></figure>
<p>4.用smali.jar重新编译修改后的smali文件，把新编译的classes.dex覆盖老的classes.dex，然后再用signapk.jar对apk进行签名。几条关键指令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ java -jar smali.jar classout -o classes.dex</span><br><span class="line">$ zip unsigned.apk AndroidManifest.xml classes.dex resources.arsc -r res</span><br><span class="line">  adding: AndroidManifest.xml (deflated 62%)</span><br><span class="line">  adding: classes.dex (deflated 53%)</span><br><span class="line">  adding: resources.arsc (deflated 73%)</span><br><span class="line">  adding: res&#x2F; (stored 0%)</span><br><span class="line">  ...</span><br><span class="line">$ java -jar signapk.jar testkey.x509.pem testkey.pk8 unsigned.apk signed.apk</span><br></pre></td></tr></table></figure>
<p>5.安装程序到android，随便输入点啥，然后点击check按钮，随后在logcat中就可以看到getkey(“mrkxqcroxqtskx”, 42)这个函数的返回值了。</p>
<h3 id="Smali修改"><a href="#Smali修改" class="headerlink" title="Smali修改"></a>Smali修改</h3><p>通过Smali/baksmali工具，我们不光可以插桩，还可以修改apk的逻辑。几个需要注意点如下：<br>1.if条件判断以及跳转语句<br>在smali中最常见的就是if这个条件判断跳转语句了，这个判断一共有12条指令：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if-eq vA, VB, cond_** 如果vA等于vB则跳转到cond_**。相当于if (vA&#x3D;&#x3D;vB)</span><br><span class="line">if-ne vA, VB, cond_** 如果vA不等于vB则跳转到cond_**。相当于if (vA!&#x3D;vB)</span><br><span class="line">if-lt vA, VB, cond_** 如果vA小于vB则跳转到cond_**。相当于if (vA&lt;vB)</span><br><span class="line">if-le vA, VB, cond_** 如果vA小于等于vB则跳转到cond_**。相当于if (vA&lt;&#x3D;vB)</span><br><span class="line">if-gt vA, VB, cond_** 如果vA大于vB则跳转到cond_**。相当于if (vA&gt;vB)</span><br><span class="line">if-ge vA, VB, cond_** 如果vA大于等于vB则跳转到cond_**。相当于if (vA&gt;&#x3D;vB)</span><br><span class="line"></span><br><span class="line">if-eqz vA, :cond_** 如果vA等于0则跳转到:cond_** 相当于if (VA&#x3D;&#x3D;0)</span><br><span class="line">if-nez vA, :cond_** 如果vA不等于0则跳转到:cond_**相当于if (VA!&#x3D;0)</span><br><span class="line">if-ltz vA, :cond_** 如果vA小于0则跳转到:cond_**相当于if (VA&lt;0)</span><br><span class="line">if-lez vA, :cond_** 如果vA小于等于0则跳转到:cond_**相当于if (VA&lt;&#x3D;0)</span><br><span class="line">if-gtz vA, :cond_** 如果vA大于0则跳转到:cond_**相当于if (VA&gt;0)</span><br><span class="line">if-gez vA, :cond_** 如果vA大于等于0则跳转到:cond_**相当于if (VA&gt;&#x3D;0)</span><br></pre></td></tr></table></figure>
<p>比如我们在crackme1里判断密码是否正确的smali代码段：  </p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">invoke-virtual &#123;v0, v1&#125;, <span class="class">Ljava/lang/String;</span>-&gt;equals(<span class="class">Ljava/lang/Object;</span>)Z</span><br><span class="line"></span><br><span class="line">move-result v1</span><br><span class="line"></span><br><span class="line">if-eqz v1,<span class="keyword"> :cond_25</span>  <span class="comment"># if (v1==0)</span></span><br><span class="line"></span><br><span class="line">iget-object v1, p0, <span class="class">Lcom/mzheng/crackme1/MainActivity$1;</span>-&gt;this$0:<span class="class">Lcom/mzheng/crackme1/MainActivity;</span></span><br><span class="line"></span><br><span class="line">const-string v2, <span class="string">&quot;Yes!&quot;</span></span><br><span class="line"></span><br><span class="line">invoke-static &#123;v1, v2, v3&#125;, <span class="class">Landroid/widget/Toast;</span>-&gt;makeText(<span class="class">Landroid/content/Context;</span><span class="class">Ljava/lang/CharSequence;</span>I)<span class="class">Landroid/widget/Toast;</span></span><br><span class="line"></span><br><span class="line">move-result-object v1</span><br><span class="line"></span><br><span class="line">invoke-virtual &#123;v1&#125;, <span class="class">Landroid/widget/Toast;</span>-&gt;show()V</span><br><span class="line"></span><br><span class="line">:cond_25</span><br><span class="line">iget-object v1, p0, <span class="class">Lcom/mzheng/crackme1/MainActivity$1;</span>-&gt;this$0:<span class="class">Lcom/mzheng/crackme1/MainActivity;</span></span><br><span class="line"></span><br><span class="line">const-string v2, <span class="string">&quot;No!&quot;</span></span><br><span class="line"></span><br><span class="line">invoke-static &#123;v1, v2, v3&#125;, <span class="class">Landroid/widget/Toast;</span>-&gt;makeText(<span class="class">Landroid/content/Context;</span><span class="class">Ljava/lang/CharSequence;</span>I)<span class="class">Landroid/widget/Toast;</span></span><br><span class="line"></span><br><span class="line">move-result-object v1</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;v1&#125;, <span class="class">Landroid/widget/Toast;</span>-&gt;show()V</span><br></pre></td></tr></table></figure>
<p>如果我们不关心密码内容，只是希望程序输出”yes”的话。我们可以把<code>if-eqz v1, :cond_25</code>改成<code>if-nez v1, :cond_25</code>。这样逻辑就变为：当输错密码的时候，程序反而会输出”yes”。<br>2.寄存器问题<br>修改Smali时有一件很重要的事情就是要注意寄存器。如果乱用寄存器的话可能会导致程序崩溃。每个方法开头声明了registers的数量，这个数量是参数和本地变量总和。参数统一用P表示。如果是非静态方法p0代表this，p1-pN代表各个参数。如果是静态方法的话，p0-pN代表各个参数。本地变量统一用v表示。如果想要增加的新的本地变量，需要在方法开头的registers数量上增加相应的数值。<br>比如下面这个方法：  </p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> constructor</span> &lt;init&gt;()V</span><br><span class="line"><span class="keyword">    .registers</span> 1</span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 7</span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;p0&#125;, <span class="class">Ljava/lang/Object;</span>-&gt;&lt;init&gt;()V</span><br><span class="line">    return-void</span><br><span class="line"><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure>
<p>因为这不是静态方法，所以p0代表this。如果想要增加一个新的本地变量，比如v0。就需要把.registers 1改为.registers 2。<br>3.给原程序增加大量逻辑的办法<br>非常不建议在程序原有的方法上增加大量逻辑，这样可能会出现很多寄存器方面的错误导致编译失败。比较好的方法是：把想要增加的逻辑先用java写成一个apk，然后把这个apk反编译成smali文件，随后把反编译后的这部分逻辑的smali文件插入到目标程序的smali文件夹中，然后再在原来的方法上采用invoke的方式调用新加入的逻辑。这样的话不管加入再多的逻辑，也只是修改了原程序的几行代码而已。这个思路也是很多重打包病毒惯用的伎俩，确实非常方便好用。</p>
<h2 id="APK签名Tricks"><a href="#APK签名Tricks" class="headerlink" title="APK签名Tricks"></a>APK签名Tricks</h2><p>当我们在实战中，有时会碰到某些apk在内部实现了自己的签名检查。这次我们介绍的Smali Instrumentation方法因为需要重打包，所以会改变原有的签名。当然，你可以通过修改apk把签名检查的逻辑删掉，但这又费时又费力。在这里简单介绍两种非常方便的方法来解决签名检查问题。<br>1.Masterkey<br>Masterkey漏洞一共有三个，可以影响android 4.4以下版本。利用这个漏洞，我们可以插入新的classes.dex替换掉原有的classes.dex而不需要对apk本身进行重新签名。如果apk本身有签名校验逻辑的话，利用这个漏洞来进行Smali Instrumentation简直再好不过了。首先，你需要一个android 4.4以下版本的虚拟机或者真机，然后再使用一个masterkey利用工具对apk进行exploit即可。工具下载地址在文章最后，使用的命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java -jar AndroidMasterKeys.jar -a orig.apk -z moddedClassesDex.zip -o out.apk</span><br></pre></td></tr></table></figure>
<p>orig.apk是原本的apk文件，moddedClassesDex.zip是修改后的classes.dex并压缩成zip文件，out.apk就是利用Masterkey漏洞生成的新的apk文件。如果成功的话用zip打开文件会看到两个classes.dex。通过masterkey打包后的apk文件签名并不会有任何变化，这样也就不用担心签名校验问题了。<br>2.自定义ROM<br>签名的判断其实是调用了android系统密码库的函数，如果我们可以自己定制ROM的话，只需要修改AOSP源码路径下的libcore\luni\src\main\java\java\security\MessageDigest.java文件。将isEqual函数中的判断语句注释掉：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isEqual</span><span class="params">(<span class="keyword">byte</span>[] digesta, <span class="keyword">byte</span>[] digestb)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (digesta.length != digestb.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        for (int i = 0; i &lt; digesta.length; i++) &#123;</span></span><br><span class="line"><span class="comment">//            if (digesta[i] != digestb[i]) &#123;</span></span><br><span class="line"><span class="comment">//                return false;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的话，如果在你自定义的ROM上运行apk，无论你怎么修改classes.dex文件，都不需要关心签名问题了，系统会永远返回签名正确的。<br><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1skSM1y9">下载</a><br><strong>reference</strong><br>安卓动态调试七种武器之长生剑 - Smali Instrumentation</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2016/01/13/C-%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98%E4%B8%8E%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/" rel="next" title="C++动态内存与智能指针">
      C++动态内存与智能指针 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91apk%E6%96%87%E4%BB%B6"><span class="nav-number">1.</span> <span class="nav-text">反编译apk文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">2.</span> <span class="nav-text">Android Dalvik虚拟机</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%90%E8%A1%8C%E7%9A%84%E6%98%AFJava%E5%AD%97%E8%8A%82%E7%A0%81%EF%BC%8CDalvik%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%90%E8%A1%8C%E7%9A%84%E6%98%AFDalvik%E5%AD%97%E8%8A%82%E7%A0%81"><span class="nav-number">2.1.</span> <span class="nav-text">Java虚拟机运行的是Java字节码，Dalvik虚拟机运行的是Dalvik字节码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dalvik%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E4%BD%93%E7%A7%AF%E6%9B%B4%E5%B0%8F"><span class="nav-number">2.2.</span> <span class="nav-text">Dalvik可执行文件体积更小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8EDalvik%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%9E%B6%E6%9E%84%E4%B8%8D%E5%90%8C"><span class="nav-number">2.3.</span> <span class="nav-text">Java虚拟机与Dalvik虚拟机架构不同</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DEX%E6%96%87%E4%BB%B6%E5%8F%8D%E6%B1%87%E7%BC%96%E5%B7%A5%E5%85%B7"><span class="nav-number">2.4.</span> <span class="nav-text">DEX文件反汇编工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%BD%8D%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81"><span class="nav-number">2.5.</span> <span class="nav-text">定位关键代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#smali%E8%AF%AD%E6%B3%95"><span class="nav-number">2.6.</span> <span class="nav-text">smali语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#smali%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="nav-number">2.7.</span> <span class="nav-text">smali文件格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E7%B1%BB"><span class="nav-number">2.8.</span> <span class="nav-text">内部类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Smali-baksmali"><span class="nav-number">3.</span> <span class="nav-text">Smali&#x2F;baksmali</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Smali%E6%8F%92%E6%A1%A9"><span class="nav-number">3.1.</span> <span class="nav-text">Smali插桩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Smali%E4%BF%AE%E6%94%B9"><span class="nav-number">3.2.</span> <span class="nav-text">Smali修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#APK%E7%AD%BE%E5%90%8DTricks"><span class="nav-number">4.</span> <span class="nav-text">APK签名Tricks</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Bruce Fan"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Bruce Fan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">137</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bruce Fan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
