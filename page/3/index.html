<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="BruceFan&#39;s Blog">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="BruceFan&#39;s Blog">
<meta property="og:locale">
<meta property="article:author" content="Bruce Fan">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>BruceFan's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BruceFan's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Stay hungry, stay foolish</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/31/Syzkaller%E5%8E%9F%E7%90%86%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/31/Syzkaller%E5%8E%9F%E7%90%86%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Syzkaller原理和源码分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2019-05-31 11:46:15" itemprop="dateCreated datePublished" datetime="2019-05-31T11:46:15+08:00">2019-05-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>syzkaller运行流程结构如下图所示，红色标签表示需要配置的选项：<br><img src="/images/syzkaller/syz-arch.png"><br><code>syz-manager</code>用来启动、监控、和重启多个虚拟机实例，并在虚拟机里启动一个<code>syz-fuzzer</code>进程。它负责持久化corpus和存储crash。<br><code>syz-fuzzer</code>在要测试的内核虚拟机上运行，syz-fuzzer指导fuzz进程（产生输入、变异、精简等）并通过RPC方式发送触发新路径的输入返回给<code>syz-manager</code>进程。它也会启动一个暂态<code>syz-executor</code>进程。<br>每个<code>syz-executor</code>进程执行一个输入（一套syscalls）。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mmap(&amp;(0x7f000000000),(0x1000), 0x3, 0x32, -1, 0)</span><br><span class="line">r0 &#x3D; open(&amp;(0x7f0000000000))&#x3D;&quot;.&#x2F;file0&quot;, 0x3, 0x9)</span><br><span class="line">read(r0, &amp;(0x7f0000000000), 42)</span><br><span class="line">close(r0)</span><br></pre></td></tr></table></figure>
<p>从<code>syz-fuzzer</code>进程接收输入来执行，并将结果返回。它被设计的尽可能简单（为了不干扰fuzz进程），用C++实现，编译为静态二进制，用共享内存通信。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>先从启动syzkaller的命令行工具syz-manager的源码开始分析，syz-manager的源码位于syz-manager/manager.go文件，首先是一个Manager结构体，里面包含了fuzz过程中的重要信息，如配置信息、虚拟机信息、测试目标信息等，具体内容后面会分析到。<br>接下来是syz-manager运行的main函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> sys.GitRevision == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;Bad syz-manager build. Build with make, run bin/syz-manager.&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	flag.Parse() <span class="comment">// 对命令行参数进行解析</span></span><br><span class="line">	log.EnableLogCaching(<span class="number">1000</span>, <span class="number">1</span>&lt;&lt;<span class="number">20</span>)</span><br><span class="line">	cfg, err := mgrconfig.LoadFile(*flagConfig) <span class="comment">// flagConfig是命令行解析出来的配置文件，通过mgrconfig的LoadFile读取到cfg中</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	target, err := prog.GetTarget(cfg.TargetOS, cfg.TargetArch) <span class="comment">// 根据配置文件里的系统和架构获取目标信息，包括系统调用等，保存在Target结构体中</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	sysTarget := targets.Get(cfg.TargetOS, cfg.TargetArch)</span><br><span class="line">	<span class="keyword">if</span> sysTarget == <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;unsupported OS/arch: %v/%v&quot;</span>, cfg.TargetOS, cfg.TargetArch)</span><br><span class="line">	&#125;</span><br><span class="line">	syscalls, err := mgrconfig.ParseEnabledSyscalls(target, cfg.EnabledSyscalls, cfg.DisabledSyscalls) <span class="comment">// 可以去掉一些不感兴趣的syscall</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	RunManager(cfg, target, sysTarget, syscalls)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pkg/mgrconfig里的config.go里定义了Config结构体，用来保存配置文件里的信息，load.go文件里定义了读取配置文件的方法。<br>prog/target.go中定义了Target结构体，GetTarget方法中用到了targets变量，targets变量在RegisterTarget方法中初始化，在RegisterTarget中添加debug.PrintStack()，发现RegisterTarget位于栈底，不知道是哪里调用了它。其实是在manager.go文件开头，import了sys包，在sys/sys.go文件中，import ( _ “**/sys/linux/gen)导入包前的下划线表示这个包里所有文件的init方法都会被执行，sys/linux/gen/里有386.go、amd64.go、arm64.go等，这些文件里都有init方法，init里调用了RegisterTarget方法，初始化了各个目标平台的target信息。GetTarget最后用sync.Once的Do方法确保target的初始化在整个程序（多线程环境）中只执行一次，内部通过互斥锁实现。<br>sysTarget的用处还没有细看。<br>接下来是RunManager方法，RunManager实现了启动虚拟机、http服务、rpc服务和log fuzz进程等操作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunManager</span><span class="params">(cfg *mgrconfig.Config, target *prog.Target, sysTarget *targets.Target, syscalls []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> vmPool *vm.Pool </span><br><span class="line">	<span class="keyword">if</span> cfg.Type != <span class="string">&quot;none&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> err error</span><br><span class="line">		vmPool, err = vm.Create(cfg, *flagDebug) <span class="comment">// 首先根据cfg中的虚拟机类型（Type如qemu）对vmPool进行初始化</span></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在vm/vm.go文件中，还是用import (_ “**/vm/qemu”)的方法，调用了所有导入文件里的init方法，qemu的init方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	vmimpl.Register(<span class="string">&quot;qemu&quot;</span>, ctor, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了vm/vmimpl/vmimpl.go的Register方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Register</span><span class="params">(typ <span class="keyword">string</span>, ctor ctorFunc, allowsOvercommit <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	Types[typ] = Type&#123;</span><br><span class="line">		Ctor:       ctor,</span><br><span class="line">		Overcommit: allowsOvercommit,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看vm/vm.go的Create方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Create</span><span class="params">(cfg *mgrconfig.Config, debug <span class="keyword">bool</span>)</span> <span class="params">(*Pool, error)</span></span> &#123;</span><br><span class="line">	typ, ok := vmimpl.Types[cfg.Type] <span class="comment">// 取出vmimpl中cfg.Type对应的虚拟机类型，如qemu</span></span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unknown instance type &#x27;%v&#x27;&quot;</span>, cfg.Type)</span><br><span class="line">	&#125;</span><br><span class="line">	env := &amp;vmimpl.Env&#123;</span><br><span class="line">		Name:    cfg.Name,</span><br><span class="line">		OS:      cfg.TargetOS,</span><br><span class="line">		Arch:    cfg.TargetVMArch,</span><br><span class="line">		Workdir: cfg.Workdir,</span><br><span class="line">		Image:   cfg.Image,</span><br><span class="line">		SSHKey:  cfg.SSHKey,</span><br><span class="line">		SSHUser: cfg.SSHUser,</span><br><span class="line">		Debug:   debug,</span><br><span class="line">		Config:  cfg.VM,</span><br><span class="line">	&#125;</span><br><span class="line">	impl, err := typ.Ctor(env) <span class="comment">// 用取出的Type类型构建vmimpl.Pool，vmimpl.Pool是interface，在这里typ.Ctor返回的是实现了这个接口的具体的Pool，如qemu的Pool</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;Pool&#123; <span class="comment">// 将Pool返回给RunManager的vmPool变量</span></span><br><span class="line">		impl:    impl, <span class="comment">// 这里的impl已经是qemu的Pool了</span></span><br><span class="line">		workdir: env.Workdir,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再回到RunManager，进行mgr := &amp;Manager创建mgr管理信息，initHTTP()创建HTTP服务器，startRPCServer(mgr)为fuzzer创建RPC服务器。接下来的go func() { for log }，并发执行一个匿名函数，不停log fuzz进度。go加上方法表示并发执行这个方法。最后RunManager执行一个mgr.vmLoop()方法，vmLoop()方法会调用一个runInstance方法，runInstance调用mgr.vmPool.Create(index)，这里是vm/vm.go的Create()，这个Create()会调用vmPool的impl的Create(workdir, index)方法，这里也就是qemu的Create(workdir, index)方法，qemu的Create方法会创建sshkey，并调用ctor方法，ctor方法会调用boot方法，boot方法会执行启动qemu的命令。vm.go的Create方法会返回启动虚拟机的实例，接下来runInstance方法会通过ssh拷贝fuzzerBin和executorBin到虚拟机实例，然后执行fuzzer二进制文件，并监控虚拟机的执行过程。</p>
<p><strong>reference</strong><br><a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/internals.md">How syzkaller works</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/31/Ubuntu%E4%B8%8BSSH%E7%99%BB%E5%BD%95Qemu%E8%99%9A%E6%8B%9F%E6%9C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/31/Ubuntu%E4%B8%8BSSH%E7%99%BB%E5%BD%95Qemu%E8%99%9A%E6%8B%9F%E6%9C%BA/" class="post-title-link" itemprop="url">Ubuntu下SSH登录Qemu虚拟机</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2019-05-31 11:40:21" itemprop="dateCreated datePublished" datetime="2019-05-31T11:40:21+08:00">2019-05-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>宿主机要通过ssh访问虚拟机有两种网络配置方式，一种是用户模式网络，另一种是网桥网络模式。</p>
<h2 id="qemu内部的用户模式网络"><a href="#qemu内部的用户模式网络" class="headerlink" title="qemu内部的用户模式网络"></a>qemu内部的用户模式网络</h2><p>在没有任何<code>-net</code>参数时，qemu默认使用的是<code>-net nic -net user</code>参数，提供了一种用户模式（user-mode）的网络模拟。使用用户模式网络的虚拟机可以连通宿主机及外部网络，用户模式网络是完全由qemu自身实现，不依赖于其他工具，而且不需要root权限。qemu使用Slirp实现了一整套TCP/IP协议栈，并且使用这个协议栈实现了一套虚拟的NAT网络。<br>优点：  </p>
<ul>
<li>使用简单  </li>
<li>独立性好  </li>
<li>虚拟机网络隔离性好  </li>
</ul>
<p>缺点：  </p>
<ul>
<li>由于其在qemu内部实现所有网络协议栈，因此其性能较差  </li>
<li>不支持部分网络功能（如ICMP），所以不能在虚拟机中使用ping命令  </li>
<li>不能从宿主机或外部网络直接访问客户机  </li>
</ul>
<p>命令举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 \</span><br><span class="line">	-kernel $KERNEL&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;bzImage \</span><br><span class="line">	-append &quot;console&#x3D;ttyS0 root&#x3D;&#x2F;dev&#x2F;sda debug earlyprintk&#x3D;serial slub_debug&#x3D;QUZ&quot; \</span><br><span class="line">	-hda $IMAGE&#x2F;stretch.img \</span><br><span class="line">	-net user,hostfwd&#x3D;tcp::10021-:22 \</span><br><span class="line">	-net nic,model&#x3D;e1000 \</span><br><span class="line">	-enable-kvm \</span><br><span class="line">	-nographic \</span><br><span class="line">	-m 1G \</span><br><span class="line">	-smp 2 \</span><br><span class="line">	-pidfile vm.pid \</span><br><span class="line">	2&gt;&amp;1 | tee vm.log</span><br></pre></td></tr></table></figure>
<p><code>-net user</code>表示使用的是用户模式，<code>hostfwd=tcp::10021-:22</code>表示将虚拟机22端口转发到宿主机的10021端口。<br><code>-net nic</code>表示为虚拟机创建虚拟机网卡，<code>model=e1000</code>表示为虚拟机添加一块e1000型的网卡，这也是qemu的默认类型。<br>查看qemu支持的NIC类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 -net nic,model&#x3D;?</span><br><span class="line">warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]</span><br><span class="line">qemu: Supported NIC models: ne2k_pci,i82551,i82557b,i82559er,rtl8139,e1000,pcnet,virtio</span><br></pre></td></tr></table></figure>
<p>这样配置好目录和参数以后启动qemu，有可能会遇到如下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[FAILED] Failed to start Raise network interfaces.</span><br></pre></td></tr></table></figure>
<p>这是虚拟机网络配置有问题，使用ip命令查看虚拟机使用的网卡，在虚拟机里执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># ip a s</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link&#x2F;loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1&#x2F;8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1&#x2F;128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: enp0s3: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link&#x2F;ether 52:54:00:12:34:56 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link&#x2F;sit 0.0.0.0 brd 0.0.0.0</span><br></pre></td></tr></table></figure>
<p>可以看到有一个<code>enp0s3</code>网卡，查看网络配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;network&#x2F;interfaces</span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet dhcp</span><br></pre></td></tr></table></figure>
<p>网络配置文件中的网卡和实际的网卡不一样，修改<code>eth0</code>为<code>enp0s3</code>，重启网络：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;etc&#x2F;init.d&#x2F;networking restart</span><br><span class="line">Restarting networking (via systemctl): networking.service[  287.214196] e1000: enp0s3 NIC Link is Up 1000 Mbps Full Duplex, Flow Control: RX</span><br><span class="line">[  287.227353] IPv6: ADDRCONF(NETDEV_CHANGE): enp0s3: link becomes ready</span><br><span class="line">[  287.446498] audit: type&#x3D;1107 audit(1559202014.248:8): pid&#x3D;1 uid&#x3D;0 auid&#x3D;4294967295 ses&#x3D;4294967295 subj&#x3D;system_u:system_r:kernel_t:s0 msg&#x3D;&#39;avc:  denied  &#123; reload &#125; for auid&#x3D;n&#x2F;a uid&#x3D;0 gid&#x3D;0 path&#x3D;&quot;&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;ssh.service&quot; cmdline&#x3D;&quot;systemctl reload --no-block ssh.service&quot; scontext&#x3D;system_u:system_r:kernel_t:s0 tcontext&#x3D;system_u:object_r:unlabeled_t:s0 tclass&#x3D;service</span><br><span class="line">[  287.446498]  exe&#x3D;&quot;&#x2F;lib&#x2F;systemd&#x2F;systemd&quot; sauid&#x3D;0 hostname&#x3D;? addr&#x3D;? terminal&#x3D;?&#39;</span><br><span class="line">.</span><br></pre></td></tr></table></figure>
<p>启动网卡成功，可以在宿主机ssh连接虚拟机了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -i identity_file -p 10021 root@localhost</span><br></pre></td></tr></table></figure>

<h2 id="使用网桥模式"><a href="#使用网桥模式" class="headerlink" title="使用网桥模式"></a>使用网桥模式</h2><p>网桥（bridge）模式可以让虚拟机和宿主机共享一个物理网络设备连接网络，虚拟机有自己的独立IP地址，可以直接连接与宿主机一样的网络，虚拟机可以访问外部网络，外部网络也可以直接访问客户机（就像访问普通物理主机一样）。即使宿主机只有一个网卡设备，使用bridge方式也可以让多个虚拟机与宿主机共享网络设备。<br>bridge模式需要添加<code>-net tap</code>参数，表明使用TAP设备。TAP是虚拟网络设备，它仿真了一个数据链路层设备（ISO七层网络结构的第二层），它像以太网的数据帧一样处理第二层数据包。TUN与TAP类似，也是一种虚拟网络设备，它是对网络层的仿真。TAP被用于创建一个网桥，而TUN与路由相关。  </p>
<h3 id="第一种linux下tap网络配置方法："><a href="#第一种linux下tap网络配置方法：" class="headerlink" title="第一种linux下tap网络配置方法："></a>第一种linux下tap网络配置方法：</h3><p>建立网桥：Ubuntu上需要安装建立虚拟网络设备的工具uml-utilities和桥接工具bridge-utils：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install uml-utilities bridge-utils</span><br></pre></td></tr></table></figure>
<p>创建一个bridge</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo brctl addbr br0</span><br></pre></td></tr></table></figure>
<p>清空网卡的IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ip addr flush dev eth0</span><br></pre></td></tr></table></figure>
<p>添加网卡到bridge</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo brctl addif br0 eth0</span><br></pre></td></tr></table></figure>
<p>创建tap接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tunctl -t tap0 -u fanrong</span><br></pre></td></tr></table></figure>
<p>添加tap0到bridge</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo brctl addif br0 tap0</span><br></pre></td></tr></table></figure>
<p>确定都已启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ifconfig eth0 up</span><br><span class="line">$ sudo ifconfig tap0 up</span><br><span class="line">$ sudo ifconfig br0 up</span><br></pre></td></tr></table></figure>
<p>检查桥接是否恰当</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo brctl show</span><br></pre></td></tr></table></figure>
<p>为br0分配ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brctl stp br0 on # 待定</span><br><span class="line">$ sudo dhclient br0</span><br></pre></td></tr></table></figure>
<p>启动命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo qemu-system-i386 -cdrom Core-current.iso -boot d -netdev tap,id&#x3D;mynet0,ifname&#x3D;tap0,script&#x3D;no,downscript&#x3D;no -device e1000,netdev&#x3D;mynet0,mac&#x3D;52:55:00:d1:55:01</span><br></pre></td></tr></table></figure>

<h3 id="第二种linux下tap网络配置方法："><a href="#第二种linux下tap网络配置方法：" class="headerlink" title="第二种linux下tap网络配置方法："></a>第二种linux下tap网络配置方法：</h3><p>1.建立一个虚拟网络接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mknod &#x2F;dev&#x2F;net&#x2F;tun c 10 200</span><br></pre></td></tr></table></figure>
<p>2.建立网桥<br>修改/etc/network/interface配置文件。此处建立一个名为br0的网桥，先桥接上eth0，在启动qemu时，再桥接上tap0。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line">auto br0</span><br><span class="line">iface br0 inet static</span><br><span class="line">address 192.168.1.2</span><br><span class="line">network 192.168.1.0</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line">broadcast 192.168.1.255</span><br><span class="line">gateway 192.168.1.1</span><br><span class="line">bridge_ports eth0</span><br><span class="line">bridge_fd 9</span><br><span class="line">bridge_hello 2</span><br><span class="line">bridge_maxage 12</span><br><span class="line">bridge_stp off</span><br></pre></td></tr></table></figure>
<p>3.建立qemu-ifup脚本，启动qemu时调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install uml-utilities bridge-utils</span><br><span class="line">$ brctl addbr br0</span><br><span class="line">$ sudo vim &#x2F;etc&#x2F;qemu-ifup</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">sudo &#x2F;sbin&#x2F;ifconfig $1 0.0.0.0 promisc up</span><br><span class="line">sudo &#x2F;sbin&#x2F;brctl addif br0 $1</span><br><span class="line">sleep 2</span><br><span class="line">$ sudo chmod +x &#x2F;etc&#x2F;qemu-ifup</span><br></pre></td></tr></table></figure>
<p>4.qemu启动命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ -net nic -net tap,ifname&#x3D;tap0,script&#x3D;&#x2F;etc&#x2F;qemu-ifup </span><br></pre></td></tr></table></figure>


<p><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://smilejay.com/2016/09/kvm-user-mode-networking/">http://smilejay.com/2016/09/kvm-user-mode-networking/</a><br><a target="_blank" rel="noopener" href="http://smilejay.com/2012/08/kvm-bridge-networking/">http://smilejay.com/2012/08/kvm-bridge-networking/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/31/Syzkaller%E5%AE%89%E8%A3%85%20Fuzz%20Qemu%20amd64%20Kernel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/31/Syzkaller%E5%AE%89%E8%A3%85%20Fuzz%20Qemu%20amd64%20Kernel/" class="post-title-link" itemprop="url">Syzkaller安装 Fuzz Qemu amd64 Kernel</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2019-05-31 11:28:49" itemprop="dateCreated datePublished" datetime="2019-05-31T11:28:49+08:00">2019-05-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>syzkaller官网上有介绍如何在Ubuntu宿主机上用qemu方法fuzz x86_64的Linux内核，但是步骤很分散，在好几个页面上，而且还可能有一些坑，后面会讲到。<br>首先介绍一下我的环境：  </p>
<ul>
<li>Ubuntu 16.04 x86_64</li>
<li>gcc 8.2.0</li>
<li>linux-5.1</li>
<li>go1.12.5</li>
</ul>
<h2 id="安装新版gcc"><a href="#安装新版gcc" class="headerlink" title="安装新版gcc"></a>安装新版gcc</h2><p>Syzkaller是一个coverage-guided fuzzer，因此需要编译内核有coverage support，gcc 6.1.0以后加入了coverage support。这里我是源码编译安装了gcc 8.2.0，大体步骤如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ wget http:&#x2F;&#x2F;ftp.tsukuba.wide.ad.jp&#x2F;software&#x2F;gcc&#x2F;releases&#x2F;gcc-8.2.0&#x2F;gcc-8.2.0.tar.gz</span><br><span class="line">$ tar xzvf gcc-8.2.0.tar.gz</span><br><span class="line">$ cd gcc-8.2.0&#x2F;</span><br><span class="line">$ .&#x2F;contrib&#x2F;download_prerequisites</span><br><span class="line">$ sudo apt install texinfo bison flex</span><br><span class="line">$ mkdir build</span><br><span class="line">$ cd build</span><br><span class="line">$ ..&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;gcc --enable-bootstrap --enable-checking&#x3D;release --enable-languages&#x3D;c,c++ --disable-multilib</span><br><span class="line">$ make -j8</span><br><span class="line">$ sudo make install</span><br><span class="line">$ vim ~&#x2F;.bashrc</span><br><span class="line">export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;gcc&#x2F;bin:$PATH</span><br><span class="line">$ source ~&#x2F;.bashrc</span><br><span class="line">$ gcc -v</span><br><span class="line">...</span><br><span class="line">gcc version 8.2.0 (GCC)</span><br></pre></td></tr></table></figure>

<h2 id="编译新版linux内核"><a href="#编译新版linux内核" class="headerlink" title="编译新版linux内核"></a>编译新版linux内核</h2><p>linux kernel也需要coverage support，KCOV在linux kernel 4.6以后加入，可以用<code>CONFIG_KCOV=y</code>配置。<br>编译内核的大体步骤如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ wget http:&#x2F;&#x2F;cdn.kernel.org&#x2F;pub&#x2F;linux&#x2F;kernel&#x2F;v5.x&#x2F;linux-5.1.tar.gz</span><br><span class="line">$ tar zxvf linux-5.1.tar.gz</span><br><span class="line">$ cd linux-5.1</span><br><span class="line">$ make defconfig</span><br><span class="line">$ make kvmconfig</span><br><span class="line">$ vim .config</span><br><span class="line">CONFIG_KCOV&#x3D;y</span><br><span class="line">CONFIG_DEBUG_INFO&#x3D;y</span><br><span class="line">CONFIG_KASAN&#x3D;y</span><br><span class="line">CONFIG_KASAN_INLINE&#x3D;y</span><br><span class="line">CONFIG_CONFIGFS_FS&#x3D;y</span><br><span class="line">CONFIG_SECURITYFS&#x3D;y</span><br><span class="line">$ make oldconfig # 使能这些选项使得一些子选项可用，一路回车即可</span><br><span class="line">$ make -j8</span><br></pre></td></tr></table></figure>

<h2 id="创建linux镜像"><a href="#创建linux镜像" class="headerlink" title="创建linux镜像"></a>创建linux镜像</h2><p>接着需要创建一个debian-strech的Linux镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install debootstrap</span><br><span class="line">$ mkdir IMAGE</span><br><span class="line">$ cd IMAGE</span><br><span class="line">$ wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;google&#x2F;syzkaller&#x2F;master&#x2F;tools&#x2F;create-image.sh -O create-image.sh</span><br><span class="line">$ chmod +x create-image.sh</span><br><span class="line">$ .&#x2F;create-image.sh</span><br><span class="line">$ ls</span><br><span class="line">chroot  create-image.sh  stretch.id_rsa  stretch.id_rsa.pub  stretch.img</span><br></pre></td></tr></table></figure>

<h2 id="安装qemu"><a href="#安装qemu" class="headerlink" title="安装qemu"></a>安装qemu</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install qemu-system-x86</span><br></pre></td></tr></table></figure>
<p>下面需要确保kernel能正常启动，sshd能正常运行，这里是一个坑点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 \</span><br><span class="line">  -kernel linux-5.1&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;bzImage \</span><br><span class="line">  -append &quot;console&#x3D;ttyS0 root&#x3D;&#x2F;dev&#x2F;sda debug earlyprintk&#x3D;serial slub_debug&#x3D;QUZ&quot;\</span><br><span class="line">  -hda IMAGE&#x2F;stretch.img \</span><br><span class="line">  -net user,hostfwd&#x3D;tcp::10021-:22 -net nic \</span><br><span class="line">  -enable-kvm \</span><br><span class="line">  -nographic \</span><br><span class="line">  -m 2G \</span><br><span class="line">  -smp 2 \</span><br><span class="line">  -pidfile vm.pid \</span><br><span class="line">  2&gt;&amp;1 | tee vm.log</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样启动的qemu可能存在<code>[FAILED] Failed to start Raise network interfaces.</code>的错误，原因是虚拟机启动后网卡名称为enp0s3（<code>ip a s</code>命令可以查看），而<code>/etc/network/interfaces</code>里的默认配置为<code>eth0</code>，网卡名称配置错误，启动不了网络接口，需要在虚拟机里修改interfaces文件。</p>
</blockquote>
<p>之后可以在另一个终端ssh连接到虚拟机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i IMAGE&#x2F;stretch.id_rsa -p 10021 -o &quot;StrictHostKeyChecking no&quot; root@localhost</span><br></pre></td></tr></table></figure>

<h2 id="安装golang"><a href="#安装golang" class="headerlink" title="安装golang"></a>安装golang</h2><p>syzkaller是go语言实现的，要编译安装需要Go 1.11+工具链。我安装的是<a target="_blank" rel="noopener" href="https://dl.google.com/go/go1.12.5.linux-amd64.tar.gz">go1.12.5</a>。将go解压到<code>/usr/local/</code>目录，在<code>~/</code>创建gopath文件夹，在环境变量中添加GOROOT变量和GOPATH等：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~&#x2F;.bashrc</span><br><span class="line">export GOROOT&#x3D;&#x2F;usr&#x2F;local&#x2F;go</span><br><span class="line">export GOPATH&#x3D;&#x2F;home&#x2F;fanrong&#x2F;gopath</span><br><span class="line">export PATH&#x3D;$GOROOT&#x2F;bin:$PATH</span><br></pre></td></tr></table></figure>

<h2 id="编译syzkaller"><a href="#编译syzkaller" class="headerlink" title="编译syzkaller"></a>编译syzkaller</h2><p>下载编译syzkaller源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ go get -u -d github.com&#x2F;google&#x2F;syzkaller&#x2F;...</span><br><span class="line">$ cd $GOPATH&#x2F;src&#x2F;github.com&#x2F;google&#x2F;syzkaller</span><br><span class="line">$ make</span><br><span class="line">$ ls bin</span><br><span class="line">linux_amd64  syz-db  syz-manager  syz-mutate  syz-prog2c  syz-repro  syz-runtest  syz-upgrade</span><br></pre></td></tr></table></figure>
<p>直接运行<code>make</code>是在amd64平台上编译amd64版本的syzkaller，如果要交叉编译需要设置<code>TARGETOS</code>、<code>TARGETARCH</code>等参数，详见Makefile。</p>
<h2 id="启动syzkaller开始fuzz"><a href="#启动syzkaller开始fuzz" class="headerlink" title="启动syzkaller开始fuzz"></a>启动syzkaller开始fuzz</h2><p>在syzkaller目录创建一个配置文件my.cfg来指定fuzz中相关的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;target&quot;: &quot;linux&#x2F;amd64&quot;,</span><br><span class="line">	&quot;http&quot;: &quot;127.0.0.1:56741&quot;,</span><br><span class="line">	&quot;workdir&quot;: &quot;workdir&quot;,</span><br><span class="line">	&quot;kernel_obj&quot;: &quot;&#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;kernel&#x2F;linux-5.1&quot;,</span><br><span class="line">	&quot;image&quot;: &quot;&#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;kernel&#x2F;IMAGE&#x2F;stretch.img&quot;,</span><br><span class="line">	&quot;sshkey&quot;: &quot;&#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;kernel&#x2F;IMAGE&#x2F;stretch.id_rsa&quot;,</span><br><span class="line">	&quot;syzkaller&quot;: &quot;.&quot;,</span><br><span class="line">	&quot;procs&quot;: 8,</span><br><span class="line">	&quot;type&quot;: &quot;qemu&quot;,</span><br><span class="line">	&quot;vm&quot;: &#123;</span><br><span class="line">		&quot;count&quot;: 4,</span><br><span class="line">		&quot;kernel&quot;: &quot;$KERNEL&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;bzImage&quot;,</span><br><span class="line">		&quot;cpu&quot;: 2,</span><br><span class="line">		&quot;mem&quot;: 2048</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就可以在syzkaller目录中运行fuzz了，这里会遇到刚才启动qemu那个坑，前面把网卡改成了<code>enp0s3</code>才能正常运行sshd，而这里又出现了网卡不能启动的错误。这里要找出错误原因需要知道syzkaller启动虚拟机时的参数，一开始我打算看源码，在源码中log启动参数，后来发现syz-manager本身提供了调试信息的打印，只要在启动syz-manager的时候加上<code>-debug</code>选项，运行发现启动qemu的命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 -m 1024 -smp 1 -net nic,model&#x3D;e1000 -net user,host&#x3D;10.0.2.10,hostfwd&#x3D;tcp::1569-:22 -display none -serial stdio -no-reboot -enable-kvm -cpu host,migratable&#x3D;off -hda &#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;IoT&#x2F;IMAGE&#x2F;stretch.img -snapshot -kernel &#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;IoT&#x2F;linux-5.1&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;bzImage -append &quot;earlyprintk&#x3D;serial oops&#x3D;panic nmi_watchdog&#x3D;panic panic_on_warn&#x3D;1 panic&#x3D;1 ftrace_dump_on_oops&#x3D;orig_cpu rodata&#x3D;n vsyscall&#x3D;native net.ifnames&#x3D;0 biosdevname&#x3D;0 root&#x3D;&#x2F;dev&#x2F;sda console&#x3D;ttyS0 kvm-intel.nested&#x3D;1 kvm-intel.unrestricted_guest&#x3D;1 kvm-intel.vmm_exclusive&#x3D;1 kvm-intel.fasteoi&#x3D;1 kvm-intel.ept&#x3D;1 kvm-intel.flexpriority&#x3D;1 kvm-intel.vpid&#x3D;1 kvm-intel.emulate_invalid_guest_state&#x3D;1 kvm-intel.eptad&#x3D;1 kvm-intel.enable_shadow_vmcs&#x3D;1 kvm-intel.pml&#x3D;1 kvm-intel.enable_apicv&#x3D;1&quot;</span><br></pre></td></tr></table></figure>
<p>单独运行这个命令，发现网卡确实不能启动，在qemu里运行<code>ip a s</code>命令，网卡名变成了eth0，所以又要把/etc/network/interfaces里的网卡名改回eth0，然后就可以正常启动syzkaller了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir workdir</span><br><span class="line">$ .&#x2F;bin&#x2F;syz-manager -config&#x3D;my.cfg</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:01 loading corpus...</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:01 serving http on http:&#x2F;&#x2F;127.0.0.1:56741</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:01 serving rpc on tcp:&#x2F;&#x2F;[::]:42897</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:01 booting test machines...</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:01 wait for the connection from test machine...</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 machine check:</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 syscalls                : 1387&#x2F;2695</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 code coverage           : enabled</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 comparison tracing      : enabled</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 extra coverage          : extra coverage is not supported by the kernel</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 setuid sandbox          : enabled</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 namespace sandbox       : &#x2F;proc&#x2F;self&#x2F;ns&#x2F;user does not exist</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 Android sandbox         : enabled</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 fault injection         : CONFIG_FAULT_INJECTION is not enabled</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 leak checking           : CONFIG_DEBUG_KMEMLEAK is not enabled</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 net packet injection    : &#x2F;dev&#x2F;net&#x2F;tun does not exist</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 net device setup        : enabled</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:25 corpus                  : 0 (0 deleted)</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:31 VMs 1, executed 0, cover 1349, crashes 0, repro 0</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:41 VMs 1, executed 595, cover 2456, crashes 0, repro 0</span><br><span class="line">2019&#x2F;05&#x2F;30 18:29:51 VMs 1, executed 1156, cover 3520, crashes 0, repro 0</span><br><span class="line">2019&#x2F;05&#x2F;30 18:30:01 VMs 1, executed 1156, cover 7565, crashes 0, repro 0</span><br><span class="line">2019&#x2F;05&#x2F;30 18:30:11 VMs 1, executed 1538, cover 8745, crashes 0, repro 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以在浏览器中查看fuzz进度：<br><img src="/images/syzkaller/syz-browser.png"></p>
<p><strong>reference</strong><br><a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/linux/setup.md">How to set up syzkaller</a><br><a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/linux/setup_ubuntu-host_qemu-vm_x86-64-kernel.md">Setup: Ubuntu host, QEMU vm, x86-64 kernel</a><br><a target="_blank" rel="noopener" href="https://www.wolfoot.com/index.php/archives/9/">ubuntu16.04 编译安装gcc8.2.0</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/09/%E7%94%A8Tensorflow-Serving%E9%83%A8%E7%BD%B2%E8%87%AA%E5%B7%B1%E7%9A%84%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/09/%E7%94%A8Tensorflow-Serving%E9%83%A8%E7%BD%B2%E8%87%AA%E5%B7%B1%E7%9A%84%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">用Tensorflow Serving部署自己的模型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2019-05-09 16:11:21" itemprop="dateCreated datePublished" datetime="2019-05-09T16:11:21+08:00">2019-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Google为了解决机器学习模型部署上线至生产环境，发布了Tensorflow Serving。本文主要通过部署一个手写数字识别的模型来介绍Tensorflow Serving的基本用法。</p>
<h2 id="构建CNN模型及checkpoint保存方式"><a href="#构建CNN模型及checkpoint保存方式" class="headerlink" title="构建CNN模型及checkpoint保存方式"></a>构建CNN模型及checkpoint保存方式</h2><p>如果不需要Tensorflow Serving部署模型的话，大部分人会选择传统的checkpoint方式保存训练好的模型，下面先看一下这种传统的保存方式：<br><strong>代码清单</strong> mnist_test.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span>  tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 屏蔽waring信息</span></span><br><span class="line">os.environ[<span class="string">&#x27;TF_CPP_MIN_LOG_LEVEL&#x27;</span>] = <span class="string">&#x27;2&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="string">&quot;&quot;&quot;------------------加载数据---------------------&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 载入数据</span></span><br><span class="line">mnist = input_data.read_data_sets(<span class="string">&quot;MNIST_data/&quot;</span>, one_hot=<span class="literal">True</span>)</span><br><span class="line">trX, trY, teX, teY = mnist.train.images, mnist.train.labels, mnist.test.images, mnist.test.labels</span><br><span class="line"><span class="comment"># 改变数据格式，为了能够输入卷积层</span></span><br><span class="line">trX = trX.reshape(<span class="number">-1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>)  <span class="comment"># -1表示不考虑输入图片的数量,1表示单通道</span></span><br><span class="line">teX = teX.reshape(<span class="number">-1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line"><span class="string">&quot;&quot;&quot;------------------构建模型---------------------&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 定义输入输出的数据容器</span></span><br><span class="line">X = tf.placeholder(<span class="string">&quot;float&quot;</span>, [<span class="literal">None</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>], name=<span class="string">&quot;X&quot;</span>)</span><br><span class="line">Y = tf.placeholder(<span class="string">&quot;float&quot;</span>, [<span class="literal">None</span>, <span class="number">10</span>])</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义和初始化权重、dropout参数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_weights</span>(<span class="params">shape</span>):</span></span><br><span class="line">    <span class="keyword">return</span> tf.Variable(tf.random_normal(shape, stddev=<span class="number">0.01</span>))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">w1 = init_weights([<span class="number">3</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">32</span>])        <span class="comment"># 3X3的卷积核，获得32个特征</span></span><br><span class="line">w2 = init_weights([<span class="number">3</span>, <span class="number">3</span>, <span class="number">32</span>, <span class="number">64</span>])       <span class="comment"># 3X3的卷积核，获得64个特征</span></span><br><span class="line">w3 = init_weights([<span class="number">3</span>, <span class="number">3</span>, <span class="number">64</span>, <span class="number">128</span>])      <span class="comment"># 3X3的卷积核，获得128个特征</span></span><br><span class="line">w4 = init_weights([<span class="number">128</span> * <span class="number">4</span> * <span class="number">4</span>, <span class="number">625</span>])   <span class="comment"># 从卷积层到全连层</span></span><br><span class="line">w_o = init_weights([<span class="number">625</span>, <span class="number">10</span>])           <span class="comment"># 从全连层到输出层</span></span><br><span class="line"> </span><br><span class="line">p_keep_conv = tf.placeholder(<span class="string">&quot;float&quot;</span>, name=<span class="string">&quot;p_keep_conv&quot;</span>)</span><br><span class="line">p_keep_hidden = tf.placeholder(<span class="string">&quot;float&quot;</span>, name=<span class="string">&quot;p_keep_hidden&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义模型</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_model</span>(<span class="params">X, w1, w2, w3, w4, w_o, p_keep_conv, p_keep_hidden</span>):</span></span><br><span class="line">    <span class="comment"># 第一组卷积层和pooling层</span></span><br><span class="line">    conv1 = tf.nn.conv2d(X, w1, strides=[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], padding=<span class="string">&#x27;SAME&#x27;</span>)</span><br><span class="line">    conv1_out = tf.nn.relu(conv1)</span><br><span class="line">    pool1 = tf.nn.max_pool(conv1_out, ksize=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>], strides=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>], padding=<span class="string">&#x27;SAME&#x27;</span>)</span><br><span class="line">    pool1_out = tf.nn.dropout(pool1, p_keep_conv)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 第二组卷积层和pooling层</span></span><br><span class="line">    conv2 = tf.nn.conv2d(pool1_out, w2, strides=[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], padding=<span class="string">&#x27;SAME&#x27;</span>)</span><br><span class="line">    conv2_out = tf.nn.relu(conv2)</span><br><span class="line">    pool2 = tf.nn.max_pool(conv2_out, ksize=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>], strides=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>], padding=<span class="string">&#x27;SAME&#x27;</span>)</span><br><span class="line">    pool2_out = tf.nn.dropout(pool2, p_keep_conv)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 第三组卷积层和pooling层</span></span><br><span class="line">    conv3 = tf.nn.conv2d(pool2_out, w3, strides=[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], padding=<span class="string">&#x27;SAME&#x27;</span>)</span><br><span class="line">    conv3_out = tf.nn.relu(conv3)</span><br><span class="line">    pool3 = tf.nn.max_pool(conv3_out, ksize=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>], strides=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>], padding=<span class="string">&#x27;SAME&#x27;</span>)</span><br><span class="line">    pool3 = tf.reshape(pool3, [<span class="number">-1</span>, w4.get_shape().as_list()[<span class="number">0</span>]])  <span class="comment"># 转化成一维的向量</span></span><br><span class="line">    pool3_out = tf.nn.dropout(pool3, p_keep_conv)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 全连层</span></span><br><span class="line">    fully_layer = tf.matmul(pool3_out, w4)</span><br><span class="line">    fully_layer_out = tf.nn.relu(fully_layer)</span><br><span class="line">    fully_layer_out = tf.nn.dropout(fully_layer_out, p_keep_hidden)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 输出层</span></span><br><span class="line">    out = tf.matmul(fully_layer_out, w_o)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">model = create_model(X, w1, w2, w3, w4, w_o, p_keep_conv, p_keep_hidden)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义代价函数、训练方法、预测操作</span></span><br><span class="line">cost = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(logits=model, labels=Y))</span><br><span class="line">train_op = tf.train.RMSPropOptimizer(<span class="number">0.001</span>, <span class="number">0.9</span>).minimize(cost)</span><br><span class="line">predict_op = tf.argmax(model, <span class="number">1</span>, name=<span class="string">&quot;predict&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义一个saver</span></span><br><span class="line">saver=tf.train.Saver()</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义存储路径</span></span><br><span class="line">ckpt_dir=<span class="string">&quot;./ckpt_dir&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(ckpt_dir):</span><br><span class="line">    os.makedirs(ckpt_dir)</span><br><span class="line"> </span><br><span class="line"><span class="string">&quot;&quot;&quot;------------------训练模型或者加载模型进行测试---------------------&quot;&quot;&quot;</span></span><br><span class="line">train_batch_size = <span class="number">128</span>  <span class="comment"># 训练集的mini_batch_size=128</span></span><br><span class="line">test_batch_size = <span class="number">256</span>   <span class="comment"># 测试集中调用的batch_size=256</span></span><br><span class="line">epoches = <span class="number">5</span>  <span class="comment"># 迭代周期</span></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;-------训练模型--------&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 初始化所有变量</span></span><br><span class="line">    tf.global_variables_initializer().run()</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 训练操作</span></span><br><span class="line"><span class="comment">#    for i in range(epoches):</span></span><br><span class="line"><span class="comment">#        train_batch = zip(range(0, len(trX), train_batch_size),</span></span><br><span class="line"><span class="comment">#                          range(train_batch_size, len(trX) + 1, train_batch_size))</span></span><br><span class="line"><span class="comment">#        for start, end in train_batch:</span></span><br><span class="line"><span class="comment">#            sess.run(train_op, feed_dict=&#123;X: trX[start:end], Y: trY[start:end],</span></span><br><span class="line"><span class="comment">#                                          p_keep_conv: 0.8, p_keep_hidden: 0.5&#125;)</span></span><br><span class="line"><span class="comment">#        # 每个周期用测试集中随机抽出test_batch_size个图片进行测试</span></span><br><span class="line"><span class="comment">#        test_indices = np.arange(len(teX))  # 返回一个array[0,1...len(teX)]</span></span><br><span class="line"><span class="comment">#        np.random.shuffle(test_indices)     # 打乱这个array</span></span><br><span class="line"><span class="comment">#        test_indices = test_indices[0:test_batch_size]</span></span><br><span class="line"><span class="comment">#    </span></span><br><span class="line"><span class="comment">#        # 获取测试集test_batch_size章图片的的预测结果</span></span><br><span class="line"><span class="comment">#        predict_result = sess.run(predict_op, feed_dict=&#123;X: teX[test_indices],</span></span><br><span class="line"><span class="comment">#                                                         p_keep_conv: 1.0,</span></span><br><span class="line"><span class="comment">#                                                         p_keep_hidden: 1.0&#125;)</span></span><br><span class="line"><span class="comment">#        # 获取真实的标签值</span></span><br><span class="line"><span class="comment">#        true_labels = np.argmax(teY[test_indices], axis=1)</span></span><br><span class="line"><span class="comment">#    </span></span><br><span class="line"><span class="comment">#        # 计算准确率</span></span><br><span class="line"><span class="comment">#        accuracy = np.mean(true_labels == predict_result)</span></span><br><span class="line"><span class="comment">#        print(&quot;epoch&quot;, i, &quot;:&quot;, accuracy)</span></span><br><span class="line"><span class="comment">#    </span></span><br><span class="line"><span class="comment">#        # 保存模型</span></span><br><span class="line"><span class="comment">#        saver.save(sess,ckpt_dir+&quot;/model.ckpt&quot;,global_step=i)</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">&quot;&quot;&quot;-----加载模型，用导入的图片进行测试--------&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 载入图片</span></span><br><span class="line">    src = cv2.imread(<span class="string">&#x27;./2.png&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 将图片转化为28*28的灰度图</span></span><br><span class="line">    src = cv2.cvtColor(src, cv2.COLOR_BGR2GRAY)</span><br><span class="line">    dst = cv2.resize(src, (<span class="number">28</span>, <span class="number">28</span>), interpolation=cv2.INTER_CUBIC)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 将灰度图转化为1*784的能够输入的网络的数组</span></span><br><span class="line">    picture = np.zeros((<span class="number">28</span>, <span class="number">28</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">28</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">28</span>):</span><br><span class="line">            picture[i][j] = (<span class="number">255</span> - dst[i][j])</span><br><span class="line">    picture = picture.reshape(<span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 载入模型</span></span><br><span class="line">    saver.restore(sess, ckpt_dir+<span class="string">&quot;/model.ckpt-4&quot;</span>)</span><br><span class="line">    <span class="comment"># 进行预测</span></span><br><span class="line">    predict_result = sess.run(predict_op, feed_dict=&#123;X: picture,</span><br><span class="line">                                                    p_keep_conv: <span class="number">1.0</span>,</span><br><span class="line">                                                    p_keep_hidden: <span class="number">1.0</span>&#125;)</span><br><span class="line">    print(<span class="string">&quot;你导入的图片是：&quot;</span>, predict_result[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<p>mnist_test.py文件包含了模型定义、训练和保存、加载。其中注释掉的代码为模型训练部分，去掉注释可以进行模型训练，训练后的模型保存在ckpt_dir中：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ls ckpt_dir</span><br><span class="line">checkpoint                       model.ckpt-1.data-00000-of-00001 model.ckpt-2.index               model.ckpt-3.meta</span><br><span class="line">model.ckpt-0.data-00000-of-00001 model.ckpt-1.index               model.ckpt-2.meta                model.ckpt-4.data-00000-of-00001</span><br><span class="line">model.ckpt-0.index               model.ckpt-1.meta                model.ckpt-3.data-00000-of-00001 model.ckpt-4.index</span><br><span class="line">model.ckpt-0.meta                model.ckpt-2.data-00000-of-00001 model.ckpt-3.index               model.ckpt-4.meta</span><br></pre></td></tr></table></figure>

<h2 id="用Saved-Model方式保存训练好的模型"><a href="#用Saved-Model方式保存训练好的模型" class="headerlink" title="用Saved Model方式保存训练好的模型"></a>用Saved Model方式保存训练好的模型</h2><p>为了能用Tensorflow Serving部署，需要用SavedModel方式保存模型。可以重新训练，再用SavedModel方式保存，也可以加载预训练的模型，保存为SavedModel方式。具体操作是在载入模型之后加入如下代码：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Saved Model</span></span><br><span class="line">tf.saved_model.simple_save(sess,</span><br><span class="line">        <span class="string">&#x27;savedmodel/1&#x27;</span>,</span><br><span class="line">        inputs=&#123;<span class="string">&quot;X&quot;</span>:X, <span class="string">&quot;p_keep_conv&quot;</span>:p_keep_conv, <span class="string">&quot;p_keep_hidden&quot;</span>:p_keep_hidden&#125;,</span><br><span class="line">        outputs=&#123;<span class="string">&quot;predict&quot;</span>:predict_op&#125;)</span><br></pre></td></tr></table></figure>
<p>第一个参数sess为当前会话；第二个参数为保存模型的路径；第三个参数是模型输入，即使用模型进行预测时feed_dict里的变量；第四个参数是模型输出，对应模型预测时的第一个参数。<br>把训练模型部分的代码注释掉，运行mnist_test.py，会将模型保存为Tensorflow Serving可以用的形式：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ls savedmodel&#x2F;1</span><br><span class="line">saved_model.pb variables</span><br><span class="line"># 查看模型的输入输出</span><br><span class="line">$ saved_model_cli show --dir savedmodel&#x2F;1 --all</span><br><span class="line"></span><br><span class="line">MetaGraphDef with tag-set: &#39;serve&#39; contains the following SignatureDefs:</span><br><span class="line"></span><br><span class="line">signature_def[&#39;serving_default&#39;]:</span><br><span class="line">  The given SavedModel SignatureDef contains the following input(s):</span><br><span class="line">    inputs[&#39;X&#39;] tensor_info:</span><br><span class="line">        dtype: DT_FLOAT</span><br><span class="line">        shape: (-1, 28, 28, 1)</span><br><span class="line">        name: X:0</span><br><span class="line">    inputs[&#39;p_keep_conv&#39;] tensor_info:</span><br><span class="line">        dtype: DT_FLOAT</span><br><span class="line">        shape: unknown_rank</span><br><span class="line">        name: p_keep_conv:0</span><br><span class="line">    inputs[&#39;p_keep_hidden&#39;] tensor_info:</span><br><span class="line">        dtype: DT_FLOAT</span><br><span class="line">        shape: unknown_rank</span><br><span class="line">        name: p_keep_hidden:0</span><br><span class="line">  The given SavedModel SignatureDef contains the following output(s):</span><br><span class="line">    outputs[&#39;predict&#39;] tensor_info:</span><br><span class="line">        dtype: DT_INT64</span><br><span class="line">        shape: (-1)</span><br><span class="line">        name: predict:0</span><br><span class="line">  Method name is: tensorflow&#x2F;serving&#x2F;predict</span><br></pre></td></tr></table></figure>
<p>saved_model_cli命令行工具在安装过tensorflow之后就有了。  </p>
<h2 id="用Tensorflow-Serving部署模型"><a href="#用Tensorflow-Serving部署模型" class="headerlink" title="用Tensorflow Serving部署模型"></a>用Tensorflow Serving部署模型</h2><p>接下来就可以用Tensorflow Serving对模型进行部署了，Tensorflow Serving可以提供<code>gRPC</code>和<code>REST</code>两种方式，<code>gRPC</code>使用<code>8500</code>端口，<code>REST</code>使用<code>8501</code>端口，通过<code>-p</code>选项来映射docker和本地的端口，前面的是本地端口，后面的是docker端口，<code>--name</code>选项指定docker容器的名称，<code>--mount</code>选项挂载文件系统到容器，<code>-e</code>选项设置环境变量，<code>-t</code>选项分配虚拟终端：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -p 8502:8501 --name mnist_model --mount type&#x3D;bind,source&#x3D;&#x2F;home&#x2F;fanrong&#x2F;tfserving&#x2F;savedmodel,target&#x3D;&#x2F;models&#x2F;mnist_test -e MODEL_NAME&#x3D;mnist_test -t tensorflow&#x2F;serving</span><br><span class="line">2019-05-09 07:31:04.975302: I tensorflow_serving&#x2F;model_servers&#x2F;server.cc:82] Building single TensorFlow model file config:  model_name: mnist_test model_base_path: &#x2F;models&#x2F;mnist_test</span><br><span class="line">2019-05-09 07:31:04.975674: I tensorflow_serving&#x2F;model_servers&#x2F;server_core.cc:461] Adding&#x2F;updating models.</span><br><span class="line">2019-05-09 07:31:04.975744: I tensorflow_serving&#x2F;model_servers&#x2F;server_core.cc:558]  (Re-)adding model: mnist_test</span><br><span class="line">2019-05-09 07:31:05.076332: I tensorflow_serving&#x2F;core&#x2F;basic_manager.cc:739] Successfully reserved resources to load servable &#123;name: mnist_test version: 1&#125;</span><br><span class="line">2019-05-09 07:31:05.076402: I tensorflow_serving&#x2F;core&#x2F;loader_harness.cc:66] Approving load for servable version &#123;name: mnist_test version: 1&#125;</span><br><span class="line">2019-05-09 07:31:05.076447: I tensorflow_serving&#x2F;core&#x2F;loader_harness.cc:74] Loading servable version &#123;name: mnist_test version: 1&#125;</span><br><span class="line">2019-05-09 07:31:05.076533: I external&#x2F;org_tensorflow&#x2F;tensorflow&#x2F;contrib&#x2F;session_bundle&#x2F;bundle_shim.cc:363] Attempting to load native SavedModelBundle in bundle-shim from: &#x2F;models&#x2F;mnist_test&#x2F;1</span><br><span class="line">2019-05-09 07:31:05.076560: I external&#x2F;org_tensorflow&#x2F;tensorflow&#x2F;cc&#x2F;saved_model&#x2F;reader.cc:31] Reading SavedModel from: &#x2F;models&#x2F;mnist_test&#x2F;1</span><br><span class="line">2019-05-09 07:31:05.081699: I external&#x2F;org_tensorflow&#x2F;tensorflow&#x2F;cc&#x2F;saved_model&#x2F;reader.cc:54] Reading meta graph with tags &#123; serve &#125;</span><br><span class="line">2019-05-09 07:31:05.109514: I external&#x2F;org_tensorflow&#x2F;tensorflow&#x2F;cc&#x2F;saved_model&#x2F;loader.cc:182] Restoring SavedModel bundle.</span><br><span class="line">2019-05-09 07:31:05.146630: I external&#x2F;org_tensorflow&#x2F;tensorflow&#x2F;cc&#x2F;saved_model&#x2F;loader.cc:285] SavedModel load for tags &#123; serve &#125;; Status: success. Took 70041 microseconds.</span><br><span class="line">2019-05-09 07:31:05.146734: I tensorflow_serving&#x2F;servables&#x2F;tensorflow&#x2F;saved_model_warmup.cc:101] No warmup data file found at &#x2F;models&#x2F;mnist_test&#x2F;1&#x2F;assets.extra&#x2F;tf_serving_warmup_requests</span><br><span class="line">2019-05-09 07:31:05.147120: I tensorflow_serving&#x2F;core&#x2F;loader_harness.cc:86] Successfully loaded servable version &#123;name: mnist_test version: 1&#125;</span><br><span class="line">2019-05-09 07:31:05.153768: I tensorflow_serving&#x2F;model_servers&#x2F;server.cc:313] Running gRPC ModelServer at 0.0.0.0:8500 ...</span><br><span class="line">[warn] getaddrinfo: address family for nodename not supported</span><br><span class="line">2019-05-09 07:31:05.158494: I tensorflow_serving&#x2F;model_servers&#x2F;server.cc:333] Exporting HTTP&#x2F;REST API at:localhost:8501 ...</span><br><span class="line">[evhttp_server.cc : 237] RAW: Entering the event loop ...</span><br></pre></td></tr></table></figure>
<p>接下来要对上线的模型请求服务，需要编写客户端代码：<br><strong>代码清单</strong> client.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">URL = <span class="string">&#x27;http://localhost:8502/v1/models/mnist_test:predict&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    src = cv2.imread(<span class="string">&#x27;./2.png&#x27;</span>)</span><br><span class="line">    src = cv2.cvtColor(src, cv2.COLOR_BGR2GRAY)</span><br><span class="line">    dst = cv2.resize(src, (<span class="number">28</span>, <span class="number">28</span>), interpolation=cv2.INTER_CUBIC)    </span><br><span class="line">    picture = np.zeros((<span class="number">28</span>,<span class="number">28</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">28</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">28</span>):</span><br><span class="line">            picture[i][j] = (<span class="number">255</span> - dst[i][j])</span><br><span class="line">    picture = picture.reshape(<span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>)</span><br><span class="line">    predict_request = <span class="string">&#x27;&#123;&quot;inputs&quot;:&#123;&quot;X&quot;:%s, &quot;p_keep_conv&quot;:1.0, &quot;p_keep_hidden&quot;:1.0&#125;&#125;&#x27;</span> % picture.tolist()</span><br><span class="line">    response = requests.post(URL, data=predict_request)</span><br><span class="line">    response.raise_for_status()</span><br><span class="line">    print(response.json()[<span class="string">&#x27;outputs&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是输入参数中的<code>X</code>，X本身是一个numpy数组类型，但是参数只能以字符串形式传递，如果直接用nunpy数组，转换为字符串是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[[[[  0.]</span><br><span class="line">   [  0.]</span><br><span class="line">   [  0.]</span><br><span class="line">   [  0.]</span><br><span class="line">   [  0.]</span><br><span class="line">   ...</span><br><span class="line">   [  0.]</span><br><span class="line">   [  0.]</span><br><span class="line">   [  0.]</span><br><span class="line">   [  0.]</span><br><span class="line">   [  0.]</span><br><span class="line">   [  0.]]]]</span><br></pre></td></tr></table></figure>
<p>服务端接收到字符串以后无法处理，会报400 Client Error: Bad Request for url: <a target="_blank" rel="noopener" href="http://localhost:8502/v1/models/mnist_test:predict">http://localhost:8502/v1/models/mnist_test:predict</a><br>所以需要先把numpy数组转换为list类型，list类型转换为字符串是这样的：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[[[0.0], [0.0], [0.0], [0.0], [0.0], [0.0], [0.0], [0.0], ...[0.0], [0.0], [0.0], [0.0], [0.0]]]]</span><br></pre></td></tr></table></figure>
<p>服务端接收到字符串之后，可以识别为list类型，进行正常处理。<br>最后是这种效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python client.py</span><br><span class="line">[2]</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/08/Docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8MySQL%E5%92%8CTensorflow-Serving/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/08/Docker%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8MySQL%E5%92%8CTensorflow-Serving/" class="post-title-link" itemprop="url">Docker安装使用MySQL和Tensorflow Serving</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2019-05-08 19:23:49" itemprop="dateCreated datePublished" datetime="2019-05-08T19:23:49+08:00">2019-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Ubuntu18-04安装"><a href="#Ubuntu18-04安装" class="headerlink" title="Ubuntu18.04安装"></a>Ubuntu18.04安装</h2><p>安装最新版Docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -qO- https:&#x2F;&#x2F;get.docker.com&#x2F; | sh</span><br></pre></td></tr></table></figure>
<p>Docker可以在容器内运行应用程序，使用docker run命令在容器内运行应用程序  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker</span><br><span class="line"></span><br><span class="line">Usage:  docker [OPTIONS] COMMAND</span><br><span class="line"></span><br><span class="line">A self-sufficient runtime for containers</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --config string      Location of client config files (default &quot;&#x2F;home&#x2F;fanrong1&#x2F;.docker&quot;)</span><br><span class="line">  -D, --debug              Enable debug mode</span><br><span class="line">  -H, --host list          Daemon socket(s) to connect to</span><br><span class="line">  -l, --log-level string   Set the logging level (&quot;debug&quot;|&quot;info&quot;|&quot;warn&quot;|&quot;error&quot;|&quot;fatal&quot;) (default &quot;info&quot;)</span><br><span class="line">      --tls                Use TLS; implied by --tlsverify</span><br><span class="line">      --tlscacert string   Trust certs signed only by this CA (default &quot;&#x2F;home&#x2F;fanrong1&#x2F;.docker&#x2F;ca.pem&quot;)</span><br><span class="line">      --tlscert string     Path to TLS certificate file (default &quot;&#x2F;home&#x2F;fanrong1&#x2F;.docker&#x2F;cert.pem&quot;)</span><br><span class="line">      --tlskey string      Path to TLS key file (default &quot;&#x2F;home&#x2F;fanrong1&#x2F;.docker&#x2F;key.pem&quot;)</span><br><span class="line">      --tlsverify          Use TLS and verify the remote</span><br><span class="line">  -v, --version            Print version information and quit</span><br><span class="line"></span><br><span class="line">Management Commands:</span><br><span class="line">  builder     Manage builds</span><br><span class="line">  config      Manage Docker configs</span><br><span class="line">  container   Manage containers</span><br><span class="line">  engine      Manage the docker engine</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<h2 id="使用Docker-MySQL"><a href="#使用Docker-MySQL" class="headerlink" title="使用Docker MySQL"></a>使用Docker MySQL</h2><p>下面以docker mysql为例介绍Docker的使用。<br>查找Docker Hub上的MySQL镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker search mysql</span><br><span class="line">NAME                                                   DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span><br><span class="line">mysql                                                  MySQL is a widely used, open-source relation…   8115                [OK]</span><br><span class="line">mariadb                                                MariaDB is a community-developed fork of MyS…   2753                [OK]</span><br><span class="line">mysql&#x2F;mysql-server                                     Optimized MySQL Server Docker images. Create…   607                                     [OK]</span><br><span class="line">zabbix&#x2F;zabbix-server-mysql                             Zabbix Server with MySQL database support       191                                     [OK]</span><br><span class="line">hypriot&#x2F;rpi-mysql                                      RPi-compatible Docker Image with Mysql          113</span><br><span class="line">zabbix&#x2F;zabbix-web-nginx-mysql                          Zabbix frontend based on Nginx web-server wi…   100                                     [OK]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>拉取官方镜像，Tag为5.7</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull mysql:5.7</span><br></pre></td></tr></table></figure>
<p>查看本地镜像列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker images</span><br><span class="line">REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu               16.04               9361ce633ff1        8 weeks ago         118MB</span><br><span class="line">tensorflow&#x2F;serving   latest              38bee21b2ca0        2 months ago        229MB</span><br><span class="line">mysql                5.7                 e47e309f72c8        3 months ago        372MB</span><br></pre></td></tr></table></figure>
<p>启动mysql docker容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run --name test_docker_mysql -p 3307:3306 -e MYSQL_ROOT_PASSWORD&#x3D;123456 -d mysql:5.7</span><br><span class="line">65b2b644555b3730ac936caab2ccf9ad451b6e31f2509ed3e2333c9e20079873</span><br></pre></td></tr></table></figure>
<p>查看docker启动情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE                COMMAND                  CREATED             STATUS              PORTS                               NAMES</span><br><span class="line">65b2b644555b        mysql:5.7            &quot;docker-entrypoint.s…&quot;   5 minutes ago       Up 5 minutes        33060&#x2F;tcp, 0.0.0.0:3307-&gt;3306&#x2F;tcp   test_docker_mysql</span><br></pre></td></tr></table></figure>
<p>到这已经可以使用docker的mysql容器提供的服务了，由于本地没有安装mysql客户端，所以这里用python去连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line"></span><br><span class="line">import pymysql</span><br><span class="line"></span><br><span class="line">db &#x3D; pymysql.connect(&quot;localhost&quot;, &quot;root&quot;, &quot;123456&quot;, &quot;mysql&quot;, port&#x3D;3307)</span><br><span class="line">cursor &#x3D; db.cursor()</span><br><span class="line">sql &#x3D; &quot;select * from user&quot;</span><br><span class="line">cursor.execute(sql)</span><br><span class="line">results &#x3D; cursor.fetchall()</span><br><span class="line">for row in results:</span><br><span class="line">    print(row)</span><br><span class="line"></span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>
<p>运行脚本结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ python mysql_test.py</span><br><span class="line">(&#39;localhost&#39;, &#39;root&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;&#39;, b&#39;&#39;, b&#39;&#39;, b&#39;&#39;, 0, 0, 0, 0, &#39;mysql_native_password&#39;, &#39;*6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9&#39;, &#39;N&#39;, datetime.datetime(2019, 5, 9, 8, 47, 32), None, &#39;N&#39;)</span><br><span class="line">(&#39;localhost&#39;, &#39;mysql.session&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;Y&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;&#39;, b&#39;&#39;, b&#39;&#39;, b&#39;&#39;, 0, 0, 0, 0, &#39;mysql_native_password&#39;, &#39;*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE&#39;, &#39;N&#39;, datetime.datetime(2019, 5, 9, 8, 47, 20), None, &#39;Y&#39;)</span><br><span class="line">(&#39;localhost&#39;, &#39;mysql.sys&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;N&#39;, &#39;&#39;, b&#39;&#39;, b&#39;&#39;, b&#39;&#39;, 0, 0, 0, 0, &#39;mysql_native_password&#39;, &#39;*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE&#39;, &#39;N&#39;, datetime.datetime(2019, 5, 9, 8, 47, 20), None, &#39;Y&#39;)</span><br><span class="line">(&#39;%&#39;, &#39;root&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;&#39;, b&#39;&#39;, b&#39;&#39;, b&#39;&#39;, 0, 0, 0, 0, &#39;mysql_native_password&#39;, &#39;*6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9&#39;, &#39;N&#39;, datetime.datetime(2019, 5, 9, 8, 47, 32), None, &#39;N&#39;)</span><br></pre></td></tr></table></figure>

<h2 id="使用Docker-Tensorflow-Serving部署模型"><a href="#使用Docker-Tensorflow-Serving部署模型" class="headerlink" title="使用Docker Tensorflow Serving部署模型"></a>使用Docker Tensorflow Serving部署模型</h2><p>下载Tensorflow Serving的Docker镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull tensorflow&#x2F;serving</span><br><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;tensorflow&#x2F;serving</span><br></pre></td></tr></table></figure>
<p>设置demo模型的路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ TESTDATA&#x3D;&quot;$(pwd)&#x2F;serving&#x2F;tensorflow_serving&#x2F;servables&#x2F;tensorflow&#x2F;testdata&quot;</span><br></pre></td></tr></table></figure>
<p>启动Tensorflow Serving容器，打开REST API端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -t -p 8501:8501 -v &quot;$TESTDATA&#x2F;saved_model_half_plus_two_cpu:&#x2F;models&#x2F;half_plus_two&quot; -e MODEL_NAME&#x3D;half_plus_two tensorflow&#x2F;serving</span><br></pre></td></tr></table></figure>
<p>用命令行请求模型的预测API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -d &#39;&#123;&quot;instances&quot;: [1.0, 2.0, 5.0]&#125;&#39; -X POST http:&#x2F;&#x2F;localhost:8501&#x2F;v1&#x2F;models&#x2F;half_plus_two:predict</span><br><span class="line">&#123; &quot;predictions&quot;: [2.5, 3.0, 4.5] &#125;</span><br><span class="line">$ curl -d &#39;&#123;&quot;inputs&quot;: 1.0&#125;&#39; -X POST http:&#x2F;&#x2F;localhost:8501&#x2F;v1&#x2F;models&#x2F;half_plus_two:predict</span><br><span class="line">&#123; &quot;predictions&quot;: 2.5 &#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/07/14/gdb%E8%B0%83%E8%AF%95AOSP%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/14/gdb%E8%B0%83%E8%AF%95AOSP%E4%BB%A3%E7%A0%81/" class="post-title-link" itemprop="url">gdb调试AOSP代码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2018-07-14 20:24:00" itemprop="dateCreated datePublished" datetime="2018-07-14T20:24:00+08:00">2018-07-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这次主要是调试Android system/bt目录下的代码，也就是蓝牙相关的代码，是源于对几个CVE（cve-2018-9355~cve-2018-9362）的学习，这几个CVE是蓝牙相关的漏洞。</p>
<h2 id="蓝牙相关代码分析"><a href="#蓝牙相关代码分析" class="headerlink" title="蓝牙相关代码分析"></a>蓝牙相关代码分析</h2><p>因为之前对蓝牙相关代码没有了解过，所以先对AOSP中关于蓝牙的代码进行学习。首先是从Android应用层编程开始，几个基本操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取设备Adapter</span></span><br><span class="line">BluetoothAdapter mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();</span><br><span class="line"><span class="comment">// 表明此手机不支持蓝牙</span></span><br><span class="line"><span class="keyword">if</span>(mBluetoothAdapter == <span class="keyword">null</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 蓝牙未开启，则开启蓝牙</span></span><br><span class="line"><span class="keyword">if</span>(!mBluetoothAdapter.isEnabled()) &#123;</span><br><span class="line">    mBluetoothAdapter.enable();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 查询已绑定设备，发现新设备</span></span><br><span class="line">mBluetoothAdapter.getBondedDevices();</span><br><span class="line">mBluetoothAdapter.startDiscovery();</span><br></pre></td></tr></table></figure>
<p>还有一些读写之类的操作先不赘述。这些API调用的是frameworks里的代码，如getDefaultAdapter()函数对应<br><code>frameworks/base/core/java/android/bluetooth/BluetoothAdapter.java</code>文件里的getDefaultAdapter()函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> BluetoothAdapter <span class="title">getDefaultAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (sAdapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">       IBinder b = ServiceManager.getService(BLUETOOTH_MANAGER_SERVICE); <span class="comment">// 这里通过Binder通信调用packages里的Android应用程序的服务</span></span><br><span class="line">       <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">           IBluetoothManager managerService = IBluetoothManager.Stub.asInterface(b);</span><br><span class="line">           sAdapter = <span class="keyword">new</span> BluetoothAdapter(managerService);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Log.e(TAG, <span class="string">&quot;Bluetooth binder is null&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> sAdapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码片段中的<code>BLUETOOTH_MANAGER_SERVICE</code>是在<br><code>frameworks/base/services/core/java/com/android/server/BluetoothService.java</code>中注册的，会通过Binder机制调用到<br><code>packages/apps/Bluetooth/src/com/android/bluetooth/btservice/AdapterService.java</code>，AdapterService.enableNative()在<br><code>packages/apps/Bluetooth/jni/com_android_bluetooth_btservice_AdapterService.cpp</code>中声明，通过jni调用HAL(hardware)里的代码。hardware里的代码会调用system里的代码实现，具体代码我就不分析了，主要介绍一下如何调试。</p>
<h2 id="调试system中蓝牙相关代码"><a href="#调试system中蓝牙相关代码" class="headerlink" title="调试system中蓝牙相关代码"></a>调试system中蓝牙相关代码</h2><p>首先需要编译Android的源码，烧录到真机上，可以参考我之前的<a target="_blank" rel="noopener" href="http://pwn4.fun/2016/03/03/%E7%BC%96%E8%AF%91Android6-0-1%E6%BA%90%E7%A0%81%EF%BC%8C%E7%83%A7%E5%BD%95%E5%88%B0nexus5%E7%9C%9F%E6%9C%BA%E4%B8%8A/">一篇文章</a>，我的系统是Android6.0.1和Ubuntu 16.04。<br>前面分析了system的代码会由packages里的bluetooth应用程序调用，所以可以先尝试调试bluetooth的应用程序，跟踪代码到system层。接下来就是对Android应用native代码调试的操作，先手动打开蓝牙，打开一个终端（需要adb root）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell</span><br><span class="line">root@hammerhead:&#x2F; # ps | grep bluetooth</span><br><span class="line">bluetooth 9134  2265  907552 46368 sys_epoll_ b6ce9894 S com.android.bluetooth</span><br><span class="line">root@hammerhead:&#x2F; # gdbserver :1234 --attach 9134</span><br><span class="line">Attached; pid &#x3D; 9134</span><br><span class="line">Listening on port 1234</span><br></pre></td></tr></table></figure>
<p>另一个终端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ cd Android6.0.1_r20</span><br><span class="line">$ source build&#x2F;envsetup.h</span><br><span class="line">$ lunch 19</span><br><span class="line">$ adb forward tcp:1234 tcp:1234</span><br><span class="line">$ gdbclient 9134</span><br><span class="line">(gdb) target remote :1234</span><br><span class="line">Remote debugging using :1234</span><br><span class="line">warning: Could not load shared library symbols for 9 libraries, e.g. &#x2F;data&#x2F;dalvik-cache&#x2F;arm&#x2F;system@framework@boot.oat.</span><br><span class="line">Use the &quot;info sharedlibrary&quot; command to see the complete listing.</span><br><span class="line">Do you need &quot;set solib-search-path&quot; or &quot;set sysroot&quot;?</span><br><span class="line">Reading symbols from &#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;Android6.0.1-r20&#x2F;out&#x2F;target&#x2F;product&#x2F;hammerhead&#x2F;symbols&#x2F;system&#x2F;bin&#x2F;linker...done.</span><br><span class="line">Loaded symbols for &#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;Android6.0.1-r20&#x2F;out&#x2F;target&#x2F;product&#x2F;hammerhead&#x2F;symbols&#x2F;system&#x2F;bin&#x2F;linker</span><br><span class="line">Reading symbols from &#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;Android6.0.1-r20&#x2F;out&#x2F;target&#x2F;product&#x2F;hammerhead&#x2F;symbols&#x2F;system&#x2F;lib&#x2F;libcutils.so...done.</span><br><span class="line">Loaded symbols for &#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;Android6.0.1-r20&#x2F;out&#x2F;target&#x2F;product&#x2F;hammerhead&#x2F;symbols&#x2F;system&#x2F;lib&#x2F;libcutils.so</span><br><span class="line">...</span><br><span class="line">Loaded symbols for &#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;Android6.0.1-r20&#x2F;out&#x2F;target&#x2F;product&#x2F;hammerhead&#x2F;symbols&#x2F;system&#x2F;vendor&#x2F;lib&#x2F;libbt-vendor.so</span><br><span class="line">__epoll_pwait () at bionic&#x2F;libc&#x2F;arch-arm&#x2F;syscalls&#x2F;__epoll_pwait.S:16</span><br><span class="line">16      ldmfd   sp!, &#123;r4, r5, r6, r7&#125;</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<p>比如我们调试蓝牙搜索的相关代码，<br><code>/packages/apps/Bluetooth/src/com/android/bluetooth/btservice/AdapterService.java</code>中的<code>startDiscovery()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">startDiscovery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    enforceCallingOrSelfPermission(BLUETOOTH_ADMIN_PERM,</span><br><span class="line">                                   <span class="string">&quot;Need BLUETOOTH ADMIN permission&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> startDiscoveryNative();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>jni调用<br><code>/packages/apps/Bluetooth/jni/com_android_bluetooth_btservice_AdapterService.cpp</code>中的<code>startDiscoveryNative()</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">startDiscoveryNative</span><span class="params">(JNIEnv* env, jobject obj)</span> </span>&#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;%s:&quot;</span>,__FUNCTION__);</span><br><span class="line"></span><br><span class="line">    jboolean result = JNI_FALSE;</span><br><span class="line">    <span class="keyword">if</span> (!sBluetoothInterface) <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = sBluetoothInterface-&gt;start_discovery();</span><br><span class="line">    result = (ret == BT_STATUS_SUCCESS) ? JNI_TRUE : JNI_FALSE;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过查看<code>/packages/apps/Bluetooth/jni/Android.mk</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_MODULE :&#x3D; libbluetooth_jni</span><br></pre></td></tr></table></figure>
<p>可以知道bluetooth的jni代码被编译成了<code>libbluetooth_jni.so</code>库，在<br><code>Android6.0.1-r20/out/target/product/hammerhead/symbols/system/lib/libbluetooth_jni.so</code>，这个是带符号的，用IDA打开它。<br>打开一个终端，查看系统中so库加载的基址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell</span><br><span class="line"># cat &#x2F;proc&#x2F;2286&#x2F;maps | grep libbluetooth</span><br><span class="line">b39e7000-b39fe000 r-xp 00000000 b3:19 921        &#x2F;system&#x2F;lib&#x2F;libbluetooth_jni.so</span><br><span class="line">b39ff000-b3a00000 r--p 00017000 b3:19 921        &#x2F;system&#x2F;lib&#x2F;libbluetooth_jni.so</span><br><span class="line">b3a00000-b3a01000 rw-p 00018000 b3:19 921        &#x2F;system&#x2F;lib&#x2F;libbluetooth_jni.so</span><br></pre></td></tr></table></figure>
<p>在IDA-&gt;Edit-&gt;Segments-&gt;Rebase program…，将Value改成0xb39e7000，找到android::startDiscoveryNative()函数：<br><img src="/images/androiddebug/startdisnative.png"><br>在这个函数的起始地址是0xb39e9a80，在gdb中下断点，继续运行，让蓝牙对周围设备进行搜索，即可触发断点：<br><img src="/images/androiddebug/gdbblue.png"><br>单步运行，可以运行到<code>system/bt/btif/src/bluetooth.c</code>中的<code>start_discovery()</code>函数（gdb中按ctrl+x+a）：<br><img src="/images/androiddebug/debugsys.png">  </p>
<h2 id="system-bin中的可执行文件调试"><a href="#system-bin中的可执行文件调试" class="headerlink" title="/system/bin中的可执行文件调试"></a>/system/bin中的可执行文件调试</h2><h3 id="对于未启动进程：调试进程keystore"><a href="#对于未启动进程：调试进程keystore" class="headerlink" title="对于未启动进程：调试进程keystore"></a>对于未启动进程：调试进程keystore</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell gdbserver :1234 &#x2F;system&#x2F;bin&#x2F;keystore</span><br><span class="line">Process &#x2F;system&#x2F;bin&#x2F;keystore created; pid &#x3D; 3990</span><br><span class="line">Listening on port 1234</span><br></pre></td></tr></table></figure>
<p>另一个终端（需要先source、lunch）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ adb forward tcp:1234 tcp:1234</span><br><span class="line">$ gdbclient 3990</span><br><span class="line">Reading symbols from &#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;Android6.0.1-r20&#x2F;out&#x2F;target&#x2F;product&#x2F;hammerhead&#x2F;symbols&#x2F;system&#x2F;bin&#x2F;keystore...done.</span><br><span class="line">(gdb) target remote :1234</span><br><span class="line">__dl__start () at bionic&#x2F;linker&#x2F;arch&#x2F;arm&#x2F;begin.S:32</span><br><span class="line">32    mov r0, sp</span><br><span class="line">(gdb) si</span><br><span class="line">33    bl __linker_init</span><br></pre></td></tr></table></figure>

<h3 id="对于已经启动的进程"><a href="#对于已经启动的进程" class="headerlink" title="对于已经启动的进程"></a>对于已经启动的进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell</span><br><span class="line"># gdbserver :1234 --attach pid</span><br></pre></td></tr></table></figure>
<p>另一个终端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ adb forward tcp:1234 tcp:1234</span><br><span class="line">$ gdbclient pid</span><br><span class="line">(gdb) target remote :1234</span><br></pre></td></tr></table></figure>

<p><strong>reference</strong><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/ffmpeg4976/article/details/49048469">蓝牙流程介绍</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4ab864caefb2">Android FrameWork学习（二）Android系统源码调试</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/06/20/%E7%94%A8Python%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/06/20/%E7%94%A8Python%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">用Python实现简单的区块链（二）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2018-06-20 17:49:46" itemprop="dateCreated datePublished" datetime="2018-06-20T17:49:46+08:00">2018-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>继续<a target="_blank" rel="noopener" href="http://pwn4.fun/2018/05/20/%E7%94%A8Python%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%88%E4%B8%80%EF%BC%89/">上一篇文章</a>的内容，我们已经有一个可以证实的区块链了，但是现在链中只保存着一些无用的信息，这篇文章中我们将会实现简单的<code>钱包（wallet）</code>和<code>交易（transaction）</code>，用交易来替换这些数据，创建一个非常简单的加密货币：”NoobCoin”。  </p>
<h2 id="创建Wallet"><a href="#创建Wallet" class="headerlink" title="创建Wallet"></a>创建Wallet</h2><p>在加密货币中，币的所有权在区块链上通过交易转移，参与者有一个地址来发送和接收币。基本形式的钱包只能保存地址，但大多数钱包是能够在区块链上创建新交易的软件。<br><img src="/images/blockchain/wallet.png"><br>上图显示了钱包、交易和区块链的关系，钱包可以创建交易，交易被存储在区块中，一个区块中可以有多个交易。具体的内容下面会详细介绍。<br>首先创建一个钱包类来保存私钥和公钥，UTXOs的作用后面再介绍：<br><strong>代码清单</strong> wallet.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> ecdsa.util <span class="keyword">import</span> PRNG</span><br><span class="line"><span class="keyword">from</span> ecdsa <span class="keyword">import</span> SigningKey</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Wallet</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        rng = PRNG(<span class="built_in">str</span>(random.random()))</span><br><span class="line">        self.privateKey = SigningKey.generate(entropy=rng)</span><br><span class="line">        self.publicKey = self.privateKey.get_verifying_key()</span><br><span class="line">        self.UTXOs = &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>在noobcoin中，公钥实际上是作为地址使用的，被共享给其他人来接收付款。私钥是用来签名交易的，这样除了私钥的所有者，没有人能花我们的币。公钥也和交易一起发送，用来验证签名是合法的，数据没有被篡改。<br><img src="/images/blockchain/signature.png"><br>这里用的椭圆曲线加密来产生公私钥对，用到了一个第三方库<a target="_blank" rel="noopener" href="https://github.com/warner/python-ecdsa">python-ecdsa</a>。</p>
<h2 id="交易和签名"><a href="#交易和签名" class="headerlink" title="交易和签名"></a>交易和签名</h2><p>每个交易都会包含以下数据：</p>
<ul>
<li>资金发送者的公钥（地址）</li>
<li>资金接收者的公钥（地址）</li>
<li>转移资金的数目</li>
<li>输入（inputs），引用先前的交易，证明发送者有资金可以发送</li>
<li>输出（outputs），显示了接收资金的所有地址，这些输出在新交易中会被当做输入</li>
<li>加密签名，证明地址的所有者是发送这个交易的人，并且数据没有被篡改  </li>
</ul>
<p>下面创建交易类：<br><strong>代码清单</strong> transaction.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transaction</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, pubkey_from, pubkey_to, value, inputs</span>):</span></span><br><span class="line">        self.transactionId = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.sender = pubkey_from</span><br><span class="line">        self.reciepient = pubkey_to</span><br><span class="line">        self.value = value</span><br><span class="line">        self.inputs = inputs</span><br><span class="line">        self.outputs = []</span><br><span class="line">        self.sequence = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calculateHash</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.sequence += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> StringUtils.sha256(self.sender.to_string() + self.reciepient.to_string() + <span class="built_in">str</span>(self.value) + <span class="built_in">str</span>(self.sequence))</span><br></pre></td></tr></table></figure>
<p>在创建产生签名的方法之前，我们需要先在StringUtils类中加一些辅助函数：<br><strong>代码清单</strong> strutils.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">applyECDSASig</span>(<span class="params">prikey, inputs</span>):</span></span><br><span class="line">    <span class="keyword">return</span> prikey.sign(inputs)</span><br><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verifyECDSASig</span>(<span class="params">pubkey, data, signature</span>):</span></span><br><span class="line">    <span class="keyword">return</span> pubkey.verify(signature, data)</span><br></pre></td></tr></table></figure>
<p>现在我们把签名方法用到Transaction类中，添加一个generateSignature()和verifySignature()方法：<br><strong>代码清单</strong> transaction.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generateSignature</span>(<span class="params">self, prikey</span>):</span></span><br><span class="line">    data = self.sender.to_string() + self.reciepient.to_string() + <span class="built_in">str</span>(self.value)</span><br><span class="line">    self.signature = StringUtils.applyECDSASig(prikey, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verifySignature</span>(<span class="params">self</span>):</span></span><br><span class="line">    data = self.sender.to_string() + self.reciepient.to_string() + <span class="built_in">str</span>(self.value)</span><br><span class="line">    <span class="keyword">return</span> StringUtils.verifyECDSASig(self.sender, data, self.signature)</span><br></pre></td></tr></table></figure>
<p>实际中会签名更多的信息，例如outputs/inputs和timestamp等，但现在我们只签名最少的。一个新的交易添加到一个区块时，矿工将会验证签名。</p>
<h2 id="测试钱包和签名"><a href="#测试钱包和签名" class="headerlink" title="测试钱包和签名"></a>测试钱包和签名</h2><p>测试一下上面的代码：<br><strong>代码清单</strong> noobchain.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wallet <span class="keyword">import</span> Wallet</span><br><span class="line"><span class="keyword">from</span> transaction <span class="keyword">import</span> Transaction</span><br><span class="line">walletA = Wallet()</span><br><span class="line">walletB = Wallet()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Private and public keys: &quot;</span></span><br><span class="line"><span class="built_in">print</span> walletA.privateKey.to_pem()</span><br><span class="line"><span class="built_in">print</span> walletA.publicKey.to_pem()</span><br><span class="line"></span><br><span class="line">transaction = Transaction(walletA.publicKey, walletB.publicKey, <span class="number">5</span>, <span class="literal">None</span>);</span><br><span class="line">transaction.generateSignature(walletA.privateKey);</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Is signature verified&quot;</span></span><br><span class="line"><span class="built_in">print</span> transaction.verifySignature()</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ python noobchain.py</span><br><span class="line">Private and public keys:</span><br><span class="line">-----BEGIN EC PRIVATE KEY-----</span><br><span class="line">MF8CAQEEGIAnlP0QuZpVjYN8cF1g0VK+QIDhpySdUqAKBggqhkjOPQMBAaE0AzIA</span><br><span class="line">BF5wfHb88KlyjGkVeSSnqge&#x2F;4Q4vxDIlHkwu5BvrszPLaEHs00DVwFEFdmjp5wkv</span><br><span class="line">vw&#x3D;&#x3D;</span><br><span class="line">-----END EC PRIVATE KEY-----</span><br><span class="line"></span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MEkwEwYHKoZIzj0CAQYIKoZIzj0DAQEDMgAEXnB8dvzwqXKMaRV5JKeqB7&#x2F;hDi&#x2F;E</span><br><span class="line">MiUeTC7kG+uzM8toQezTQNXAUQV2aOnnCS+&#x2F;</span><br><span class="line">-----END PUBLIC KEY-----</span><br><span class="line"></span><br><span class="line">Is signature verified</span><br><span class="line">True</span><br></pre></td></tr></table></figure>
<p>上面的代码创建了两个钱包，打印了walletA的公私钥。创建了一个交易，用walletA的私钥给它签名。<br>接下来介绍outputs和inputs，并把交易保存到区块链。</p>
<h2 id="outputs-amp-inputs"><a href="#outputs-amp-inputs" class="headerlink" title="outputs &amp; inputs"></a>outputs &amp; inputs</h2><h3 id="加密货币是如何被拥有的"><a href="#加密货币是如何被拥有的" class="headerlink" title="加密货币是如何被拥有的"></a>加密货币是如何被拥有的</h3><p>你要拥有一个比特币需要先接收一个比特币，分布式账本并不会真的添加一个比特币给你，减少发送者的一个比特币，发送者会引用以前的交易证明他有一个比特币并作为input，然后创建一个交易output来证明发送了一个比特币到你的地址。（交易的input就是引用先前的交易output作为证明）<br>你钱包的余额就是所有未使用的地址是你的交易output的总和。<br>这里我们遵循比特币的惯例，称未使用的交易输出为：<code>UTXO</code>.<br>下面来创建TransactionInput和TransactionOutput类：<br><strong>代码清单</strong> transaction.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TransactionInput</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, transactionOutputId</span>):</span></span><br><span class="line">        self.transactionOutputId = transactionOutputId</span><br><span class="line">        self.UTXO = <span class="literal">None</span> <span class="comment"># 包含未使用的交易output</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TransactionOutput</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, pubkey_to, value, parentTransactionId</span>):</span></span><br><span class="line">        self.reciepient = pubkey_to</span><br><span class="line">        self.value = value</span><br><span class="line">        self.parentTransactionId = parentTransactionId</span><br><span class="line">        self.<span class="built_in">id</span> = StringUtils.sha256(pubkey_to.to_string()+<span class="built_in">str</span>(value)+parentTransactionId)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isMine</span>(<span class="params">self, publicKey</span>):</span></span><br><span class="line">        <span class="keyword">return</span> publicKey == self.reciepient</span><br></pre></td></tr></table></figure>
<p>大致的工作流程：初始钱包手动创建一个交易，给A钱包100个币，这个交易没有input，只有output。output显示接收者为A钱包，金额是100，output会被添加到全局UTXOs，这个交易会被添加到第0个区块，不会被验证。钱包A要给钱包B发送40个币，交易的input就是引用上一笔交易的output，证明自己有足够的币可以发送，交易会有两个output，一个是接收者为B钱包，金额是40，另一个是接收者为A钱包，金额是60（找零）。这两个output会被添加到全局UTXOs，并将交易的input引用的output从全局UTXOs中删除，这笔交易会被添加到区块上。</p>
<h3 id="处理交易"><a href="#处理交易" class="headerlink" title="处理交易"></a>处理交易</h3><p>链上的区块可能会接收到很多交易，区块链可能会很长，处理一个新的交易会花费大量的时间，因为我们必须要验证它的inputs。为了解决这个问题，就需要保存一个额外的集合：所有可用来做input的未花费output，因此我们新建一个config.py文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">blockchain = []</span><br><span class="line"><span class="comment"># 未使用的output</span></span><br><span class="line">UTXOs = &#123;&#125;</span><br><span class="line">minimumTransaction = <span class="number">0.1</span></span><br><span class="line">difficulty = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>在Transaction类中添加一个processTransaction()方法：<br><strong>代码清单</strong> transaction.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">processTransaction</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.verifySignature() == <span class="literal">False</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;#Transaction Signature failed to verify&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="comment"># 收集交易input（确保他们是未花费的）</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> self.inputs:</span><br><span class="line">        i.UTXO = config.UTXOs[i.transactionOutputId]</span><br><span class="line">    <span class="comment"># 输入的和不能小于最小交易额</span></span><br><span class="line">    <span class="keyword">if</span> self.getInputsValue() &lt; config.minimumTransaction:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;#Transaction Inputs too small: &quot;</span> + self.getInputsValue()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="comment"># 产生交易输出</span></span><br><span class="line">    leftOver = self.getInputsValue() - self.value</span><br><span class="line">    self.transactionId = self.calculateHash()</span><br><span class="line">    <span class="comment"># 发送value给reciptient</span></span><br><span class="line">    self.outputs.append(TransactionOutput(self.reciepient, self.value, self.transactionId))</span><br><span class="line">    <span class="comment"># 发送找零给sender</span></span><br><span class="line">    self.outputs.append(TransactionOutput(self.sender, leftOver, self.transactionId))</span><br><span class="line">    <span class="keyword">for</span> o <span class="keyword">in</span> self.outputs:</span><br><span class="line">        config.UTXOs[o.<span class="built_in">id</span>] = o</span><br><span class="line">    <span class="comment"># 从UTXO删除交易inputs当做花费</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> self.inputs:</span><br><span class="line">        <span class="keyword">if</span> i.UTXO == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">del</span> config.UTXOs[i.UTXO.<span class="built_in">id</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回输入值的和</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getInputsValue</span>(<span class="params">self</span>):</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> self.inputs:</span><br><span class="line">        <span class="keyword">if</span> i.UTXO == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        total += i.UTXO.value</span><br><span class="line">    <span class="keyword">return</span> total</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回输出值的和</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getOutputsValue</span>(<span class="params">self</span>):</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> o <span class="keyword">in</span> self.outputs:</span><br><span class="line">        total += o.value</span><br><span class="line">    <span class="keyword">return</span> total</span><br></pre></td></tr></table></figure>
<p>我们用这个方法来做一些检查，确保交易是合法的。最后，我们从UTXOs中删除了input引用到的output，意味着一个交易的output只能被用做一次input。<br>最后再来更新钱包：</p>
<ul>
<li>收集我们的余额（通过遍历UTXOs列表来检查交易的output是否是自己的）</li>
<li>为我们创建交易</li>
</ul>
<p><strong>代码清单</strong> wallet.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> config</span><br><span class="line"><span class="keyword">from</span> transaction <span class="keyword">import</span> Transaction, TransactionInput</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Wallet</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="comment"># 计算自己的余额</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getBalance</span>(<span class="params">self</span>):</span></span><br><span class="line">        total = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> config.UTXOs.items():</span><br><span class="line">            UTXO = item[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> UTXO.isMine(self.publicKey): <span class="comment"># 将全局UTXOs中是自己的output添加到自己钱包的UTXOs</span></span><br><span class="line">                self.UTXOs[UTXO.<span class="built_in">id</span>] = UTXO</span><br><span class="line">                total += UTXO.value</span><br><span class="line">        <span class="keyword">return</span> total</span><br><span class="line">    <span class="comment"># 发送金额给其他人</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sendFunds</span>(<span class="params">self, _recipient, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.getBalance() &lt; value:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;#Not Enough funds to send transaction. Transaction Discarded.&quot;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        inputs = []</span><br><span class="line">        total = <span class="number">0</span></span><br><span class="line">        <span class="comment"># 需要引用到的output</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.UTXOs.items():</span><br><span class="line">            UTXO = item[<span class="number">1</span>]</span><br><span class="line">            total += UTXO.value</span><br><span class="line">            inputs.append(TransactionInput(UTXO.<span class="built_in">id</span>))</span><br><span class="line">            <span class="keyword">if</span> total &gt; value:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># 创建交易</span></span><br><span class="line">        newTransaction = Transaction(self.publicKey, _recipient, value, inputs)</span><br><span class="line">        newTransaction.generateSignature(self.privateKey)</span><br><span class="line">        <span class="comment"># 删除引用过的output</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> inputs:</span><br><span class="line">            <span class="keyword">del</span> self.UTXOs[i.transactionOutputId]</span><br><span class="line">        <span class="keyword">return</span> newTransaction</span><br></pre></td></tr></table></figure>

<h2 id="添加交易到区块上"><a href="#添加交易到区块上" class="headerlink" title="添加交易到区块上"></a>添加交易到区块上</h2><p>现在交易系统已经可以运行，我们需要把它实现到区块链上。把区块链上无用的数据替换为一个交易的列表。一个区块上可能会有上千个交易，对于计算hash来说需要包含的太多。因此，我们使用交易的<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fengzhiwu/p/5524324.html">merkle root</a>。在StringUtils类中添加一个产生merkleroot的辅助方法：<br><strong>代码清单</strong> strutils.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getMerkleRoot</span>(<span class="params">transactions</span>):</span></span><br><span class="line">    count = <span class="built_in">len</span>(transactions)</span><br><span class="line">    previousTreeLayer = []</span><br><span class="line">    <span class="keyword">for</span> transaction <span class="keyword">in</span> transactions:</span><br><span class="line">        previousTreeLayer.append(transaction.transactionId)</span><br><span class="line">    treeLayer = previousTreeLayer</span><br><span class="line">    <span class="keyword">while</span> count &gt; <span class="number">1</span>:</span><br><span class="line">        treeLayer = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(previous)):</span><br><span class="line">            treeLayer.append(sha256(previousTreeLayer[i<span class="number">-1</span>]+previousTreeLayer[i]))</span><br><span class="line">        count = <span class="built_in">len</span>(treeLayer)</span><br><span class="line">        previousTreeLayer = treeLayer</span><br><span class="line">    merkleRoot = treeLayer[<span class="number">0</span>] <span class="keyword">if</span> <span class="built_in">len</span>(treeLayer) == <span class="number">1</span> <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> merkleRoot</span><br></pre></td></tr></table></figure>
<p>接下来修改Block类：<br><strong>代码清单</strong> block.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Block</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, previousHash</span>):</span></span><br><span class="line">        self.previousHash = previousHash</span><br><span class="line">        self.timeStamp = time.time()</span><br><span class="line">        self.transactions = []</span><br><span class="line">        self.nonce = <span class="number">0</span></span><br><span class="line">        self.merkleRoot = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.<span class="built_in">hash</span> = self.calculateHash()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calculateHash</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> StringUtils.sha256(self.previousHash+<span class="built_in">str</span>(self.timeStamp)+<span class="built_in">str</span>(self.nonce)+self.merkleRoot)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mineBlock</span>(<span class="params">self, difficulty</span>):</span></span><br><span class="line">        self.merkleRoot = StringUtils.getMerkleRoot(self.transactions)</span><br><span class="line">        target = <span class="string">&#x27;0&#x27;</span>*difficulty</span><br><span class="line">        <span class="keyword">while</span> self.<span class="built_in">hash</span>[<span class="number">0</span>:difficulty] != target:</span><br><span class="line">            self.nonce += <span class="number">1</span></span><br><span class="line">            self.<span class="built_in">hash</span> = self.calculateHash()</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Block Mined!!! : &quot;</span> + self.<span class="built_in">hash</span></span><br><span class="line">    <span class="comment"># 将交易添加到这个区块上</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addTransaction</span>(<span class="params">self, transaction</span>):</span></span><br><span class="line">        <span class="keyword">if</span> transaction == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> self.previousHash != <span class="string">&quot;0&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> transaction.processTransaction() != <span class="literal">True</span>:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&quot;Transaction failed to process. Discarded.&quot;</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        self.transactions.append(transaction)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Transaction Successfully added to Block&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<h2 id="运行noobcoin"><a href="#运行noobcoin" class="headerlink" title="运行noobcoin"></a>运行noobcoin</h2><p>我们需要测试用钱包发送和接收币，更新我们区块链的合法性检查。有许多方法来创建新币，在比特币区块链，矿工可以用一笔交易作为挖到区块的奖励。现在，我们直接释放我们想用到的所有币，在第0个区块（genesis block）。就像比特币，我们将硬编码Genesis区块。<br>我们来更新noobchain.py文件：</p>
<ul>
<li>一个Genesis区块，释放100个noobcoin给walletA</li>
<li>一个更新的链合法性检查，将交易考虑在内</li>
<li>一些测试交易，来看看是否运行正常</li>
</ul>
<p><strong>代码清单</strong> noobchain.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> config</span><br><span class="line"><span class="keyword">from</span> block <span class="keyword">import</span> Block</span><br><span class="line"><span class="keyword">from</span> wallet <span class="keyword">import</span> Wallet</span><br><span class="line"><span class="keyword">from</span> transaction <span class="keyword">import</span> Transaction, TransactionOutput, TransactionInput</span><br><span class="line"></span><br><span class="line">walletA = Wallet()</span><br><span class="line">walletB = Wallet()</span><br><span class="line">coinbase = Wallet()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将coinbase里的100个coin给A</span></span><br><span class="line">genesisTransaction = Transaction(coinbase.publicKey, walletA.publicKey, <span class="number">100</span>, <span class="literal">None</span>)</span><br><span class="line">genesisTransaction.generateSignature(coinbase.privateKey)</span><br><span class="line">genesisTransaction.transactionId = <span class="string">&quot;0&quot;</span></span><br><span class="line">genesisTransaction.outputs.append(TransactionOutput(genesisTransaction.reciepient, genesisTransaction.value, genesisTransaction.transactionId))</span><br><span class="line">config.UTXOs[genesisTransaction.outputs[<span class="number">0</span>].<span class="built_in">id</span>] = genesisTransaction.outputs[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Creating and Mining Genesis block... &quot;</span></span><br><span class="line">genesis = Block(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">genesis.addTransaction(genesisTransaction)</span><br><span class="line">genesis.mineBlock(config.difficulty)</span><br><span class="line">config.blockchain.append(genesis)</span><br><span class="line"></span><br><span class="line"><span class="comment"># testing</span></span><br><span class="line">block1 = Block(genesis.<span class="built_in">hash</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;walletA&#x27;s balance is: %f&quot;</span> % walletA.getBalance()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;walletA is attempting to send funds (40) to walletB...&quot;</span></span><br><span class="line">block1.addTransaction(walletA.sendFunds(walletB.publicKey, <span class="number">40</span>))</span><br><span class="line">block1.mineBlock(config.difficulty)</span><br><span class="line">config.blockchain.append(block1)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;walletA&#x27;s balance is: %f&quot;</span>  % walletA.getBalance()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;walletB&#x27;s balance is: %f&quot;</span>  % walletB.getBalance()</span><br><span class="line"></span><br><span class="line">block2 = Block(block1.<span class="built_in">hash</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;walletA is attempting to send more funds (1000) than it has...&quot;</span></span><br><span class="line">block2.addTransaction(walletA.sendFunds(walletB.publicKey, <span class="number">1000</span>))</span><br><span class="line">block2.mineBlock(config.difficulty)</span><br><span class="line">config.blockchain.append(block2)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;walletA&#x27;s balance is: %f&quot;</span> % walletA.getBalance()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;walletB&#x27;s balance is: %f&quot;</span> % walletB.getBalance()</span><br><span class="line"></span><br><span class="line">block3 = Block(block2.<span class="built_in">hash</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;walletB is attempting to send funds (20) to walletA...&quot;</span></span><br><span class="line">block3.addTransaction(walletB.sendFunds(walletA.publicKey, <span class="number">20</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;walletA&#x27;s balance is: %f&quot;</span> % walletA.getBalance()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;walletB&#x27;s balance is: %f&quot;</span> % walletB.getBalance()</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ python noobchain.py</span><br><span class="line">Creating and Mining Genesis block...</span><br><span class="line">Transaction Successfully added to Block</span><br><span class="line">Block Mined!!! : 000ecc366d3c553e131693c972dc77b7f2bb7c8156aa7125bb10c9e4052d8874</span><br><span class="line">walletA&#39;s balance is: 100.000000</span><br><span class="line">walletA is attempting to send funds (40) to walletB...</span><br><span class="line">Transaction Successfully added to Block</span><br><span class="line">Block Mined!!! : 0005af73ad51e2a0fa80444bdd284342c102dc202c9139889f62a3f989d8343d</span><br><span class="line">walletA&#39;s balance is: 60.000000</span><br><span class="line">walletB&#39;s balance is: 40.000000</span><br><span class="line">walletA is attempting to send more funds (1000) than it has...</span><br><span class="line">#Not Enough funds to send transaction. Transaction Discarded.</span><br><span class="line">Block Mined!!! : 00035606ee8cd61c0afb21c496193fdfc67a17172befd6cae90d7a9410a27d5f</span><br><span class="line">walletA&#39;s balance is: 60.000000</span><br><span class="line">walletB&#39;s balance is: 40.000000</span><br><span class="line">walletB is attempting to send funds (20) to walletA...</span><br><span class="line">Transaction Successfully added to Block</span><br><span class="line">walletA&#39;s balance is: 80.000000</span><br><span class="line">walletB&#39;s balance is: 20.000000</span><br></pre></td></tr></table></figure>
<p>我们的钱包现在可以在区块链上发送资金了，我们有了一个本地的加密货币。最后，再加上检查区块链合法性的方法即可：<br><strong>代码清单</strong> noobchain.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isChainValid</span>():</span></span><br><span class="line">    hashTarget = <span class="string">&#x27;0&#x27;</span> * config.difficulty</span><br><span class="line">    tempUTXOs = &#123;&#125;</span><br><span class="line">    tempUTXOs[genesisTransaction.outputs[<span class="number">0</span>].<span class="built_in">id</span>] = genesisTransaction.outputs[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(config.blockchain)):</span><br><span class="line">        curblock = config.blockchain[i]</span><br><span class="line">        preblock = config.blockchain[i<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">if</span> curblock.<span class="built_in">hash</span> != curblock.calculateHash():</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;Current Hashes not equal&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> preblock.<span class="built_in">hash</span> != curblock.previousHash:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;Previous Hashes not equal&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> curblock.<span class="built_in">hash</span>[:config.difficulty] != hashTarget:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;#This block hasnt been mined&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(curblock.transactions)):</span><br><span class="line">            curTransaction = curblock.transactions[t]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> curTransaction.verifySignature():</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;#Signature on Transaction %d is Invalid&#x27;</span> % t</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">if</span> curTransaction.getInputsValue() != curTransaction.getOutputsValue():</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;#Inputs are not equal to outputs on Transaction %d&#x27;</span> % t</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> curTransaction.inputs:</span><br><span class="line">                tempOutput = tempUTXOs[i.transactionOutputId]</span><br><span class="line">                <span class="keyword">if</span> tempOutput == <span class="literal">None</span>:</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;#Referenced input on Transaction %d is Missing&#x27;</span> % t</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                <span class="keyword">if</span> i.UTXO.value != tempOutput.value:</span><br><span class="line">                    <span class="built_in">print</span> <span class="string">&#x27;#Referenced input Transaction %d value is Invalid&#x27;</span> % t</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                <span class="keyword">del</span> tempUTXOs[i.transactionOutputId]</span><br><span class="line">            <span class="keyword">for</span> o <span class="keyword">in</span> curTransaction.outputs:</span><br><span class="line">                tempUTXOs[o.<span class="built_in">id</span>] = o</span><br><span class="line">            <span class="keyword">if</span> curTransaction.outputs[<span class="number">0</span>].reciepient != curTransaction.reciepient:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;#Transaction %d output reciepient is not who it should be&#x27;</span> % t</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">if</span> curTransaction.outputs[<span class="number">1</span>].reciepient != curTransaction.sender:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;#Transaction %d output change is not sender&#x27;</span> % t</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;Blockchain is valid&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/fanrong1992/py-blockchain">项目完整代码</a><br><strong>reference</strong><br><a target="_blank" rel="noopener" href="https://medium.com/programmers-blockchain/creating-your-first-blockchain-with-java-part-2-transactions-2cdac335e0ce">https://medium.com/programmers-blockchain/creating-your-first-blockchain-with-java-part-2-transactions-2cdac335e0ce</a><br><a target="_blank" rel="noopener" href="https://github.com/warner/python-ecdsa">https://github.com/warner/python-ecdsa</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fengzhiwu/p/5524324.html">https://www.cnblogs.com/fengzhiwu/p/5524324.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/06/10/%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/06/10/%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BA/" class="post-title-link" itemprop="url">支持向量机</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2018-06-10 09:48:52" itemprop="dateCreated datePublished" datetime="2018-06-10T09:48:52+08:00">2018-06-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>支持向量机是一种二分类模型。它的基本模型是定义在特征空间上的间隔最大的线性分类器，支持向量机还包括核技巧，这使它成为实质上的非线性分类器。支持向量机的学习策略就是间隔最大化，可形式化为一个求解凸二次规划的问题。<br>支持向量机学习方法包含构建由简至繁的模型：  </p>
<ul>
<li>当训练数据线性可分时，通过硬间隔最大化（hard margin maximization），学习一个线性的分类器，即线性可分支持向量机。</li>
<li>当训练数据近似线性可分时，通过软间隔最大化（soft margin maximization），也学习一个线性的分类器，即线性支持向量机。</li>
<li>当训练数据线性不可分时，通过使用核技巧（kernel trick）及软间隔最大化，学习非线性支持向量机。</li>
</ul>
<h2 id="间隔与支持向量"><a href="#间隔与支持向量" class="headerlink" title="间隔与支持向量"></a>间隔与支持向量</h2><p>给定训练样本集$D={(\boldsymbol{x_1},y_1),(\boldsymbol{x_2},y_2),…,(\boldsymbol{x_m},y_m)}, y_m\in{-1,+1}$，分类学习最基本的想法就是基于训练集D在样本空间中找到一个划分超平面，将不同类别的样本分开。<br><img src="/images/machinelearning/svm1.png"><br>能将两类训练样本分开的超平面有很多，应该找两类训练样本正中间的划分超平面，因为该划分超平面对训练样本局部扰动的容忍性最好，产生的分类结果是最鲁棒的，对未见实例的泛化能力最强。<br>在样本空间中，划分超平面可通过如下线性方程来描述：</p>
<p>$$<br>\begin{aligned}<br>\boldsymbol{w^{T}x}+b=0<br>\end{aligned}\tag{1}<br>$$<br>其中$\boldsymbol{w}=(w_1;w_2;…;w_d)$为法向量，决定了超平面的方向，b为位移项，决定了超平面与原点之间的距离。划分超平面可被法向量$\boldsymbol{w}$和位移b确定，下面将其记为$(\boldsymbol{w},b)$。样本空间中任意点$\boldsymbol{x}$到超平面$(\boldsymbol{w},b)$的距离可写为</p>
<p>$$<br>\begin{aligned}<br>r=\frac{|\boldsymbol{w^Tx}+b|}{||\boldsymbol{w}||}<br>\end{aligned}\tag{2}<br>$$<br>假设超平面$(\boldsymbol{w},b)$能将训练样本正确分类，即对于$(\boldsymbol{x_i},y_i)\in D$，若$y_i=+1$，则有$\boldsymbol{w^Tx_i}+b&gt;0$；若$y_i=-1$，则有$\boldsymbol{w^Tx_i}+b&lt;0$。令</p>
<p>$$<br>\begin{cases}<br>\boldsymbol{w^Tx_i}+b \geqslant +1, &amp; y_i=+1; \\<br>\boldsymbol{w^Tx_i}+b \leqslant -1, &amp; y_i=-1.<br>\end{cases}\tag{3}<br>$$<br>如下图所示，距离超平面最近的这几个训练样本点使式(3)等号成立，它们被称为<code>支持向量（support vector）</code>，这两类支持向量到超平面的距离之和为</p>
<p>$$<br>\begin{aligned}<br>\gamma=\frac{2}{||\boldsymbol{w}||}<br>\end{aligned}\tag{4}<br>$$<br>它被称为<code>间隔（margin）</code>。<br><img src="/images/machinelearning/svm2.png"><br>要找到具有<code>最大间隔（maximum margin）</code>的划分超平面，也就是要找到能满足式(3)中约束的参数$\boldsymbol{w}$和$b$，使得$\gamma$最大，即</p>
<p>$$<br>\begin{aligned}<br>&amp; \max_{\boldsymbol{w},b}\frac{2}{||\boldsymbol{w}||} \\<br>&amp; s.t. \ y_i(\boldsymbol{w^Tx_i}+b) \geqslant 1, \quad i=1,2,…,m.<br>\end{aligned}\tag{5}<br>$$<br>为了最大化间隔，需最大化$||\boldsymbol{w}||^{-1}$，等价于最小化$||\boldsymbol{w}||^2$。因此，式(5)可写为</p>
<p>$$<br>\begin{aligned}<br>&amp; \min_{\boldsymbol{w},b}\frac{1}{2}||\boldsymbol{w}||^2 \\<br>&amp; s.t. \ y_i(\boldsymbol{w^Tx_i}+b) \geqslant 1, \quad i=1,2,…,m.<br>\end{aligned}\tag{6}<br>$$<br>这就是<code>支持向量机（Support Vector Machine）</code>的基本型。</p>
<h2 id="对偶问题"><a href="#对偶问题" class="headerlink" title="对偶问题"></a>对偶问题</h2><p>式(6)是一个<code>凸二次规划（convex quadratic programming）</code>问题，能直接用现成的优化计算包求解，但还有更高效的办法。对式(6)使用拉格朗日乘子法可得到其<code>对偶问题（dual problem）</code>。对式(6)的每条约束添加拉格朗日乘子$\alpha_i\geqslant0$，则该问题的拉格朗日函数可写为</p>
<p>$$<br>\begin{aligned}<br>L(\boldsymbol{w},b,\boldsymbol{\alpha})=\frac{1}{2}||\boldsymbol{w}||^2+\sum_{i=1}^m\alpha_i(1-y_i(\boldsymbol{w^Tx_i}+b)),<br>\end{aligned}\tag{7}<br>$$<br>其中$\boldsymbol{\alpha}=(\alpha_1;\alpha_2;…;\alpha_m)$。令$L(\boldsymbol{w},b,\boldsymbol{\alpha})$对$\boldsymbol{w}$和$b$的偏导为零可得</p>
<p>$$<br>\begin{eqnarray}<br>\boldsymbol{w} &amp;=&amp; \sum_{i=1}^m\alpha_iy_ix_i, \tag{8} \\<br>0 &amp;=&amp; \sum_{i=1}^m\alpha_iy_i. \tag{9}<br>\end{eqnarray}<br>$$<br>将式(8)代入(7)，即可将$L(\boldsymbol{w},b,\boldsymbol{\alpha})$中的$\boldsymbol{w}$和$b$消去，再考虑式(9)的约束，就得到式(6)的对偶问题</p>
<p>$$<br>\begin{aligned}<br>&amp; \max_\alpha\sum_{i=1}^m\alpha_i-\frac{1}{2}\sum_{i=1}^m\sum_{j=1}^m\alpha_i\alpha_jy_iy_j\boldsymbol{x_i^Tx_j} \\<br>&amp; s.t. \ \sum_{i=1}^m\alpha_iy_i=0, \\<br>&amp; \alpha_i \geqslant 0, \qquad i=1,2,…,m.<br>\end{aligned}\tag{10}<br>$$<br>解出$\alpha$后，求出$\boldsymbol{w}$与$b$即可得到模型</p>
<p>$$<br>\begin{aligned}<br>f(x)&amp;=\boldsymbol{w^Tx}+b \\<br>&amp;=\sum_{i=1}^m\alpha_iy_i\boldsymbol{x_i^Tx}+b<br>\end{aligned}\tag{11}<br>$$<br>从对偶问题(10)解出的$\alpha_i$是式(7)中的拉格朗日乘子，它对应着训练样本$(\boldsymbol{x_i},y_i)$。注意到式(6)中有不等式约束，因此上述过程需满足<code>KKT（Karush-Kuhn-Tucker）</code>条件，即要求</p>
<p>$$<br>\begin{cases}<br>\alpha_i\geqslant 0; \\<br>y_if(x_i)-1\geqslant 0; \\<br>\alpha_i(y_if(x_i)-1)=0.<br>\end{cases}\tag{12}<br>$$<br>于是，对任意训练样本$(\boldsymbol{x_i},y_i)$，总有$\alpha_i=0$或$y_if(\boldsymbol{x_i})=1$。若$\alpha_i=0$，则该样本不会在式(11)的求和中出现，也就不会对$f(x)$有任何影响；若$\alpha_i&gt;0$，则必有$y_if(\boldsymbol{x_i})=1$，所对应的样本点位于最大间隔边界上，是一个支持向量。支持向量机的一个重要性质：训练完成后，大部分的训练样本都不需要保留，最终模型仅与支持向量有关。<br>式(10)是一个二次规划问题，可以用通用的二次规划算法求解，但是该问题的规模正比于训练样本数，人们通过利用问题本身的特性，提出了很多高效算法，<code>SMO（Sequential Minimal Optimization）</code>是最流行的一种。<br>SMO的思想是每次选取两个变量$\alpha_i$和$\alpha_j$，并固定其他的参数$\alpha_k$，求解式(10)获得更新后的$\alpha_i$和$\alpha_j$，不断迭代直至收敛。SMO采用了一个启发式：使选取的两变量所对应样本之间的间隔最大。仅考虑$\alpha_i$和$\alpha_j$时，式(10)中的约束可重写为：</p>
<p>$$<br>\begin{aligned}<br>\alpha_iy_i+\alpha_jy_j=-\sum_{k\neq i,j}\alpha_ky_k=c<br>\end{aligned}\tag{13}<br>$$<br>消去式(10)中的变量$\alpha_j$，则得到一个关于$\alpha_i$的单变量二次规划问题，仅有的约束是$\alpha_i\geqslant0$。这样的二次规划具有闭式解，不必调用数值优化算法即可高效地计算出更新后的$\alpha_i$和$\alpha_j$。<br>根据式(8)可求出$\boldsymbol{w}$，对于$b$，可以用任意一个支持向量的性质$y_s(\boldsymbol{w^Tx_s}+b)=1$来计算。当然现实任务中采用更鲁棒的做法，使用所有支持向量求解的平均值。</p>
<h2 id="软间隔支持向量机"><a href="#软间隔支持向量机" class="headerlink" title="软间隔支持向量机"></a>软间隔支持向量机</h2><p>基础型的SVM的假设所有样本在样本空间是线性可分的（硬间隔），但现实中的情况通常不满足这种特性。为此，要引入<code>软间隔（soft margin）</code>的概念。<br><img src="/images/machinelearning/soft.png"><br>允许某些样本不满足约束 $y_i(\boldsymbol{w^Tx_i}+b)\geqslant1$，当然，在最大化间隔的同时，不满足约束的样本应尽可能少。</p>
<h2 id="核函数"><a href="#核函数" class="headerlink" title="核函数"></a>核函数</h2><p>前面的讨论中，假设的训练样本是线性可分的，即存在一个划分超平面能将训练样本正确分类。然而现实任务中，原始样本空间内也许并不存在能正确划分两类样本的超平面。<br><img src="/images/machinelearning/nonlinear.png"><br>这样的问题，可将样本从原始空间映射到一个更高维的特征空间，使得样本在这个特征空间内线性可分。令$\phi(\boldsymbol{x})$表示将$\boldsymbol{x}$映射后的特征向量，在特征空间中划分超平面所对应的模型可表示为</p>
<p>$$<br>\begin{aligned}<br>f(\boldsymbol{x})=\boldsymbol{w^T}\phi(\boldsymbol{x})+b<br>\end{aligned}\tag{14}<br>$$<br>其中$\boldsymbol{w}$和$b$是模型参数，间隔最大化类似式(6)</p>
<p>$$<br>\begin{aligned}<br>&amp; \min_{\boldsymbol{w},b}\frac{1}{2}||\boldsymbol{w}||^2 \\<br>&amp; s.t. \ y_i(\boldsymbol{w^T}\phi(\boldsymbol{x_i})+b)\geqslant1, \quad i=1,2,…,m.<br>\end{aligned}\tag{15}<br>$$<br>其对偶问题是</p>
<p>$$<br>\begin{aligned}<br>&amp; \max_{\alpha}\sum_{i=1}^m\alpha_i-\frac{1}{2}\sum_{i=1}^m\sum_{j=1}^m\alpha_i\alpha_jy_iy_j\phi(\boldsymbol{x_i})\cdot\phi(\boldsymbol{x_j}) \\<br>&amp; s.t. \ \sum_{i=1}^m\alpha_iy_i=0, \\<br>&amp; \alpha_i\geqslant0, \quad i=1,2,…,m.<br>\end{aligned}\tag{16}<br>$$<br>式中$\phi(\boldsymbol{x_i})\cdot\phi(\boldsymbol{x_j})$为$\phi(\boldsymbol{x_i})$和$\phi(\boldsymbol{x_j})$的内积。<br><strong>核函数的定义：</strong> 设$\mathcal{X}$是输入空间（欧式空间$\boldsymbol{R^n}$的子集或离散集合），又设$\mathcal{H}$为特征空间，如果存在一个从$\mathcal{X}$到$\mathcal{H}$的映射</p>
<p>$$<br>\phi(\boldsymbol{x}):\mathcal{X} \to \mathcal{H}<br>$$<br>使得对所有$\boldsymbol{x_i,x_j}\in\mathcal{X}$，函数$K(\boldsymbol{x_i,x_j})$满足条件</p>
<p>$$<br>K(\boldsymbol{x_i,x_j})=\phi(\boldsymbol{x_i})\cdot\phi(\boldsymbol{x_j})<br>$$<br>则称$K(\boldsymbol{x_i,x_j})$为核函数，$\phi(\boldsymbol{x})$为映射函数。<br>核技巧的想法是，在学习与预测中只定义核函数$K(\boldsymbol{x_i,x_j})$，而不显式定义映射函数。通常，直接计算核函数比较容易，计算映射函数的内积很困难，因为特征空间的维数可能很高，甚至是无穷维。</p>
<p><strong>reference</strong><br>《机器学习》<br>《统计学习方法》</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/06/01/%E5%86%B3%E7%AD%96%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/06/01/%E5%86%B3%E7%AD%96%E6%A0%91/" class="post-title-link" itemprop="url">决策树</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2018-06-01 11:59:00" itemprop="dateCreated datePublished" datetime="2018-06-01T11:59:00+08:00">2018-06-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>分类决策树模型是一种描述对实例进行分类的树形结构，决策树由结点和有向边组成，结点有两种类型：内部结点和叶结点。内部结点表示一个特征或属性，叶结点表示一个类。<br>用决策树分类，从根结点开始，对实例的某一特征进行测试，根据测试结果，将实例分配到其子结点；这时，每一个子结点对应着该特征的一个取值。如此递归地对实例进行测试并分配，直至达到叶结点。最后将实例分到叶结点的类中。决策树学习的目的是为了产生一个泛化能力强，即处理未见示例能力强的决策树，其基本流程遵循简单且直观的分而治之（divide-and-conquer）策略。  </p>
<h2 id="决策树的构造"><a href="#决策树的构造" class="headerlink" title="决策树的构造"></a>决策树的构造</h2><p>在构造决策树时，我们需要解决的第一个问题就是，当前数据集上哪个特征在划分数据分类时起决定性作用。为了找到决定性的特征，划分出最好的结果，我们必须评估每个特征。完成测试之后，原始数据集就被划分为几个数据子集。这些数据子集会分布在第一个决策点的所有分支上。如果某个分支下的数据属于同一类型，则已正确地划分数据分类。<br>下面我们将用<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/ID3_algorithm">ID3算法</a>划分数据集（还有C4.5算法和CART算法，这里先不讨论）。每次划分数据集时我们只选取一个特征属性，那么就需要知道选哪些特征作为划分的参考属性。<br>下表中有5个海洋动物，特征包括不浮出水面是否可以生存，是否有脚蹼。我们可以将这些动物分成两类：鱼类和非鱼类。要决定用第一个特征还是第二个特征划分数据，需要用到量化的方法——<code>信息增益</code>。</p>
<table>
<thead>
<tr>
<th align="center">序号</th>
<th align="center">不浮出水面可以生存</th>
<th align="center">有脚蹼</th>
<th align="center">属于鱼类</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">是</td>
<td align="center">是</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">是</td>
<td align="center">是</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">是</td>
<td align="center">否</td>
<td align="center">否</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">否</td>
<td align="center">是</td>
<td align="center">否</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">否</td>
<td align="center">是</td>
<td align="center">否</td>
</tr>
</tbody></table>
<h3 id="信息增益"><a href="#信息增益" class="headerlink" title="信息增益"></a>信息增益</h3><p>划分数据集的大原则是：将无序的数据变得更加有序。在划分数据集前后信息发生的变化称为<code>信息增益（information gain）</code>，可以计算每个特征值划分数据集获得的信息增益，信息增益越大，说明划分之后的信息熵越小，即数据更加有序。所以信息增益最高的特征就是我们要选择的。<br>信息论中度量信息的方式称为<code>熵（entropy）</code>，熵定义为信息的期望值。假定当前样本集合$D$中第$i$类样本所占的比例为$p_i$(i = 1,2,…,n)，则$D$的信息熵定义为</p>
<p>$$<br>H(D) = -\sum_{i=1}^n p_i log_2 p_i<br>$$</p>
<p>$H(D)$的值越小，则$D$越有序。<br>假定离散属性$a$有$K$个可能的取值{$a^1,a^2,…,a^K$}，用$a$对样本集$D$进行划分，则会产生$K$个分支结点，其中第$k$个分支结点包含了$D$中所有属性$a$的属性值为$a^k$的样本，记为$D^k$。根据上面信息熵公式可以算出$H(D^k)$，再考虑到各个分支所包含的样本数不同，给其赋予权重$|D^v|/|D|$，于是可以计算出属性$a$对样本集$D$进行划分的信息增益：</p>
<p>$$<br>G(D,a) = H(D)-\sum_{k=1}^K \frac{|D^k|}{|D|} H(D^k)<br>$$</p>
<h3 id="划分数据集"><a href="#划分数据集" class="headerlink" title="划分数据集"></a>划分数据集</h3><p>下面用Python来计算信息熵，创建trees.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> log</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcShannonEnt</span>(<span class="params">dataSet</span>):</span></span><br><span class="line">    numEntries = <span class="built_in">len</span>(dataSet) <span class="comment"># 计算信息数目</span></span><br><span class="line">    labelCounts = &#123;&#125;</span><br><span class="line">    <span class="comment"># 将信息保存到字典中</span></span><br><span class="line">    <span class="keyword">for</span> featVec <span class="keyword">in</span> dataSet:</span><br><span class="line">        currentLabel = featVec[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">if</span> currentLabel <span class="keyword">not</span> <span class="keyword">in</span> labelCounts.keys():</span><br><span class="line">            labelCounts[currentLabel] = <span class="number">0</span></span><br><span class="line">        labelCounts[currentLabel] += <span class="number">1</span></span><br><span class="line">    shannonEnt = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> labelCounts:</span><br><span class="line">        <span class="comment"># 计算每种类别的概率</span></span><br><span class="line">        prob = <span class="built_in">float</span>(labelCounts[key])/numEntries</span><br><span class="line">        shannonEnt -= prob * log(prob, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> shannonEnt</span><br></pre></td></tr></table></figure>
<p>接下来在trees.py中创建简单鱼鉴定数据集：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createDataSet</span>():</span></span><br><span class="line">    dataSet = [[<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;yes&#x27;</span>],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;yes&#x27;</span>],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">0</span>, <span class="string">&#x27;no&#x27;</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;no&#x27;</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;no&#x27;</span>]]</span><br><span class="line">    labels = [<span class="string">&#x27;no surfacing&#x27;</span>, <span class="string">&#x27;flippers&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> dataSet, labels</span><br><span class="line"></span><br><span class="line">myDat, labels = createDataSet()</span><br><span class="line"><span class="built_in">print</span> myDat</span><br><span class="line"><span class="built_in">print</span> calcShannonEnt(myDat)</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ python trees.py</span><br><span class="line">[[1, 1, &#39;yes&#39;], [1, 1, &#39;yes&#39;], [1, 0, &#39;no&#39;], [0, 1, &#39;no&#39;], [0, 1, &#39;no&#39;]]</span><br><span class="line">0.970950594455</span><br></pre></td></tr></table></figure>
<p>可以在数据集中添加数据来观察信息熵的变化情况。<br>另一种度量集合无需程序的方法是<code>基尼不纯度（Gini impurity）</code>，简单地说就是从一个数据集中随机选取子项，度量其被错误分类到其他分组里的概率。本文对基尼不纯度也先不讨论。<br>接下来我们将对每个特征划分数据集的结果计算一次信息熵，然后判断按照哪个特征划分是最好的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按照给定特征划分数据集</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">splitDataSet</span>(<span class="params">dataSet, axis, value</span>):</span></span><br><span class="line">    retDataSet = []</span><br><span class="line">    <span class="keyword">for</span> featVec <span class="keyword">in</span> dataSet:</span><br><span class="line">        <span class="keyword">if</span> featVec[axis] == value:</span><br><span class="line">            <span class="comment"># 去掉给定特征，重新构建数据集</span></span><br><span class="line">            reducedFeatVec = featVec[:axis]</span><br><span class="line">            reducedFeatVec.extend(featVec[axis+<span class="number">1</span>:])</span><br><span class="line">            retDataSet.append(reducedFeatVec)</span><br><span class="line">    <span class="keyword">return</span> retDataSet</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> splitDataSet(myDat, <span class="number">0</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ python trees.py</span><br><span class="line">[[1, 1, &#39;yes&#39;], [1, 1, &#39;yes&#39;], [1, 0, &#39;no&#39;], [0, 1, &#39;no&#39;], [0, 1, &#39;no&#39;]]</span><br><span class="line">0.970950594455</span><br><span class="line">[[1, &#39;yes&#39;], [1, &#39;yes&#39;], [0, &#39;no&#39;]]</span><br></pre></td></tr></table></figure>
<p>下面我们遍历整个数据集，计算按各个特征划分数据集的信息增益，找到最好的特征划分方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">chooseBestFeatureToSplit</span>(<span class="params">dataSet</span>):</span></span><br><span class="line">    <span class="comment"># 计算共有多少个特征</span></span><br><span class="line">    numFeatures = <span class="built_in">len</span>(dataSet[<span class="number">0</span>]) - <span class="number">1</span></span><br><span class="line">    baseEntropy = calcShannonEnt(dataSet)</span><br><span class="line">    bestInfoGain = <span class="number">0.0</span>; bestFeature = <span class="number">-1</span></span><br><span class="line">    <span class="comment"># 遍历所有的特征</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (numFeatures):</span><br><span class="line">        <span class="comment"># 特征i有哪些值</span></span><br><span class="line">        featList = [example[i] <span class="keyword">for</span> example <span class="keyword">in</span> dataSet]</span><br><span class="line">        uniqueVals = <span class="built_in">set</span>(featList)</span><br><span class="line">        newEntropy = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># 遍历所有的特征值</span></span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> uniqueVals:</span><br><span class="line">            subDataSet = splitDataSet(dataSet, i, value)</span><br><span class="line">            <span class="comment"># 计算按特征i划分后各分支的权重</span></span><br><span class="line">            prob = <span class="built_in">len</span>(subDataSet) / <span class="built_in">float</span>(<span class="built_in">len</span>(dataSet))</span><br><span class="line">            newEntropy += prob * calcShannonEnt(subDataSet)</span><br><span class="line">        infoGain = baseEntropy - newEntropy</span><br><span class="line">        <span class="keyword">if</span> (infoGain &gt; bestInfoGain):</span><br><span class="line">            bestInfoGain = infoGain</span><br><span class="line">            bestFeature = i</span><br><span class="line">    <span class="keyword">return</span> bestFeature</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> chooseBestFeatureToSplit(myDat)</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ python trees.py</span><br><span class="line">[[1, 1, &#39;yes&#39;], [1, 1, &#39;yes&#39;], [1, 0, &#39;no&#39;], [0, 1, &#39;no&#39;], [0, 1, &#39;no&#39;]]</span><br><span class="line">0.970950594455</span><br><span class="line">[[1, &#39;yes&#39;], [1, &#39;yes&#39;], [0, &#39;no&#39;]]</span><br><span class="line">0 </span><br></pre></td></tr></table></figure>

<h3 id="递归构建决策树"><a href="#递归构建决策树" class="headerlink" title="递归构建决策树"></a>递归构建决策树</h3><p>构建决策树的流程是：获得原始数据集，然后基于最好的特征划分数据集，第一次划分之后，数据将被向下传递到树分支的下一个结点，下一个结点再次划分数据，因此可以采用递归方式。<br>递归结束的条件是：程序遍历完所有划分数据集的特征，或者每个分支下的所有实例都具有相同的分类。<br>如果数据集已经处理了所有属性，但是类标签依然不是唯一的，此时我们需要采用多数表决的方法决定该叶子结点的分类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">majorityCnt</span>(<span class="params">classList</span>):</span></span><br><span class="line">    classCount = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> vote <span class="keyword">in</span> classList:</span><br><span class="line">        <span class="keyword">if</span> vote <span class="keyword">not</span> <span class="keyword">in</span> classCount.keys(): classCount[vote] = <span class="number">0</span></span><br><span class="line">        classCount[vote] += <span class="number">1</span></span><br><span class="line">    sortedClassCount = <span class="built_in">sorted</span>(classCount.iteritems(), key=operator.itemgetter(<span class="number">1</span>), reverse=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> sortedClassCount[<span class="number">0</span>][<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>创建决策树：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createTree</span>(<span class="params">dataSet, labels</span>):</span></span><br><span class="line">    classList = [example[<span class="number">-1</span>] <span class="keyword">for</span> example <span class="keyword">in</span> dataSet]</span><br><span class="line">    <span class="comment"># 类别完全相同则停止继续划分</span></span><br><span class="line">    <span class="keyword">if</span> classList.count(classList[<span class="number">0</span>]) == <span class="built_in">len</span>(classList):</span><br><span class="line">        <span class="keyword">return</span> classList[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 遍历完所有特征，返回出现最多的类</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(dataSet[<span class="number">0</span>]) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> majorityCnt(classList)</span><br><span class="line">    bestFeat = chooseBestFeatureToSplit(dataSet)</span><br><span class="line">    bestFeatLabel = labels[bestFeat]</span><br><span class="line">    myTree = &#123;bestFeatLabel:&#123;&#125;&#125;</span><br><span class="line">    <span class="keyword">del</span>(labels[bestFeat])</span><br><span class="line">    featValues = [example[bestFeat] <span class="keyword">for</span> example <span class="keyword">in</span> dataSet]</span><br><span class="line">    uniqueVals = <span class="built_in">set</span>(featValues)</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> uniqueVals:</span><br><span class="line">        subLabels = labels[:]</span><br><span class="line">        myTree[bestFeatLabel][value] = createTree(splitDataSet(dataSet, bestFeat, value), subLabels)</span><br><span class="line">    <span class="keyword">return</span> myTree</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> createTree(myDat, labels)</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#39;no surfacing&#39;: &#123;0: &#39;no&#39;, 1: &#123;&#39;flippers&#39;: &#123;0: &#39;no&#39;, 1: &#39;yes&#39;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>决策树最终以嵌套字典的方式表示，最左边是第一个划分特征，不浮出水面，0表示不是鱼类，1再以脚蹼划分。这棵树包含了3个叶子结点和2个判断结点。</p>
<p><strong>reference</strong><br>《机器学习实战》<br>《机器学习》<br><a target="_blank" rel="noopener" href="http://atlantic8.github.io/2017/03/02/Decision-Tree/">http://atlantic8.github.io/2017/03/02/Decision-Tree/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/05/30/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/05/30/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" class="post-title-link" itemprop="url">卷积神经网络</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2018-05-30 12:05:58" itemprop="dateCreated datePublished" datetime="2018-05-30T12:05:58+08:00">2018-05-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>关于卷积神经网络的原理这篇文章先不做介绍，推荐<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&mid=2650728746&idx=1&sn=61e9cb824501ec7c505eb464e8317915&scene=0#wechat_redirect">机器视角：长文揭秘图像处理和卷积神经网络架构</a>和<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25754846">卷积：如何成为一个很厉害的神经网络</a>这两篇文章，这里记录一下PyTorch对卷积神经网络的实现。<br><strong>代码清单</strong> model.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卷积神经网络(两个卷积层)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConvNet</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, num_classes=<span class="number">10</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(ConvNet, self).__init__()</span><br><span class="line">        self.layer1 = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">1</span>, <span class="number">16</span>, kernel_size=<span class="number">5</span>, stride=<span class="number">1</span>, padding=<span class="number">2</span>),</span><br><span class="line">            nn.BatchNorm2d(<span class="number">16</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>))</span><br><span class="line">        self.layer2 = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">16</span>, <span class="number">32</span>, kernel_size=<span class="number">5</span>, stride=<span class="number">1</span>, padding=<span class="number">2</span>),</span><br><span class="line">            nn.BatchNorm2d(<span class="number">32</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>))</span><br><span class="line">        self.fc = nn.Linear(<span class="number">7</span>*<span class="number">7</span>*<span class="number">32</span>, num_classes) <span class="comment"># full connection，即输出层</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        out = self.layer1(x)</span><br><span class="line">        out = self.layer2(out)</span><br><span class="line">        out = out.reshape(out.size(<span class="number">0</span>), <span class="number">-1</span>)</span><br><span class="line">        out = self.fc(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure>
<p>这里首先构建了一个两层的卷积神经网络，<code>torch.nn.Squential</code>是一个顺序的容器，模块按照构造函数顺序加入。<br><code>torch.nn.Conv2d</code>是将2D卷积（卷积核是2D的）应用到输入，其参数依次为：  </p>
<ul>
<li>in_channels 输入图像的通道数</li>
<li>out_channels 卷积产生的通道数</li>
<li>kernel_size 卷积核大小</li>
<li>stride 卷积的步长</li>
<li>padding 在输入的各边0填充</li>
</ul>
<p>输入为一个图像的Tensor形式，其中包含$N$词袋大小，$C$是通道数，$H$是输入的高度，$W$是输入的宽度，单位是pixel。下面的demo.py中可以看到一个图像的Tensor如何构造。<br><code>torch.nn.BatchNorm2d</code><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1502.03167">Batch Normalization</a>对每个隐藏层的输入进行标准化，有加速收敛等好处。<br><code>torch.nn.ReLU</code>是一个非线性激活函数，$ReLU(x) = max(0, x)$正数不变，负数都转化为0。<br><code>torch.nn.MaxPool2d</code>是对输入进行一个2D最大池化。<br><code>torch.nn.Linear</code>对输入的数据进行一个线性转变$y = Ax + b$，参数依次为：</p>
<ul>
<li>in_features 输入样本的大小</li>
<li>out_features 输出样本的大小，这里是10个数字</li>
<li>bias</li>
</ul>
<p><strong>代码清单</strong> train.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> model <span class="keyword">import</span> ConvNet</span><br><span class="line"></span><br><span class="line"><span class="comment"># Device configuration</span></span><br><span class="line">device = torch.device(<span class="string">&#x27;cuda:0&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hyper parameters</span></span><br><span class="line">num_epochs = <span class="number">5</span></span><br><span class="line">num_classes = <span class="number">10</span></span><br><span class="line">batch_size = <span class="number">100</span></span><br><span class="line">learning_rate = <span class="number">0.001</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MNIST dataset</span></span><br><span class="line">train_dataset = torchvision.datasets.MNIST(root=<span class="string">&#x27;./data/&#x27;</span>,</span><br><span class="line">                                           train=<span class="literal">True</span>,</span><br><span class="line">                                           transform=transforms.ToTensor(),</span><br><span class="line">                                           download=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">test_dataset = torchvision.datasets.MNIST(root=<span class="string">&#x27;./data/&#x27;</span>,</span><br><span class="line">                                          train=<span class="literal">False</span>,</span><br><span class="line">                                          transform=transforms.ToTensor())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Data loader</span></span><br><span class="line">train_loader = torch.utils.data.DataLoader(dataset=train_dataset,</span><br><span class="line">                                           batch_size=batch_size,</span><br><span class="line">                                           shuffle=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">test_loader = torch.utils.data.DataLoader(dataset=test_dataset,</span><br><span class="line">                                          batch_size=batch_size,</span><br><span class="line">                                          shuffle=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">model = ConvNet(num_classes).to(device)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Loss and optimizer</span></span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = torch.optim.Adam(model.parameters(), lr=learning_rate)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Train the model</span></span><br><span class="line">total_step = <span class="built_in">len</span>(train_loader)</span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">    <span class="keyword">for</span> i, (images, labels) <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_loader):</span><br><span class="line">        images = images.to(device)</span><br><span class="line">        labels = labels.to(device)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Forward pass</span></span><br><span class="line">        outputs = model(images)</span><br><span class="line">        loss = criterion(outputs, labels)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Backward and optimize</span></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i+<span class="number">1</span>) % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&#x27;Epoch [&#123;&#125;/&#123;&#125;], Step [&#123;&#125;/&#123;&#125;], Loss: &#123;:.4f&#125;&#x27;</span></span><br><span class="line">                   .<span class="built_in">format</span>(epoch+<span class="number">1</span>, num_epochs, i+<span class="number">1</span>, total_step, loss.item()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test the model</span></span><br><span class="line">model.<span class="built_in">eval</span>()  <span class="comment"># eval mode (batchnorm uses moving mean/variance instead of mini-batch mean/variance)</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    correct = <span class="number">0</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> images, labels <span class="keyword">in</span> test_loader:</span><br><span class="line">        images = images.to(device)</span><br><span class="line">        labels = labels.to(device)</span><br><span class="line">        outputs = model(images)</span><br><span class="line">        _, predicted = torch.<span class="built_in">max</span>(outputs.data, <span class="number">1</span>)</span><br><span class="line">        total += labels.size(<span class="number">0</span>)</span><br><span class="line">        correct += (predicted == labels).<span class="built_in">sum</span>().item()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&#x27;Test Accuracy of the model on the 10000 test images: &#123;&#125; %&#x27;</span>.<span class="built_in">format</span>(<span class="number">100</span> * correct / total))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Save the model checkpoint</span></span><br><span class="line">torch.save(model.state_dict(), <span class="string">&#x27;model.ckpt&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ python train.py</span><br><span class="line">Epoch [1&#x2F;5], Step [100&#x2F;600], Loss: 0.1743</span><br><span class="line">Epoch [1&#x2F;5], Step [200&#x2F;600], Loss: 0.1452</span><br><span class="line">Epoch [1&#x2F;5], Step [300&#x2F;600], Loss: 0.1029</span><br><span class="line">Epoch [1&#x2F;5], Step [400&#x2F;600], Loss: 0.0549</span><br><span class="line">Epoch [1&#x2F;5], Step [500&#x2F;600], Loss: 0.0608</span><br><span class="line">...</span><br><span class="line">Test Accuracy of the model on the 10000 test images: 99 %</span><br></pre></td></tr></table></figure>
<p>这里首先介绍一下训练数据，PyTorch支持<a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/torchvision/datasets.html">多种数据集</a>，上述代码用到的是MNIST数据集，一般在训练和测试时都是直接使用官网提供的<a target="_blank" rel="noopener" href="http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz">二进制数据集</a>，但是作为初学者，不太理解这个二进制到底是什么东西，所以先用下面的代码将二进制文件解析为原始的图片和对应的标签：<br><strong>代码清单</strong> resolve.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_image</span>(<span class="params">filename</span>):</span></span><br><span class="line">  f = <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">  index = <span class="number">0</span></span><br><span class="line">  buf = f.read()</span><br><span class="line">  f.close()</span><br><span class="line">  magic, images, rows, columns = struct.unpack_from(<span class="string">&#x27;&gt;IIII&#x27;</span> , buf , index)</span><br><span class="line">  index += struct.calcsize(<span class="string">&#x27;&gt;IIII&#x27;</span>)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> xrange(images):</span><br><span class="line">    image = Image.new(<span class="string">&#x27;L&#x27;</span>, (columns, rows))</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> xrange(rows):</span><br><span class="line">      <span class="keyword">for</span> y <span class="keyword">in</span> xrange(columns):</span><br><span class="line">        image.putpixel((y, x), <span class="built_in">int</span>(struct.unpack_from(<span class="string">&#x27;&gt;B&#x27;</span>, buf, index)[<span class="number">0</span>]))</span><br><span class="line">        index += struct.calcsize(<span class="string">&#x27;&gt;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;save &#x27;</span> + <span class="built_in">str</span>(i) + <span class="string">&#x27;image&#x27;</span></span><br><span class="line">    image.save(<span class="string">&#x27;test/&#x27;</span> + <span class="built_in">str</span>(i) + <span class="string">&#x27;.png&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_label</span>(<span class="params">filename, saveFilename</span>):</span></span><br><span class="line">  f = <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">  index = <span class="number">0</span></span><br><span class="line">  buf = f.read()</span><br><span class="line"></span><br><span class="line">  f.close()</span><br><span class="line"></span><br><span class="line">  magic, labels = struct.unpack_from(<span class="string">&#x27;&gt;II&#x27;</span> , buf , index)</span><br><span class="line">  index += struct.calcsize(<span class="string">&#x27;&gt;II&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  labelArr = [<span class="number">0</span>] * labels</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> xrange(labels):</span><br><span class="line">    labelArr[x] = <span class="built_in">int</span>(struct.unpack_from(<span class="string">&#x27;&gt;B&#x27;</span>, buf, index)[<span class="number">0</span>])</span><br><span class="line">    index += struct.calcsize(<span class="string">&#x27;&gt;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  save = <span class="built_in">open</span>(saveFilename, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  save.write(<span class="string">&#x27;,&#x27;</span>.join(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="built_in">str</span>(x), labelArr)))</span><br><span class="line">  save.write(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  save.close()</span><br><span class="line">  <span class="built_in">print</span> <span class="string">&#x27;save labels success&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  read_image(<span class="string">&#x27;data/raw/t10k-images-idx3-ubyte&#x27;</span>)</span><br><span class="line">  read_label(<span class="string">&#x27;data/raw/t10k-labels-idx1-ubyte&#x27;</span>, <span class="string">&#x27;test/label.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/images/machinelearning/img.png" alt="解析出的图片"><br>解析出数据集中的图片后，我们可以随意选取图片来测试训练的模型<code>model.ckpt</code>：<br><strong>代码清单</strong> demo.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> model <span class="keyword">import</span> ConvNet</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model_path = <span class="string">&quot;./model.ckpt&quot;</span></span><br><span class="line">img_path = <span class="string">&quot;./12.png&quot;</span></span><br><span class="line"></span><br><span class="line">model = ConvNet()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;load pretrained model from %s&quot;</span> % model_path</span><br><span class="line">model.load_state_dict(torch.load(model_path))</span><br><span class="line"></span><br><span class="line">transformer = transforms.ToTensor()</span><br><span class="line"><span class="comment"># 将图像转换为灰度模式，即单通道</span></span><br><span class="line">image = Image.<span class="built_in">open</span>(img_path).convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line"><span class="comment">#image.resize((28, 28), Image.BILINEAR)</span></span><br><span class="line"><span class="comment"># 将图像转换为Tensor</span></span><br><span class="line">image = transformer(image)</span><br><span class="line"><span class="comment"># 为Tensor添加一维，表示batch</span></span><br><span class="line">image = image.view(<span class="number">1</span>, *image.size())</span><br><span class="line"></span><br><span class="line">model.<span class="built_in">eval</span>()</span><br><span class="line">output = model(image)</span><br><span class="line"></span><br><span class="line">preds = torch.<span class="built_in">max</span>(output, <span class="number">1</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> preds.item()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ python demo.py</span><br><span class="line">load pretrained model from .&#x2F;model.ckpt</span><br><span class="line">9</span><br></pre></td></tr></table></figure>
<p>可以看到用训练的模型可以正确识别出图片中的数字9。<br><strong>reference</strong><br><a target="_blank" rel="noopener" href="https://github.com/yunjey/pytorch-tutorial/blob/master/tutorials/02-intermediate/convolutional_neural_network/main.py">https://github.com/yunjey/pytorch-tutorial/blob/master/tutorials/02-intermediate/convolutional_neural_network/main.py</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Bruce Fan"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Bruce Fan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">125</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bruce Fan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
